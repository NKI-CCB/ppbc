---
author: "Kat Moore"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    df_print: paged
    highlight: kate
params:
  outcome:
    label: "Survival outcome type"
    value: "OS"
    input: "select"
    choice: ["OS", "DRS"]
  min_cell_count:
    value: 20000
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, libraries, echo=F}
library(tidyverse)
library(here)
library(ggpubr)
library(survival)
library(survminer)
library(broom)

theme_set(theme_bw())
```

This notebook reports on the relationship between cell densities and the following clinical outcome:

```{r}
outcome <- params$outcome
ptitle <- ifelse(outcome == "OS", "Overall survival", "Distant recurrence")
print(ptitle)
```

---
title: '`r paste('Cox regression with total density:', ptitle)`'
---

## Setup

### Select regions

Load data

```{r}
dens <- readRDS(here("data/vectra/processed/density_ppbc_withoutCD27.Rds"))
```

Use total density for association with outcome.

```{r}
dens <- dens %>%
  filter(classifier_label %in% c("Total"))

dens$classifier_label %>% unique()
```

### Cell count threshold

Counts per panel at start:

```{r}
dens %>%
  group_by(cell_type, panel) %>%
  summarise(n = sum(n), .groups="drop") %>%
  pivot_wider(names_from = panel, values_from = n, values_fill = 0) %>%
  arrange(desc(MPIF27+MPIF26))
```

### Cell count threshold

The minimum number of cells of a given type that must be present across the whole dataset is:

```{r}
min_cell_count <- as.integer(params$min_cell_count)
min_cell_count
```

Cell types which fail this threshold:

```{r}
excluded_cells <- dens %>%
  group_by(cell_type, panel) %>%
  summarise(n = sum(n), .groups="drop") %>%
  filter(n < min_cell_count) %>%
  pull(cell_type)

excluded_cells
```

Remaining cell groups:

```{r}
dens <- dens %>% filter(!cell_type %in% excluded_cells)
unique(dens$cell_type)
```

### Sample count threshold

Number of samples per panel:

```{r}
dens %>%
  select(t_number, panel, study_group, group) %>%
  distinct() %>%
  group_by(panel, group) %>%
  count() %>%
  pivot_wider(names_from = panel, values_from = n)
```

Per stage:

```{r}
dens %>%
  select(t_number, stage, study_group, group) %>%
  distinct() %>%
  group_by(stage, group) %>%
  count() %>%
  pivot_wider(names_from = stage, values_from = n, values_fill = 0)
```

Not enough samples to include prbc and lac, or stage IV samples.

```{r}
cox_dens <- dens %>%
  #filter(!group %in% c("lac")) %>%
  filter(stage != "stage IV")

cox_dens <- droplevels(cox_dens)

cox_dens %>%
  select(t_number, stage, study_group, group) %>%
  distinct() %>%
  group_by(stage, group) %>%
  count() %>%
  pivot_wider(names_from = stage, values_from = n)
```

### Clinical outcomes

Detect the appropriate time and clinical outcomes for Cox regressions.

```{r}
if(params$outcome == "OS"){
  timevar <- "time_OS_months"
  eventvar <- "death"
} else if (params$outcome == "DRS"){
  timevar <- "time_DRS_months"
  eventvar <- "distant_recurrence"
} else {
  stop("Outcome must be OS or DRS")
}

if(!timevar %in% colnames(cox_dens)){
  stop(paste("Time variable", timevar,"not found in input data"))
} else if (!eventvar %in% colnames(cox_dens)){
  stop(paste("Event variable", eventvar,"not found in input data"))
}

print(paste0(ptitle, " (", outcome, ")"))
print(paste("Time variable:", timevar))
print(paste("Event variable:", eventvar))
```

Set up the left side of the Cox formula.

```{r}
survres <- paste0("Surv(time = ", timevar,", event = ", eventvar, ")")
survres
```

### Cox functions

```{r}
source(here("src/spatial/cox_spatial.R"))
```

## Cox: all samples

Overall impact of density independent on involution and nulliparous groups combined.

Fit separate models for each cell_type/tumor vs stroma/panel. P value is calculated by a likelihood ratio test (LRT) that compares the fit of the Cox model with the fit of a reduced model that does not contain the covariate of interest. Hazard ratios and confidence intervals are obtained from the covariate of interest in the full model.

### Relevant cells

We are only interested in the association of putative immune cells and clinical outcome.

```{r}
relevant_cells <- unique(cox_dens$cell_type)
relevant_cells <- relevant_cells[!relevant_cells %in% c("PanCK+", "Other")]
relevant_cells
```

### Univariate

Use the intercept as the reduced formula for univarate analysis

```{r}
univ_form <- paste0(survres, " ~ 1")
univ_form
```

Example Cox output for single cell type.

```{r}
cox_density(cox_dens, "MPIF27", "CD3+CD8+",
            f = univ_form, tidied = T)
```

#### Results

Loop over all cell types, while auto-detecting which panel to use.

```{r}
univ_cox <- lapply(relevant_cells, function(x){
  all_cox_density(cox_dens, x,
                  f = univ_form)
}) %>%
  bind_rows() %>%
  mutate(lrt.fdr = p.adjust(lrt.pval, method = "BH"), .after = panel) %>%
  mutate(formula = paste0(univ_form, " + Density"))

univ_cox %>%
  arrange(lrt.fdr, lrt.pval)
```

### Multivariate

Start with a limited number of covariates. Potential covariates (see `12_genewise_survival.R`): 

group (PPBC study group)
stage
age_at_diagnosis
grade
surgery
radiotherapy
strata(hormonetherapy)
chemotherapy
herceptin
strata(PAM50)

PAM50 is not suitable, since that will be correlated with immune cell density. Same is likely true of treatment interventions.
Stratify PPBC to allow separate baseline hazards functions for each PPBC subgroup.

```{r}
multiv_form <- paste0(survres," ~ strata(group) + stage")
multiv_form
```

Example one cell type:

```{r}
#The LRT pval is the same for all the covariates because 
#it's a comparison between the full and reduced model
#However, covariate estimates should be different
cox_density(cox_dens, "MPIF27", "CD3+CD8+",
            f = multiv_form,
            tidied=F)

cox_density(cox_dens, "MPIF27", "CD3+CD8+",
            f = multiv_form,
            tidied=T)

```

#### Results 

```{r}
mult_cox <- lapply(relevant_cells, function(x){
  all_cox_density(cox_dens, x,
                  f = multiv_form)
}) %>%
  bind_rows() %>%
  # group_by(panel) %>% #Debatable
  mutate(lrt.fdr = p.adjust(lrt.pval, method = "BH"), .after = panel) %>%
  mutate(formula = paste0(multiv_form, " + density"))

mult_cox %>%
  arrange(lrt.fdr, lrt.pval)
```

## Cox: inv - np - pr subgroups

Check significance in involution samples and nulliparous samples separately.

Involution samples:

```{r}
inv_dens <- filter(cox_dens, group == "inv")
inv_dens <- droplevels(inv_dens)

inv_dens %>%
  select(t_number, stage, study_group, group) %>%
  distinct() %>%
  group_by(group, stage) %>%
  distinct() %>%
  count()
```

Nulliparous samples:

```{r}
np_dens <- filter(cox_dens, group == "nonprbc")
np_dens <- droplevels(np_dens)

np_dens %>%
  select(t_number, stage, study_group, group) %>%
  distinct() %>%
  group_by(group, stage) %>%
  distinct() %>%
  count()
```

Pregnant samples:

```{r}
pr_dens <- filter(cox_dens, group == "prbc")
pr_dens <- droplevels(pr_dens)

pr_dens %>%
  select(t_number, stage, study_group, group) %>%
  distinct() %>%
  group_by(group, stage) %>%
  distinct() %>%
  count()
```


### Univariate

As above, but split by group. Formula:

```{r}
univ_form
```

Example single cell type.

```{r}
cox_density(df = inv_dens, panel = "MPIF26", cell_type = "CD20+",
            f = univ_form, tidied=F)
```

#### Involution

```{r}
inv_univ_cox <- lapply(relevant_cells, function(x){
  all_cox_density(inv_dens, x,
                  f = univ_form)
}) %>%
  bind_rows() %>%
  mutate(lrt.fdr = p.adjust(lrt.pval, method = "BH"), .after = panel) %>%
  mutate(formula = paste0(univ_form, " + Density")) %>%
  mutate(subset = "inv", .before = everything())

inv_univ_cox %>%
  arrange(lrt.fdr, lrt.pval)
```

#### Nulliparous

All cell density results by region and panel, arranged by FDR and P value.

```{r}
np_univ_cox <- lapply(relevant_cells, function(x){
  all_cox_density(np_dens, x,
                  f = univ_form)
}) %>%
  bind_rows() %>%
  mutate(lrt.fdr = p.adjust(lrt.pval, method = "BH"), .after = panel) %>%
  mutate(formula = paste0(" + Density"))

np_univ_cox %>%
  arrange(lrt.fdr, lrt.pval)
```

#### Pregnant

All cell density results by region and panel, arranged by FDR and P value.

```{r}
pr_univ_cox <- lapply(relevant_cells, function(x){
  all_cox_density(pr_dens, x,
                  f = univ_form)
}) %>%
  bind_rows() %>%
  mutate(lrt.fdr = p.adjust(lrt.pval, method = "BH"), .after = panel) %>%
  mutate(formula = paste0(" + Density"))

pr_univ_cox %>%
  arrange(lrt.fdr, lrt.pval)
```


### Multivariate

Given that we are analysing PPBC groups separately, we can omit `strata_group` from this formula.

```{r}
multiv_subform <- paste0(survres, " ~ stage")
multiv_subform
```

#### Involution

All cell density results by region and panel, arranged by FDR and P value.

```{r}
inv_mult_cox <- lapply(relevant_cells, function(x){
  all_cox_density(inv_dens, x,
                  f = multiv_subform)
}) %>%
  bind_rows() %>%
  mutate(lrt.fdr = p.adjust(lrt.pval, method = "BH"), .after = panel) %>%
  mutate(formula = paste0(multiv_subform, " + density"))

inv_mult_cox %>%
  arrange(lrt.fdr, lrt.pval)
```

Reshape by region, split by panel

```{r}
inv_mult_cox %>%
  select(cell_type, term, lrt.fdr, panel, lrt.pval) %>%
  arrange(lrt.fdr, lrt.pval) %>%
  pivot_wider(names_from = term,
              values_from = c(lrt.fdr, lrt.pval)) %>%
  split(., .$panel)
```

#### Nulliparous

All cell density results by region and panel, arranged by FDR and P value.

```{r}
np_mult_cox <- lapply(relevant_cells, function(x){
  all_cox_density(np_dens, x,
                  f = multiv_subform)
}) %>%
  bind_rows() %>%
  mutate(lrt.fdr = p.adjust(lrt.pval, method = "BH"), .after = panel) %>%
  mutate(formula = paste0(multiv_subform, " + density"))

np_mult_cox %>%
  arrange(lrt.fdr, lrt.pval)
```

#### Pregnant

All cell density results by region and panel, arranged by FDR and P value.

```{r}
pr_mult_cox <- lapply(relevant_cells, function(x){
  all_cox_density(pr_dens, x,
                  f = multiv_subform)
}) %>%
  bind_rows() %>%
  mutate(lrt.fdr = p.adjust(lrt.pval, method = "BH"), .after = panel) %>%
  mutate(formula = paste0(multiv_subform, " + density"))

pr_mult_cox %>%
  arrange(lrt.fdr, lrt.pval)
```


## Kaplan-Meier: Density by study group

KMs require categorical variables. Convert density into quantiles. P values are from logrank tests.

MPIF26

```{r}
cells_26 <- unique(filter(cox_dens, panel == "MPIF26")$cell_type)
cells_26 <- cells_26[!cells_26 %in% c("PanCK+", "Other")]

lapply(cells_26, function(x){
  km_plot(cox_dens, panel = "MPIF26", cell_type = x, outcome,
        f = paste0(survres, " ~ quantile"))
}) %>% set_names(cells_26)
```

MPIF27

```{r}
cells_27 <- unique(filter(cox_dens, panel == "MPIF27")$cell_type)
cells_27 <- cells_27[!cells_27 %in% c("PanCK+", "Other")]

lapply(cells_27, function(x){
  km_plot(cox_dens, panel = "MPIF27", cell_type = x, outcome,
        f =  paste0(survres, " ~ quantile"))
}) %>% set_names(cells_27)
```

## Cox: interaction

Interaction term between group and cell density. Aims to answer the question: which cell densities affect outcome *differently* in involuting vs nulliparous patients. Maybe be statistically underpowered due to lack of more samples.

```{r}
cox_dens %>%
  select(t_number, study_group, group) %>%
  distinct() %>%
  group_by(group) %>%
  count()
```

The analysis below works very similarly to the one implemented with `cox_density()`, except that a formula with an interaction term is automatically generated.

The reduced formula will be:

```{r}
inv_baseform <- paste(multiv_subform, "+ group + Total_density")
inv_baseform
```

The interaction term formula is:

```{r}
inv_intform <- paste(inv_baseform, "+ group:Total_density")
inv_intform
```

`Group` is a binary factor that refers to whether a sample is involuting or nulliparous, and `Total_density` refers to the density of a given cell type. An LRT attempts to determine whether models fit using the interaction term `group:Total_density` is different than the base formula `~stage + group + Total_density`. 

Again, this test is likely statistically underpowered. Unfortunately it is not simple to do a formal power calculation between nonbinary predictors in an interaction term.

```{r}
cox_interaction(cox_dens, "MPIF27", "CD20+",
                baseform = inv_baseform, tidied = F)
```


### Results by significance

Also the wrapper function is similar to `all_cox_density()`, except that it invokes `cox_interaction` instead of `cox_density`.

```{r}
interaction_df <- lapply(relevant_cells, function(x){
  all_cox_interaction(cox_dens, x, baseform = inv_baseform)
}) %>%
 bind_rows() %>%
  #Only show the involution-related interaction terms
  filter(str_detect(term, "inv")) %>%
  mutate(lrt.fdr = p.adjust(lrt.pval, method = "BH"), .after = panel) %>%
  mutate(formula = inv_intform)

```

All cell density results by panel, arranged by FDR and P value.

```{r}
interaction_df %>%
  arrange(lrt.fdr, lrt.pval)
```




# Analyses Hanne 

```{r}
library(tximport)
library(dplyr)
library(tidyr)
library(gplots)
library(ggplot2)
library(grid)
library(vcd)
library(corrplot)
library(ca)
library(scales)
library(ggthemes)
library(ztable)
library(magrittr)
library(prodlim)
library(Publish)
library(readxl)
library(devtools)
library(multcomp)
library(car)
library(rstatix)
```


```{r}
MPIF26_dens <- filter(cox_dens, panel == "MPIF26")
MPIF27_dens <- filter(cox_dens, panel == "MPIF27")
```



```{r}
table(cox_dens$cell_type)
table(MPIF26_dens$cell_type)
table(MPIF27_dens$cell_type)
```


divide into MPIF26 and MPIF27
divide into cell type subgroups
```{r}
#MPIF26
MPIF26_dens_CD20 <- filter(MPIF26_dens, cell_type == "CD20+")
MPIF26_dens_CD3_Foxp3neg <- filter(MPIF26_dens, cell_type == "CD3+FoxP3-")
MPIF26_dens_Foxp3 <- filter(MPIF26_dens, cell_type == "FoxP3+")
MPIF26_dens_PanCK <- filter(MPIF26_dens, cell_type == "PanCK+")
MPIF26_dens_Other <- filter(MPIF26_dens, cell_type == "Other")

#MPIF27
MPIF27_dens_CD20 <- filter(MPIF27_dens, cell_type == "CD20+")
MPIF27_dens_CD3_CD8neg <- filter(MPIF27_dens, cell_type == "CD3+CD8-")
MPIF27_dens_CD3_CD8pos <- filter(MPIF27_dens, cell_type == "CD3+CD8+")
MPIF27_dens_PanCK <- filter(MPIF27_dens, cell_type == "PanCK+")
MPIF27_dens_Other <- filter(MPIF27_dens, cell_type == "Other")

# combination
Combo_dens_CD20 <- filter(cox_dens, cell_type == "CD20+")
```


differntiate patients into cell_type high versus low (based on median per group)
MPIF26

```{r}
MPIF26_dens_CD20 <- MPIF26_dens_CD20 %>%
  mutate(med_density = median(density, na.rm = TRUE)) %>%
  mutate(
    Density_Total = case_when(
      density >= med_density ~ "high",
      density < med_density ~ "low"))

MPIF26_dens_CD3_Foxp3neg <- MPIF26_dens_CD3_Foxp3neg %>%
  mutate(med_density = median(density, na.rm = TRUE)) %>%
  mutate(
    Density_Total = case_when(
      density >= med_density ~ "high",
      density < med_density ~ "low"))

MPIF26_dens_Foxp3 <- MPIF26_dens_Foxp3 %>%
  mutate(med_density = median(density, na.rm = TRUE)) %>%
  mutate(
    Density_Total = case_when(
      density >= med_density ~ "high",
      density < med_density ~ "low"))

MPIF27_dens_CD20 <- MPIF27_dens_CD20 %>%
  mutate(med_density = median(density, na.rm = TRUE)) %>%
  mutate(
    Density_Total = case_when(
      density >= med_density ~ "high",
      density < med_density ~ "low"))

MPIF27_dens_CD3_CD8neg <- MPIF27_dens_CD3_CD8neg %>%
  mutate(med_density = median(density, na.rm = TRUE)) %>%
  mutate(
    Density_Total = case_when(
      density >= med_density ~ "high",
      density < med_density ~ "low"))

MPIF27_dens_CD3_CD8pos <- MPIF27_dens_CD3_CD8pos %>%
  mutate(med_density = median(density, na.rm = TRUE)) %>%
  mutate(
    Density_Total = case_when(
      density >= med_density ~ "high",
      density < med_density ~ "low"))

Combo_dens_CD20 <- Combo_dens_CD20 %>%
  mutate(med_density = median(density, na.rm = TRUE)) %>%
  mutate(
    Density_Total = case_when(
      density >= med_density ~ "high",
      density < med_density ~ "low"))
```


Make data frames 
```{r}
MPIF26_dens <- as.data.frame(MPIF26_dens)
MPIF26_dens_CD20 <- as.data.frame(MPIF26_dens_CD20)
MPIF26_dens_CD3_Foxp3neg <- as.data.frame(MPIF26_dens_CD3_Foxp3neg)
MPIF26_dens_Foxp3 <- as.data.frame(MPIF26_dens_Foxp3)
MPIF26_dens_PanCK <- as.data.frame(MPIF26_dens_PanCK)
MPIF26_dens_Other <- as.data.frame(MPIF26_dens_Other)

MPIF27_dens <- as.data.frame(MPIF27_dens)
MPIF27_dens_CD20 <- as.data.frame(MPIF27_dens_CD20)
MPIF27_dens_CD3_CD8neg <- as.data.frame(MPIF27_dens_CD3_CD8neg)
MPIF27_dens_CD3_CD8pos <- as.data.frame(MPIF27_dens_CD3_CD8pos)
MPIF27_dens_PanCK <- as.data.frame(MPIF27_dens_PanCK)
MPIF27_dens_Other <- as.data.frame(MPIF27_dens_Other)

Combo_dens_CD20 <- as.data.frame(Combo_dens_CD20)
```


## ANOVA

#### CD20 MPIF26

```{r}
group_by(MPIF26_dens_CD20, study_group) %>%
  summarise(
    count = n(),
    mean = mean(density, na.rm = TRUE),
    sd = sd(density, na.rm = TRUE)
  )
```


Remove NA values
```{r}
MPIF26_dens_CD20 <- MPIF26_dens_CD20[!is.na(MPIF26_dens_CD20$density),]

group_by(MPIF26_dens_CD20, study_group) %>%
  summarise(
    count = n(),
    mean = mean(density, na.rm = TRUE),
    sd = sd(density, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
MPIF26_dens_CD20$study_group <- gsub("non_prbc", "nonPrBC", MPIF26_dens_CD20$study_group)
MPIF26_dens_CD20$study_group <- gsub("ppbc_inv", "PPBCinv", MPIF26_dens_CD20$study_group)
MPIF26_dens_CD20$study_group <- gsub("ppbc_lac", "PPBClac", MPIF26_dens_CD20$study_group)
MPIF26_dens_CD20$study_group <- gsub("prbc", "PrBC", MPIF26_dens_CD20$study_group)

MPIF26_dens_CD20$study_group <- ordered(MPIF26_dens_CD20$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(MPIF26_dens_CD20$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(MPIF26_dens_CD20$density)
```


```{r}
MPIF26_dens_CD20 %>% 
  group_by(study_group) %>%
  identify_outliers(density)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.density_CD20 <- aov(density ~ study_group, data = MPIF26_dens_CD20)
# summary of the analysis
summary(res.aov.density_CD20)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.density_CD20)
```

```{r}
pwc_density_CD20 <- MPIF26_dens_CD20 %>% tukey_hsd(density ~ study_group)
pwc_density_CD20
```



Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.density_CD20, 1)
```


```{r}
leveneTest(density ~ study_group, data = MPIF26_dens_CD20)
```

From the output above we can see that the p-value is more than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is not statistically significantly different. Therefore, we CANNOT assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(density ~ study_group, data = MPIF26_dens_CD20)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(MPIF26_dens_CD20$density, MPIF26_dens_CD20$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.density_CD20, 2)

model_density_CD20 <- lm(density ~ study_group, data=MPIF26_dens_CD20)
ggqqplot(residuals(model_density_CD20))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_density_CD20 <- residuals(object = res.aov.density_CD20)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_density_CD20)
shapiro_test(residuals(model_density_CD20))
```

Check normality assumption by groups. Computing Shapiro-Wilk test for each group level. If the data is normally distributed, the p-value should be greater than 0.05.

-> data not normally distributed 

```{r}
MPIF26_dens_CD20 %>%
  group_by(study_group) %>%
  shapiro_test(density)

ggqqplot(MPIF26_dens_CD20, "density", facet.by = "study_group")
```


Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(density ~ study_group, data = MPIF26_dens_CD20)
```

Wilcoxon pairwise test 

The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.


```{r}
pairwise.t.test(MPIF26_dens_CD20$density, MPIF26_dens_CD20$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
my_comparisons <- list( c("PPBCinv", "nonPrBC"), c("PPBCinv", "PrBC"), c("PPBCinv", "PPBClac") )

density_CD20_MPIF26 <- ggboxplot(MPIF26_dens_CD20, x="study_group", y="density",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "density_CD20 at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 10, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 2500) # + stat_pvalue_manual(pwc_density_CD20, hide.ns = TRUE, y.position = c(1500))
density_CD20_MPIF26
```

```{r}
pdf(file="density_CD20_MPIF26.pdf", width = 7, height=4.5)
density_CD20_MPIF26
dev.off()
```


#### CD20 MPIF27

```{r}
group_by(MPIF27_dens_CD20, study_group) %>%
  summarise(
    count = n(),
    mean = mean(density, na.rm = TRUE),
    sd = sd(density, na.rm = TRUE)
  )
```


Remove NA values
```{r}
MPIF27_dens_CD20 <- MPIF27_dens_CD20[!is.na(MPIF27_dens_CD20$density),]

group_by(MPIF27_dens_CD20, study_group) %>%
  summarise(
    count = n(),
    mean = mean(density, na.rm = TRUE),
    sd = sd(density, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
MPIF27_dens_CD20$study_group <- gsub("non_prbc", "nonPrBC", MPIF27_dens_CD20$study_group)
MPIF27_dens_CD20$study_group <- gsub("ppbc_inv", "PPBCinv", MPIF27_dens_CD20$study_group)
MPIF27_dens_CD20$study_group <- gsub("ppbc_lac", "PPBClac", MPIF27_dens_CD20$study_group)
MPIF27_dens_CD20$study_group <- gsub("prbc", "PrBC", MPIF27_dens_CD20$study_group)

MPIF27_dens_CD20$study_group <- ordered(MPIF27_dens_CD20$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(MPIF27_dens_CD20$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(MPIF27_dens_CD20$density)
```


```{r}
MPIF27_dens_CD20 %>% 
  group_by(study_group) %>%
  identify_outliers(density)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.density_CD20 <- aov(density ~ study_group, data = MPIF27_dens_CD20)
# summary of the analysis
summary(res.aov.density_CD20)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.density_CD20)
```

```{r}
pwc_density_CD20 <- MPIF27_dens_CD20 %>% tukey_hsd(density ~ study_group)
pwc_density_CD20
```


Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.density_CD20, 1)
```


```{r}
leveneTest(density ~ study_group, data = MPIF27_dens_CD20)
```

From the output above we can see that the p-value is not less than the significance level of 0.05. This means that there is NO evidence to suggest that the variance across groups is statistically significantly different. Therefore, we CANNOT assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(density ~ study_group, data = MPIF27_dens_CD20)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(MPIF27_dens_CD20$density, MPIF27_dens_CD20$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.density_CD20, 2)

model_density_CD20 <- lm(density ~ study_group, data=MPIF27_dens_CD20)
ggqqplot(residuals(model_density_CD20))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_density_CD20 <- residuals(object = res.aov.density_CD20)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_density_CD20)
shapiro_test(residuals(model_density_CD20))
```

Check normality assumption by groups. Computing Shapiro-Wilk test for each group level. If the data is normally distributed, the p-value should be greater than 0.05.

-> data not normally distributed


```{r}
MPIF27_dens_CD20 %>%
  group_by(study_group) %>%
  shapiro_test(density)

ggqqplot(MPIF27_dens_CD20, "density", facet.by = "study_group")
```


Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(density ~ study_group, data = MPIF27_dens_CD20)
```

Wilcoxon pairwise test 

The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.


```{r}
pairwise.t.test(MPIF27_dens_CD20$density, MPIF27_dens_CD20$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
density_CD20_MPIF27 <- ggboxplot(MPIF27_dens_CD20, x="study_group", y="density",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "density_CD20 at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 10, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 2500) #+ stat_pvalue_manual(pwc_density_CD20, hide.ns = TRUE, y.position = c(1000))
density_CD20_MPIF27
```

```{r}
pdf(file="density_CD20_MPIF27.pdf", width = 7, height=4.5)
density_CD20_MPIF27
dev.off()
```


#### CD20 total

```{r}
group_by(Combo_dens_CD20, study_group) %>%
  summarise(
    count = n(),
    mean = mean(density, na.rm = TRUE),
    sd = sd(density, na.rm = TRUE)
  )
```


Remove NA values
```{r}
Combo_dens_CD20 <- Combo_dens_CD20[!is.na(Combo_dens_CD20$density),]

group_by(Combo_dens_CD20, study_group) %>%
  summarise(
    count = n(),
    mean = mean(density, na.rm = TRUE),
    sd = sd(density, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
Combo_dens_CD20$study_group <- gsub("non_prbc", "nonPrBC", Combo_dens_CD20$study_group)
Combo_dens_CD20$study_group <- gsub("ppbc_inv", "PPBCinv", Combo_dens_CD20$study_group)
Combo_dens_CD20$study_group <- gsub("ppbc_lac", "PPBClac", Combo_dens_CD20$study_group)
Combo_dens_CD20$study_group <- gsub("prbc", "PrBC", Combo_dens_CD20$study_group)

Combo_dens_CD20$study_group <- ordered(Combo_dens_CD20$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(Combo_dens_CD20$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(Combo_dens_CD20$density)
```


```{r}
Combo_dens_CD20 %>% 
  group_by(study_group) %>%
  identify_outliers(density)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.density_CD20 <- aov(density ~ study_group, data = Combo_dens_CD20)
# summary of the analysis
summary(res.aov.density_CD20)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.density_CD20)
```

```{r}
pwc_density_CD20 <- Combo_dens_CD20 %>% tukey_hsd(density ~ study_group)
pwc_density_CD20
```



Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.density_CD20, 1)
```


```{r}
leveneTest(density ~ study_group, data = Combo_dens_CD20)
```

From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we CAN assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(density ~ study_group, data = Combo_dens_CD20)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(Combo_dens_CD20$density, Combo_dens_CD20$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.density_CD20, 2)

model_density_CD20 <- lm(density ~ study_group, data=Combo_dens_CD20)
ggqqplot(residuals(model_density_CD20))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_density_CD20 <- residuals(object = res.aov.density_CD20)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_density_CD20)
shapiro_test(residuals(model_density_CD20))
```

Check normality assumption by groups. Computing Shapiro-Wilk test for each group level. If the data is normally distributed, the p-value should be greater than 0.05.

-> data not normally distributed

```{r}
Combo_dens_CD20 %>%
  group_by(study_group) %>%
  shapiro_test(density)

ggqqplot(Combo_dens_CD20, "density", facet.by = "study_group")
```


Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(density ~ study_group, data = Combo_dens_CD20)
```


Wilcoxon paiwise test 

The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.

```{r}
pairwise.t.test(Combo_dens_CD20$density, Combo_dens_CD20$study_group,
                 p.adjust.method = "BH")
```

Visualization

```{r, fig.width=7, fig.height=4.5}
density_CD20 <- ggboxplot(Combo_dens_CD20, x="study_group", y="density",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "density_CD20 at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 10, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 2500) # + stat_pvalue_manual(pwc_density_CD20, hide.ns = TRUE, y.position = c(1500))
density_CD20
```

```{r}
pdf(file="density_CD20.pdf", width = 7, height=4.5)
density_CD20
dev.off()
```



#### CD3+CD8+

MPIF27_dens_CD3_CD8pos
```{r}
group_by(MPIF27_dens_CD3_CD8pos, study_group) %>%
  summarise(
    count = n(),
    mean = mean(density, na.rm = TRUE),
    sd = sd(density, na.rm = TRUE)
  )
```


Remove NA values
```{r}
MPIF27_dens_CD3_CD8pos <- MPIF27_dens_CD3_CD8pos[!is.na(MPIF27_dens_CD3_CD8pos$density),]

group_by(MPIF27_dens_CD3_CD8pos, study_group) %>%
  summarise(
    count = n(),
    mean = mean(density, na.rm = TRUE),
    sd = sd(density, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
MPIF27_dens_CD3_CD8pos$study_group <- gsub("non_prbc", "nonPrBC", MPIF27_dens_CD3_CD8pos$study_group)
MPIF27_dens_CD3_CD8pos$study_group <- gsub("ppbc_inv", "PPBCinv", MPIF27_dens_CD3_CD8pos$study_group)
MPIF27_dens_CD3_CD8pos$study_group <- gsub("ppbc_lac", "PPBClac", MPIF27_dens_CD3_CD8pos$study_group)
MPIF27_dens_CD3_CD8pos$study_group <- gsub("prbc", "PrBC", MPIF27_dens_CD3_CD8pos$study_group)

MPIF27_dens_CD3_CD8pos$study_group <- ordered(MPIF27_dens_CD3_CD8pos$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(MPIF27_dens_CD3_CD8pos$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(MPIF27_dens_CD3_CD8pos$density)
```


```{r}
MPIF27_dens_CD3_CD8pos %>% 
  group_by(study_group) %>%
  identify_outliers(density)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.density_CD3_CD8pos <- aov(density ~ study_group, data = MPIF27_dens_CD3_CD8pos)
# summary of the analysis
summary(res.aov.density_CD3_CD8pos)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.density_CD3_CD8pos)
```

```{r}
pwc_density_CD3_CD8pos <- MPIF27_dens_CD3_CD8pos %>% tukey_hsd(density ~ study_group)
pwc_density_CD3_CD8pos
```



Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.density_CD3_CD8pos, 1)
```


```{r}
leveneTest(density ~ study_group, data = MPIF27_dens_CD3_CD8pos)
```

From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(density ~ study_group, data = MPIF27_dens_CD3_CD8pos)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(MPIF27_dens_CD3_CD8pos$density, MPIF27_dens_CD3_CD8pos$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.density_CD3_CD8pos, 2)

model_density_CD3_CD8pos <- lm(density ~ study_group, data=MPIF27_dens_CD3_CD8pos)
ggqqplot(residuals(model_density_CD3_CD8pos))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_density_CD3_CD8pos <- residuals(object = res.aov.density_CD3_CD8pos)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_density_CD3_CD8pos)
shapiro_test(residuals(model_density_CD3_CD8pos))
```

Check normality assumption by groups. Computing Shapiro-Wilk test for each group level. If the data is normally distributed, the p-value should be greater than 0.05.
```{r}
MPIF27_dens_CD3_CD8pos %>%
  group_by(study_group) %>%
  shapiro_test(density)

ggqqplot(MPIF27_dens_CD3_CD8pos, "density", facet.by = "study_group")
```


Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(density ~ study_group, data = MPIF27_dens_CD3_CD8pos)
```

Wilcoxon paiwise test 

The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.

```{r}
pairwise.t.test(MPIF27_dens_CD3_CD8pos$density, MPIF27_dens_CD3_CD8pos$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
my_comparisons <- list( c("PPBCinv", "nonPrBC"), c("PPBCinv", "PrBC"), c("PPBCinv", "PPBClac") )
density_CD3_CD8pos <- ggboxplot(MPIF27_dens_CD3_CD8pos, x="study_group", y="density",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "density_CD3_CD8pos at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 10, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 3600)
density_CD3_CD8pos
```

```{r, fig.width=7, fig.height=4.5}
density_CD3_CD8pos <- ggboxplot(MPIF27_dens_CD3_CD8pos, x="study_group", y="density",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "density_CD3_CD8pos at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 20, aes(colour = study_group)) + stat_compare_means(method = , comparisons = my_comparisons) + stat_compare_means(label.y = 1500) + ylim(0,1000)
density_CD3_CD8pos
```

```{r}
pdf(file="density_CD3_CD8pos.pdf", width = 7, height=4.5)
density_CD3_CD8pos
dev.off()
```



#### CD3+CD8-

```{r}
group_by(MPIF27_dens_CD3_CD8neg, study_group) %>%
  summarise(
    count = n(),
    mean = mean(density, na.rm = TRUE),
    sd = sd(density, na.rm = TRUE)
  )
```


Remove NA values
```{r}
MPIF27_dens_CD3_CD8neg <- MPIF27_dens_CD3_CD8neg[!is.na(MPIF27_dens_CD3_CD8neg$density),]

group_by(MPIF27_dens_CD3_CD8neg, study_group) %>%
  summarise(
    count = n(),
    mean = mean(density, na.rm = TRUE),
    sd = sd(density, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
MPIF27_dens_CD3_CD8neg$study_group <- gsub("non_prbc", "nonPrBC", MPIF27_dens_CD3_CD8neg$study_group)
MPIF27_dens_CD3_CD8neg$study_group <- gsub("ppbc_inv", "PPBCinv", MPIF27_dens_CD3_CD8neg$study_group)
MPIF27_dens_CD3_CD8neg$study_group <- gsub("ppbc_lac", "PPBClac", MPIF27_dens_CD3_CD8neg$study_group)
MPIF27_dens_CD3_CD8neg$study_group <- gsub("prbc", "PrBC", MPIF27_dens_CD3_CD8neg$study_group)

MPIF27_dens_CD3_CD8neg$study_group <- ordered(MPIF27_dens_CD3_CD8neg$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(MPIF27_dens_CD3_CD8neg$study_group))
```


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.density_CD3_CD8neg <- aov(density ~ study_group, data = MPIF27_dens_CD3_CD8neg)
# summary of the analysis
summary(res.aov.density_CD3_CD8neg)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.density_CD3_CD8neg)
```

```{r}
pwc_density_CD3_CD8neg <- MPIF27_dens_CD3_CD8neg %>% tukey_hsd(density ~ study_group)
pwc_density_CD3_CD8neg
```


Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(density ~ study_group, data = MPIF27_dens_CD3_CD8neg)
```

Wilcoxon paiwise test 

The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.

```{r}
pairwise.t.test(MPIF27_dens_CD3_CD8neg$density, MPIF27_dens_CD3_CD8neg$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
density_CD3_CD8neg <- ggboxplot(MPIF27_dens_CD3_CD8neg, x="study_group", y="density",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PrBC", "nonPrBC"),
          ylab = "density_CD3_CD8neg at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 10, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 1600) # + stat_pvalue_manual(pwc_density_CD3_CD8neg, hide.ns = TRUE)
density_CD3_CD8neg
```

```{r}
pdf(file="density_CD3_CD8neg.pdf", width = 7, height=4.5)
density_CD3_CD8neg
dev.off()
```



#### CD3+ FoxP3-

MPIF26_dens_CD3_Foxp3neg

```{r}
group_by(MPIF26_dens_CD3_Foxp3neg, study_group) %>%
  summarise(
    count = n(),
    mean = mean(density, na.rm = TRUE),
    sd = sd(density, na.rm = TRUE)
  )
```


Remove NA values
```{r}
MPIF26_dens_CD3_Foxp3neg <- MPIF26_dens_CD3_Foxp3neg[!is.na(MPIF26_dens_CD3_Foxp3neg$density),]

group_by(MPIF26_dens_CD3_Foxp3neg, study_group) %>%
  summarise(
    count = n(),
    mean = mean(density, na.rm = TRUE),
    sd = sd(density, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
MPIF26_dens_CD3_Foxp3neg$study_group <- gsub("non_prbc", "nonPrBC", MPIF26_dens_CD3_Foxp3neg$study_group)
MPIF26_dens_CD3_Foxp3neg$study_group <- gsub("ppbc_inv", "PPBCinv", MPIF26_dens_CD3_Foxp3neg$study_group)
MPIF26_dens_CD3_Foxp3neg$study_group <- gsub("ppbc_lac", "PPBClac", MPIF26_dens_CD3_Foxp3neg$study_group)
MPIF26_dens_CD3_Foxp3neg$study_group <- gsub("prbc", "PrBC", MPIF26_dens_CD3_Foxp3neg$study_group)

MPIF26_dens_CD3_Foxp3neg$study_group <- ordered(MPIF26_dens_CD3_Foxp3neg$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(MPIF26_dens_CD3_Foxp3neg$study_group))
```


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.density_CD3_Foxp3neg <- aov(density ~ study_group, data = MPIF26_dens_CD3_Foxp3neg)
# summary of the analysis
summary(res.aov.density_CD3_Foxp3neg)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.density_CD3_Foxp3neg)
```

```{r}
pwc_density_CD3_Foxp3neg <- MPIF26_dens_CD3_Foxp3neg %>% tukey_hsd(density ~ study_group)
pwc_density_CD3_Foxp3neg
```

Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(density ~ study_group, data = MPIF26_dens_CD3_Foxp3neg)
```

Wilcoxon paiwise test 

The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.

```{r}
pairwise.t.test(MPIF26_dens_CD3_Foxp3neg$density, MPIF26_dens_CD3_Foxp3neg$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
density_CD3_Foxp3neg_MPIF26 <- ggboxplot(MPIF26_dens_CD3_Foxp3neg, x="study_group", y="density",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "density_CD3_Foxp3neg at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 10, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 2500)#+ stat_pvalue_manual(pwc_density_CD3_Foxp3neg, hide.ns = TRUE, y.position = c(1500))
density_CD3_Foxp3neg_MPIF26
```

```{r}
pdf(file="density_CD3_Foxp3neg_MPIF26.pdf", width = 7, height=4.5)
density_CD3_Foxp3neg_MPIF26
dev.off()
```



#### FoxP3+

```{r}
group_by(MPIF26_dens_Foxp3, study_group) %>%
  summarise(
    count = n(),
    mean = mean(density, na.rm = TRUE),
    sd = sd(density, na.rm = TRUE)
  )
```


Remove NA values
```{r}
MPIF26_dens_Foxp3 <- MPIF26_dens_Foxp3[!is.na(MPIF26_dens_Foxp3$density),]

group_by(MPIF26_dens_Foxp3, study_group) %>%
  summarise(
    count = n(),
    mean = mean(density, na.rm = TRUE),
    sd = sd(density, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
MPIF26_dens_Foxp3$study_group <- gsub("non_prbc", "nonPrBC", MPIF26_dens_Foxp3$study_group)
MPIF26_dens_Foxp3$study_group <- gsub("ppbc_inv", "PPBCinv", MPIF26_dens_Foxp3$study_group)
MPIF26_dens_Foxp3$study_group <- gsub("ppbc_lac", "PPBClac", MPIF26_dens_Foxp3$study_group)
MPIF26_dens_Foxp3$study_group <- gsub("prbc", "PrBC", MPIF26_dens_Foxp3$study_group)

MPIF26_dens_Foxp3$study_group <- ordered(MPIF26_dens_Foxp3$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(MPIF26_dens_Foxp3$study_group))
```

Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.density_Foxp3 <- aov(density ~ study_group, data = MPIF26_dens_Foxp3)
# summary of the analysis
summary(res.aov.density_Foxp3)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.density_Foxp3)
```

```{r}
pwc_density_Foxp3 <- MPIF26_dens_Foxp3 %>% tukey_hsd(density ~ study_group)
pwc_density_Foxp3
```


Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(density ~ study_group, data = MPIF26_dens_Foxp3)
```

Wilcoxon paiwise test 

The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.

```{r}
pairwise.t.test(MPIF26_dens_Foxp3$density, MPIF26_dens_Foxp3$study_group,
                 p.adjust.method = "BH")
```

Visualization

```{r, fig.width=7, fig.height=4.5}
density_Foxp3_MPIF26 <- ggboxplot(MPIF26_dens_Foxp3, x="study_group", y="density",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "density_Foxp3 at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 1, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 350)#+ stat_pvalue_manual(pwc_density_Foxp3, hide.ns = TRUE, y.position = c(1500))
density_Foxp3_MPIF26
```

```{r}
pdf(file="density_Foxp3_MPIF26.pdf", width = 7, height=4.5)
density_Foxp3_MPIF26
dev.off()
```


# Kaplan-meiers

##total

###CD20


```{r}
CD20_density_OS_combo <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + Density_Total, data = Combo_dens_CD20), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - MPIF26 - CD20 by study group",
    palette = c("#521262", "#AA96DA", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")
CD20_density_OS_combo

CD20_density_DRS_combo <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + Density_Total, data = Combo_dens_CD20), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - MPIF26 - CD20 by study group",
    palette = c("#521262", "#AA96DA", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")
CD20_density_DRS_combo
```

```{r}
pdf(file="CD20_density_OS_combo.pdf", width = 7, height=5)
CD20_density_OS_combo
dev.off()

pdf(file="CD20_density_DRS_combo.pdf", width = 7, height=5)
CD20_density_DRS_combo
dev.off()
```


```{r}
Combo_dens_CD20_withoutprbc <- subset(Combo_dens_CD20, group %in% c("nonprbc", "inv"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + Density_Total, data = Combo_dens_CD20_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD20 by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + Density_Total, data = Combo_dens_CD20_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD20 by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")
```

```{r}
CD20_density_OS_combo <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + Density_Total, data = Combo_dens_CD20), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - MPIF26 - CD20 by study group",
    #palette = c("#521262", "#AA96DA", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "group")
CD20_density_OS_combo

CD20_density_DRS_combo <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + Density_Total, data = Combo_dens_CD20), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - MPIF26 - CD20 by study group",
    #palette = c("#521262", "#AA96DA", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "group")
CD20_density_DRS_combo
```


##MPIF26

###CD20
```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + Density_Total, data = MPIF26_dens_CD20), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - MPIF26 - CD20 by study group",
    palette = c("#521262", "#AA96DA", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + Density_Total, data = MPIF26_dens_CD20), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - MPIF26 - CD20 by study group",
    palette = c("#521262", "#AA96DA", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")
```


```{r}
MPIF26_dens_CD20_withoutprbc <- subset(MPIF26_dens_CD20, group %in% c("nonprbc", "inv"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + Density_Total, data = MPIF26_dens_CD20_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - MPIF26 - CD20 by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + Density_Total, data = MPIF26_dens_CD20_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - MPIF26 - CD20 by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")
```

###CD3+FoxP3-
```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + Density_Total, data = MPIF26_dens_CD3_Foxp3neg), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - MPIF26 - CD3+FoxP3- by study group",
    palette = c("#521262", "#AA96DA", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")

#ggsurvplot(
 #   fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + Density_Total, data = MPIF26_dens_CD3_Foxp3neg), 
  #  xlab = "Months", 
   # ylab = "Overall survival probability",
    #title = "DRS - MPIF26 - CD3+FoxP3- by study group",
    #palette = c("#521262", "#AA96DA", "#46CDCF"),
    #ggtheme = theme_bw(),
    #pval = T, facet.by = "Density_Total")
```

```{r}
MPIF26_dens_CD3_Foxp3neg_withoutprbc <- subset(MPIF26_dens_CD3_Foxp3neg, group %in% c("nonprbc", "inv"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + Density_Total, data = MPIF26_dens_CD3_Foxp3neg_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - MPIF26 - CD3_Foxp3neg by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + Density_Total, data = MPIF26_dens_CD3_Foxp3neg_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - MPIF26 - CD3_Foxp3neg by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")
```


###FoxP3+
```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + Density_Total, data = MPIF26_dens_Foxp3), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - MPIF26 - FoxP3 by study group",
    palette = c("#521262", "#AA96DA", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + Density_Total, data = MPIF26_dens_Foxp3), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - MPIF26 - FoxP3 by study group",
    palette = c("#521262", "#AA96DA", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")
```


```{r}
MPIF26_dens_Foxp3_withoutprbc <- subset(MPIF26_dens_Foxp3, group %in% c("nonprbc", "inv"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + Density_Total, data = MPIF26_dens_Foxp3_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - MPIF26 - Foxp3 by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + Density_Total, data = MPIF26_dens_Foxp3_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - MPIF26 - Foxp3 by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")
```


##MPIF27

###CD20
```{r}
OS_spatial_CD20 <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + Density_Total, data = MPIF27_dens_CD20), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - MPIF27 - CD20 by study group",
    palette = c("#521262", "#AA96DA", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")
OS_spatial_CD20

DRS_spatial_CD20 <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + Density_Total, data = MPIF27_dens_CD20), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - MPIF27 - CD20 by study group",
    palette = c("#521262", "#AA96DA", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")
DRS_spatial_CD20
```

```{r}
pdf(file="OS_spatial_CD20.pdf", width = 7, height=5)
OS_spatial_CD20
dev.off()
```

```{r}
MPIF27_dens_CD20_withoutprbc <- subset(MPIF27_dens_CD20, group %in% c("nonprbc", "inv"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + Density_Total, data = MPIF27_dens_CD20_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - MPIF27 - CD20 by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + Density_Total, data = MPIF27_dens_CD20_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - MPIF27 - CD20 by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")
```


###CD3+CD8-
```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + Density_Total, data = MPIF27_dens_CD3_CD8neg), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - MPIF27 - CD3+CD8- by study group",
    palette = c("#521262", "#AA96DA", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + Density_Total, data = MPIF27_dens_CD3_CD8neg), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - MPIF27 - CD3+CD8- by study group",
    palette = c("#521262", "#AA96DA", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")
```

```{r}
MPIF27_dens_CD3_CD8neg_withoutprbc <- subset(MPIF27_dens_CD3_CD8neg, group %in% c("nonprbc", "inv"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + Density_Total, data = MPIF27_dens_CD3_CD8neg_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - MPIF27 - CD3_CD8neg by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + Density_Total, data = MPIF27_dens_CD3_CD8neg_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - MPIF27 - CD3_CD8neg by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")
```



###CD3+CD8+
```{r}
CD8_OS_spatial <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + Density_Total, data = MPIF27_dens_CD3_CD8pos), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - MPIF27 - CD3+CD8+ by study group",
    palette = c("#521262", "#AA96DA", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")
CD8_OS_spatial

CD8_DRS_spatial <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + Density_Total, data = MPIF27_dens_CD3_CD8pos), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - MPIF27 - CD3+CD8+ by study group",
    palette = c("#521262", "#AA96DA", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")
CD8_DRS_spatial
```


```{r}
pdf(file="CD8_OS_spatial.pdf", width = 7, height=5)
CD8_OS_spatial
dev.off()

pdf(file="CD8_DRS_spatial.pdf", width = 7, height=5)
CD8_DRS_spatial
dev.off()
```

```{r}
MPIF27_dens_CD3_CD8pos_withoutprbc <- subset(MPIF27_dens_CD3_CD8pos, group %in% c("nonprbc", "inv"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + Density_Total, data = MPIF27_dens_CD3_CD8pos_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - MPIF27 - CD3_CD8pos by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + Density_Total, data = MPIF27_dens_CD3_CD8pos_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - MPIF27 - CD3_CD8pos by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Density_Total")
```


#### within study groups OS

subset data low IG signature versus high IG signature 

```{r}
MPIF27_dens_CD3_CD8pos_low <- subset(MPIF27_dens_CD3_CD8pos, Density_Total %in% c("low"), )
MPIF27_dens_CD3_CD8pos_high <- subset(MPIF27_dens_CD3_CD8pos, Density_Total %in% c("high"), )
```


Testing proportional hazards assumption -> zie file Kat: stratify for PAM50


```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + group + clin_subtype,
  data = MPIF27_dens_CD3_CD8pos_low) %>%
  cox.zph()

coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + group + clin_subtype,
  data = MPIF27_dens_CD3_CD8pos_high) %>%
  cox.zph()
```


low CD8 cluster 

univariate 

```{r}
#univariate
cox_OS_CD8low <- coxph(Surv(time_OS_months, death) ~ group, data = MPIF27_dens_CD3_CD8pos_low)
summary(cox_OS_CD8low)
```


multivariate 

```{r}
MPIF27_dens_CD3_CD8pos_low$group <- ordered(MPIF27_dens_CD3_CD8pos_low$group,
                                levels = c("inv", "prbc", "nonprbc"))
```


```{r}
table(MPIF27_dens_CD3_CD8pos_low$group)
```



```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    group +
    strata(clin_subtype),
  data = MPIF27_dens_CD3_CD8pos_low)
summary(clin.cov.cox)
```



```{r}
#with study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~  stage + clin_subtype + group, data = MPIF27_dens_CD3_CD8pos_low)
study_strata
plot_OS_CD8low_multivariate <- ggadjustedcurves(study_strata, data=MPIF27_dens_CD3_CD8pos_low, method="conditional", variable="group", palette = c("#46CDCF", "#521262", "#AA96DA"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_OS_CD8low_multivariate
```

```{r}
pdf(here("plot_OS_CD8low_multivariate.pdf"), width = 7, height = 5)
plot_OS_CD8low_multivariate
dev.off()
```

High CD8 cluster 

univariate 

```{r}
#univariate
cox_OS_CD8high <- coxph(Surv(time_OS_months, death) ~ group, data = MPIF27_dens_CD3_CD8pos_high)
summary(cox_OS_CD8high)
```

multivariate

```{r}
MPIF27_dens_CD3_CD8pos_high$group <- ordered(MPIF27_dens_CD3_CD8pos_high$group,
                                levels = c("inv", "prbc", "nonprbc"))
```


```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    group +
    strata(clin_subtype),
  data = MPIF27_dens_CD3_CD8pos_high)
summary(clin.cov.cox)
```

```{r}
#with study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + clin_subtype + group, data = MPIF27_dens_CD3_CD8pos_high)
study_strata
plot_OS_CD8high_multivariate <- ggadjustedcurves(study_strata, data=MPIF27_dens_CD3_CD8pos_high, method="conditional", variable="group", palette = c("#46CDCF", "#521262", "#AA96DA"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_OS_CD8high_multivariate
```

#### within study groups DRS


```{r}
coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage + group + clin_subtype,
  data = MPIF27_dens_CD3_CD8pos_low) %>%
  cox.zph()

coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage + group + clin_subtype,
  data = MPIF27_dens_CD3_CD8pos_high) %>%
  cox.zph()
```


low CD8 cluster 

univariate 

```{r}
#univariate
cox_DRS_CD8low <- coxph(Surv(time_DRS_months, distant_recurrence) ~ group, data = MPIF27_dens_CD3_CD8pos_low)
summary(cox_DRS_CD8low)
```


multivariate 

```{r}
MPIF27_dens_CD3_CD8pos_low$group <- ordered(MPIF27_dens_CD3_CD8pos_low$group,
                                levels = c("inv", "prbc", "nonprbc"))
```


```{r}
table(MPIF27_dens_CD3_CD8pos_low$group)
```



```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    group +
    strata(clin_subtype),
  data = MPIF27_dens_CD3_CD8pos_low)
summary(clin.cov.cox)
```



```{r}
#with study group as covariate 
study_strata <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~  stage + clin_subtype + group, data = MPIF27_dens_CD3_CD8pos_low)
study_strata
plot_DRS_CD8low_multivariate <- ggadjustedcurves(study_strata, data=MPIF27_dens_CD3_CD8pos_low, method="conditional", variable="group", palette = c("#46CDCF", "#521262", "#AA96DA"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_DRS_CD8low_multivariate
```

```{r}
pdf(here("plot_DRS_CD8low_multivariate.pdf"), width = 7, height = 5)
plot_DRS_CD8low_multivariate
dev.off()
```

High CD8 cluster 

univariate 

```{r}
#univariate
cox_DRS_CD8high <- coxph(Surv(time_DRS_months, distant_recurrence) ~ group, data = MPIF27_dens_CD3_CD8pos_high)
summary(cox_DRS_CD8high)
```

multivariate

```{r}
MPIF27_dens_CD3_CD8pos_high$group <- ordered(MPIF27_dens_CD3_CD8pos_high$group,
                                levels = c("inv", "prbc", "nonprbc"))
```


```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    group +
    strata(clin_subtype),
  data = MPIF27_dens_CD3_CD8pos_high)
summary(clin.cov.cox)
```

```{r}
#with study group as covariate 
study_strata <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage + clin_subtype + group, data = MPIF27_dens_CD3_CD8pos_high)
study_strata
plot_DRS_CD8high_multivariate <- ggadjustedcurves(study_strata, data=MPIF27_dens_CD3_CD8pos_high, method="conditional", variable="group", palette = c("#46CDCF", "#521262", "#AA96DA"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_DRS_CD8high_multivariate
```








## Session info

```{r}
sessionInfo()
```

