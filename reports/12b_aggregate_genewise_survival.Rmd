---
title: "Aggregation genewise survival"
author: "Kat Moore"
date: "`r Sys.Date()`"
output: 
   html_document:
    toc: yes
    toc_float: yes
    toc_depth: 4
    highlight: tango
    df_print: paged
---

Create an overlap file of miscellaneous genewise survival analyses.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=F}
library(UpSetR)
library(RColorBrewer)
library(openxlsx)
library(here)
library(pheatmap)
library(tidyverse)

theme_set(theme_bw())
```

# Aggregate results

Load all data frames related to genewise survival

```{r}
#res_list <- purrr::map(list.files(here("data", "Rds"),
#                                  pattern="genewise", full.names = T), readRDS)

res_list <- purrr::map(list.files(here("results", "survival"),
                                  pattern="genewise", full.names = T), read_csv)

#names(res_list) = str_remove(str_remove(list.files(here("data", "Rds"), pattern="genewise"), "12_"), ".Rds")

names(res_list) = str_remove(str_remove(list.files(here("results", "survival"), pattern="genewise"), "12_"), ".csv")
```

Example input

```{r}
head(res_list$multi_genewise_os)
```

The number of rows should be the same everywhere.

```{r}
stopifnot(all(unlist(lapply(res_list, function(x) nrow(x)==nrow(res_list$multi_genewise_os)))))
```

Aggregate Excel sheet.

```{r}
openxlsx::write.xlsx(list(univ_cox_surv = res_list$uni_genewise_os,
                          univ_cox_dr = res_list$uni_genewise_drs,
                          multi_cox_surv = res_list$multi_genewise_os,
                          multi_cox_dr = res_list$multi_genewise_drs,
                          inv_only_univ_surv = res_list$inv_uni_genewise_os,
                          inv_only_univ_dr = res_list$inv_uni_genewise_drs,
                          inv_only_multi_surv = res_list$inv_multi_genewise_os,
                          inv_only_multi_dr = res_list$multi_genewise_drs
                          ),
                     file = here("results", "survival", "12_cox_allgenes.xlsx"))
```

Unified df:

```{r}
res = bind_rows(res_list,) %>%
  arrange(fdr, p.value) %>%
  select(gene_name, analysis, everything())

head(res)
```

# Global overview

What global significance level should we choose?
There are generally more hits in univariate than multivariate models (not strange).
Interestingly, there are more hits with drs models than os models.
Models run on involution samples only have hardly any hits, probably due to insufficient sample size.

```{r}
pt = list()
for (i in seq(0.05, 0.3, by = 0.05)){
  td = enframe(unlist(lapply(res_list, function(x) nrow(dplyr::filter(x, fdr <= i)))))
  td = td[, "value", drop=F]
  colnames(td)[1] = as.character(i)
  pt[[length(pt)+1]] = td
}

pt = pt %>% bind_cols()
pt = t(as.matrix(pt))
colnames(pt) = str_remove(names(res_list), "genewise_")
pt
```

Overview analysis type

```{r}
ann_df = data.frame(row.names = colnames(pt),
                    input = if_else(str_detect(colnames(pt), "inv"), "involution samples", "all samples"),
                    formula = if_else(str_detect(colnames(pt), "multi"), "multivariate", "univariate"),
                    event = if_else(str_detect(colnames(pt), "os"), "overall survival", "distant recurrence")
)

ann_df
```

```{r}
quantile_breaks <- function(xs, n = 10) {
  breaks <- quantile(xs, probs = seq(0, 1, length.out = n))
  breaks[!duplicated(breaks)]
}

mat_breaks <- quantile_breaks(pt, n = 11)

pheatmap(pt, annotation_col = ann_df,
         main = "Significant hits at various fdr cutoffs",
         cluster_rows = F, cluster_cols = F,
         breaks =  mat_breaks,
         color = colorRampPalette(rev(brewer.pal(n = 8,
                                                 name = "RdYlBu")))(length(mat_breaks) - 1),
         display_numbers = T, number_format = "%0.f")
```

# Upset plots

Show overlap between hits at fdr cutoffs 0.1, 0.15 and 0.2.

```{r, fig.width=8}
for(i in seq(0.1, 0.2, by = 0.05)){
 sig_genes = lapply(res_list, function(x) x[x$fdr <= i,]$ensembl_gene_id)
 names(sig_genes) = str_remove(names(sig_genes), "genewise_")

 print(upset(fromList(sig_genes), order.by = "freq", 
       #empty.intersections = "on",
       #nsets = length(sig_genes), 
       set_size.show = TRUE,
       mainbar.y.label = paste("Cox FDR cutoff", i),
       sets.bar.color = "blue", 
       main.bar.color = "black", 
       set_size.scale_max = 1200,
       sets.x.label = "Sig genes one vs rest comparisons") )
}


```

```{r}
sessionInfo()
```

