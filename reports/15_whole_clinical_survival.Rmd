---
title: "Loading in Clinicopathological data"
author: Hanne LeFrere and Kat Moore
output:
  html_notebook:
    toc: yes
    toc_float: yes

---

```{r, echo=F}
#install.packages("tidyverse")
library(tidyverse)
library(readxl)
#if (!requireNamespace("BiocManager", quietly = TRUE))
   # install.packages("BiocManager")
#BiocManager::install("tximport")
#library(tximport) #Why is this here?
library(survival)
library(survminer)

#install.packages("here")
library(here)

```

# Process metadata

## Importing the data

```{r}

CP_Data <- read_excel(here("data","metadata","20191001_UZ+INCIP+OMEGA_PPBC 2Y + Codering.xlsx"), sheet = "NEW_PPBC 2Y_02-10-2019")

```

```{r}
colnames(CP_Data)
```

## Data structure

```{r}
#str(CP_Data)

is.na(CP_Data$patient_ref) %>% table()
```


## Finding and deleting the missing patient_ref values

We want to delete the rows with patient_ref = NA, as these patients have to be exluded from the analyses, because:
  - incomplete information 
  - too old or too young at diagnosis
  - not enough FU available 
  - positive family history 
  
```{r}
which(is.na(CP_Data$patient_ref))
```

Deleting patients with missing values in the patient_ref column

```{r}
#CP_Data$patient_ref %>% summary()
CP_Data_Filtered <- CP_Data %>% filter(!is.na(patient_ref))

#
#str(CP_Data_Filtered)

stopifnot(sum(is.na(CP_Data_Filtered$patient_ref)) == 0)
#length(which(complete.cases(CP_Data_Filtered$patient_ref)==FALSE))
#length(which(complete.cases(CP_Data_Filtered$patient_ref)==TRUE))
```


## Replace all missing values with NA

Missing values are represented by 999 in excel and SPSS. In R these need to be replaced with NA!

### Replace 999 with NA

```{r}
sum(is.na(CP_Data))
CP_Data_Filtered[sapply(CP_Data_Filtered, function(x) as.character(x) == "999")] <- NA
sum(is.na(CP_Data_Filtered))

#length(which(complete.cases(CP_Data_Filtered$patient_ref)==FALSE))
#length(which(complete.cases(CP_Data_Filtered$patient_ref)==TRUE))

#which(complete.cases(CP_Data_Filtered$patient_ref)==FALSE)
#warnings()
#class(CP_Data_Filtered)
```




### Rename case 999 again - as now it has been given NA as name


```{r}
CP_Data_Filtered$patient_ref[is.na(CP_Data_Filtered$patient_ref)] <- 999
```

## Data structure

```{r}
length(which(complete.cases(CP_Data_Filtered$patient_ref)==FALSE))
length(which(complete.cases(CP_Data_Filtered$patient_ref)==TRUE))

which(is.na(CP_Data_Filtered$patient_ref))
```


```{r}
str(CP_Data_Filtered$stage_long)

```


## Recoding into different variables 

### Grade

Structure of grade 

```{r}

length(which(complete.cases(CP_Data_Filtered$grade)==FALSE))
length(which(complete.cases(CP_Data_Filtered$grade)==TRUE))

which(is.na(CP_Data_Filtered$grade))

```


Split the grade column into 3 seperate columns being grade I, Grade II and Grade III


```{r}
CP_Data_Filtered$grade_I <- NA
CP_Data_Filtered$grade_I[CP_Data_Filtered$grade=="grade I"] <- 1
CP_Data_Filtered$grade_I[CP_Data_Filtered$grade=="grade II"] <- 0
CP_Data_Filtered$grade_I[CP_Data_Filtered$grade=="grade III"] <- 0


CP_Data_Filtered$grade_II <- NA
CP_Data_Filtered$grade_II[CP_Data_Filtered$grade=="grade I"] <- 0
CP_Data_Filtered$grade_II[CP_Data_Filtered$grade=="grade II"] <- 1
CP_Data_Filtered$grade_II[CP_Data_Filtered$grade=="grade III"] <- 0


CP_Data_Filtered$grade_III <- NA
CP_Data_Filtered$grade_III[CP_Data_Filtered$grade=="grade I"] <- 0
CP_Data_Filtered$grade_III[CP_Data_Filtered$grade=="grade II"] <- 0
CP_Data_Filtered$grade_III[CP_Data_Filtered$grade=="grade III"] <- 1




length(which(complete.cases(CP_Data_Filtered$grade_I)==FALSE))
length(which(complete.cases(CP_Data_Filtered$grade_I)==TRUE))
which(is.na(CP_Data_Filtered$grade_I))

length(which(complete.cases(CP_Data_Filtered$grade_II)==FALSE))
length(which(complete.cases(CP_Data_Filtered$grade_II)==TRUE))
which(is.na(CP_Data_Filtered$grade_II))

length(which(complete.cases(CP_Data_Filtered$grade_III)==FALSE))
length(which(complete.cases(CP_Data_Filtered$grade_III)==TRUE))
which(is.na(CP_Data_Filtered$grade_III))

```


### Stage

Structure of stage 

```{r}

length(which(complete.cases(CP_Data_Filtered$stage_short)==FALSE))
length(which(complete.cases(CP_Data_Filtered$stage_short)==TRUE))

which(is.na(CP_Data_Filtered$stage_short))

```


Split the grade column into 3 seperate columns being grade I, Grade II and Grade III


```{r}
CP_Data_Filtered$stage_I <- NA
CP_Data_Filtered$stage_I[CP_Data_Filtered$stage_short=="stage I"] <- 1
CP_Data_Filtered$stage_I[CP_Data_Filtered$stage_short=="stage II"] <- 0
CP_Data_Filtered$stage_I[CP_Data_Filtered$stage_short=="stage III"] <- 0
CP_Data_Filtered$stage_I[CP_Data_Filtered$stage_short=="stage IV"] <- 0

CP_Data_Filtered$stage_II <- NA
CP_Data_Filtered$stage_II[CP_Data_Filtered$stage_short=="stage I"] <- 0
CP_Data_Filtered$stage_II[CP_Data_Filtered$stage_short=="stage II"] <- 1
CP_Data_Filtered$stage_II[CP_Data_Filtered$stage_short=="stage III"] <- 0
CP_Data_Filtered$stage_II[CP_Data_Filtered$stage_short=="stage IV"] <- 0


CP_Data_Filtered$stage_III <- NA
CP_Data_Filtered$stage_III[CP_Data_Filtered$stage_short=="stage I"] <- 0
CP_Data_Filtered$stage_III[CP_Data_Filtered$stage_short=="stage II"] <- 0
CP_Data_Filtered$stage_III[CP_Data_Filtered$stage_short=="stage III"] <- 1
CP_Data_Filtered$stage_III[CP_Data_Filtered$stage_short=="stage IV"] <- 0

CP_Data_Filtered$stage_IV <- NA
CP_Data_Filtered$stage_IV[CP_Data_Filtered$stage_short=="stage I"] <- 0
CP_Data_Filtered$stage_IV[CP_Data_Filtered$stage_short=="stage II"] <- 0
CP_Data_Filtered$stage_IV[CP_Data_Filtered$stage_short=="stage III"] <- 0
CP_Data_Filtered$stage_IV[CP_Data_Filtered$stage_short=="stage IV"] <- 1




length(which(complete.cases(CP_Data_Filtered$stage_I)==FALSE))
length(which(complete.cases(CP_Data_Filtered$stage_I)==TRUE))
which(is.na(CP_Data_Filtered$stage_I))

length(which(complete.cases(CP_Data_Filtered$stage_II)==FALSE))
length(which(complete.cases(CP_Data_Filtered$stage_II)==TRUE))
which(is.na(CP_Data_Filtered$stage_II))

length(which(complete.cases(CP_Data_Filtered$stage_III)==FALSE))
length(which(complete.cases(CP_Data_Filtered$stage_III)==TRUE))
which(is.na(CP_Data_Filtered$stage_III))

length(which(complete.cases(CP_Data_Filtered$stage_IV)==FALSE))
length(which(complete.cases(CP_Data_Filtered$stage_IV)==TRUE))
which(is.na(CP_Data_Filtered$stage_IV))

```

### Tumour Size v1

Structure of tumour size v1 

```{r}

length(which(complete.cases(CP_Data_Filtered$tumor_size_v1)==FALSE))
length(which(complete.cases(CP_Data_Filtered$tumor_size_v1)==TRUE))

which(is.na(CP_Data_Filtered$tumor_size_v1))

```


Split the tumour size column into 3 seperate columns being 1mm - ≤20mm ; >20mm - ≤50mm ; ≥50mm


```{r}
CP_Data_Filtered$TSa1 <- NA
CP_Data_Filtered$TSa1[CP_Data_Filtered$tumor_size_v1=="1mm - ≤20mm"] <- 1
CP_Data_Filtered$TSa1[CP_Data_Filtered$tumor_size_v1==">20mm - ≤50mm"] <- 0
CP_Data_Filtered$TSa1[CP_Data_Filtered$tumor_size_v1=="≥50mm"] <- 0

CP_Data_Filtered$TSa2 <- NA
CP_Data_Filtered$TSa2[CP_Data_Filtered$tumor_size_v1=="1mm - ≤20mm"] <- 0
CP_Data_Filtered$TSa2[CP_Data_Filtered$tumor_size_v1==">20mm - ≤50mm"] <- 1
CP_Data_Filtered$TSa2[CP_Data_Filtered$tumor_size_v1=="≥50mm"] <- 0


CP_Data_Filtered$TSa3 <- NA
CP_Data_Filtered$TSa3[CP_Data_Filtered$tumor_size_v1=="1mm - ≤20mm"] <- 0
CP_Data_Filtered$TSa3[CP_Data_Filtered$tumor_size_v1==">20mm - ≤50mm"] <- 0
CP_Data_Filtered$TSa3[CP_Data_Filtered$tumor_size_v1=="≥50mm"] <- 1



length(which(complete.cases(CP_Data_Filtered$TSa1)==FALSE))
length(which(complete.cases(CP_Data_Filtered$TSa1)==TRUE))
which(is.na(CP_Data_Filtered$TSa1))

length(which(complete.cases(CP_Data_Filtered$TSa2)==FALSE))
length(which(complete.cases(CP_Data_Filtered$TSa2)==TRUE))
which(is.na(CP_Data_Filtered$TSa2))

length(which(complete.cases(CP_Data_Filtered$TSa3)==FALSE))
length(which(complete.cases(CP_Data_Filtered$TSa3)==TRUE))
which(is.na(CP_Data_Filtered$TSa3))

```


### Tumour Size v1

Structure of tumour size v2

```{r}

length(which(complete.cases(CP_Data_Filtered$tumor_size_v2)==FALSE))
length(which(complete.cases(CP_Data_Filtered$tumor_size_v2)==TRUE))

which(is.na(CP_Data_Filtered$tumor_size_v2))

```


Split the tumour size column into 6 seperate columns being ≥1mm - ≤5mm ; >5mm - ≤10mm ; >10mm - ≤20mm ; >20mm - ≤50mm ; >50mm ; any size + extension to chest wall/skin


```{r}
CP_Data_Filtered$TSb1 <- NA
CP_Data_Filtered$TSb1[CP_Data_Filtered$tumor_size_v2=="≥1mm - ≤5mm"] <- 1
CP_Data_Filtered$TSb1[CP_Data_Filtered$tumor_size_v2==">5mm - ≤10mm"] <- 0
CP_Data_Filtered$TSb1[CP_Data_Filtered$tumor_size_v2==">10mm - ≤20mm"] <- 0
CP_Data_Filtered$TSb1[CP_Data_Filtered$tumor_size_v2==">20mm - ≤50mm"] <- 0
CP_Data_Filtered$TSb1[CP_Data_Filtered$tumor_size_v2==">50mm"] <- 0
CP_Data_Filtered$TSb1[CP_Data_Filtered$tumor_size_v2=="any size + extension to chest wall/skin"] <- 0

CP_Data_Filtered$TSb2 <- NA
CP_Data_Filtered$TSb2[CP_Data_Filtered$tumor_size_v2=="≥1mm - ≤5mm"] <- 0
CP_Data_Filtered$TSb2[CP_Data_Filtered$tumor_size_v2==">5mm - ≤10mm"] <- 1
CP_Data_Filtered$TSb2[CP_Data_Filtered$tumor_size_v2==">10mm - ≤20mm"] <- 0
CP_Data_Filtered$TSb2[CP_Data_Filtered$tumor_size_v2==">20mm - ≤50mm"] <- 0
CP_Data_Filtered$TSb2[CP_Data_Filtered$tumor_size_v2==">50mm"] <- 0
CP_Data_Filtered$TSb2[CP_Data_Filtered$tumor_size_v2=="any size + extension to chest wall/skin"] <- 0


CP_Data_Filtered$TSb3 <- NA
CP_Data_Filtered$TSb3[CP_Data_Filtered$tumor_size_v2=="≥1mm - ≤5mm"] <- 0
CP_Data_Filtered$TSb3[CP_Data_Filtered$tumor_size_v2==">5mm - ≤10mm"] <- 0
CP_Data_Filtered$TSb3[CP_Data_Filtered$tumor_size_v2==">10mm - ≤20mm"] <- 1
CP_Data_Filtered$TSb3[CP_Data_Filtered$tumor_size_v2==">20mm - ≤50mm"] <- 0
CP_Data_Filtered$TSb3[CP_Data_Filtered$tumor_size_v2==">50mm"] <- 0
CP_Data_Filtered$TSb3[CP_Data_Filtered$tumor_size_v2=="any size + extension to chest wall/skin"] <- 0

CP_Data_Filtered$TSb4 <- NA
CP_Data_Filtered$TSb4[CP_Data_Filtered$tumor_size_v2=="≥1mm - ≤5mm"] <- 0
CP_Data_Filtered$TSb4[CP_Data_Filtered$tumor_size_v2==">5mm - ≤10mm"] <- 0
CP_Data_Filtered$TSb4[CP_Data_Filtered$tumor_size_v2==">10mm - ≤20mm"] <- 0
CP_Data_Filtered$TSb4[CP_Data_Filtered$tumor_size_v2==">20mm - ≤50mm"] <- 1
CP_Data_Filtered$TSb4[CP_Data_Filtered$tumor_size_v2==">50mm"] <- 0
CP_Data_Filtered$TSb4[CP_Data_Filtered$tumor_size_v2=="any size + extension to chest wall/skin"] <- 0

CP_Data_Filtered$TSb5 <- NA
CP_Data_Filtered$TSb5[CP_Data_Filtered$tumor_size_v2=="≥1mm - ≤5mm"] <- 0
CP_Data_Filtered$TSb5[CP_Data_Filtered$tumor_size_v2==">5mm - ≤10mm"] <- 0
CP_Data_Filtered$TSb5[CP_Data_Filtered$tumor_size_v2==">10mm - ≤20mm"] <- 0
CP_Data_Filtered$TSb5[CP_Data_Filtered$tumor_size_v2==">20mm - ≤50mm"] <- 0
CP_Data_Filtered$TSb5[CP_Data_Filtered$tumor_size_v2==">50mm"] <- 1
CP_Data_Filtered$TSb5[CP_Data_Filtered$tumor_size_v2=="any size + extension to chest wall/skin"] <- 0

CP_Data_Filtered$TSb6 <- NA
CP_Data_Filtered$TSb6[CP_Data_Filtered$tumor_size_v2=="≥1mm - ≤5mm"] <- 0
CP_Data_Filtered$TSb6[CP_Data_Filtered$tumor_size_v2==">5mm - ≤10mm"] <- 0
CP_Data_Filtered$TSb6[CP_Data_Filtered$tumor_size_v2==">10mm - ≤20mm"] <- 0
CP_Data_Filtered$TSb6[CP_Data_Filtered$tumor_size_v2==">20mm - ≤50mm"] <- 0
CP_Data_Filtered$TSb6[CP_Data_Filtered$tumor_size_v2==">50mm"] <- 0
CP_Data_Filtered$TSb6[CP_Data_Filtered$tumor_size_v2=="any size + extension to chest wall/skin"] <- 1



length(which(complete.cases(CP_Data_Filtered$TSb1)==FALSE))
length(which(complete.cases(CP_Data_Filtered$TSb1)==TRUE))
which(is.na(CP_Data_Filtered$TSb1))

length(which(complete.cases(CP_Data_Filtered$TSb2)==FALSE))
length(which(complete.cases(CP_Data_Filtered$TSb2)==TRUE))
which(is.na(CP_Data_Filtered$TSb2))

length(which(complete.cases(CP_Data_Filtered$TSb3)==FALSE))
length(which(complete.cases(CP_Data_Filtered$TSb3)==TRUE))
which(is.na(CP_Data_Filtered$TSb3))

length(which(complete.cases(CP_Data_Filtered$TSb4)==FALSE))
length(which(complete.cases(CP_Data_Filtered$TSb4)==TRUE))
which(is.na(CP_Data_Filtered$TSb4))

length(which(complete.cases(CP_Data_Filtered$TSb5)==FALSE))
length(which(complete.cases(CP_Data_Filtered$TSb5)==TRUE))
which(is.na(CP_Data_Filtered$TSb5))

length(which(complete.cases(CP_Data_Filtered$TSb6)==FALSE))
length(which(complete.cases(CP_Data_Filtered$TSb6)==TRUE))
which(is.na(CP_Data_Filtered$TSb6))
```


```{r}
colnames(CP_Data_Filtered)
```


## Frequency study group 

```{r}
table(CP_Data_Filtered$study_group)

```


## Recoding integer variables into factors 

First create a CP_all group that only contains PPBC-inv, PPBC-lac, PrBC and non-PrBC and excludes PPBC-no-info!

Then rename molecular subtype integer in such a way that Luminal A is the reference category! 

```{r}

CP_All <- subset(CP_Data_Filtered, study_group %in% c("PPBC-inv","non-PrBC", "PPBC-lac", "PrBC"), )

CP_All$molecular_subtype_integer <- factor(CP_All$molecular_subtype_integer,
                           levels = c("1", "2", "3", "4", "5"),
                           labels = c("Luminal A", "Luminal B (HER2neg)", "Luminal B (HER2pos)", "HER2pos", "TN"))
```



## Subsetting the data into categories only containing certain study groups! 

```{r}

CP_inv_vs_nonPrBC <- subset(CP_All, study_group %in% c("PPBC-inv","non-PrBC"), )

CP_inv_vs_PrBC <- subset(CP_All, study_group %in% c("PPBC-inv","PrBC"), )

CP_inv_vs_lac <- subset(CP_All, study_group %in% c("PPBC-inv","PPBC-lac"), )

CP_PrBC_vs_nonPrBC <- subset(CP_All, study_group %in% c("PrBC","non-PrBC"), )

CP_inv <- subset(CP_All, study_group == "PPBC-inv", )

CP_lac <- subset(CP_All, study_group == "PPBC-lac", )

CP_PrBC <- subset(CP_All, study_group == "PrBC", )

CP_nonPrBC <- subset(CP_All, study_group == "non-PrBC", )

```

## Saving the data files

```{r, eval=F}
#saveRDS(CP_Data_Filtered, file = "CP_Data_Filtered.RDS") 
#aveRDS(CP_All, file = "CP_All.RDS") 
#saveRDS(CP_inv_vs_nonPrBC, file = "CP_inv_vs_nonPrBC.RDS")
#saveRDS(CP_inv_vs_PrBC, file = "CP_inv_vs_PrBC.RDS") 
#saveRDS(CP_inv_vs_lac, file = "CP_inv_vs_lac.RDS") 
#saveRDS(CP_PrBC_vs_nonPrBC, file = "CP_PrBC_vs_nonPrBC.RDS") 
#saveRDS(CP_inv, file = "CP_inv.RDS") 
#saveRDS(CP_lac, file = "CP_lac.RDS") 
#saveRDS(CP_PrBC, file = "CP_PrBC.RDS") 
#saveRDS(CP_nonPrBC, file = "CP_nonPrBC.RDS") 
```



```{r}

str(CP_Data_Filtered$PR_trimester_integer)
str(CP_Data_Filtered$PR_trimester)

```


## Fix factors

For some categories, the key to reading the factor was in the column title. Recode these so that they're readable later on.

```{r}

CP_Data_Filtered = CP_Data_Filtered %>% mutate(
  study_group_integer = case_when(
    study_group_integer == 1 ~ "PPBC-inv",
    study_group_integer == 2 ~ "PPBC-lac",
    study_group_integer == 3 ~ "PPBC-no-info",
    study_group_integer == 4 ~ "PrBC",
    study_group_integer == 5 ~ "non-PrBC",
    TRUE ~ as.character(study_group_integer)
  ),
  country_integer = case_when(
    country_integer == 1 ~ "BEL",
    country_integer == 2 ~ "CAN",
    country_integer == 3 ~ "NLD",
    country_integer == 4 ~ "USA",
    country_integer == 5 ~ "ITA",
    country_integer == 6 ~ "DEU",
    country_integer == 7 ~ "AUT",
    country_integer == 8 ~ "CZE",
    country_integer == 9 ~ "DNK",
    country_integer == 10 ~ "ESP",
    country_integer == 11 ~ "RUS",
    country_integer == 12 ~ "POL",
    country_integer == 13 ~ "CHE",
    country_integer == 14 ~ "GRC",
    TRUE ~ as.character(country_integer)
  ),
  LR_integer = case_when(
    LR_integer == 0 ~ "no",
    LR_integer == 1 ~ "lateral",
    LR_integer == 2 ~ "lateral_IS",
    LR_integer == 3 ~ "contralateral",
    LR_integer == 4 ~ "contralateral_IS",
    LR_integer == 5 ~ "bilateral",
    LR_integer == 6 ~ "glands",
    TRUE ~ as.character(LR_integer)
  ),
  reason_death_integer = case_when(
    reason_death_integer == 0 ~ "alive",
    reason_death_integer == 1 ~ "unknown",
    reason_death_integer == 2 ~ "BC",
    reason_death_integer == 3 ~ "other",
    TRUE ~ as.character(reason_death_integer)
  ),
  year_birth_interval_integer = case_when(
    year_birth_interval_integer == 1 ~ "1955-<1960",
    year_birth_interval_integer == 2 ~ "1960-<1965",
    year_birth_interval_integer == 3 ~ "1965-<1970",
    year_birth_interval_integer == 4 ~ "1970-<1975",
    year_birth_interval_integer == 5 ~ "1975-<1980",
    year_birth_interval_integer == 6 ~ "1980-<1985",
    year_birth_interval_integer == 7 ~ "1985-<1990",
    year_birth_interval_integer == 8 ~ "≥1990",
    TRUE ~ as.character(year_birth_interval_integer)
  ),
  age_interval_integer = case_when(
    age_interval_integer == 1 ~ "26-30years",
    age_interval_integer == 2 ~ "31-35years",
    age_interval_integer == 3 ~ "36-40years",
    age_interval_integer == 4 ~ ">40years",
    TRUE ~ as.character(age_interval_integer)
  ),
  year_diagnosis_interval_integer = case_when(
    year_diagnosis_interval_integer == 1 ~ "1995-<2000",
    year_diagnosis_interval_integer == 2 ~ "2000-<2005",
    year_diagnosis_interval_integer == 3 ~ "2005-<2010",
    year_diagnosis_interval_integer == 4 ~ "2010-<2015",
    year_diagnosis_interval_integer == 5 ~ "≥2015",
    TRUE ~ as.character(year_diagnosis_interval_integer)
  ),
  BC_side_integer = case_when(
    BC_side_integer == 1 ~ "right",
    BC_side_integer == 2 ~ "left",
    BC_side_integer == 3 ~ "bilateral",
    TRUE ~ as.character(BC_side_integer)
  ),
  tumor_setting_integer = case_when(
    tumor_setting_integer == 1 ~ "early_BC",
    tumor_setting_integer == 2 ~ "metastatic_BC",
    TRUE ~ as.character(tumor_setting_integer)
  ),
  grade_integer = case_when(
    grade_integer == 1 ~ "grade I",
    grade_integer == 2 ~ "grade II",
    grade_integer == 3 ~ "grade III",
    TRUE ~ as.character(grade_integer)
  ),
  tumor_size_v1_integer = case_when(
    tumor_size_v1_integer == 1 ~ "1mm - ≤20mm",
    tumor_size_v1_integer == 2 ~ ">20mm - ≤50mm",
    tumor_size_v1_integer == 3 ~ "≥50mm",
    TRUE ~ as.character(tumor_size_v1_integer)
  ),
  tumor_size_v2_integer = case_when(
    tumor_size_v2_integer == 1 ~ "≥1mm - ≤5mm",
    tumor_size_v2_integer == 2 ~ ">5mm - ≤10mm",
    tumor_size_v2_integer == 3 ~ ">10mm - ≤20mm",
    tumor_size_v2_integer == 4 ~ ">20mm - ≤50mm",
    tumor_size_v2_integer == 5 ~ ">50mm",
    tumor_size_v2_integer == 6 ~ "any size + extension to chest wall/skin",
    TRUE ~ as.character(tumor_size_v2_integer)
  ),
  stage_short_integer = case_when(
    stage_short_integer == 1 ~ "stage I",
    stage_short_integer == 2 ~ "stage II",
    stage_short_integer == 3 ~ "stage III",
    stage_short_integer == 4 ~ "stage IV",
    TRUE ~ as.character(stage_short_integer)
  ),
  stage_long_integer = case_when(
    stage_short_integer == 1 ~ "stage IA",
    stage_short_integer == 2 ~ "stage IB",
    stage_short_integer == 3 ~ "stage IIA",
    stage_short_integer == 4 ~ "stage IIB",
    stage_short_integer == 5 ~ "stage IIIA",
    stage_short_integer == 6 ~ "stage IIIB",
    stage_short_integer == 7 ~ "stage IIIC",
    stage_short_integer == 8 ~ "stage IV",
    TRUE ~ as.character(stage_short_integer)
  ),
  T_integer = case_when(
    T_integer == 10 ~ "T1mi",
    T_integer == 11 ~ "T1a",
    T_integer == 12 ~ "T1b",
    T_integer == 13 ~ "T1c",
    T_integer == 20 ~ "T2",
    T_integer == 30 ~ "T3",
    T_integer == 40 ~ "T4",
    T_integer == 41 ~ "T4a",
    T_integer == 42 ~ "T4b",
    T_integer == 43 ~ "T4c",
    T_integer == 44 ~ "T4d",
    TRUE ~ as.character(T_integer)
  ),
  N_integer = case_when(
    N_integer == 10 ~ "N0",
    N_integer == 11 ~ "N1",
    N_integer == 12 ~ "N1mi",
    N_integer == 13 ~ "N1a",
    N_integer == 20 ~ "N2",
    N_integer == 21 ~ "N2a",
    N_integer == 22 ~ "N2b",
    N_integer == 30 ~ "N3",
    N_integer == 31 ~ "N3a",
    N_integer == 32 ~ "N3b",
    N_integer == 33 ~ "N3c",
    TRUE ~ as.character(N_integer)
  ),
  histological_subtype_integer = case_when(
    histological_subtype_integer == 1 ~ "IDC",
    histological_subtype_integer == 2 ~ "ILC",
    histological_subtype_integer == 3 ~ "IDC+ILC",
    histological_subtype_integer == 4 ~ "other",
    TRUE ~ as.character(histological_subtype_integer)
  ),
  surgery_type_integer = case_when(
    surgery_type_integer == 0 ~ "no surgery",
    surgery_type_integer == 1 ~ "BE",
    surgery_type_integer == 2 ~ "ME",
    surgery_type_integer == 3 ~ "SN",
    surgery_type_integer == 4 ~ "OE",
    surgery_type_integer == 5 ~ "combination",
    TRUE ~ as.character(surgery_type_integer)
  ),
  HT_type_integer = case_when(
    HT_type_integer == 0 ~ "no HT",
    HT_type_integer == 1 ~ "adj HT",
    HT_type_integer == 2 ~ "neoadj HT",
    HT_type_integer == 3 ~ "combo HT",
    TRUE ~ as.character(HT_type_integer)
  ),
  CT_type_integer = case_when(
    CT_type_integer == 0 ~ "no CT",
    CT_type_integer == 1 ~ "adj CT",
    CT_type_integer == 2 ~ "neoadj CT",
    CT_type_integer == 3 ~ "combo CT",
    TRUE ~ as.character(CT_type_integer)
  ),
  CT_schedule_integer = case_when(
    CT_schedule_integer == 0 ~ "no CT",
    CT_schedule_integer == 1 ~ "A/E/T",
    CT_schedule_integer == 2 ~ "EC/AC/TC",
    CT_schedule_integer == 3 ~ "EC/AC + T",
    CT_schedule_integer == 4 ~ "FEC/FAC",
    CT_schedule_integer == 5 ~ "FEC/FAC + T",
    CT_schedule_integer == 6 ~ "A(C)/E(C)/T(C) + CMF",
    CT_schedule_integer == 7 ~ "(F)A(C)/(F)E(C)/T(C) + platinum",
    CT_schedule_integer == 8 ~ "other treatment",
    TRUE ~ as.character(CT_schedule_integer)
  ),
  HERC_type_integer = case_when(
    HERC_type_integer == 0 ~ "no HERC",
    HERC_type_integer == 1 ~ "adj HERC",
    HERC_type_integer == 2 ~ "neoadj HERC",
    HERC_type_integer == 3 ~ "combo HERC",
    TRUE ~ as.character(HERC_type_integer)
  ),
  molecular_subtype_integer = case_when(
    molecular_subtype_integer == 1 ~ "Luminal A",
    molecular_subtype_integer == 2 ~ "Luminal B (HER2neg)",
    molecular_subtype_integer == 3 ~ "Luminal B (HER2pos)",
    molecular_subtype_integer == 4 ~ "HER2pos (non-luminal)",
    molecular_subtype_integer == 5 ~ "Triple Negative",
    TRUE ~ as.character(molecular_subtype_integer)
  ),
  mutation_status_short_integer = case_when(
    mutation_status_short_integer == 0 ~ "no mutation",
    mutation_status_short_integer == 1 ~ "BRCApos",
    mutation_status_short_integer == 2 ~ "CHEK2pos",
    mutation_status_short_integer == 3 ~ "other mutation",
    mutation_status_short_integer == 4 ~ "BRCAneg",
    mutation_status_short_integer == 5 ~ "BRCAneg and CHEK2neg",
    TRUE ~ as.character(mutation_status_short_integer)
  ),
  mutation_status_long_integer = case_when(
    mutation_status_long_integer == 0 ~ "no mutation",
    mutation_status_long_integer == 1 ~ "BRCA1pos",
    mutation_status_long_integer == 2 ~ "BRCA2pos",
    mutation_status_long_integer == 3 ~ "CHEK2pos",
    mutation_status_long_integer == 4 ~ "BRCAneg",
    mutation_status_long_integer == 5 ~ "BRCAneg and CHEK2neg",
    mutation_status_long_integer == 6 ~ "other mutation",
    TRUE ~ as.character(mutation_status_long_integer)
  ),
  BF_time_interval_integer = case_when(
    BF_time_interval_integer == 0 ~ "no BF",
    BF_time_interval_integer == 1 ~ "≤1 month",
    BF_time_interval_integer == 2 ~ ">1 months - ≤3 months",
    BF_time_interval_integer == 3 ~ ">3 months - ≤6 months",
    BF_time_interval_integer == 4 ~ ">6 months - ≤12 months",
    BF_time_interval_integer == 5 ~ "> 12 months",
    TRUE ~ as.character(BF_time_interval_integer)
  ),
  treatment_CTvsSurgery_integer = case_when(
    treatment_CTvsSurgery_integer == 0 ~ "no CT or Surgery",
    treatment_CTvsSurgery_integer == 1 ~ "neoadj CT",
    treatment_CTvsSurgery_integer == 2 ~ "Surgery",
    treatment_CTvsSurgery_integer == 3 ~ "neoadj CT + Surgery",
    treatment_CTvsSurgery_integer == 4 ~ "Surgery + adj CT",
    treatment_CTvsSurgery_integer == 5 ~ "neoadj CT + Surgery + adj CT",
    treatment_CTvsSurgery_integer == 6 ~ "other",
    TRUE ~ as.character(treatment_CTvsSurgery_integer)
  ),
  therapy_during_PR_integer = case_when(
    therapy_during_PR_integer == 0 ~ "no",
    therapy_during_PR_integer == 1 ~ "yes",
    therapy_during_PR_integer == 2 ~ "no PrBC",
    TRUE ~ as.character(therapy_during_PR_integer)
  ),
  therapy_during_PR_type_integer = case_when(
    therapy_during_PR_type_integer == 0 ~ "no",
    therapy_during_PR_type_integer == 1 ~ "neoadj CT",
    therapy_during_PR_type_integer == 2 ~ "Surgery",
    therapy_during_PR_type_integer == 3 ~ "neoadj CT + Surgery",
    therapy_during_PR_type_integer == 4 ~ "Surgery + adj CT",
    therapy_during_PR_type_integer == 5 ~ "neoadj CT + Surgery + adj CT",
    therapy_during_PR_type_integer == 6 ~ "other",
    therapy_during_PR_type_integer == 7 ~ "no PrBC",
    TRUE ~ as.character(therapy_during_PR_type_integer)
  ),
  CT_during_PR_detail_integer = case_when(
    CT_during_PR_detail_integer == 0 ~ "no",
    CT_during_PR_detail_integer == 1 ~ "CT only during PR",
    CT_during_PR_detail_integer == 2 ~ "CT during and after PR",
    CT_during_PR_detail_integer == 3 ~ "CT only after PR",
    CT_during_PR_detail_integer == 4 ~ "no PrBC",
    TRUE ~ as.character(CT_during_PR_detail_integer)
  ),
  CT_during_PR_type_integer = case_when(
    CT_during_PR_type_integer == 0 ~ "no CT during pregnancy",
    CT_during_PR_type_integer == 1 ~ "A/E/T",
    CT_during_PR_type_integer == 2 ~ "AC/EC/TC",
    CT_during_PR_type_integer == 3 ~ "EC/AC + T",
    CT_during_PR_type_integer == 4 ~ "FEC/FAC",
    CT_during_PR_type_integer == 5 ~ "FEC/FAC + T",
    CT_during_PR_type_integer == 6 ~ "other",
    CT_during_PR_type_integer == 7 ~ "no PrBC",
    TRUE ~ as.character(CT_during_PR_type_integer)
  ),
  PR_trimester_integer = case_when(
    PR_trimester_integer == 0 ~ "no PrBC",
    PR_trimester_integer == 1 ~ "trimester 1",
    PR_trimester_integer == 2 ~ "trimester 2",
    PR_trimester_integer == 3 ~ "trimester 3",
    TRUE ~ as.character(PR_trimester_integer)
  ),
  liver_DR_overall = if_else(liver_DR_overall==1, TRUE, FALSE),
  bone_DR_overall = if_else(bone_DR_overall==1, TRUE, FALSE),
  brain_DR_overall = if_else(brain_DR_overall==1, TRUE, FALSE),
  lung_DR_overall = if_else(lung_DR_overall==1, TRUE, FALSE),
  other_DR_overall = if_else(other_DR_overall==1, TRUE, FALSE),
  DR_at_one_primary_site = if_else(DR_at_one_primary_site==1, TRUE, FALSE),
  liver_DR_primary_site = if_else(liver_DR_primary_site==1, TRUE, FALSE),
  bone_DR_primary_site = if_else(bone_DR_primary_site==1, TRUE, FALSE),
  brain_DR_primary_site = if_else(brain_DR_primary_site==1, TRUE, FALSE),
  lung_DR_primary_site = if_else(lung_DR_primary_site==1, TRUE, FALSE),
  other_DR_primary_site = if_else(other_DR_primary_site==1, TRUE, FALSE),
  BF = if_else(BF==1, TRUE, FALSE)
)

```


```{r}
warnings()
```

```{r}
has_name(CP_Data_Filtered, "stage_I")
```


```{r}

str(CP_Data_Filtered$PR_trimester_integer)
str(CP_Data_Filtered$PR_trimester)

```



```{r}
CP_Data_Filtered
```

# Survival

```{r}
#colnames(CP_All)

CP_All %>% select("OS_months","Death")

CP_All %>% select(study_group) %>% table()
```

## OS Cox model

Stratified model

```{r}
#Tibbles don't play nice with surminer
CP_All <- as.data.frame(CP_All)

study_strata <- coxph(
  Surv(time=OS_months,
       event=Death) ~ age_diagnosis + year_diagnosis + grade_integer + stage_short_integer + surgery + RT + HT + CT + HERC + molecular_subtype_integer + strata(study_group), data = CP_All)

summary(study_strata)
```

Unstratified model

```{r}
clin.cov.cox <-coxph(
  Surv(time=OS_months,
       event=Death) ~ age_diagnosis + year_diagnosis + grade_integer + stage_short_integer + surgery + RT + HT + CT + HERC + molecular_subtype_integer + study_group, data = CP_All)
summary(clin.cov.cox)
```

## KM curves OS

```{r}
ggadjustedcurves(study_strata, data=CP_All, method="conditional", variable="study_group") +
  ggtitle("PPBC (n= 1039) multivariate OS: Stratified")

ggadjustedcurves(clin.cov.cox, variable = "study_group", data = CP_All, method="conditional") +
  ggtitle("PPBC (n= 1039) multivariate OS: Balanced")
```

```{r}
ggadjustedcurves(study_strata, data=CP_All, method="conditional", variable="study_group") +
  ggtitle("PPBC (n= 1039) multivariate OS: Stratified") +
  ylim(c(0.4, 1))

ggadjustedcurves(clin.cov.cox, variable = "study_group", data = CP_All, method="conditional") +
  ggtitle("PPBC (n= 1039) multivariate OS: Balanced") +
  ylim(c(0.4, 1))
```

```{r}
ggadjustedcurves(clin.cov.cox, variable = "study_group", data = CP_All, method="average") +
  ggtitle("PPBC (n= 1039) multivariate OS: Average") +
  ylim(c(0.4, 1))
```

## OS Forest

```{r, fig.height=10, fig.width=6}
ggforest(clin.cov.cox, data = CP_All) +
  ggtitle("PPBC (n= 1039) multivariate OS")
```


##  DRS Cox model
`


Stratified model

```{r}
#Tibbles don't play nice with surminer
CP_All <- as.data.frame(CP_All)

dr_strata <- coxph(
  Surv(time=DR_months,
       event=DR) ~ age_diagnosis + year_diagnosis + grade_integer + stage_short_integer + surgery + RT + HT + CT + HERC + molecular_subtype_integer + strata(study_group), data = CP_All)

dr_strata
```

Unstratified model

```{r}
dr.cov.cox <-coxph(
  Surv(time=DR_months,
       event=DR) ~ age_diagnosis + year_diagnosis + grade_integer + stage_short_integer + surgery + RT + HT + CT + HERC + molecular_subtype_integer + study_group, data = CP_All)
summary(dr.cov.cox)
```

## KM curves DRS

```{r}
ggadjustedcurves(dr_strata, data=CP_All, method="conditional", variable="study_group") +
  ggtitle("PPBC (n = 1039) multivariate DRS: Stratified")

ggadjustedcurves(dr.cov.cox, variable = "study_group", data = CP_All, method="conditional") +
  ggtitle("PPBC (n= 1039) multivariate DRS: Balanced")
```

```{r}
ggadjustedcurves(dr_strata, data=CP_All, method="conditional", variable="study_group") +
  ggtitle("PPBC (n= 1039) multivariate DRS: Stratified") +
  ylim(c(0.4, 1))

ggadjustedcurves(dr.cov.cox, variable = "study_group", data = CP_All, method="conditional") +
  ggtitle("PPBC (n= 1039) multivariate DRS: Balanced") +
  ylim(c(0.4, 1))
```

```{r}
ggadjustedcurves(dr.cov.cox, variable = "study_group", data = CP_All, method="average") +
  ggtitle("PPBC (n= 1039) multivariate DRS: Average") +
  ylim(c(0.4, 1))
```
`

