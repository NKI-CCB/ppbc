---
title: "Kaplan Meier plots for gene tertiles"
output: 
  html_notebook:
    toc: yes
    toc_float: yes
    toc_depth: 4
    highlight: tango
---

```{r}
rm(list = ls())
```

```{r, include=F}
library(DESeq2)
library(survival)
library(ggthemes)
library(survminer)
library(pheatmap)
library(RColorBrewer)
library(edgeR)
library(glmnet)
library(openxlsx)
library(here)
library(ggpubr)
library(tidyverse)
```

# Set up


## Gene metadata

```{r}
gx_annot <- read_tsv(here("data/metadata/01_tx_annot.tsv"))
gx_annot = gx_annot %>% select(ensembl_gene_id = gene_id, gene_name, gene_type, description = gene_description) %>% distinct()
```


## Survival metadata

As described in notebook 12, we have 183 samples with adequate data.

```{r}
metadata = readxl::read_excel(here("data", "metadata", "12_survival_metadata.xlsx"))
nrow(metadata)
```

## Previous results

### Diffex

```{r}
#For the gene_report function
source(here("src", "deseq_report_functions.R"))
```

```{r, collapse=T}
lrt <- here("results", "diffex", "06_LRT_allgenes.xlsx") %>% 
  readxl::excel_sheets() %>% 
  set_names() %>% 
  map(readxl::read_excel, path = here("results", "diffex", "06_LRT_allgenes.xlsx"))
names(lrt)

pw <- here("results", "diffex", "07_pairwise_comparisons_allgenes.xlsx") %>% 
  readxl::excel_sheets() %>% 
  set_names() %>% 
  map(readxl::read_excel, path = here("results", "diffex", "07_pairwise_comparisons_allgenes.xlsx"))
names(pw)

ovr = here("results", "diffex", "08_one_vs_rest_allgenes.xlsx") %>% 
  readxl::excel_sheets() %>% 
  set_names() %>% 
  map(readxl::read_excel, path = here("results", "diffex", "08_one_vs_rest_allgenes.xlsx"))
names(ovr)

#Substitute lrt down to all genes and rename it for convenience.
lrt = lrt["repLRT_all"]
names(lrt) = "LRT"

#Combine all results into single list.
res_list = append(lrt, pw)
res_list = append(res_list, ovr)
names(res_list) = str_remove_all(str_remove_all(names(res_list), "rep_"), "_all")
names(res_list) = str_replace(names(res_list), "_", "_vs_")
names(res_list)
```

### Overall survival

```{r}

os <- readxl::read_excel(path = here("results", "survival", "12_cox_allgenes.xlsx"),
                         sheet = "multi_cox_surv")
os
```

```{r}
os_path = readxl::read_excel(path = here("results", "survival", "12_cox_allgenes.xlsx"),
                         sheet = "path_multi_os")
os_path
```


### Distant recurrence

```{r}
drs <- readxl::read_excel(path = here("results", "survival", "12_cox_allgenes.xlsx"),
                         sheet = "multi_cox_dr")
drs
```


### Interaction model

```{r}
inv_int_os <- readxl::read_excel(here("results", "survival", "12b_os_gene:inv_interaction.xlsx"))

head(inv_int_os)
```

```{r}
inv_int_drs <- readxl::read_excel(here("results", "survival", "12b_drs_gene:inv_interaction.xlsx"))

head(inv_int_drs)
```

## Transposed matrix for Cox regressions

Also created in notebook 12. First 20 columns are metadata, after that there is one column per gene. Gene expression columns are TMM-log2 normalized.

```{r}
coxdata = readRDS(here("data", "Rds", "12_coxdata.Rds"))
colnames(coxdata)[1:30]
```

Exclusively sample data. Clean up sample labels a little.

```{r}
sample_data = coxdata[,1:20]

#head(sample_data)

sample_data = sample_data %>%
  mutate(PPBC = case_when(
    study_group == "non_prbc" ~ "nulliparous",
    study_group == "ppbc_inv" ~ "involution",
    study_group == "ppbc_lac" ~ "lactation",
    study_group == "prbc" ~ "pregnant",
    
  ))

table(sample_data$study_group, sample_data$PPBC)
```


In gene x sample format:

```{r}
ens_mat <- t(coxdata[21:ncol(coxdata)])
dim(ens_mat)
ens_mat[1:10,1:10]
```


A count matrix in genes x samples format, containing the same TMM/log normalized expression information as coxdata, but with gene symbols and repeat IDs de-duplicated:

```{r}
sym_mat <- as.matrix(readRDS(here("data", "Rds", "12b_tmmnorm_geneEx_survival.Rds")))
dim(sym_mat)
sym_mat[1:10,1:10]
```

# Functions


## Retrieve ntile of a gene

By default: tertiles

```{r}
gene_ntile <- function(gene_id, id_type, gene_dict = gx_annot, geneEx = ens_mat,
                       n = 3, labels = c("low", "medium", "high")){
  
  stopifnot(id_type %in% c("ensembl", "symbol"))
  stopifnot(length(labels) == n)
  
  if(id_type == "symbol"){
    id <- gene_dict[gene_dict$gene_name == gene_id,]$ensembl_gene_id
    name <- gene_id
    #return(gene_id)
  }
  
  if(id_type == "ensembl"){
    id <- gene_id
    name <- gene_dict[gene_dict$ensembl_gene_id == gene_id,]$gene_name
  }
  
  gene <- ens_mat[rownames(ens_mat) %in% id, , drop = F]
  if(nrow(gene) == 0){
    stop("Gene not found in provided count matrix")
  }
  
  if(nrow(gene) > 1){
    warning("Multiple ensembl ids mapped to single gene symbol. Averaging expression.")
    gene <- t(as.matrix(colMeans(gene)))
    #return(gene)
  }
  
  rownames(gene) <- name #Not strictly necessary, useful for debugging
  
  if(length(id) > 1){
    id = paste(id, collapse = ";")
  }
  
  gene_df <- tibble::tibble(sample_name = colnames(gene),
                            gene_symbol = name,
                            ensembl_gene_id = id,
                            tmm = gene[1,],
                            ntile = dplyr::ntile(gene[1,], n),
                            labels = factor(dplyr::ntile(gene[1,], n), labels = labels)
  )
  
  #gene_df <- dplyr::mutate(gene_df, labels = as.character(labels)) #Or survminer will complain
  
  return(gene_df)
}

#gene_ntile("ENSG00000000003", id_type = "ensembl") #%>% select(ntile, labels) %>% table()
gene_ntile("MUC2", id_type = "symbol") %>% head(10)

```



## Kaplan Meier of gene ntiles

Study groups are too small with too many imbalances to show adjusted models per group. (Model does not converge, coefficient is infinite, or conditional correction method for small group sizes shrinks away the slope into nothing.) Show unadjusted Kaplan-Meiers faceted by study group and the ntiles for the whole dataset.

Dynamic switching of survival type is also tricky due to the way Surv() evaluates variables.

```{r, fig.width=8}
km_ntiles <- function(gene_id, id_type = "symbol", gene_dict = gx_annot, geneEx = ens_mat,
                      n = 3, labels = c("low", "medium", "high"),
                      sampledata = sample_data, survival_type = "os"){
  
  stopifnot(survival_type %in% c("os", "drs"))
  ntiles <- gene_ntile(gene_id = gene_id, id_type = id_type, gene_dict = gene_dict,
                       geneEx = geneEx, n = n, labels = labels)
  
  sd <- dplyr::left_join(ntiles, sampledata, by = "sample_name")
  #  return(sd)
  
  #Nonfunctional due to some kind of parsing problem with Surv()
  #Toggle for survival type
  if(survival_type == "os"){
    ti <- "months_overall_survival"
    ev <- "overall_survival"
    ylab <- "Overall survival probability"
    type <- "Overall survival"
  }
  
  if(survival_type == "drs"){
    ti <- "months_to_drs"
    ev <- "distant_recurrence"
    ylab <- "Distant recurrence probability"
    type <- "Distant recurrence"
  }
  
  covariates <- c("age_at_diagnosis", "year_of_diagnosis", "grade",
                  "stage", "surgery", "radiotherapy", "hormonetherapy",
                  "chemotherapy", "herceptin", "PAM50", "study_group")
  
  cov <- paste(covariates, collapse = "+")
  svf = paste0('Surv(time=',ti,', event=',ev,')~')
  facet_formula <- as.formula(paste0(svf, "labels"))
  reduced =  as.formula(paste0(svf, cov))
  formula = as.formula(paste0(svf, paste0(cov, "+ntile")))

  reslist <- list()
  gn <- unique(sd$gene_symbol)
    
  #Facet plot: Show unadjusted curves for gene by study group
  facet_plot <- survminer::ggsurvplot(
    #fit = survfit(Surv(months_overall_survival, overall_survival)~ labels, data = as.data.frame(sd)), 
    #If you want to use a formula object, use surv_fit instead of survfit
    fit = survminer::surv_fit(facet_formula, data = as.data.frame(sd)), 
    xlab = "Months", 
    ylab = ylab,
    title = paste(type, "with", gn, "expression by PPBC group"),
    pval = T, facet.by = "PPBC")
  
  reslist$facet_plot <- facet_plot
  
  #return(reslist)
  
  #Cox models for all covariates, study group and ntile gene expression
  c <- survival::coxph(formula, data = as.data.frame(sd))
  #print(c)
  
  #Store p value associated with the coefficient of the ntile
  fit_ntile <- as.data.frame(summary(c)$coefficients)
  p_ntile <- signif(fit_ntile[rownames(fit_ntile) == "ntile", ]$`Pr(>|z|)`, 2)
  
  #Anova p value vs reduced model
  d <- survival::coxph(reduced, data = as.data.frame(sd))
  aod <- anova(d,c) #Conventional to list from smallest to largest but order does not matter
  aod_p <- signif(aod[4][2,], 2)

  #Adjusted survival curve for all 4 PPBC groups
  #B too small to show groupwise
  #Use surv_adjustedcurves to get data and the then manually plot for more control over appearance
  adj_curv <- surv_adjustedcurves(fit = c, variable = "ntile", data = as.data.frame(sd), method = "conditional") %>%
    left_join(select(mutate(sd, ntile = as.factor(ntile)), ntile, labels), by = c("variable" = "ntile")) %>%
    ggplot(., aes(x = time, y = surv, color = labels)) + 
    geom_step(size = 1) + theme_survminer() + scale_y_continuous(limits = c(0,1)) + 
    ylab(label =  ylab) + labs(color = paste(gn, "expression")) +
    ggtitle(paste(type, "for gene", gn, "adjusted for clinical covariates")) +
    annotate(geom = "text", label = paste0("Coef pval for ntile: ", p_ntile), x= 25, y =0.1) +
    annotate(geom = "text", label = paste0("Anova pval vs reduced: ", aod_p), x= 25, y =0.2)
  
  reslist$adj_curv <- adj_curv

  return(reslist)
  
}

km_ntiles("MS4A1")


```


```{r, fig.width=8}
km_ntiles("MS4A1", survival_type = "drs")
```

## Gene summary diffex and survival



Retrieve and combine survival results

```{r}
gene_survival <- function(id, id_type = "symbol", s = os, d = drs, ios = inv_int_os, idrs = inv_int_drs,
                          gene_dict = gx_annot, ...){
  
  if(id_type == "ensembl"){
    ens_id <- id
  } else {
    gnt <- gene_dict[gene_dict$gene_name == id, "ensembl_gene_id"]
    ens_id <- unique(gnt$ensembl_gene_id)
    if (length(ens_id) > 1) {
      warning(paste0("Multiple ensembl ids retrieved for ", id, ": ",
                     paste(ens_id,collapse=","), ". Returning first in series."))
      ens_id <- ens_id[1]
    }
  }
  
    
  g_os <- s[s$ensembl_gene_id == ens_id, , drop=F]
  g_os <- g_os %>% mutate(type = "overall survival") %>%
    select(type, everything())
  
  g_drs <- d[d$ensembl_gene_id == ens_id, , drop=F]
  g_drs <- g_drs %>% mutate(type = "distant recurrence") %>%
    select(type, everything())
  
  g_int_os <- ios[ios$ensembl_gene_id == ens_id, , drop=F]
  g_int_os <- g_int_os %>% mutate(type = "interaction os") %>%
    select(type, gene_name, fdr, beta, `HR (95% CI for HR)`, p.value, ensembl_gene_id, gene_type, description)
  
  g_int_drs <- idrs[idrs$ensembl_gene_id == ens_id, , drop=F]
  g_int_drs <- g_int_drs %>% mutate(type = "interaction drs") %>%
    select(type, gene_name, fdr, beta, `HR (95% CI for HR)`, p.value, ensembl_gene_id, gene_type, description)
  
  g <- bind_rows(g_os, g_drs, g_int_os, g_int_drs)
  
  return(g)
}

#gene_survival("MS4A1")
gene_survival("MUC2")

```



```{r}
gene_summary <- function(id, id_type = "symbol", ...){
  g <- gene_survival(id = id, id_type = id_type, ...)
  ens_id <- unique(g$ensembl_gene_id)
  r <- gene_report(res_list, ens_id)
  res <- list(survival_report = g, diffex_report = r)
  return(res)
}

#gene_summary("MS4A1")
gene_summary("MUC2")
```

## TMM beehive plot

Similar to the ones from previous notebooks, but on TMM/log2 normalized data as that's what was used as input for the survival analysis.

```{r, fig.height = 6}
tmm_beehive <- function(id, id_type = "symbol", ensembl_mat = ens_mat, symbol_mat = sym_mat, sampledata = sample_data){
  
  stopifnot(id_type %in% c("symbol", "ensembl"))
  
  if(id_type == "symbol"){
    mat <- symbol_mat
  } else {
    mat <- ensembl_mat
  }
  
  mat <- mat[rownames(mat) == id, , drop=F]
  
  if(nrow(mat) == 0){
    stop("Id not found in expression matrix, do you have the right identifier?")
  }
  
  df <- as.data.frame(mat) %>% rownames_to_column("gene_name") %>%
    gather(key = "sample_name", -gene_name, value = "tmm_log") %>%
    left_join(., sample_data, by = "sample_name")
  
  #return(df)
  
  bh <- df %>%
    ggplot(aes(x = factor(PPBC, levels = c("nulliparous", "pregnant", "lactation", "involution")), y = tmm_log)) +
    geom_jitter(aes(color = PAM50), height = 0, width = 0.2) +
    geom_boxplot(alpha = 0) +
    xlab("PPBC") +
    ylab("Log(TMM expression)") +
    ggthemes::scale_color_colorblind() +
    ggthemes::theme_clean() +
    ggtitle(paste("TMM/Log normalized expression of", unique(df$gene_name)))
  
  vb <- df %>%
    ggplot(aes(x = gene_name, y = tmm_log)) +
    geom_jitter(aes(color = study_group), height = 0, width = 0.2) +
    geom_violin(alpha = 0 ) +
    xlab("PPBC") +
    ylab("Log(TMM expression)") +
    ggthemes::scale_color_colorblind() +
    ggthemes::theme_clean()
  
  #rsl <- ggpubr::ggarrange(plotlist = list(bh, vb), ncol = 2)
  rsl <- list(beehive = bh, violin = vb)
  
  return(rsl)
}

#sample_data
tmm_beehive("MS4A1")
```

# Genes of interest

From survival, diffex, or background literature

## CD20 (MS4A1)

### OS and DRS

```{r, fig.height=10, fig.width=8}

ggarrange(plotlist = km_ntiles("MS4A1"), ncol = 1, nrow = 2)
ggarrange(plotlist = km_ntiles("MS4A1", survival_type = "drs"), ncol = 1, nrow = 2)
```

### Summary results

```{r}
gene_summary("MS4A1")$survival_report
```

```{r}
gene_summary("MS4A1")$diffex_report
```

### Expression

```{r, fig.width=8}
tmm_beehive("MS4A1")$beehive
```

## CD27

The protein encoded by this gene is a member of the TNF-receptor superfamily. This receptor is required for generation and long-term maintenance of T cell immunity. It binds to ligand CD70, and plays a key role in regulating B-cell activation and immunoglobulin synthesis. This receptor transduces signals that lead to the activation of NF-κB and MAPK8/JNK. Adaptor proteins TRAF2 and TRAF5 have been shown to mediate the signaling process of this receptor. CD27-binding protein (SIVA), a proapoptotic protein, can bind to this receptor and is thought to play an important role in the apoptosis induced by this receptor.[5]

In murine γδ T cells its expression has been correlated with the secretion of IFNγ.[6]
Varlilumab is an antibody that binds to CD27 and is an experimental cancer treatment.
CD27 has been shown to interact with SIVA1,[7] TRAF2[8][9] and TRAF3.[8][9] 

[The immunobiology of CD27 and OX40 and their potential as targets for cancer immunotherapy](https://www.ncbi.nlm.nih.gov/pubmed/29118006)

### OS and DRS

```{r, fig.height=10, fig.width=8}

ggarrange(plotlist = km_ntiles("CD27"), ncol = 1, nrow = 2)
ggarrange(plotlist = km_ntiles("CD27", survival_type = "drs"), ncol = 1, nrow = 2)
```

### Summary results

```{r}
gene_summary("CD27")$survival_report
```

```{r}
gene_summary("CD27")$diffex_report
```

### Expression

```{r, fig.width=8}
tmm_beehive("CD27")$beehive
```

## FoxP3

### OS and DRS

```{r, fig.height=10, fig.width=8}

ggarrange(plotlist = km_ntiles("FOXP3"), ncol = 1, nrow = 2)
ggarrange(plotlist = km_ntiles("FOXP3", survival_type = "drs"), ncol = 1, nrow = 2)
```

### Summary results

```{r}
gene_summary("FOXP3")$survival_report
```

```{r}
gene_summary("FOXP3")$diffex_report
```

### Expression

```{r, fig.width=8}
tmm_beehive("FOXP3")$beehive
```

## CD7

This gene encodes a transmembrane protein which is a member of the immunoglobulin superfamily. This protein is found on thymocytes and mature T cells. It plays an essential role in T-cell interactions and also in T-cell/B-cell interaction during early lymphoid development.

### OS and DRS

```{r, fig.height=10, fig.width=8}

ggarrange(plotlist = km_ntiles("CD7"), ncol = 1, nrow = 2)
ggarrange(plotlist = km_ntiles("CD7", survival_type = "drs"), ncol = 1, nrow = 2)
```

### Summary results

```{r}
gene_summary("CD7")$survival_report
```

```{r}
gene_summary("CD7")$diffex_report
```

### Expression

```{r, fig.width=8}
tmm_beehive("CD7")$beehive
```


## Top overall survival

Too many significant at fdr 0.1.

```{r}
os_top <- os %>% arrange(fdr, p.value) %>%
  filter(gene_type == "protein_coding" & fdr < 0.1) %>% pull(gene_name)

print(paste(length(os_top), "protein coding genes with fdr < 0.1 for overall survival"))
print(os_top)
```

Focus on those under fdr 0.05

```{r, collapse=T}
os_top <- os %>% arrange(fdr, p.value) %>%
  filter(gene_type == "protein_coding" & fdr < 0.05) %>% pull(gene_name)

print(paste(length(os_top), "protein coding genes with fdr < 0.05 for overall survival"))
print(paste(os_top, collapse=","))
```

```{r, fig.height=10, fig.width=8}


for(i in os_top){
 print(ggarrange(plotlist = km_ntiles(i), ncol = 1, nrow = 2)) 
}

```



## Top distant recurrence

```{r, collapse=T}
drs_top <- drs %>% arrange(fdr, p.value) %>%
  filter(gene_type == "protein_coding" & fdr < 0.1) %>% pull(gene_name)

print(paste(length(drs_top), "protein coding genes with fdr < 0.05 for overall survival"))
print(paste(drs_top, collapse=","))
```

```{r, fig.height = 10, fig.width=8}
for(i in drs_top){
  print(ggarrange(plotlist = km_ntiles(i, survival_type = "drs"), ncol = 1, nrow = 2)) 
}
```




## Top 20 interaction model

```{r, collapse=T}
print(paste("Interaction model identifies", nrow(inv_int %>% filter(fdr < 0.05 & gene_type == "protein_coding")), "protein coding genes at fdr < 0.05"))

inv_int %>% filter(fdr < 0.05 & gene_type == "protein_coding") %>% pull(gene_name)
```


Filter on protein coding only

```{r, fig.height = 10, fig.width=8}
for (i in inv_int %>% filter(fdr < 0.05 & gene_type == "protein_coding") %>% head(20) %>% pull(gene_name)){
  #print(km_ntiles(i)$facet_plot)
  print(ggarrange(plotlist = km_ntiles(i, survival_type = "os"), ncol = 1, nrow = 2)) 
}

```



# Stepwise work and debugging

```{r, eval=T}
sd <- as.data.frame(left_join(gene_ntile("DAZL", id_type = "symbol"), sample_data, by = "sample_name"))

sd %>% head(10)
```


We can choose to set up our ntiles as a categorical or continuous variable. If continuous, we get one p value for the ntile group from coxph.

```{r}
c <- coxph(
  Surv(time=months_overall_survival,
       event=overall_survival) ~ age_at_diagnosis + year_of_diagnosis + grade + stage + surgery + radiotherapy + hormonetherapy + chemotherapy + herceptin + PAM50 + study_group + ntile,
  data = sd)

c
fit_ntile <- as.data.frame(summary(c)$coefficients)
p_ntile <- signif(fit_ntile[rownames(fit_ntile) == "ntile", ]$`Pr(>|z|)`, 2)

ggadjustedcurves(c, variable = "ntile", data = sd, method="conditional", legend.title="ntile") +
  ggtitle(paste("Adjusted survival curve for", unique(sd$gene_symbol), ": Continuous ntile variable"),) +
  annotate(geom = "text", label = paste0("Coef pval for ntile: ", p_ntile), x= 25, y =0.1)


```



If categorical, we get a p value for each comparison to the reference. The plot is also slightly different.

```{r}

c <- coxph(
  Surv(time=months_overall_survival,
       event=overall_survival) ~ age_at_diagnosis + year_of_diagnosis + grade + stage + surgery + radiotherapy + hormonetherapy + chemotherapy + herceptin + PAM50 + study_group + labels,
  data = sd)

c

ggadjustedcurves(c, variable = "labels", data = sd, method="conditional") +
  ggtitle(paste("Adjusted survival curve for", unique(sd$gene_symbol), ": Categorical ntiles"))

```

If we want to change the variable labels, we need to call surv_adjustedcurves, join with the labels we want, then plot. Plotted names like ntiles 1-3 can't be changed after the plot has been called.

```{r}
c <- coxph(
  Surv(time=months_overall_survival,
       event=overall_survival) ~ age_at_diagnosis + year_of_diagnosis + grade + stage + surgery + radiotherapy + hormonetherapy + chemotherapy + herceptin + PAM50 + study_group + ntile,
  data = sd)


gn <- "DAZL"
surv_adjustedcurves(fit = c, variable = "ntile", data = sd, method = "conditional") %>%
  left_join(select(mutate(sd, ntile = as.factor(ntile)), ntile, labels), by = c("variable" = "ntile")) %>%
  #mutate(!!gn := labels) %>% #select(-labels, time, variable, surv) %>%
   ggplot(., aes(x = time, y = surv, color = labels)) + 
        geom_step(size = 1) + theme_survminer() + scale_y_continuous(limits = c(0,1)) + 
        ylab("Survival rate") + labs(color = paste(gn, "expression"))
```

For p values, compare anova vs reduced
http://www.drizopoulos.com/courses/emc/ep03_%20survival%20analysis%20in%20r%20companion#proportional-hazards-assumption
```{r}
d <- coxph(
  Surv(time=months_overall_survival,
       event=overall_survival) ~ age_at_diagnosis + year_of_diagnosis + grade + stage + surgery + radiotherapy + hormonetherapy + chemotherapy + herceptin + PAM50 + study_group,
  data = sd)

anova(d, c)[4][2,] #p val
anova(d, c)
```

```{r}
c
```


```{r}
s <- coxph(
  Surv(time=months_overall_survival,
       event=overall_survival) ~ age_at_diagnosis + year_of_diagnosis + grade + stage + surgery + radiotherapy + hormonetherapy + chemotherapy + herceptin + PAM50 + study_group + strata(labels),
  data = sd)

ggadjustedcurves(s, variable = "labels", data = sd, method="conditional") +
  ggtitle(paste("Adjusted survival curve for", unique(sd$gene_symbol), ": Stratified"))
```

Categorical and continuous representations of the facetted plots are identical

```{r, fig.width = 8}

ggsurvplot(
  fit = survfit(Surv(months_overall_survival, event=overall_survival) ~ ntile, data = sd), 
  xlab = "Months", 
  ylab = "Overall survival probability",
  title = paste(unique(sd$gene_symbol), "tier by PPBC group"),
  pval = T, facet.by = "PPBC")

ggsurvplot(
  fit = survfit(Surv(months_overall_survival, event=overall_survival) ~ labels, data = sd), 
  xlab = "Months", 
  ylab = "Overall survival probability",
  title = paste(unique(sd$gene_symbol), "tier by PPBC group"),
  pval = T, facet.by = "PPBC")

```

## Why we can't have groupwise adjusted plots
  
Making adjusted plots of each group in a facetted manner doesn't work because the groups are small enough that the coefficients are (near) infinite and the model can't converge, or because correcting for the size of such a small group essentially corrects the risk away into nothing.

```{r, fig.width=8}
sd <- as.data.frame(left_join(gene_ntile("DAZL", id_type = "symbol"), sample_data, by = "sample_name"))


for(i in unique(sd$study_group)){
  print(i)
  sdi <- sd[sd$study_group == i,]
  #print(sdi)
  #print(sdi$months_overall_survival)
  
  coxi <- coxph(
  Surv(time=months_overall_survival,
       event=overall_survival) ~ age_at_diagnosis  + grade + stage + surgery + radiotherapy + hormonetherapy + chemotherapy + herceptin + labels,
  data = sdi)
  print(coxi)
  
  sc <- surv_adjustedcurves(fit = coxi, variable = "ntile", data = sd, method = "conditional") #%>%
  #left_join(select(mutate(sd, ntile = as.factor(ntile)), ntile, labels), by = c("variable" = "ntile")) #%>%
  #mutate(!!gn := labels) %>% #select(-labels, time, variable, surv) %>%
   #ggplot(., aes(x = time, y = surv, color = labels)) + 
    #    geom_step(size = 1) + theme_survminer() + scale_y_continuous(limits = c(0,1)) + 
    #    ylab("Survival rate")
  print(sc)
  
  p <- ggadjustedcurves(coxi, variable = "labels", data = sd, method="conditional") +
    ggtitle(i)
  print(p)
}

```

## Save notebook data

```{r}
save.image(here("reports","12c_genewise_kaplan_meier_plots.RData"))
```



