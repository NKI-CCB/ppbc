---
title: "FlexGSEA results"
output: 
  html_notebook:
    toc: yes
    toc_float: yes
    toc_depth: 4
    highlight: tango
---

A series of reports generated to visualize FlexGSEA results from script (14_flexgsea_deseq).


```{r, include=F}
library(flexgsea)
library(here)
library(pheatmap)
library(scrime)
library(RColorBrewer)
library(ggthemes)
library(tidyverse)
```

# Load data

## Count matrix used as input:

```{r}
cm <- readRDS(here("results", "flexgsea", "deseq", "input", "geneSymbol_countmatrix.Rds"))

cm[1:10,1:10]
```

## Annotation

```{r}
gx_annot <- read_tsv(here("data/metadata/01_tx_annot.tsv"))
gx_annot = gx_annot %>% select(ensembl_gene_id = gene_id, gene_name, gene_type, description = gene_description) %>% distinct()
```


## Gene signatures used for analysis:

```{r}
gene_signatures = list(
  go_c5 = read_gmt(file = here("data","external","gmt","c5.all.v7.0.symbols.gmt")),# Gene ontology BP
  hallmark = read_gmt(file = here("data","external","gmt","h.all.v7.0.symbols.gmt")), # 50 gene overview
  canonpath_c2 = read_gmt(file = here("data","external","gmt","c2.cp.v7.0.symbols.gmt")), #Canonical pathways
  cgp_c2 = read_gmt(file = here("data", "external", "gmt", "c2.cgp.v7.0.symbols.gmt")) #Chemical and genetic perturbations
)

signature_files = enframe(c(
  go_c5 = here("data","external","gmt","c5.all.v6.2.symbols.gmt"),
  hallmark = here("data","external","gmt","h.all.v6.2.symbols.gmt"), # 50 gene overview
  canonpath_c2 =  here("data","external","gmt","c2.cp.v6.2.symbols.gmt"), #Canonical pathways
  cgp_c2 = here("data", "external", "gmt", "c2.cgp.v7.0.symbols.gmt") #Chemical and genetic perturbations
  ), "signature_name", "file") %>% mutate( abs = c(T, F, T, F))

signature_files
```

## Results files

```{r}
result_files = here("results", "flexgsea", "deseq", "results",
                    list.files(here("results", "flexgsea", "deseq", "results"),
                               pattern = ".Rds"))

result_files
```


## Heatmap colors

Created in notebook 6

```{r}
all_colors = readRDS(here("data","Rds", "06_heatmap_colors.Rds"))
study_colors = all_colors$study_colors
pam_colors = all_colors$pam_colors
gene_colors = all_colors$gene_colors
```

# Combine results

## Output structure

Results file is structure as a nested list with parameters and flexgsea results in the top level. Most results are stored in table, which is a list of each coefficient run (there will be only one for vs rest comparisons). Running es and leading edge can be used to make mountain plots. For leading edge, integers are reported instead of gene names. These correspond to the row number in the input matrix.

```{r}
#test <- readRDS(result_files[1])
test <- readRDS("/DATA/share/postpartumbc/results/flexgsea/deseq/results/study_group_canonpath_c2_results_flexdeseq.Rds") 
#str(test)

names(test)

head(test$parameters$value, 1)

names(test$flexgsea_results)
test$flexgsea_results$running_es_neg$study_group_ppbc_inv_vs_non_prbc[1]
test$flexgsea_results$running_es_pos$study_group_ppbc_inv_vs_non_prbc[1]
test$flexgsea_results$leading_edge$study_group_ppbc_inv_vs_non_prbc[1]

test$flexgsea_results$table %>% names()
rownames(cm)[4842]
```

## Parsing the data list

Create single list of all files and bind the results tables together. Store the name of the coefficient under "key"

```{r}
datalist = lapply(result_files, readRDS)


gene_sig = lapply(datalist, function(x) c(
    as.character(x$parameters[x$parameters$parameter == "signature_name", "value"]))
    ) %>% unlist()

gseares = lapply(datalist, function(x) gsea_results = x$flexgsea_results$table)
  
gseares = lapply(gseares, function(x) bind_rows(x, .id="key"))

names(gseares) = gene_sig

gseares = gseares %>% bind_rows(.id = "gene_signature")

unique(gseares$key)
#unique(gseares$gene_signature)

#Because it's large, remove
rm(datalist)
```

Split the key into a more readable format.

```{r}
gseares = gseares %>% mutate(comparison = case_when(
  str_detect(key, "vs_rest_") ~ str_replace(str_remove(str_remove(key, ".*_rest_"), "ppbc_"), "non_", "non"),
  str_detect(key, "study_group") ~ str_replace(str_remove(str_remove(key, "study_group_"), "ppbc_"), "non_", "non"),
  TRUE ~ key
))

gseares = gseares %>% select(fdr, p, comparison, GeneSet, everything())

gseares %>% select(key, comparison) %>% distinct()
```


# Total number of significant gene signatures

```{r}
gseares %>% mutate(sigfdr = fdr < 0.25) %>% select(comparison, sigfdr) %>% table()
```


```{r}
gseares %>% mutate(sigfdr = fdr < 0.25) %>% group_by(comparison, sigfdr) %>% summarise(n=n()) %>%
  arrange(desc(n)) %>% ungroup %>% filter(sigfdr == T) %>%
  ggplot(aes(x = factor(comparison, level=comparison), y = n)) +
  geom_bar(stat="identity") + #scale_y_log10() +
  xlab("Comparison") + ylab("Signatures significant at FDR < 0.25 (log10)") +
  ggtitle("Number of significant gene signatures across all comparisons")

```

Comparisons with no significant gene signatures:

```{r}
no_sig_genesets = gseares %>% mutate(sigfdr = fdr < 0.25) %>% select(comparison, sigfdr) %>% table() %>% as.data.frame() %>%
  filter(sigfdr == T & Freq == 0)

no_sig_genesets

#flexres %>% mutate(comparison_has_atleastone_significant_hit)
```

# Significant collections by comparison

```{r}
gseares %>% filter(fdr < 0.25) %>% group_by(comparison, gene_signature) %>% summarise(n=n()) %>% arrange(desc(n))
```

```{r, fig.width=10}
gseares %>% mutate(sigFDR = fdr < 0.25) %>% #filter(fdr < 0.25) %>%
  ggplot(aes(x = gene_signature, y = -log10(fdr), color = sigFDR)) +
  geom_jitter(width=0.1, height = 0) +
  facet_wrap(~ comparison, ncol = 3) +
  theme(axis.text.x = element_text(angle=90)) +
  scale_color_manual(values = c("darkgray", "darkred")) +
  geom_hline(yintercept = -log10(0.25), linetype = "dashed") +
  ggtitle("Signficant gene collections at FDR < 0.25, all comparisons")

```

# Exploration of significant pathways

```{r}
sigflex = gseares %>% filter(fdr < 0.25) %>% select(comparison, GeneSet, fdr, everything())

sigflex %>% group_by(comparison) %>% summarise(n=n()) %>% arrange(n)
```

```{r}
for (i in 1:length(unique(sigflex$comparison))){
 temp = sigflex[sigflex$comparison==unique(sigflex$comparison)[i],]
  temp = arrange(temp, fdr, p)
  print(head(temp, 30))
}

```





