---
title: "FlexGSEA results"
output: 
  html_notebook:
    toc: yes
    toc_float: yes
    toc_depth: 4
    highlight: tango
---

A series of reports generated to visualize FlexGSEA results from script (14_flexgsea_deseq).

```{r, include=F}
rm(list = ls())
```

```{r, include=F}
library(flexgsea)
library(here)
library(pheatmap)
library(scrime)
library(RColorBrewer)
library(ggthemes)
library(rlist)
library(tidyverse)
```

# Load data

## Count matrix used as input:

```{r}
cm <- readRDS(here("results", "flexgsea", "deseq", "input", "geneSymbol_countmatrix.Rds"))

cm[1:10,1:10]
```

## Annotation

```{r}
gx_annot <- read_tsv(here("data/metadata/01_tx_annot.tsv"))
gx_annot = gx_annot %>% select(ensembl_gene_id = gene_id, gene_name, gene_type, description = gene_description) %>% distinct()
```


## Gene signatures used for analysis:

```{r}
gene_signatures = list(
  go_c5 = read_gmt(file = here("data","external","gmt","c5.all.v7.0.symbols.gmt")),# Gene ontology BP
  hallmark = read_gmt(file = here("data","external","gmt","h.all.v7.0.symbols.gmt")), # 50 gene overview
  canonpath_c2 = read_gmt(file = here("data","external","gmt","c2.cp.v7.0.symbols.gmt")), #Canonical pathways
  cgp_c2 = read_gmt(file = here("data", "external", "gmt", "c2.cgp.v7.0.symbols.gmt")) #Chemical and genetic perturbations
)

signature_files = enframe(c(
  go_c5 = here("data","external","gmt","c5.all.v6.2.symbols.gmt"),
  hallmark = here("data","external","gmt","h.all.v6.2.symbols.gmt"), # 50 gene overview
  canonpath_c2 =  here("data","external","gmt","c2.cp.v6.2.symbols.gmt"), #Canonical pathways
  cgp_c2 = here("data", "external", "gmt", "c2.cgp.v7.0.symbols.gmt") #Chemical and genetic perturbations
  ), "signature_name", "file") %>% mutate( abs = c(T, F, T, F))

signature_files
```

## Results files

Most of the important comparisons were made in a single batch. A few additional pairwise (group A vs group B) were made later.

```{r}
result_files = here("results", "flexgsea", "deseq", "results",
                    list.files(here("results", "flexgsea", "deseq", "results"),
                               pattern = ".Rds"))

result_files = c(result_files, 
                 here("results", "flexgsea", "deseq", "results_more_pairwise",
                    list.files(here("results", "flexgsea", "deseq", "results_more_pairwise"),
                               pattern = ".Rds")))

stopifnot(all(file.exists(result_files)))
```


## Heatmap colors

Created in notebook 6

```{r}
all_colors = readRDS(here("data","Rds", "06_heatmap_colors.Rds"))
study_colors = all_colors$study_colors
pam_colors = all_colors$pam_colors
gene_colors = all_colors$gene_colors
```

# Combine results

## Output structure

Results file is structure as a nested list with parameters and flexgsea results in the top level. Most results are stored in table, which is a list of each coefficient run (there will be only one for vs rest comparisons). Running es and leading edge can be used to make mountain plots. For leading edge, integers are reported instead of gene names. These correspond to the row number in the input matrix.

```{r, include=F}
#test <- readRDS(result_files[1])
test <- readRDS("/DATA/share/postpartumbc/results/flexgsea/deseq/results/study_group_canonpath_c2_results_flexdeseq.Rds") 
#str(test)

names(test)

head(test$parameters$value, 1)

names(test$flexgsea_results)
test$flexgsea_results$running_es_neg$study_group_ppbc_inv_vs_non_prbc[1]
test$flexgsea_results$running_es_pos$study_group_ppbc_inv_vs_non_prbc[1]
test$flexgsea_results$leading_edge$study_group_ppbc_inv_vs_non_prbc[1]

test$flexgsea_results$table %>% names()
rownames(cm)[4842]
```

## Parsing the data list

Create single list of all files and bind the results tables together. Store the name of the coefficient under "key"

```{r}
datalist = lapply(result_files, readRDS)


gene_sig = lapply(datalist, function(x) c(
    as.character(x$parameters[x$parameters$parameter == "signature_name", "value"]))
    ) %>% unlist()

gseares = lapply(datalist, function(x) gsea_results = x$flexgsea_results$table)
  
gseares = lapply(gseares, function(x) bind_rows(x, .id="key"))

names(gseares) = gene_sig

gseares = gseares %>% bind_rows(.id = "gene_signature")

unique(gseares$key)
#unique(gseares$gene_signature)

#Because it's large, remove
rm(datalist)
```

Split the key into a more readable format.

```{r}
gseares = gseares %>% mutate(comparison = case_when(
  str_detect(key, "vs_rest_") ~ str_replace(str_remove(str_remove(key, ".*_rest_"), "ppbc_"), "non_", "non"),
  str_detect(key, "study_group") ~ str_replace(str_remove(str_remove(key, "study_group_"), "ppbc_"), "non_", "non"),
  str_detect(key, "reflac") ~ str_replace(str_remove_all(str_remove(key, "reflac_"), "ppbc_"), "non_", "non"),
  str_detect(key, "refprbc") ~ str_replace(str_remove_all(str_remove(key, "refprbc_"), "ppbc_"), "non_", "non"),
  TRUE ~ key
))

gseares = gseares %>% select(fdr, p, comparison, GeneSet, everything())

gseares %>% select(key, comparison) %>% distinct()
```

Make a leading edge key for downstream

```{r}
gseares = 
gseares %>% select(comparison, GeneSet, fdr, everything()) %>%
  arrange(fdr, p) %>%
   mutate(short = case_when(
    str_detect(comparison, "vs_rest") ~ comparison,
    str_detect(comparison, "vs_lac") ~ "reflac",
    str_detect(comparison, "vs_prbc") ~ "refprbc",
    str_detect(comparison, "vs_nonprbc") ~ "study_group", #different run, different nomenclature
    TRUE ~ "fixme"
  )) %>%
  mutate(le_key = paste(short,GeneSet, sep=":"))

stopifnot(sum(gseares$short == "fixme") == 0)
```


## Write aggregate table

```{r}
openxlsx::write.xlsx(gseares, file = here("results", "flexgsea", "deseq", "14_flexgsea_aggregate_results.xlsx"))
```


# Total number of significant gene signatures

```{r}
gseares %>% mutate(sigfdr = fdr < 0.25) %>% select(comparison, sigfdr) %>% table()
```


```{r}
gseares %>% mutate(sigfdr = fdr < 0.25) %>% group_by(comparison, sigfdr) %>% summarise(n=n()) %>%
  arrange(desc(n)) %>% ungroup %>% filter(sigfdr == T) %>%
  ggplot(aes(x = factor(comparison, level=comparison), y = n)) +
  geom_bar(stat="identity") + #scale_y_log10() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("Comparison") + ylab("Signatures significant at FDR < 0.25") +
  ggtitle("Number of significant gene signatures across all comparisons")

```

Comparisons with no significant gene signatures:

```{r}
no_sig_genesets = gseares %>% mutate(sigfdr = fdr < 0.25) %>% select(comparison, sigfdr) %>% table() %>% as.data.frame() %>%
  filter(sigfdr == T & Freq == 0)

no_sig_genesets
```

# Significant collections by comparison

```{r}
gseares %>% filter(fdr < 0.25) %>% group_by(comparison, gene_signature) %>%
  summarise(n=n()) %>% arrange(desc(n))
```

```{r, fig.width=10}
gseares %>% mutate(sigFDR = fdr < 0.25) %>% #filter(fdr < 0.25) %>%
  ggplot(aes(x = gene_signature, y = -log10(fdr), color = sigFDR)) +
  geom_jitter(width=0.1, height = 0) +
  facet_wrap(~ comparison, ncol = 4) +
  theme(axis.text.x = element_text(angle=90)) +
  scale_color_manual(values = c("darkgray", "darkred")) +
  geom_hline(yintercept = -log10(0.25), linetype = "dashed") +
  ggtitle("Signficant gene collections at FDR < 0.25, all comparisons")

```

Just the vs rest comparisons:

```{r, fig.width=8}
gseares %>% mutate(sigFDR = fdr < 0.25) %>% #filter(fdr < 0.25) %>%
  filter(str_detect(comparison, "vs_rest")) %>%
  mutate(comparison = str_replace_all(comparison,"_", " ")) %>%
  ggplot(aes(x = gene_signature, y = -log10(fdr), color = sigFDR)) +
  geom_jitter(width=0.1, height = 0) +
  facet_wrap(~ comparison, ncol = 4) +
  theme(axis.text.x = element_text(angle=90)) +
  scale_color_manual(values = c("darkgray", "darkred")) +
  geom_hline(yintercept = -log10(0.25), linetype = "dashed") +
  ggtitle("Signficant gene collections at FDR < 0.25, all comparisons") +
  ggthemes::theme_few() +
  theme(axis.text.x = element_text(angle = 90))

```

# Exploration of significant pathways

```{r}
sigflex = gseares %>% filter(fdr < 0.25) %>% select(comparison, GeneSet, fdr, everything())

sigflex %>% group_by(comparison) %>% summarise(n=n()) %>% arrange(n)
```

```{r}
for (i in 1:length(unique(sigflex$comparison))){
 temp = sigflex[sigflex$comparison==unique(sigflex$comparison)[i],]
  temp = arrange(temp, fdr, p)
  temp = temp %>% select(comparison, GeneSet, fdr, nes, max_es_at, everything())
  print(head(temp, 30))
}

```

```{r}
sigflex %>% filter(comparison == "nonprbc_vs_rest") %>%
  arrange(fdr) %>% select(GeneSet, fdr)
```

```{r}
sigflex %>% filter(comparison == "prbc_vs_rest") %>%
  filter(gene_signature == "canonpath_c2") %>%
  arrange(fdr) %>% select(GeneSet, fdr)
```

```{r}
sigflex %>% filter(comparison == "prbc_vs_rest") %>%
  filter(gene_signature == "go_c5") %>%
  arrange(fdr) %>% select(GeneSet, fdr)
```


```{r}
for (i in 1:length(unique(sigflex$comparison))){
 temp = sigflex[sigflex$comparison==unique(sigflex$comparison)[i],]
  temp = arrange(temp, fdr, p)
  temp = temp %>% select(comparison, GeneSet, fdr, nes, max_es_at, everything())
  temp = temp %>% mutate(GeneSet = substr(GeneSet,1,50))
  p = head(temp, 30) %>%
    ggplot(aes(x = GeneSet, y = nes)) +
    geom_bar(stat = "identity") + coord_flip() +
    ggtitle(paste0("Top 30 ", unique(sigflex$comparison)[i], " (", nrow(filter(temp, fdr < 0.25)), " total hits)"))
  
  print(p)
}

```

# Involution comparisons

Focus on pathways significant in comparisons with involution.

```{r}
sigflex %>% group_by(comparison) %>% summarise(n=n()) %>% arrange(n) %>%
  filter(str_detect(comparison, "inv"))
```

```{r}
invflex = filter(sigflex, str_detect(comparison, "inv"))

for (i in 1:length(unique(invflex$comparison))){
 temp = invflex[invflex$comparison==unique(invflex$comparison)[i],]
  temp = arrange(temp, fdr, p)
  temp = temp %>% select(comparison, GeneSet, fdr, nes, max_es_at, everything())
  temp = temp %>% mutate(GeneSet = substr(GeneSet,1,50))
  p = head(temp, 30) %>%
    ggplot(aes(x = GeneSet, y = nes)) +
    geom_bar(stat = "identity") + coord_flip() +
    ggtitle(paste0("Top 30 ", unique(invflex$comparison)[i], " (", nrow(filter(temp, fdr < 0.25)), " total hits)"))
  
  print(p)
}
```

Odd that all of the inv vs lac pathways have a positive nes.

```{r}
invflex %>%
  ggplot(aes(y = nes, x = fdr, color = gene_signature)) +
  geom_bar(stat="identity") + 
  facet_wrap(~ comparison) +
  ggtitle("Directionality of significant pathways in comparisons including involution")
```

# Leading edge

## Extract from dataset

We need a different part of the datalist to extract this information. Because the items we wish to retrieve are lists instead of data frames, another approach is needed.

```{r}
datalist = lapply(result_files, readRDS)

gene_sig = lapply(datalist, function(x) c(
    as.character(x$parameters[x$parameters$parameter == "signature_name", "value"]))
    ) %>% unlist()

le = lapply(datalist, function(x) gsea_results = x$flexgsea_results$leading_edge)
le_paths = lapply(le, function(x) names(x[1]))
#str(le)

#Too many levels, go down one
ne <- lapply(le,"[[",1)
#str(ne[1])

#Lost the names, extract them as follows
names_key = 
  tibble(
    key = unlist(le_paths),
    comparison = lapply(datalist, function(x) c(
      as.character(x$parameters[x$parameters$parameter == "comparison_name", "value"]))
    ) %>% unlist(),
    geneset = lapply(datalist, function(x) c(
      as.character(x$parameters[x$parameters$parameter == "signature_name", "value"]))
    ) %>% unlist()
  )

names_key = mutate(names_key, name = paste(comparison, geneset, sep=":"))
#names_key

#Reapply the names
names(ne) <- names_key$name

#go down a level again
#se <-lapply(ne, "[[" ,1)
#str(se[1])
#se <- unlist(ne)

#Because it's large, remove
rm(datalist)
```

Flatten the remaining levels down to one, and set up a dictionary for the integers.

```{r}
#Leading edge shows integers instead of gene names, these correspond to the integer
#gene_key = enframe(rownames(cm), "integer", "gene_name")
gene_key = setNames(rownames(cm), 1:nrow(cm))
#gene_key
gene_le <- rlist::list.flatten(ne) #The best function
#str(gene_le[1:10])

names(gene_le) = names(gene_le) %>% str_replace(":(.*)\\.", ":")
```

## Add metadata

```{r,eval=F}
#Comparisons correspond to reflac and "refprbc"
invflex %>%
  filter(fdr < 0.25) %>%
  select(short, le_key)




```

## Annotation

```{r}
anndf <- tibble(sample_name = colnames(cm)) %>%
  mutate(study_group = case_when(
    str_detect(sample_name, "non_prbc") ~ "non_prbc",
    str_detect(sample_name, "prbc") ~ "prbc",
    str_detect(sample_name, "ppbc_inv") ~ "ppbc_inv",
    str_detect(sample_name, "ppbc_lac") ~ "ppbc_lac"
  ))

table(anndf$study_group)
```


## Function


```{r}
#' Leading edge heatmap
#'
#' @param le_list A one level list containing the comparison and gene_sig separated by columns as a name
#' @param leading_edge_name A name present in le_list, i.e. inv_vs_rest:KEGG_AUTOIMMUNE_THYROID_DISEASE
#' @param m A matrix containing genes x samples used to run flexgsea. Will be used to map row integers from le_list to the gene symbol.
#' @param gsea_res An aggregated table of flexgsea results
#' @param anno_df An annotation data frame for pheatmap
#' @param groups_to_plot Which groups to show in the heatmap (a vector)
#' @param study_colors A named vector of colors matching anno_df
#' @param scale Whether to scale the heatmap values by "row", "column" or "none"
#' @return A pheatmap object showing the leading edge of that gene set
#'
#' @examples

leading_edge_heatmap <- function(le_list = gene_le, leading_edge_name, m = cm, gsea_res = gseares,
                                 anno_df = anndf, groups_to_plot = unique(anndf$study_group),
                                 colors = study_colors, scale = "row", show_colnames = F){
  
  stopifnot(class(m) %in% c("data.frame", "matrix"))
  
  #Extract stats from gsea results object
  geneset <- str_split(leading_edge_name, ":")[[1]][[2]]
  set_res <- gsea_res %>% filter(GeneSet == !!geneset)
  fdr <- signif(set_res$fdr,2)
  nes <- signif(set_res$nes,2)
  comp <- paste0("(", str_replace_all(set_res$comparison,"_", " "), ")")
  #short <- str_split(leading_edge_name, ":")[[1]][[1]]
  pset <- suppressWarnings(str_replace_all(tolower(geneset), "_", " "))
  plot_title <- paste0(pset, ": ", comp, ", fdr: ", fdr, ", nes: ", nes)
  
  #Transform the matrix
  m = as.matrix(m)
  m = log2(m + 0.5)
  
  #Subset leading edge list
  stopifnot(leading_edge_name %in% names(le_list))
  le_comp = le_list[names(le_list) == leading_edge_name]
  
  #Retrieve names of leading edge list
  gene_dict = enframe(rownames(cm), "row_num", "gene_name")
  genes_in_set = gene_dict[gene_dict$row_num %in% unlist(le_comp),]$gene_name
  
  #Subset count matrix down to genes in leading edge
  m <- m[rownames(m) %in% genes_in_set, ]
  
  #Subset matrix down to groups to plot
  m <- m[,anno_df[anno_df$study_group %in% groups_to_plot,]$sample_name]
  stopifnot(all(apply(m,2,class) == "numeric"))
  
  #Plot heatmap
  anno_df <- column_to_rownames(anno_df,"sample_name") #Necessary
  colors = colors[names(colors) %in% anno_df$study_group]
  pheatmap::pheatmap(m, fontsize_row = 8,
                     #annotation_colors = colors,
                     scale = "row", annotation_col = anno_df,
                     show_colnames = F,
                     main = plot_title)

  }
```

## Leading edge heatmaps


Involution vs lac example

```{r, fig.height=8, fig.width=10 ,warnings=F}
leading_edge_heatmap(leading_edge_name = "reflac:HALLMARK_INTERFERON_ALPHA_RESPONSE",
                     groups_to_plot = c("ppbc_inv", "ppbc_lac"))
```

S

Show top 10 comparisons containing involution
```{r, fig.height=8, fig.width=10 ,warnings=F}
code <- c("inv" = "ppbc_inv", "lac" = "ppbc_lac", "nonprbc" = "non_prbc")

for (i in 1:10){
  g1 = dplyr::recode(str_split(invflex$comparison[i], "_vs_")[[1]][[1]], !!!code)
  g2 = dplyr::recode(str_split(invflex$comparison[i], "_vs_")[[1]][[2]], !!!code)
  #print(paste(g1, g2, invflex$comparison[i]))
  leading_edge_heatmap(leading_edge_name = invflex$le_key[i],gsea_res = invflex,
                     groups_to_plot = c(g1, g2))
}

```

Top 10 across dataset

```{r, fig.height=8, fig.width=10 ,warnings=F}
code <- c("inv" = "ppbc_inv", "lac" = "ppbc_lac",
          "nonprbc" = "non_prbc", "prbc" = "prbc", "rest" = "rest")

gseares <- arrange(gseares, fdr, p)

for (i in 1:10){
  g1 = dplyr::recode(str_split(gseares$comparison[i], "_vs_")[[1]][[1]], !!!code)
  g2 = dplyr::recode(str_split(gseares$comparison[i], "_vs_")[[1]][[2]], !!!code)
  #print(paste(g1, g2, invflex$comparison[i]))
  if (g2 == "rest"){
    leading_edge_heatmap(leading_edge_name = gseares$le_key[i]) #Will plot all groups
  } else {
    leading_edge_heatmap(leading_edge_name = gseares$le_key[i],
                     groups_to_plot = c(g1, g2))
  }
  
}
```

# Mountain plots (under construction)

Need the plain old running es stat.

```{r}
datalist = lapply(result_files, readRDS)
run = lapply(datalist, function(x) gsea_results = x$flexgsea_results$running_edge)
run%>% length()

datalist[[1]]$flexgsea_results$running_es_pos$inv_vs_rest_ppbc_inv_vs_rest$KEGG_GLYCOLYSIS_GLUCONEOGENESIS[[1]]
datalist[[1]]$flexgsea_results$running_es_neg$inv_vs_rest_ppbc_inv_vs_rest$KEGG_GLYCOLYSIS_GLUCONEOGENESIS[[1]]
```


```{r, eval=F}
library(clusterProfiler)
gseaplot
```




```{r}
save.image(here::here("reports", "14_flexgsea_results.RData"))
```



