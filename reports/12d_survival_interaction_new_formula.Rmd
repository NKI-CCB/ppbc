---
title: "PPBC: Survival analyses with one vs rest interaction terms"
output: 
  html_notebook:
    toc: yes
    toc_float: yes
    toc_depth: 4
    highlight: tango
---

# Introduction

We previously attempted an interaction formula in notebook 12b as follows:

> survival ~ clinical covariates + study group + gene + study group * gene

Or, written out:

> survival ~ clinical covariates + non_prbc + prbc + ppbc_lac + ppbc_inv + gene + gene * non_prbc + gene * prbc + gene * ppbc_lac + gene * ppbc_inv

In notebook 12c we ascertained that although p values coming from this formula are very low, kaplan meier plots indicate that it does a pretty bad job of identifying genes that are specifically associated with survival.

Instead, we'll try a one vs rest approach. Rather than modelling each level of PPBC independently, we will code all involution samples as 1 and all others as 0.

> survival ~ clinical covariates + inv vs rest + gene + inv vs rest * gene


# Data prep

```{r}
rm(list = ls())
```

```{r, include=F}
library(DESeq2)
library(survival)
library(ggthemes)
library(survminer)
library(pheatmap)
library(RColorBrewer)
library(edgeR)
library(glmnet)
library(openxlsx)
library(here)
library(ggpubr)
library(tidyverse)
```

# Pre-process and load data

```{r}
source(here("src", "deseq_report_functions.R"))
source(here("src", "survival_tools.R"))
```

## Count and sample data

```{r}
dds = readRDS(here("data/Rds/08_dds_inv_vs_rest_standard.Rds"))
gx_annot <- read_tsv(here("data/metadata/01_tx_annot.tsv"))
gx_annot = gx_annot %>% select(ensembl_gene_id = gene_id, gene_name, gene_type, description = gene_description) %>% distinct()
```


## Gene sets

For Fisher's exact tests

```{r}
gene_sets = list(
  go_bp = flexgsea::read_gmt(here("data","external","gmt","c5.bp.v7.0.symbols.gmt")),
  hallmark = flexgsea::read_gmt(here("data","external","gmt","h.all.v7.0.symbols.gmt")),
  c2_canon = flexgsea::read_gmt(here("data","external","gmt","c2.cp.v7.0.symbols.gmt")),
  c2_cgp = flexgsea::read_gmt(here("data","external","gmt","c2.cgp.v7.0.symbols.gmt"))
)
```

## ImmPort genes

To easily identify genes with a known immune function

```{r}
immune_gene_list <- read_csv(here("data", "external","gene-sets","InnateDB_genes.csv"))
```


## Survival metadata

As described in notebook 12, we have 183 samples with adequate data.

```{r}
metadata = readxl::read_excel(here("data", "metadata", "12_survival_metadata.xlsx"))
nrow(metadata)
```

## Transposed matrix for Cox regressions

Also created in notebook 12. The gene expression columns are TMM/log2 normalized.

```{r}
coxdata = readRDS(here("data", "Rds", "12_coxdata.Rds"))
colnames(coxdata)[1:30]
```

### Ensembl ID expression matrix

```{r}
ens_mat <- t(coxdata[21:ncol(coxdata)])
dim(ens_mat)
ens_mat[1:4,1:4]
```


A count matrix in genes x samples format, containing the same TMM/log normalized expression information as coxdata, but with gene symbols and repeat IDs de-duplicated:

```{r}
sym_mat <- as.matrix(readRDS(here("data", "Rds", "12b_tmmnorm_geneEx_survival.Rds")))
dim(sym_mat)
sym_mat[1:4,1:4]
```

## Involution vs rest encoding

```{r}
levels(coxdata$study_group)
```

```{r}
coxdata = coxdata %>%
  mutate(involution = as.numeric(study_group == "ppbc_inv")) %>%
  select(sample_name:study_group, involution, everything())

table(coxdata$study_group, coxdata$involution)
```

```{r}
colnames(coxdata)[1:30]
#Genes start at position 22
colnames(coxdata)[22]
```

## Sample data

```{r}
sample_data = coxdata[,1:21]

#head(sample_data)

sample_data = sample_data %>%
  mutate(PPBC = case_when(
    study_group == "non_prbc" ~ "nulliparous",
    study_group == "ppbc_inv" ~ "involution",
    study_group == "ppbc_lac" ~ "lactation",
    study_group == "prbc" ~ "pregnant",
    
  ))

head(sample_data)
```

## Heatmap colors

Created in notebook 6

```{r}
all_colors = readRDS(here("data","Rds", "06_heatmap_colors.Rds"))
study_colors = all_colors$study_colors
pam_colors = all_colors$pam_colors
gene_colors = all_colors$gene_colors
```


Define colors for survival groups

```{r}
surv_df <- coxdata %>% 
  select(sample_name,study_group, PAM50,
         months_overall_survival, overall_survival,
         months_to_drs, distant_recurrence) %>%
  mutate(survival_group = case_when(
    overall_survival == 1 & months_overall_survival < 50 ~ "death_50mo",
    overall_survival == 1 & months_overall_survival < 100 ~ "death_100mo",  
    overall_survival == 1 & months_overall_survival < 150 ~ "death_150mo",
    overall_survival == 1 & months_overall_survival < 200 ~ "death_200mo",
    overall_survival == 1 & months_overall_survival < 250 ~ "death_200mo",
    overall_survival == 0 ~ "survived",
  TRUE ~ "no_data"
)) %>%
  mutate(drs_group = case_when(
  distant_recurrence == 1 & months_to_drs < 50 ~ "met_50mo",
  distant_recurrence == 1 & months_to_drs < 100 ~ "met_100mo",  
  distant_recurrence == 1 & months_to_drs < 150 ~ "met_150mo",
  distant_recurrence == 1 & months_to_drs < 200 ~ "met_200mo",
  distant_recurrence == 1 & months_to_drs < 250 ~ "met_200mo",
  distant_recurrence == 0 ~ "no_metastasis",
  TRUE ~ "no_data"
))

rownames(surv_df) = surv_df$sample_name

#head(surv_df)

#ann_df = [,c("study_group", "survival_group"), drop=F]
os_colors = viridis::viridis(length(unique(surv_df$survival_group)))
#unique(sd$survival_group) %>% paste(collapse=", ")

names(os_colors) = c("survived","death_200mo", "death_150mo" , "death_100mo", "death_50mo")
color_grid(os_colors)

drs_colors = viridis::viridis(length(unique(surv_df$drs_group))) 
#Ordered from best to worst
names(drs_colors) =  c("no_metastasis","met_200mo","met_150mo","met_100mo", "met_50mo")
color_grid(drs_colors)
```

## TMM normalization of gene expression

Normally we use vst normalization for visualization, but since we used TMM for the cox regression, we should also use TMM for the visualizations. We can load our previous result from notebook 12b.

```{r}
tmmnorm <- readRDS(here("data", "Rds", "12b_tmmnorm_geneEx_survival.Rds"))
```

# Functions for interaction term Cox regressions


## Extract results from models

```{r}
extract_interaction_cox_results <- function(cox_models, anno_df = gx_annot){
  

  
    gene_results <- lapply(cox_models,
                           function(x){
                             x <- summary(x)
                             
                             #Overall model significance
                             logrank_p <- x$logtest[[3]] #p value logrank test
                             wald_p <- x$waldtest[[3]] #p value wald test
                             lrt_p <- x$sctest[[3]] #p value likelihood ratio test
                             
                             #Save formula
                             coefs <- as.data.frame(x$coefficients)
                             #form = paste0(paste0('Surv(time=',time,', event=',event,')~'),
                            #               paste0(rownames(coefs), collapse = "+"))
                             
                             #Save gene from formula
                             coefs <- rownames_to_column(coefs, "feature")
                             gene <- coefs$feature[str_detect(coefs$feature, "^ENSG")]
                                      
                             #Extract results for interaction coefficient
                                      
                             int <- coefs[coefs$feature==paste0("involution:", gene), , drop=F]
                             colnames(int) <- c("feature", "beta", "HR", "se(beta)", "z", "p.value")
                             int <- int %>% mutate(p.value = signif(p.value, 2),
                                                   beta = signif(beta, 2),
                                                   HR = signif(HR, 2),
                                                   ensembl_gene_id = gene,
                                                   interaction = feature,
                                                   #formula_type = type,
                                                   logrank_p = signif(logrank_p, 2),
                                                   wald_p = signif(logrank_p, 2),
                                                   lrt_p = signif(logrank_p, 2),
                                                   #formula = form
                                                   )
                          
                             #Do the same for conf intervals
                             conf = rownames_to_column(as.data.frame(x$conf.int), "feature")
                             conf = conf[conf$feature == paste0("involution:", gene), , drop=F]
                             HR.confint.lower <- signif(conf[,"lower .95"], 2)
                             HR.confint.upper <- signif(conf[,"upper .95"],2)
                             int$HR <- paste0(int$HR, " (", 
                                              HR.confint.lower, "-", HR.confint.upper, ")")
                             res<- int %>% select(ensembl_gene_id, beta, HR, p.value, everything())
                             res <- res %>% rename(`HR (95% CI for HR)` = HR)
                             res <- res %>% select(-feature, -`se(beta)`, -z) #redundant
                             res <- as.vector(res[1,,drop=T])
                             
                             return(res)
                             })
    #res_df <- t(as.data.frame(gene_results, check.names = FALSE))
  
    res_df <- bind_rows(gene_results)
    #return(res_df)
  
  df = res_df %>%
    left_join(., anno_df, by="ensembl_gene_id") %>%
      mutate(fdr = p.adjust(p.value, method = "fdr")) %>%
      select(gene_name, fdr, beta,`HR (95% CI for HR)`, p.value, gene_type, description, everything())
  
  return(df)
}

```

## Apply formula per gene

```{r}
genewise_cox_interactions <- function(gene_list, data = coxdata, survival_type, show_runtime=T){
  
  stopifnot(survival_type %in% c("os", "drs"))

  start <- Sys.time()
  
  if(survival_type == "os"){
    time = "months_overall_survival"
    event = "overall_survival"
  } else {
    time = "months_to_drs"
    event = "distant_recurrence"
  }
  
  cov = 'age_at_diagnosis+year_of_diagnosis+stage+grade+surgery+radiotherapy+hormonetherapy+chemotherapy+herceptin+PAM50+involution'

  formula = paste0('Surv(time=',time,', event=',event,')~',cov)
  
  if(show_runtime){print(formula)}
  
  gene_formulas <-  sapply(gene_list,
                           function(x)
                             as.formula(paste(formula, x, paste0("involution*", x), sep="+")))
  #return(unlist(format(gene_formulas)))
  gene_models <- lapply(gene_formulas, function(x){coxph(x, data = data)})
  
  
  res <- extract_interaction_cox_results(gene_models)
  
  res$formula <- gsub("[[:space:]]", "", unlist(format(gene_formulas)))
  
  res <- res %>%arrange(fdr, p.value)
  
  end <- Sys.time()
  
  if(show_runtime){print(end-start)}
  
  return(res)
}

```

Test on 5 genes

```{r}
test = genewise_cox_interactions(gene_list = colnames(coxdata)[22:27], #Full: colnames(coxdata)[22:ncol(coxdata)],
                                 survival_type = "os")

test
```




# Survival analysis

```{r}
#Results directory
resDir = here("data", "Rds")
dir.create(resDir, showWarnings = F)
stopifnot(file.exists(resDir))
print("Genes start at position 22")
print(colnames(coxdata)[22])
overwrite <- F
```


```{r, eval=F}
resPath = file.path(resDir, "12d_interaction_newform_os.Rds")

if(file.exists(resPath) == F| overwrite == T){
  print("Interaction involution:gene for OS, new formula")
  res <-  genewise_cox_interactions(gene_list = colnames(coxdata)[22:ncol(coxdata)], 
                                 survival_type = "os")
  saveRDS(res, resPath)
}

resPath = file.path(resDir, "12d_interaction_newform_drs.Rds")

if(file.exists(resPath) == F| overwrite == T){
  print("Interaction involution:gene for DRS, new formula")
  res <-  genewise_cox_interactions(gene_list = colnames(coxdata)[22:ncol(coxdata)], 
                                 survival_type = "drs")
  saveRDS(res, resPath)
}
```

# Overall survival

```{r}
os <- readRDS(file.path(resDir,"12d_interaction_newform_os.Rds"))

head(os)
```

Example formula (gene varies by row):

```{r}
os$formula[1]
```



## Total hits
 
```{r}
print(paste("Total number of OS-associated genes with fdr ~ 0:", nrow(os[os$fdr == 0,])))

print(paste("Total number of OS-associated genes with fdr < 0.05:", nrow(os[os$fdr < 0.05,])))

print(paste("Total number of OS-associated genes with fdr < 0.1:", nrow(os[os$fdr < 0.1,])))
print(paste("Total number of OS-associated genes with fdr < 0.2:", nrow(os[os$fdr < 0.2,])))
print(paste("Total number of OS-associated genes with fdr < 0.3:", nrow(os[os$fdr < 0.3,])))

print(
  paste(
    "Total number of OS-associated genes with fdr < 0.25 for which the overall model (logrank, Wald, lrt) is also significant:",
    (os %>% filter(fdr < 0.25 & logrank_p <0.05 & wald_p < 0.05 & lrt_p < 0.05) %>% nrow())
  ))
```

```{r}
head(os, 30)
```


## Protein coding only

```{r}
print(
  paste(
    "Total number of OS-associated protein-coding genes with fdr < 0.25:",
    (os %>% filter(fdr < 0.25 & gene_type == "protein_coding") %>% nrow())
  ))

os %>% filter(fdr < 0.25 & gene_type == "protein_coding") %>% pull(gene_name)
```

```{r}
os %>% filter(fdr < 0.25 & gene_type == "protein_coding")
```


## Beta > 0 : Higher gene expression = Likelier death

```{r, collapse=T}
print(paste("Overall survival Beta > 0, fdr < 0.25:",
      nrow(os %>% filter(beta > 0 & fdr < 0.25))))

os %>% filter(beta > 0 & fdr < 0.25) %>%
  pull(gene_name)
```

## Beta < 0 : Lower gene expression = Likelier death


```{r}
print(paste("Overall survival multivariate Beta < 0, fdr < 0.25:",
      nrow(os %>% filter(beta < 0 & fdr < 0.25))))
os %>% filter(beta < 0 & fdr < 0.25) %>%
  pull(gene_name)
```

## Pathway analysis (Fisher's)

Input: Genes with fdr < 0.05
Output: Pathways significant with an fdr of 0.1

```{r}
path_os = fisher_pathways(
  sig_genes = pull(filter(os, fdr < 0.25),gene_name),
      background_genes = os$gene_name,
      list_signatures = gene_sets,
      fdr_cutoff = Inf,
      verbose = F,
      collapse_rows=F)

print("Sig pathways fdr < 0.1: ")

lapply(path_os, function(x) nrow(filter(x, fdr < 0.1)))
```

Top 20 pathways:

```{r, fig.height=6, fig.width=9}
bind_rows(path_os, .id = "gene_set") %>%
  arrange(fdr, pval) %>% head(20)

#Plotting one pathway not worth it
#plot_enrichment(
#        enrich_res = .,
#        fdr = 0.1,
#        max_nchar_path = 40,
#        max_path = 20,
#        title = "Sig pathways fdr < 0.1: Overall Survival Interactions"
#      )
```


## Heatmap

### Involution only:

Mostly these are genes with positive coefficients, so it makes sense that it's darker around events.

```{r, fig.width=8}
ann_df = surv_df[surv_df$study_group=="ppbc_inv", ,drop=F]
ann_df = ann_df[,"survival_group", drop=F]
#Sort by survival group
ann_df = ann_df[order(ann_df$survival_group),,drop=F]

#Match
#ovsd = vsd[,colnames(vsd)[match(rownames(ann_df), colnames(vsd))]]
stopifnot(identical(sort(colnames(tmmnorm)), sort(colnames(tmmnorm))))
otmm = tmmnorm[,colnames(tmmnorm)[match(rownames(ann_df), colnames(tmmnorm))]]

#Quantile breaks
quantile_breaks <- function(xs, n = 10) {
  breaks <- quantile(as.matrix(xs), probs = seq(0, 1, length.out = n))
  breaks[!duplicated(breaks)]
}

mat_breaks <- quantile_breaks(scrime::rowScales(otmm), n = 10)

pheatmap::pheatmap(as.matrix(otmm[rownames(otmm) %in% filter(os, fdr < 0.25 & gene_type == "protein_coding")$gene_name,]),
         show_colnames = F, show_rownames = T,
         scale="row", annotation_col = ann_df,
         cluster_cols = F, cluster_rows = F,
         #color = viridis::cividis(length(mat_breaks) - 1), 
         color = RColorBrewer::brewer.pal(length(mat_breaks) - 1, "Blues"),
         breaks=mat_breaks,
         annotation_colors = list(survival_group = os_colors),
         main = "OS interaction gene:inv (fdr <0.25): Involution samples only")

#Not better without row scaling
#mat_breaks <- quantile_breaks(ovsd, n = 10)

#pheatmap::pheatmap(as.matrix(ovsd[rownames(ovsd) %in% filter(os, fdr < 00.5)$gene_name,]),
#         show_colnames = F, show_rownames = F,
#         scale="none", annotation_col = ann_df,
#         cluster_cols = F,
#         color = viridis::cividis(length(mat_breaks) - 1),
#         breaks=mat_breaks,
#         annotation_colors = list(survival_group = os_colors),
#         main = "Genes associated with OS interaction gene:ppbc_inv (fdr < 0.05)")
```

### All samples

No obvious pattern here

```{r, fig.width= 8}
ann_df = surv_df[,c("sample_name", "study_group", "overall_survival"), drop=F]

#Sort by survival group
ann_df = ann_df %>% arrange(study_group, overall_survival)
ann_df = column_to_rownames(ann_df, "sample_name")

#Match
otmm = tmmnorm[,colnames(tmmnorm)[match(rownames(ann_df), colnames(tmmnorm))]]

#Quantile breaks
quantile_breaks <- function(xs, n = 10) {
  breaks <- quantile(as.matrix(xs), probs = seq(0, 1, length.out = n))
  breaks[!duplicated(breaks)]
}

#Two color scale
colfunc <- colorRampPalette(c("white", "steelblue"))

mat_breaks <- quantile_breaks(scrime::rowScales(otmm), n = 10)

pheatmap::pheatmap(otmm[rownames(otmm) %in% filter(os, fdr < 0.25)$gene_name,],
         show_colnames = F, show_rownames = T,
         scale="row", annotation_col = ann_df,
         cluster_cols = F, cluster_rows = F,
         #color = viridis::cividis(length(mat_breaks) - 1), 
         #color = colfunc(length(mat_breaks) - 1),
         color = RColorBrewer::brewer.pal(length(mat_breaks) - 1, "Blues"),
         breaks=mat_breaks,
         annotation_colors = list(study_group = study_colors[-5],
                                  survival_group = os_colors),
         main = "Genes associated with OS interaction gene:ppbc_inv- genewise fdr <0.25") 
```

## KM tertiles

We cannot create adjusted plots for each individual study group, because the number of events is too low. We can however show them for one vs rest comparisons (either involution or not).

This function shows the unadajusted study groups individually as well as the survival curves for all study groups together.

```{r, fig.height=10, fig.width=8}
for (i in filter(os, gene_type == "protein_coding" & fdr < 0.25)$gene_name){
  #print(km_ntiles(i, id_type = "symbol"))
  print(ggarrange(plotlist = km_ntiles(i), ncol = 1, nrow = 2)) 
}

```
This function shows the unadjusted and adjusted survival curves for involution samples, non-involution samples

```{r, fig.width=10, fig.height = 8}
source(here("src", "survival_tools.R"))
#km_ntiles_ovr("MS4A1", ovr_column = "involution", sampledata = sample_data)

for (i in filter(os, gene_type == "protein_coding" & fdr < 0.25)$gene_name){
  print(km_ntiles_ovr(i, ovr_column = "involution", survival_type = "os", sampledata = sample_data))
}

```

## Dot plots

Get rid of these? Hard to read.


```{r}
cox_dotplot <- function(gene_id,  cox_results, id_type = "gene_name", cox_events = "os",
                        data = coxdata, gene_annotation = gx_annot){
  
  stopifnot(id_type %in% c("gene_name", "ensembl_gene_id"))
  stopifnot(cox_events %in% c("os", "drs")) 
  
  if(cox_events == "os"){
    event_data = coxdata %>% select(sample_name, study_group, months_overall_survival, overall_survival)
    title_string = "OS for interaction "
    legend_label = "Death"
  } else {
    event_data = coxdata %>% select(sample_name, study_group, months_to_drs, distant_recurrence)
    title_string = "DRS for interaction "
    legend_label = "Metastasis"
  }
  
  event_type = colnames(event_data)[3:4]
  colnames(event_data)[3:4] <- c("time_months", "event")
  
  if(id_type == "gene_name"){
    gene_annot <- gx_annot[gx_annot$gene_name==gene_id,,drop=F]
  } else {
    gene_annot <- gx_annot[gx_annot$ensembl_gene_id==gene_id,,drop=F]
  }
  
  #stopifnot(nrow(gene_annot) == 1)
  if (nrow(gene_annot) > 1){
    gene_annot <- head(gene_annot, 1)
  }
  
  gene_data = coxdata[,c(gene_annot$ensembl_gene_id), drop=F]
  gene_data = cbind(gene_data, event_data)
  
  colnames(gene_data)[1] = "TMM_lognorm_expression"
  gene_data$gene_name = gene_annot$gene_name
  
  gene_results = cox_results[cox_results$ensembl_gene_id == gene_annot$ensembl_gene_id, ]
  stopifnot(nrow(gene_results) == 1)
  
  title_string = paste0(title_string, paste0("(involution*", gene_annot$gene_name), ")\n") #Response type for gene name
  title_string = paste(title_string,
                       paste(paste(colnames(gene_results)[2:4], gene_results[2:4], sep=": "), #FDR, beta and HR
                             collapse = ", "))
  
  gene_data %>%
    mutate(event = as.factor(event),
           study_group = recode(study_group,
                                non_prbc = "Nulliparous",
                                ppbc_inv = "Involution",
                                ppbc_lac = "Lactation",
                                prbc = "Pregnancy",
                                .default = levels(study_group))) %>%
    ggplot(aes(x =time_months, y = TMM_lognorm_expression, color = event)) +
    geom_point() +
    geom_rug()+
    #geom_smooth(method='lm',se=F)+
    facet_wrap(~study_group)+
    scale_color_colorblind() + theme_few() +
    ggtitle(title_string) +
    ylab("log(TMM)") +
    xlab("Time (Months)") +
    labs(color=legend_label)
  
  }
```


This is pretty much a rubbish visualization. (Or is it?)

```{r}
for (i in os[os$fdr < 0.1,]$gene_name){
  print(cox_dotplot(i, os))
}
```



## Save data

```{r}

openxlsx::write.xlsx(x = list("os_inv*gene" = os,
                              "fisher_paths" = bind_rows(path_os) %>% arrange(fdr, pval) %>%
                                select(pathway,fdr, pval, everything())),
                    file = here("results", "survival", "12d_os_gene:inv_newformula.xlsx"))
```


# DRS

```{r}
drs = readRDS(file.path(resDir, "12d_interaction_newform_drs.Rds"))
```

Example formula (gene varies by row):

```{r}
drs$formula[1]
```

Stats reported for coefficient:

```{r}
drs$interaction[1]
```


## Total hits
 
```{r}

print(paste("Total number of drs-associated genes with fdr < 0.1:", nrow(drs[drs$fdr < 0.1,])))

print(paste("Total number of drs-associated genes with fdr < 0.25:", nrow(drs[drs$fdr < 0.25,])))

print(
  paste(
    "Total number of drs-associated genes with fdr < 0.25 for which the overall model (logrank, Wald, lrt) is also significant:",
    (drs %>% filter(fdr < 0.25 & logrank_p <0.05 & wald_p < 0.05 & lrt_p < 0.05) %>% nrow())
         ))
```

## Protein-coding only

```{r}
print(paste("Protein-coding DRS genes with FDR < 0.25",
            (drs %>% filter(fdr < 0.25 & gene_type == "protein_coding") %>% nrow())))

print(drs %>% filter(fdr < 0.25 & gene_type == "protein_coding") %>% pull(gene_name))
```

```{r}
drs %>% filter(fdr < 0.25 & gene_type == "protein_coding")
```


## Beta > 0 : Higher gene expression = Likelier death

```{r, collapse=T}
print(paste("Distant recurrence Beta > 0, fdr < 0.25:",
      nrow(drs %>% filter(beta > 0 & fdr < 0.25))))

drs %>% filter(beta > 0 & fdr < 0.25) %>%
  pull(gene_name)
```

## Beta < 0 : Lower gene expression = Likelier death


```{r}
print(paste("Overall survival multivariate Beta < 0, fdr < 0.25:",
      nrow(drs %>% filter(beta < 0 & fdr < 0.25))))
drs %>% filter(beta < 0 & fdr < 0.25) %>%
  pull(gene_name)
```

## Pathway analysis (Fisher's)

Input: Genes with fdr < 0.05
Output: Pathways significant with an fdr of 0.1

```{r}
path_drs = fisher_pathways(
  sig_genes = pull(filter(drs, fdr < 0.25),gene_name),
      background_genes = drs$gene_name,
      list_signatures = gene_sets,
      fdr_cutoff = Inf,
      verbose = F,
      collapse_rows=F)

print("Sig pathways fdr < 0.1: ")

lapply(path_drs, function(x) nrow(filter(x, fdr < 0.1)))
```

Top 20 pathways:

```{r, fig.height=6, fig.width=9}
bind_rows(path_drs, .id = "gene_set") %>%
  arrange(fdr, pval) %>% head(20)

#Plotting one pathway not worth it
#plot_enrichment(
#        enrich_res = .,
#        fdr = 0.1,
#        max_nchar_path = 40,
#        max_path = 20,
#        title = "Sig pathways fdr < 0.1: Overall Survival Interactions"
#      )
```


## Heatmap


Involution only:

```{r, fig.width=8}
ann_df = surv_df[surv_df$study_group=="ppbc_inv", ,drop=F]
ann_df = ann_df[,"drs_group", drop=F]
#Sort by drs group
ann_df = ann_df[order(ann_df$drs_group),,drop=F]

#Match
stopifnot(identical(sort(colnames(tmmnorm)), sort(colnames(tmmnorm))))
otmm = tmmnorm[,colnames(tmmnorm)[match(rownames(ann_df), colnames(tmmnorm))]]

#Quantile breaks
quantile_breaks <- function(xs, n = 10) {
  breaks <- quantile(as.matrix(xs), probs = seq(0, 1, length.out = n))
  breaks[!duplicated(breaks)]
}

mat_breaks <- quantile_breaks(scrime::rowScales(otmm), n = 10)

pheatmap::pheatmap(as.matrix(otmm[rownames(otmm) %in% filter(drs, fdr < 0.25 & gene_type == "protein_coding")$gene_name,]),
         show_colnames = F, show_rownames = T,
         scale="row", annotation_col = ann_df,
         cluster_cols = F,
         #color = viridis::cividis(length(mat_breaks) - 1), 
         color = RColorBrewer::brewer.pal(length(mat_breaks) - 1, "Blues"),
         breaks=mat_breaks,
         annotation_colors = list(drs_group = drs_colors),
         main = "Genes associated with DRS interaction gene:ppbc_inv (fdr <0.25)")

#Not better without row scaling
#mat_breaks <- quantile_breaks(ovsd, n = 10)

#pheatmap::pheatmap(as.matrix(ovsd[rownames(ovsd) %in% filter(os, fdr < 00.5)$gene_name,]),
#         show_colnames = F, show_rownames = F,
#         scale="none", annotation_col = ann_df,
#         cluster_cols = F,
#         color = viridis::cividis(length(mat_breaks) - 1),
#         breaks=mat_breaks,
#         annotation_colors = list(survival_group = os_colors),
#         main = "Genes associated with OS interaction gene:ppbc_inv (fdr < 0.05)")
```

All samples

```{r, fig.width= 8}
ann_df = surv_df[,c("study_group", "drs_group"), drop=F]
#Sort by drs group
ann_df = ann_df[order(ann_df$drs_group),]

#Match
stopifnot(identical(sort(colnames(tmmnorm)), sort(colnames(tmmnorm))))
otmm = tmmnorm[,colnames(tmmnorm)[match(rownames(ann_df), colnames(tmmnorm))]]

#Quantile breaks
quantile_breaks <- function(xs, n = 10) {
  breaks <- quantile(as.matrix(xs), probs = seq(0, 1, length.out = n))
  breaks[!duplicated(breaks)]
}

#Two color scale
colfunc <- colorRampPalette(c("white", "steelblue"))

mat_breaks <- quantile_breaks(scrime::rowScales(otmm), n = 10)

pheatmap::pheatmap(otmm[rownames(otmm) %in% filter(drs, fdr < 0.25)$gene_name,],
         show_colnames = F, show_rownames = T,
         scale="row", annotation_col = ann_df,
         cluster_cols = F,
         #color = viridis::cividis(length(mat_breaks) - 1), 
         #color = colfunc(length(mat_breaks) - 1),
         color = RColorBrewer::brewer.pal(length(mat_breaks) - 1, "Blues"),
         breaks=mat_breaks,
         annotation_colors = list(study_group = study_colors[-5],
                                  drs_group = drs_colors),
         main = "Genes associated with DRS interaction gene:ppbc_inv (fdr <0.25)") 
```

## KM tertiles

```{r, fig.height=10, fig.width=8}
for (i in filter(drs, gene_type == "protein_coding" & fdr < 0.25)$gene_name){
  #print(km_ntiles(i, id_type = "symbol"))
  print(ggarrange(plotlist = km_ntiles(i), ncol = 1, nrow = 2)) 
}

```


```{r, fig.width=10, fig.height = 8}
source(here("src", "survival_tools.R"))
#km_ntiles_ovr("MS4A1", ovr_column = "involution", sampledata = sample_data)

for (i in filter(drs, gene_type == "protein_coding" & fdr < 0.25)$gene_name){
  print(km_ntiles_ovr(i, ovr_column = "involution", survival_type = "drs", sampledata = sample_data))
}

```














## Save data

```{r}
openxlsx::write.xlsx(x = list("drs_inv*gene" = drs,
                              "fisher_paths" = bind_rows(path_drs) %>% arrange(fdr, pval) %>%
                                select(pathway,fdr, pval, everything())),
                    file = here("results", "survival", "12d_drs_gene:inv_newformula.xlsx"))
```


```{r}
save.image(here("reports", "12d_survival_interaction_newformula.RData"))
```






