---
title: "Flexgsea results"
output: 
  html_notebook:
    toc: yes
    toc_float: yes
---

```{r}
library(tidyverse)
library(flexgsea)
library(here)
library(ComplexHeatmap)
library(scrime)
library(RColorBrewer)
```

# Load data

Gene collections from the Broad Institute:

```{r}
gene_signatures = list(
  hallmark = read_gmt(file = here("data","external","gmt","h.all.v6.2.symbols.gmt")), # 50 gene overview
  go_c5 = read_gmt(file = here("data","external","gmt","c5.all.v6.2.symbols.gmt")), # Gene ontology
  oncogene_c6 = read_gmt(file = here("data","external","gmt","c6.all.v6.2.symbols.gmt")), #Oncogenic gene signatures
  immune_c7 = read_gmt(file = here("data","external","gmt","c7.all.v6.2.symbols.gmt")), #Immunological signatures
  canonpath_c2 = read_gmt(file = here("data","external","gmt","c2.cp.v6.2.symbols.gmt")), #Canonical pathways
  motif_tf_mir_c3 = read_gmt(file = here("data","external", "gmt","c3.all.v6.2.symbols.gmt")), #Targets of TFs and miRs
  comp_canc_c4 = read_gmt(file = here("data","external","gmt","c4.all.v6.2.symbols.gmt")) #Computational gene sets from cancer gene neighborhoods and cancer modules
)

signature_files = enframe(c(
  hallmark = here("data","external","gmt","h.all.v6.2.symbols.gmt"), # 50 gene overview
  go_c5 = here("data","external","gmt","c5.all.v6.2.symbols.gmt"), # Gene ontology
  oncogene_c6 = here("data","external","gmt","c6.all.v6.2.symbols.gmt"), #Oncogenic gene signatures
  immune_c7 =  here("data","external","gmt","c7.all.v6.2.symbols.gmt"), #Immunological signatures
  canonpath_c2 =  here("data","external","gmt","c2.cp.v6.2.symbols.gmt"), #Canonical pathways
  motif_tf_mir_c3 = here("data","external", "gmt","c3.all.v6.2.symbols.gmt"), #Targets of TFs and miRs
  comp_canc_c4 = here("data","external","gmt","c4.all.v6.2.symbols.gmt")), #Computational gene sets from cancer gene neighborhoods and cancer modules
  "signature_name", "file")
```

Results files from flexgsea. See src/flexgsea_limma.R for production.

```{r}
result_files = here("results", "flexgsea", "limma_results", list.files(here("results", "flexgsea", "limma_results"), pattern = ".Rds"))
```

Gene expression matrix as input for flexgsea. (Unneeded?)

```{r}
#geneEx = readRDS(here("results", "flexgsea", "limma_input", "geneSymbol_countmatrix.Rds"))
```


# Report function

Collapse each individual output into a single report data frame.

```{r}
report_flexgsea <- function(path_list = result_files){
  require(tidyverse)
  require(here)
  
  datalist = lapply(path_list, readRDS)
  
  gseares = lapply(datalist, function(x) gsea_results = x$flexgsea_results$table[[length(x$flexgsea_results$table)]] %>% arrange(fdr))
  
  metares = lapply(datalist, function(x) c(
    comparison = as.character(x$parameters[x$parameters$parameter == "comparison_name", "value"]),
    gene_sig = as.character(x$parameters[x$parameters$parameter == "signature_name", "value"]))
    )
  
  names(gseares) = lapply(metares, function(x) paste(x, collapse=":"))
  
  gseares = bind_rows(gseares, .id = "key") #Collapse list of data frames into single data frame with list names stored in .id
  
  gseares = gseares %>% separate(key, into = c("comparison", "gene_signature"), sep = ":", remove = F)
  
  gseares = gseares %>% select(comparison, gene_signature, fdr, GeneSet, p, nes, es, everything())
  
  return(gseares)
}
```

```{r}
flexres = report_flexgsea(result_files)

head(flexres)
```


# Total number of significant gene signatures

```{r}
flexres %>% mutate(sigfdr = fdr < 0.25) %>% select(comparison, sigfdr) %>% table()
```


```{r}
flexres %>% mutate(sigfdr = fdr < 0.25) %>% group_by(comparison, sigfdr) %>% summarise(n=n()) %>%
  arrange(desc(n)) %>% ungroup %>% filter(sigfdr == T) %>%
  ggplot(aes(x = factor(comparison, level=comparison), y = n)) +
  geom_bar(stat="identity") + scale_y_log10() +
  xlab("Comparison") + ylab("Signatures significant at FDR < 0.25 (log10)") +
  ggtitle("Number of significant gene signatures across all comparisons")

```

Comparisons with no significant gene signatures:

```{r}
no_sig_genesets = flexres %>% mutate(sigfdr = fdr < 0.25) %>% select(comparison, sigfdr) %>% table() %>% as.data.frame() %>%
  filter(sigfdr == T & Freq == 0)

no_sig_genesets

#flexres %>% mutate(comparison_has_atleastone_significant_hit)
```

# Significant collections by comparison

```{r}
flexres %>% filter(fdr < 0.25) %>% group_by(comparison, gene_signature) %>% summarise(n=n()) %>% arrange(desc(n))
```

```{r, fig.width=10}
flexres %>% mutate(sigFDR = fdr < 0.25) %>% #filter(fdr < 0.25) %>%
  ggplot(aes(x = gene_signature, y = -log10(fdr), color = sigFDR)) +
  geom_jitter(width=0.1, height = 0) +
  facet_wrap(~ comparison, ncol = 3) +
  theme(axis.text.x = element_text(angle=90)) +
  scale_color_manual(values = c("darkgray", "darkred")) +
  geom_hline(yintercept = -log10(0.25), linetype = "dashed") +
  ggtitle("Signficant gene collections at FDR < 0.25, all comparisons")

```

```{r, fig.width=10}
flexres %>% mutate(sigFDR = fdr < 0.25) %>% filter(!comparison %in% no_sig_genesets$comparison) %>%
  ggplot(aes(x = gene_signature, y = -log10(fdr), color = sigFDR)) +
  geom_jitter(width=0.1, height = 0) +
  facet_wrap(~ comparison, ncol = 2) +
  theme(axis.text.x = element_text(angle=90)) +
  scale_color_manual(values = c("darkgray", "darkred")) +
  geom_hline(yintercept = -log10(0.25), linetype = "dashed") +
  ggtitle("Signficant gene collections at FDR < 0.25")

```

# Exploration of significant pathways

```{r}
sigflex = flexres %>% filter(fdr < 0.25) %>% select(key, GeneSet, fdr, everything())

sigflex %>% group_by(comparison) %>% summarise(n=n()) %>% arrange(n)
```

```{r}
for (i in 1:length(unique(sigflex$comparison))){
 temp = sigflex[sigflex$comparison==unique(sigflex$comparison)[i],]
  temp = arrange(temp, fdr)
  print(temp)
}

```

## Plot pathways

Todo: Plot batch on bottom

```{r}
plot_pathway = function(flexgsea_res = sigflex, comparison, voom_dir = here("results", "flexgsea", "limma_input"),
                        collection, geneSet, rowscale_heatmap = T, method = "both", colclust, ...){
  
  require(tidyverse)
  require(here)
  require(ComplexHeatmap)
  library(scrime)
  require(RColorBrewer)
  
  stopifnot(method %in% c("both", "boxplot", "heatmap"))
  
  flex = flexgsea_res %>% filter(comparison == !!comparison & gene_signature == !!collection & GeneSet == !!geneSet)
  fdr = round(flex$fdr, 2)
  nes = round(flex$nes, 2)
  
  
  v = readRDS(file=file.path(voom_dir, paste0(comparison,"_input_flimma.Rds")))$voom
  geneNames = gene_signatures[[collection]][[geneSet]]
  
  print(paste("Collection:", collection))
  print(paste("Genes in:", geneSet, ":"))
  print(paste(geneNames, collapse = ", "))
  print("Genes from pathway below count threshold:")
  print(paste(geneNames[!geneNames %in% rownames(v$E)], collapse = ", "))
  
  anno_df = as.data.frame(v$targets)
  anno_df = anno_df[, c("group", "batch", "PAM50")]
  
  mat = v$E[rownames(v$E) %in% geneNames,]
  
  #Boxplot
  gEx = rownames_to_column(as.data.frame(mat), "gene_name")
  gEx = gEx %>% gather(key=sample_name, -gene_name, value = normEx)
  
  gEx = left_join(gEx, rownames_to_column(anno_df, "sample_name"),
                  by="sample_name")
  title = paste("FDR:", fdr, "NES:", nes, comparison)
  
  boxPlot = gEx %>%
    ggplot(aes(x = gene_name, y = normEx, color = group)) +
    geom_boxplot() +
    ylab("TMM-normalized, voomT counts") +
    xlab(geneSet) +
    ggtitle(title) +
    theme(axis.text.x = element_text(angle=90))
  
  #Heatmap
  if (rowscale_heatmap==T){
    hmat = scrime::rowScales(mat)
  } else {
    hmat = mat
  }
  
  # Top column annotation
  ann_top = anno_df[,"group", drop=F]

  #Colors must be named lists with named elements
  topcolors=suppressWarnings(colorRampPalette(brewer.pal(length(unique(ann_top$group)),"Spectral"))(length(unique(ann_top$group))))
  names(topcolors) = unique(ann_top$group)
  top_cols=list(study_group=topcolors)
  colTop <- HeatmapAnnotation(df=ann_top, which="col", col = top_cols)
  
  #Change legend according to whether input is scaled
  if (rowscale_heatmap==T){
    hlp = list(title="rowscaled TMMvoom")
  } else {
    hlp = list(title="TMM voom counts")
  }
  hm = Heatmap(hmat, top_annotation = colTop, show_column_names = F,
               heatmap_legend_param = hlp, cluster_columns = colclust,  ...)
  
  plotlist = list(boxPlot, hm)
  
  if (method == "both"){
    return(plotlist)
  } else if (method == "boxplot"){
    return(boxPlot)
  } else {
    return(hm)
  }
}
```


```{r}
vtest = readRDS(file=file.path(here("results", "flexgsea", "limma_input"), paste0("inv_vs_rest","_input_flimma.Rds")))$voom

meta = as.data.frame(vtest$targets)
meta %>% rownames_to_column("dummy") %>% separate(dummy, into=c("A", "B"), sep="_[0-9]") %>%
  select(study_group = A, batch) %>% ggplot(aes = study_group)
head(meta)
```


```{r}
test = plot_pathway(comparison = "inv_vs_rest", collection = "canonpath_c2", geneSet = "REACTOME_PROLACTIN_RECEPTOR_SIGNALING", rowscale_heatmap = T, method="both")
```

```{r}
plot_pathway_group = function(flexgsea_res = sigflex, comparison, method, rowscale_heatmap=T,colclust=T, max_n = 10){
  
  require(tidyverse)
  
  thisflex = flexgsea_res %>% filter(comparison == !!comparison)
  thisflex = head(thisflex)
  
  flexlist = list()
  
  
  for (i in 1:nrow(thisflex)){
    flexlist[[length(flexlist)+1]] = plot_pathway(comparison = comparison,
                                                 collection = thisflex$gene_signature[i],
                                                 geneSet = thisflex$GeneSet[i],
                                                 rowscale_heatmap = rowscale_heatmap,
                                                 method=method, colclust = colclust)
  }
  
  return(flexlist)
}
```


## Involution vs rest

```{r}
sigflex %>% filter(comparison == "inv_vs_rest")
```


```{r}
plot_pathway_group(comparison = "inv_vs_rest", method= "boxplot")
```


```{r}
plot_pathway_group(comparison = "inv_vs_rest", method= "heatmap", colclust=T)
```

## Prbc vs nonprbc

```{r}
plot_pathway_group(comparison = "prbc_vs_nonprbc", method= "boxplot")
```

```{r}
plot_pathway_group(comparison = "prbc_vs_nonprbc", method= "heatmap")
```

```{r}
v
```


```{r}
gene_signatures[["canonpath_c2"]][["REACTOME_PROLACTIN_RECEPTOR_SIGNALING"]]
```


```{r}
genes_from_collection = function(collection, geneSet, collection_list = gene_signatures){
  
  thiscol = collection_list[[collection]][[geneSet]]
  
  return(thiscol)
  
}

rm(genes_from_collection)
```

```{r}
test = genes_from_collection(collection="canonpath_c2", geneSet = "REACTOME_PROLACTIN_RECEPTOR_SIGNALING")

str(test)
```


flexres = flexgsea(x = v, y = m,
                       gene.sets = signature,
                       gene.score.fn = flexgsea_limma,
                       es.fn=flexgsea_weighted_ks,
                       sig.fun=flexgsea_calc_sig,
                       nperm=nperm, parallel = T)
                       
```{r}
save.image(here("reports","11_flexgsea_results.RData"))
```


```{r}
flexgsea_limma
```

gene.scores <- gene.score.fn(x, y, abs=abs)

prep <- es.fn$prepare(gene.scores)




```{r}
flexgsea_weighted_ks
```



```{r}
prbc_vs_rest = readRDS("/DATA/share/postpartumbc/results/flexgsea/limma_results/prbc_vs_rest_immune_c7_results_flimma.Rds")
prbc_vs_rest$sampledata %>% select(group, study_group) %>% table()
```

