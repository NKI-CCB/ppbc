---
title: "Define cell types"
author: "Kat Moore"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    df_print: paged
    highlight: kate
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
library(here)
library(tidyverse)

theme_set(theme_bw())
```

We broadly define the following cell types:

* Cytotoxic T-cell (CD8+, CD3+)
* T-reg (CD3+, FoxP3+)
* Helper T-cell (CD3+, CD8-, FoxP3-)
* B-cell (CD20+, CD138-)
* Plasma B-cell (CD20+, CD138+)
* NK cell (CD8+, CD3- or CD27+, CD3-)
* Epithelial cell (PanCK+ and negative for immune markers)

Here we are assuming that CD3+CD8-FoxP3- are *probably* CD4+, since double-negative T-cells represent a [small (1-5%) populatoin of lymphocytes](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3269300/). One may also argue that not all CD8+ T-cells are by definition cytotoxic, but we lack the data to make such distinctions here.

CD27 is an early immune activation marker and is highly associated with a positive outcome in the PPBC cohort, especially among involuting patients. We therefore consider it as an additional characteristic of immune cells. 

CD138 in combination with CD20 is a plasma B marker, but it is also [expressed by T cells](https://www.biorxiv.org/content/10.1101/2020.03.25.008995v1) and [malignant cells](https://pubmed.ncbi.nlm.nih.gov/14983940/).

## Load data

```{r load-data}
mpif26 <- readRDS(here("data/vectra/processed/objects_MPIF26.Rds"))
mpif27 <- readRDS(here("data/vectra/processed/objects_MPIF27.Rds"))
```

## Cell definitions

FoxP3 positivity in the absence of CD3 positivity can occur. These cells will be classified as T-regs.

```{r summarise-markers, cache=F}
summarise_markers <- function (objects) {
  #Summarise markers as strings for downstream sanity checks
  marker_cols <- colnames(objects)[str_detect(colnames(objects), "_positive")]
  #Except DAPI
  marker_cols <- marker_cols[-which(marker_cols == "DAPI_positive")]
  markers_str <- str_replace(marker_cols, "_positive", "+")
  positive <- as.matrix(objects[, marker_cols])
  objects$markers <- apply(positive, 1, function (pos) {
        paste0(markers_str[pos], collapse="_")
  })
  
  objects %>%
    relocate(markers, .after=panel)
}

mpif26 <- summarise_markers(mpif26)
mpif27 <- summarise_markers(mpif27)
```

MPIF26 exclusive markers:  CD27, FoxP3
MPIF27 exclusive markers: CD138, CD8 
Shared markers: CD20, CD3, PanCK, DAPI

```{r}
mpif26 %>% 
  group_by(cell_type, markers) %>%
  count() %>%
  arrange(cell_type)
```

```{r}
mpif27 %>% 
  group_by(cell_type, markers) %>%
  count() %>%
  arrange(cell_type)
```
