---
title: "Organize Vectra samples"
author: "Kat Moore"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    df_print: paged
    highlight: kate
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(lubridate)
library(tidyverse)
library(methods)
```

## Overview

In Nov 2021, we went from having a single exported batch to work with, to having all batches available.

```{r}
list.files(here("data/vectra"), pattern = "Batch")
```

`Batch 3 Leuven (Batch 1 in HALO)` refers to the first batch that was exported in August. It is redundant with the new folder "batch 1" and should not be used.

```{r}
batches <- list.files(here("data/vectra"), pattern = "Batch")

batches <- batches[-which(batches == "Batch 3 Leuven (Batch 1 in HALO)")]
batches
```

There are two panels in each batch. The markers are as follows:

MPIF26 = CD3_CD20_CD27_FoxP3_PanCK
MPIF27 = CD3_CD8_CD138_CD20_PanCK

We cross-reference these samples with the list of known failed stainings later on.

### Metadata

All samples now have a T-number. The conversion back to the original sample names can be found here:

```{r}
meta <- readxl::read_excel(here("data/metadata/spatial/PPBC_sample_set.xlsx"))
head(meta)
```

There are more remarks to be found here.

```{r}
#File is messy and has been manually justified using a mix of spaces and tabs
remarks <- read_delim(here("data/metadata/spatial/CFMPB527 Analysis remarks.txt"),
                      delim = " ") %>%
  set_names(c("t_number", "remark")) %>%
  filter(str_detect(t_number, "T[0-9][0-9]\\-")) %>%
  separate(t_number, into = c("t_number", "temp"), sep = "\t") %>%
  mutate(remark = paste(temp, remark)) %>% select(-temp) %>%
  mutate(remark = str_trim(
    str_remove(str_remove(str_remove(remark, "\t"),"NA"), "\r"),
    side = c("both", "left", "right")))
```

```{r}
remarks %>% head()
```


### Directory structure

For every sample, the data is in a dated sub-directory.

```{r}
list.files(here("data/vectra/Batch 1/MPIF26/T21-60303/Halo archive 2021-06-24 11-33 - v3.2.1851"))
```

Basic stats are in `summary_results.csv`.

```{r}
read_csv(
  here("data/vectra/Batch 1/MPIF26/T21-60303/Halo archive 2021-06-24 11-33 - v3.2.1851/summary_results.csv")
)
```

Full results are in an `object_results.csv` file.

```{r}
read_csv(
  here("data/vectra/Batch 3 Leuven (Batch 1 in HALO)/MPIF26/T21-60303/Halo archive 2021-06-24 11-33 - v3.2.1851/T21-60303_I1_MPIF26_(CD3_CD20_CD27_FoxP3_PanCK)_LMS-5-7592052_Scan1_fuse.tif_208446_job113494.object_results.csv")
) %>% head()


```

The image segmentations are in the Images directory with a .annotations extension: these are xml files. Unclear what the difference is between the two annotations files.

```{r}
list.files(here("data/vectra/Batch 3 Leuven (Batch 1 in HALO)/MPIF26/T21-60303/Halo archive 2021-06-24 11-33 - v3.2.1851/Images"))
```

## Process metadata

```{r}
meta <- readxl::read_excel(here("data/metadata/spatial/PPBC_sample_set.xlsx"), .name_repair = "universal")

head(meta)
```

### Basic preprocessing

Fix column names.

```{r}
colnames(meta) <- colnames(meta) %>%
  tolower() %>%
  str_replace_all("\\.", "_") %>%
  str_replace("__", "_") %>%
  str_replace("seg_", "seg")

head(meta)
```

This Excel file was designed by humans for humans, with a bunch of colored fields and empty rows that contain only a header. These row headers can be found in the staining column.

```{r}
meta %>%
  filter(!staining %in% c("MPIF26", "MPIF27"))

#Remove these rows.

meta <- meta %>%
  filter(staining %in% c("MPIF26", "MPIF27"))
```

Most of the time, the T-number has only been filled in once for each panel. Sometimes a block ID has been filled into the empty space instead of NA. It's unclear why, but these samples clearly belong to the same ID.

```{r}
#Show the affected rows and the row that proceeds them
meta[sort(c(which(str_detect(meta$extern_number, "Block")),
  which(str_detect(meta$extern_number, "Block"))-1)),]

#replace block with NA so we can fill in the correct IDs below
meta$extern_number[which(str_detect(meta$extern_number, "Block"))] <- NA
```

Fix the NAs.

```{r}
meta <- meta %>%
  fill(extern_batch, extern_number, t_number, .direction = "down")

meta %>% head()
```

### Failed and missing samples

A number of analyses failed. These are marked with x.

```{r}
meta %>%
  filter(annotations == "x") %>%
  select(t_number, staining, extern_number, batch_in_halo, annotations, comments) %>%
  distinct()
```

Each sample within a batch should be present within both samples, but already we can see that some batches have uneven numbers.

```{r}
panel_check <- lapply(here("data/vectra", batches),
       function(x) {
         lapply(c("MPIF26", "MPIF27"), function(y){
           tibble(
             batch = str_remove(x, "/DATA/share/postpartumbc/data/vectra/"),
             panel = y,
             t_number = list.files(file.path(x, y))
           )}
         )
       }) %>% bind_rows() %>%
  arrange(t_number)

panel_check %>%
  pivot_wider(names_from = panel, values_from = t_number, values_fn = length)

```

Ensure that the samples present in each batch are identical when the numbers are equal, and print the discrepancy when they are not.

```{r}
#A data frame where sample names are stored as a list-col
panel_lcol <- panel_check %>%
  pivot_wider(names_from = panel, values_from = t_number, values_fn = list)

missing_samples <- list()

suppressWarnings(
  for (x in 1:nrow(panel_lcol)){
  if(all(sort(panel_lcol$MPIF26[[x]]) == sort(panel_lcol$MPIF27[[x]]))){
    #print(paste("No discrepancies in batch", panel_lcol$batch[[x]]))
  } else {
    #print(paste("Mismatched samples found in batch", panel_lcol$batch[[x]]))
    #print(paste("Found in MPIF26 but absent in MPIF27:"))
    problem <- setdiff(sort(unlist(panel_lcol[x,"MPIF26",drop=T])),
                  sort(unlist(panel_lcol[x,"MPIF27",drop=T])))
    #print(problem)
    missing_samples[[length(missing_samples) + 1]] <- tibble(
      batch = panel_lcol$batch[[x]], t_number = problem,
      MPIF26_present = T, MPIF27_present = F
    )
    #print(paste("Found in MPIF27 but absent in MPIF26:"))
    problem <- setdiff(sort(unlist(panel_lcol[x,"MPIF27",drop=T])),
                  sort(unlist(panel_lcol[x,"MPIF26",drop=T])))
    #print(problem)
    missing_samples[[length(missing_samples) + 1]] <- tibble(
      batch = panel_lcol$batch[[x]], t_number = problem,
      MPIF26_present = F, MPIF27_present = T
    )
  }
})

missing_samples <- missing_samples %>% 
  bind_rows()

missing_samples
```

Find the reason why these samples failed, if available in the metadata

```{r}
missing_samples <- missing_samples %>%
  mutate(present_in_metadata = t_number %in% meta$t_number) %>%
  left_join(.,pivot_wider(
    select(meta,t_number, staining, comments),
    names_from = staining, values_from = comments,
    names_glue = "comments_{staining}"),
            by = "t_number") %>%
  relocate(t_number, .before = everything())

missing_samples
```

See if there are comments about these samples in the remarks:

```{r}
missing_samples <- missing_samples %>%
  mutate(present_in_remarks = t_number %in% remarks$t_number,
         .after = present_in_metadata) %>%
  left_join(., remarks, by = "t_number")

missing_samples
```

All missing samples accounted for, though we still need to ask for the patient ref of T20-62412 since it's absent from the metadata. More on that later.

```{r}
write_csv(missing_samples, here("data/metadata/spatial/00_missing_panel_samples.csv"))
```

### Duplicates

Some patients evidently provided more than one tissue block.

```{r}
dups <- filter(count(group_by(meta, extern_number)), n!=2)$extern_number

meta %>%
  filter(extern_number %in% dups) %>%
  arrange(extern_number) %>%
  select(extern_number, t_number) %>%
  distinct()
```

## File location dictionary

The data structure is a mess. Let's look up the location of the relevant files so we can make symlinks later on.

Reminder:

MPIF26 = CD3_CD20_CD27_FoxP3_PanCK
MPIF27 = CD3_CD8_CD138_CD20_PanCK

First retrieve sample names, panel, and batch.

```{r}
filedict <- lapply(here("data/vectra", batches),
       function(x) {
         lapply(c("MPIF26", "MPIF27"), function(y){
           tibble(
             t_number = list.files(file.path(x, y)),
             batch = str_remove(x, "/DATA/share/postpartumbc/data/vectra/"),
             panel = y
           )}
         )
       }) %>% bind_rows() %>%
  arrange(t_number)

filedict %>% head()
```

### Object results

Same samples apparently lack these files.

```{r}
mainDir <- here("data/vectra")

tibble(object_results = str_remove(list.files(
  file.path(mainDir, filedict$batch, filedict$panel, filedict$t_number),
  recursive = T, full.names = T, pattern = ".object_results.csv"
),"/DATA/share/postpartumbc/")) %>%
  mutate(temp = str_remove(object_results, "data/vectra/Batch 1/MPIF26/")) %>%
  separate(temp, into = c("t_number", NA), extra = "drop", sep = "/") %>%
  left_join(filedict, ., by = "t_number")

filedict
```

Why is for example T09-22827 scanned twice in MPIF26? Nothing in the remarks file.

```{r}
mainDir <- here("data/vectra")
tibble(
  object_results = list.files(
    file.path(mainDir, batches), #Excluding the old Leuven export
    recursive = T, full.names = T, pattern = ".object_results.csv"
  )
) %>%
  #Extract the t_number, batch and panel from the object results
  separate(object_results,
           into=c(NA,NA,NA,NA,NA,NA,"batch","panel",
                  "t_number", "Halo_time", "object_file"),sep="/", remove = F) %>%
  relocate(object_results, .after = everything()) %>%
  relocate(t_number, .before = everything()) %>%
  arrange(t_number)
```


MPIF27 object results

```{r}
filedict <- sapply(filedict$t_number,
       function(x){
         list.files(file.path(mainDir, "MPIF27", x), recursive = T, full.names = T,
                    pattern = ".object_results.csv")
       }) %>%
  enframe("t_number", "mpif27_object_results") %>%
  left_join(filedict, ., by = "t_number")

head(filedict)
```

### Summary results

MPIF26

```{r}
filedict <- sapply(filedict$t_number,
       function(x){
         list.files(file.path(mainDir, "MPIF26", x), recursive = T, full.names = T,
                    pattern = "summary_results.csv")
       }) %>%
  enframe("t_number", "mpif26_summary_results") %>%
  left_join(filedict, ., by = "t_number")
```

MPIF27

```{r}
filedict <- sapply(filedict$t_number,
       function(x){
         list.files(file.path(mainDir, "MPIF27", x), recursive = T, full.names = T,
                    pattern = "summary_results.csv")
       }) %>%
  enframe("t_number", "mpif27_summary_results") %>%
  left_join(filedict, ., by = "t_number")
```

### Pivot wider by panel

TODO

### Annotations files

For every sample, two annotations files are present. One file has the job ID in the identifier, the other does not. For instance.

```{r}
lapply(filedict$t_number[1],
       function(x){
         list.files(file.path(mainDir, "MPIF26", x), recursive = T,
                    pattern = ".annotations")
       })
```

Unclear what the difference is. TODO: Fill in Iris' explanation once she responds to the email asking about it.

MPIF26

```{r}
filedict <- sapply(filedict$t_number,
       function(x){
         list.files(file.path(mainDir, "MPIF26", x), recursive = T, full.names = T,
                    pattern = ".annotations")[1]
       }) %>%
  enframe("t_number", "mpif26_job_annotations") %>%
  left_join(., 
            sapply(filedict$t_number,
                   function(x){
                     list.files(file.path(mainDir, "MPIF26", x), recursive = T, full.names = T,
                                pattern = ".annotations")[2]
                   }) %>%
              enframe("t_number", "mpif26_annotations")
  , by = "t_number") %>%
  left_join(filedict, ., by = "t_number")

head(filedict)
```

MPIF27

```{r}
filedict <- sapply(filedict$t_number,
       function(x){
         list.files(file.path(mainDir, "MPIF27", x), recursive = T, full.names = T,
                    pattern = ".annotations")[1]
       }) %>%
  enframe("t_number", "mpif27_job_annotations") %>%
  left_join(., 
            sapply(filedict$t_number,
                   function(x){
                     list.files(file.path(mainDir, "MPIF27", x), recursive = T, full.names = T,
                                pattern = ".annotations")[2]
                   }) %>%
              enframe("t_number", "mpif27_annotations")
  , by = "t_number") %>%
  left_join(filedict, ., by = "t_number")

head(filedict)
```

### Batches

The batches associated with folder names do not necessarily reflect the staining batches. These can be found here, with the following comment:

>Hereby I send to you the batches exactly howthey are logged in the Ventana stainer, including date and time + the controls that are stained

```{r}
detailed_batches <- readxl::read_excel(here("data/metadata/spatial/MPIF26en27 batches gekleurd.xlsx")) %>%
  rename(t_number = `Block ID`, staining = `Protocol Name`, scan_time = `Start Time`) %>%
  select(t_number, staining, scan_time) %>%
  mutate(t_number = str_remove(t_number, " [A|B|I].*"), #Suddenly some t_number have suffixes
         staining = str_remove(str_remove(staining, "CF "), " v1"))
head(detailed_batches)
```

Add to metadata. TODO fix T20-62169_I1 and T20-62169_II1 (WHY)

```{r}
meta %>%
  left_join(., detailed_batches, by = c("t_number", "staining"))
```

## Link to RNA data

Link with RNAseq IDs and study_group etc. Note: the molecular subtypes as listed here are based on the clinical classification from Leuven. Also, some samples were later removed from the RNAseq analysis for QC reasons.

```{r}
combi_meta <- read_tsv(here("data/metadata/01_sample_annot.tsv")) %>%
  select(sample_ref, patient_ref, sample_name, study_group, PPBC, country, clin_subtype = molecular_subtype,
         stage=stage_short, grade, TIL_percent = TILprecent, age = age_diagnosis,
         overall_survival, distant_recurrence, months_of_followup,
         months_involution_breastfeeding, breastfeeding_months) %>%
  left_join(meta, ., by = c("extern_number" = "sample_ref")) %>%
  distinct()
```

There should be the same number of observations after joining with RNAseq data.

```{r}
stopifnot(nrow(combi_meta) == nrow(meta))
```

### Write metadata

```{r}
write_csv(combi_meta, here("data/metadata/spatial/00_vectra_metadata.csv"))
```


### RNAseq sample names

Also add sample name/patient ref for easier cross-referencing later.

```{r}
filedict <- filedict %>%
  inner_join(., select(combi_meta, t_number, extern_number, sample_name), by = "t_number") %>%
  relocate(extern_number:sample_name, .after = t_number) %>%
  distinct()

head(filedict)
```


## Create symlinks

Create directory structure.

```{r}
symdir <- here("data/vectra/raw")
dir.create(symdir, showWarnings = F)
dir.create(file.path(symdir, "annotations"), showWarnings = F)
dir.create(file.path(symdir, "objects"), showWarnings = F)
dir.create(file.path(symdir, "summary"), showWarnings = F)
```


### Object results

Add symbolic links to file dictionary.

```{r}

filedict$sym_mpif26_object_results <- file.path(
  symdir, "objects",
  paste(filedict$t_number, "MPIF26", "object_results.csv", sep = "_")
)

filedict$sym_mpif27_object_results <- file.path(
  symdir, "objects", paste(filedict$t_number, "MPIF27","batch1", "object_results.csv", sep = "_")
  )
```

Create the symbolic links.

```{r}
#Will harmlessly give a "file exists" warning and return FALSE if already done
suppressWarnings(file.symlink(
  from = filedict$mpif26_object_results,
  to = filedict$sym_mpif26_object_results
))

suppressWarnings(file.symlink(
  from = filedict$mpif27_object_results,
  to = filedict$sym_mpif27_object_results
))
```

### Summary results

Add symlinks to file dict.

```{r}
filedict$sym_mpif26_summary_results <- file.path(
  symdir, "summary", paste(filedict$t_number, "MPIF26","batch1", "summary_results.csv", sep = "_")
  )

filedict$sym_mpif27_summary_results <- file.path(
  symdir, "summary", paste(filedict$t_number, "MPIF27","batch1", "summary_results.csv", sep = "_")
  )
```


Create the symlinks.

```{r}
#Will harmlessly give a "file exists" warning and return FALSE if already done
suppressWarnings(file.symlink(
  from = filedict$mpif26_summary_results,
  to = filedict$sym_mpif26_summary_results
))
```

```{r}
suppressWarnings(file.symlink(
  from = filedict$mpif27_summary_results,
  to = filedict$sym_mpif27_summary_results
))
```

### Annotations

The annotation files that contain `job` in the file name appear to contain less info. Put these in their own subfolder. The files without that string go in the parent directory.

```{r}
dir.create(here(symdir, "annotations", "job_annotations"))
```

Add symlinks to file dict.

```{r}
filedict$sym_mpif26_annotations <- file.path(
  symdir, "annotations", paste(filedict$t_number, "MPIF26","batch1", "annotations.xml", sep = "_")
  )

filedict$sym_mpif27_annotations <- file.path(
  symdir, "annotations", paste(filedict$t_number, "MPIF27","batch1", "annotations.xml", sep = "_")
  )
```

Create the symlinks

```{r}
#Will harmlessly give a "file exists" warning and return FALSE if already done
suppressWarnings(file.symlink(
  from = filedict$mpif26_annotations,
  to = filedict$sym_mpif26_annotations
))

suppressWarnings(file.symlink(
  from = filedict$mpif27_annotations,
  to = filedict$sym_mpif27_annotations
))
```

Now do the job annotations.

```{r}
filedict$sym_mpif26_job_annotations <- 
file.path(
  symdir, "annotations", "job_annotations", paste(filedict$t_number, "MPIF26","batch1", "job_annotations.xml", sep = "_")
  )

filedict$sym_mpif27_job_annotations <- 
file.path(
  symdir, "annotations", "job_annotations", paste(filedict$t_number, "MPIF27","batch1", "job_annotations.xml", sep = "_")
  )
```

```{r}
#Will harmlessly give a "file exists" warning and return FALSE if already done
suppressWarnings(file.symlink(
  from = filedict$mpif26_job_annotations,
  to = filedict$sym_mpif26_job_annotations
))

suppressWarnings(file.symlink(
  from = filedict$mpif27_job_annotations,
  to = filedict$sym_mpif27_job_annotations
))
```

## Write file dictionary

Contains original file location and symlink path for all of the result types.

```{r}
write_csv(filedict, here("data/metadata/spatial/00_file_location_dictionary.csv"))
```

```{r}
sessionInfo()
```
