---
title: "Marker correction"
author: "Kat Moore and Tycho Bismeijer"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    df_print: paged
    highlight: kate
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
ggplot2::theme_set(ggplot2::theme_bw())
```

```{r libraries}
library(fs)
library(here)
library(tidyverse)
```

Examine implausible marker corrections and, where possible, correct for them.

MPIF26 exclusive markers:  CD27, FoxP3
MPIF27 exclusive markers: CD138, CD8 
Shared markers: CD20, CD3, PanCK, DAPI

DAPI is used to visualize nuclear DNA. We have already established that all objects exported in this analysis are DAPI positive.

Worth noting is that although PanCk is broadly used as a "cancer marker", cytokeratins are also expressed on healthy epithelium (see: fibroblasts), PanCK double positivity on i.e. immune cells is a frequent problem due to the intensity of the adjacency between epithelial and immune cells. 

Also notable is that while CD138 was included as a plasma B-cell marker, it is [also expressed on malignant cells](https://pubmed.ncbi.nlm.nih.gov/14983940/).

## Load data

```{r load-mpif26}
mpif26 <- readRDS(here("data/vectra/interim/MPIF26_df.Rds"))
mpif26 <- mpif26[,sapply(mpif26, function(x) all(!is.nan(x)))]
colnames(mpif26) <- str_replace(colnames(mpif26), "_(nucleus|cytoplasm|membrane)_", "_")
```

```{r load-mpif27}
mpif27 <- readRDS(here("data/vectra/interim/MPIF27_df.Rds"))
mpif27 <- mpif27[,sapply(mpif27, function(x) all(!is.nan(x)))]
colnames(mpif27) <- str_replace(colnames(mpif27), "_(nucleus|cytoplasm|membrane)_", "_")
```

## Problematic marker combinations

We should not observe:

CD3+ CD20+
CD8+ CD20+
FOXP3+ CD20+

In principle, we should also not observe double positivity of PanCK and immune markers, nor CD138 and T cell markers, but these combinations may occur due to the high abundance of these markers, which causes spillover to adjacent cells.

Abundance of these combinations:

```{r count-cells}
cell_counts <- read_csv(here("results/spatial/cell_counts_by_marker.csv"))
```

Recall that:

MPIF26 exclusive markers:  CD27, FoxP3
MPIF27 exclusive markers: CD138, CD8 
Shared markers: CD20, CD3, PanCK, DAPI

```{r}
panel_markers <- cell_counts %>%
  pivot_wider(names_from=classifier_label, values_from=n) %>%
  mutate(count = Tumor + Stroma, .after=Stroma) %>%
  group_by(marker_pos, panel) %>%
  summarize(sum = sum(count), .groups="drop") %>%
  pivot_wider(names_from = panel, values_from=sum, values_fill = 0) %>%
  arrange(desc(MPIF27 + MPIF26))

panel_markers
```

PanCK/immune marker combinations:

```{r}
panel_markers %>%
  filter(str_detect(marker_pos, "PanCK") & str_detect(marker_pos, "CD"))
```


Also address:
CD8+CD3- (MPIF27)
CD27+CD3- (MPIF26)
CD20+_CD3+_CD8+ (MPIF27)
CD138+_CD8+ (MPIF27)
CD20+_CD8+

NK cells may sometimes express [CD8](https://journals.asm.org/doi/10.1128/JVI.01420-14) and [CD27](https://pubmed.ncbi.nlm.nih.gov/18326863/).

```{r}
panel_markers %>%
  filter(marker_pos %in% c(
    "CD20+_CD3+_DAPI+",
    "CD8+_DAPI+",
    "CD27+_DAPI+",
    "CD20+_CD3+_CD8+_DAPI+",
    "CD20+_CD8+_DAPI+"
  )) %>%
  mutate(marker_pos = str_remove(marker_pos, "_DAPI\\+"))
```

Additional impossible combinations exist within the data, but in relatively low numbers.

## Marker coexpression

Because we are plotting a few million points, this does take a few minutes to run, and it will only get worse as new samples come in. We therefore exclude the double negatives for each marker combo to reduce the total number of points.

```{r, coexpression_fn}
coexpression_plot <- function(marker1, marker2, df1 = mpif26, df2 = mpif27){
  
  pos1 <- paste0(marker1, "_positive")
  pos2 <- paste0(marker2, "_positive")
  intens1 <- paste0(marker1, "_intensity")
  intens2 <- paste0(marker2, "_intensity")
  
  if(pos1 %in% colnames(df1) & pos2 %in% colnames(df1) &
     pos1 %in% colnames(df2) & pos2 %in% colnames(df2)){
    #print("markers in both")
    df <- bind_rows(
      df1, df2
    )
  } else if (pos1 %in% colnames(df1) & pos2 %in% colnames(df1)) {
    df <- df1
  } else if (pos1 %in% colnames(df2) & pos2 %in% colnames(df2)) {
    df <- df2
  } else {
    stop("Provide a marker combination that exists in the same panel")
  }
  
  df <- df %>%
    select(t_number, panel, object_id, contains(marker1), contains(marker2))
  
  #Convert positivity logicals into strings
  df$marker1 <- if_else(df[,pos1]==T, paste0(marker1, "+"), paste0(marker1, "-"))
  df$marker2 <- if_else(df[,pos2]==T, paste0(marker2, "+"), paste0(marker2, "-"))
  df <- df %>%
    mutate(markers = paste0(marker1, marker2)) %>%
    select(-marker1, marker2)
  
  #Remove double negatives to improve runtime
  df <- df %>%
    filter(!(.data[[pos1]]==F & .data[[pos2]]==F))
  
  df %>%
    ggplot(aes_string(x = intens1, y = intens2, shape = "panel")) +
    geom_hex() +
    scale_fill_viridis_c(trans='log10') +
    ggtitle(paste(marker1, marker2, "coexpression"))
  

}  
```

### Implausible CD3 combinations

Many of the most abundant problematic markers combinations involve either the unexpected presence or the unexpected absence of CD3. Plot CD3 expression alongside problem markers.

```{r cd3_coexpression}
lapply(c("CD20", "CD138"), function(x){
  coexpression_plot("CD3", x)
})
```

```{r cd3_coexpression-sample}
lapply(c("CD20", "CD138"), function(x){
  coexpression_plot("CD3", x) +
    facet_wrap(~t_number)
})
```

There is no FACS-style cloud around which we can "gate" alternatively for any of these combinations.

### PanCK-immune coexpression

```{r panck_coexpression}
lapply(c("CD20", "CD3", "CD8","FoxP3", "CD27"), function(x){
  coexpression_plot("PanCK", x)
})
```

PanCK-CD20 coexpression does show signs of bleedthrough from PanCK into the CD20 channel. There is a smaller population of CD3 cells for which the same problem occurs. Check these two markers sample-wise.

```{r, fig.height=6}
lapply(c("CD20", "CD3", "CD8", "FoxP3", "CD27"), function(x){
  coexpression_plot("PanCK", x) +
    facet_wrap(~t_number)
})
```

There is definitely some sample-specific weirdness going on with PanCK-CD20 coexpression. PanCK-CD3 coexpression is less bizarre, but still shows aberrant behavior between samples. TODO: discuss with Tycho.

### Implausible CD20 coexpression

CD3-CD20 coexpression was covered above, let's look at the other exclusive T cell markers.

```{r, cd20_coexpression}
lapply(c("CD8", "FoxP3", "CD27"), function(x){
  coexpression_plot("CD20", x)
})
```

There is more overlap than usual between CD20-FoxP3+ and double positive cells than is usual - or maybe there are just fewer points here so they show up better?

```{r, cd20_coexpression_sample}
lapply(c("CD8", "FoxP3", "CD27"), function(x){
  coexpression_plot("CD20", x) +
    facet_wrap(~t_number)
})
```

These do not appear to show any major sample-specific aberrations.

## Missing and rare markers

### CD3-CD8+

```{r samples-that-miss-cd3-but-have-cd8}
cell_counts %>%
  filter(
    !str_detect(marker_pos, fixed('CD3+')),
    str_detect(marker_pos, fixed('CD8+')),
    n > 0) %>%
  arrange(desc(n))
```

### CD3-FoxP3+

```{r samples-that-miss-cd3-but-have-foxp3}
cell_counts %>%
  filter(
    !str_detect(marker_pos, fixed('CD3+')),
    str_detect(marker_pos, fixed('FoxP3+')),
    n > 0) %>%
  arrange(desc(n))
```

### CD20+CD138+

```{r cd20poscd138pos-samples}
cell_counts %>%
  filter(
    str_detect(marker_pos, fixed('CD20+')),
    str_detect(marker_pos, fixed('CD138+')),
    n > 0) %>%
  arrange(desc(n))

```

```{r}
sessionInfo()
```
