---
title: "PPBC density"
author: "Kat Moore"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    df_print: paged
    highlight: kate
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(ggpubr)
library(survival)
library(broom) #for converting coxph to tibble

theme_set(theme_bw())
```

## Load data

```{r}
density <- read_tsv(here("results/spatial/density.tsv"))
#head(density)

density %>%
  group_by(panel) %>%
  count()
```


The metadata is separated into three sheets.

```{r}
read_sheets_to_list <- function(xlsfile){
  readxl::excel_sheets(xlsfile) %>% 
    set_names() %>% 
    map(readxl::read_excel, path = xlsfile)
}

read_sheets_to_list(here("data/metadata/PPBC_metadata.xlsx"))
```

Here the t_number can be mapped to the patient_ID (via sample_ID).

```{r}
head(meta$sample_data)
```

Survival data can be found here.

```{r}
head(meta$patient_data)
```

Explanations are in the codebook.

```{r}
head(meta$codebook)
```


## Survival outcomes in PPBC

Join t_numbers with survival, link to density.

```{r}
dens <- meta$sample_data %>%
  filter(experimental_platform != "RNAseq" & !is.na(sample_ID)) %>%
  select(t_number = sample_ID, patient_ID) %>% distinct() %>%
  left_join(., meta$patient_data, by = "patient_ID") %>%
  left_join(density, ., by = "t_number")

stopifnot(nrow(filter(dens, is.na(death)))==0)

head(dens)
```

Four possible possible PPBC categories exist : 

* nulliparous breast cancer(non_prbc)
* pregnant breast cancer (prbc)
* post-partum breast cancer: lactating (ppbc_lac)
* post-partum breast cancer: involuting (ppbc_inv)

```{r}
unique(dens$study_group)
```


Format PPBC categories.

```{r}
dens <- dens %>%
  mutate(classifier_label = factor(classifier_label,
                                   levels = c("Stroma", "Tumor")),
         panel = factor(panel, levels = c("MPIF26", "MPIF27")),
         #Shorter group names, similar to study_group but clearer 
         #and with no potential delimiters
         group = case_when(
           study_group == "ppbc_inv" ~ "inv",
           study_group == "non_prbc" ~ "nonprbc",
           study_group == "ppbc_lac" ~ "lac",
           TRUE ~ study_group) 
         ) %>%
  mutate(group = factor(group, levels = c("nonprbc", "prbc", "lac", "inv"))) %>%
  relocate(group, .after = study_group)

dens %>%
  select(study_group, group) %>%
  distinct()
```

Cell types by panel:

```{r}
bind_cols (
  dens %>%
    filter(panel == "MPIF26") %>%
    select(MPIF26 = cell_type) %>%
    distinct(),
  dens %>%
    filter(panel == "MPIF27") %>%
    select(MPIF27 = cell_type) %>%
    distinct()
)
```

## Density by group

Number of samples per study group (will improve):

```{r}
dens %>%
  select(t_number, panel, study_group, group) %>%
  distinct() %>%
  group_by(panel, group) %>%
  count() %>%
  pivot_wider(names_from = panel, values_from = n)
```

With n=3, not enough to do stats on pregnant for now. But we include it because we expect more samples in the pregnant group in subsequent batches.

```{r}
#Reshape results of pairwise wilcox tests between groups, so that
#every cell type can be reported in a single row
reshape_pairwise <- function(pairwise_res){
  pairwise_res$p.value %>%
    as.data.frame() %>% rownames_to_column("group") %>%
    pivot_longer(cols = c(-group),names_to = "group2", values_to = "wilcox.bh") %>%
    filter(!is.na(wilcox.bh)) %>%
    mutate(pairwise.wilcox = paste(group, group2, sep = "_vs_")) %>%
    select(-group, -group2) %>%
    pivot_wider(names_from = pairwise.wilcox, values_from = wilcox.bh,
                names_glue = "{pairwise.wilcox}_bh")
}

#Perform both kruskal wallis and pairwise wilcox tests on each cell type and panel
#for tumor and stroma separately
stat_density <- function(df,
                         panel = c("MPIF26", "MPIF27"),
                         cell_type){
  
  stopifnot(cell_type %in% unique(df$cell_type))
  
  df <- filter(df, panel == {{panel}})
  df <- df %>% filter(cell_type == {{cell_type}})
  
  #Test between all study_group groups together for tumor
  krusk <- tibble(
   cell_type = {{cell_type}},
   panel = {{panel}},
   kruskal_p = kruskal.test(density ~ study_group, data = df)$p.value
  )

  pairwise <- pairwise.wilcox.test(df$density, df$short_name,
                 p.adjust.method = "BH")
  pairwise <- reshape_pairwise(pairwise)
  
  res <- cbind(krusk, pairwise)
  res
  }

#Testing
#stat_density(df = filter(dens, classifier_label == "Tumor"), panel = "MPIF26", cell_type = "FoxP3+")

combi_dens <- function(df, cell_type){
  #Separate stroma and tumor
  tum <- filter(df, classifier_label == "Tumor")
  strom <- filter(df, classifier_label == "Stroma")
  #return(tum)
  
  mpif26_cells <- df %>% filter(panel == "MPIF26") %>% pull(cell_type) %>%
    unique()
  
  mpif27_cells <- df %>% filter(panel == "MPIF27") %>% pull(cell_type) %>%
    unique()
  
  #Density for stroma and tumor separately, skipping panels if the cell type is absent
  if(cell_type %in% mpif26_cells & cell_type %in% mpif27_cells){
    #print("Both panels")
    
    tum <- bind_rows(
      stat_density(tum, panel = "MPIF26", cell_type = cell_type),
      stat_density(tum, panel = "MPIF27", cell_type = cell_type)
    ) %>% mutate(classifier_label = "Tumor")
    
    strom <- bind_rows(
      stat_density(strom, panel = "MPIF26", cell_type = cell_type),
      stat_density(strom, panel = "MPIF27", cell_type = cell_type)
    ) %>% mutate(classifier_label = "Stroma")
    
    res <- bind_rows(tum,strom)
    
  } else if (cell_type %in% mpif26_cells) {
    
    tum <- stat_density(tum, panel = "MPIF26", cell_type = cell_type) %>%
      mutate(classifier_label = "Tumor")
    
    strom <- stat_density(strom, panel = "MPIF26", cell_type = cell_type) %>%
                  mutate(classifier_label = "Stroma")
    
    res <-  bind_rows(tum, strom)
      
  } else if (cell_type %in% mpif27_cells){
    
    tum <- stat_density(tum, panel = "MPIF27", cell_type = cell_type) %>%
      mutate(classifier_label = "Tumor")
    
    strom <- stat_density(strom, panel = "MPIF27", cell_type = cell_type) %>%
                  mutate(classifier_label = "Stroma")
    
    res <- bind_rows(tum, strom)
      
  } else {
    stop("Provide a valid cell type")
  }
  res %>%
    relocate(classifier_label, .after = panel)
  
}


density_by_ppbc <- lapply(unique(dens$cell_type), function(x){
  combi_dens(df = dens, cell_type = x)
  }) %>%
  bind_rows() %>%
  #Panels are treated separately, should BH be calculated separately for regions?
  group_by(panel, classifier_label) %>%
  mutate(kruskal_bh = p.adjust(kruskal_p), .after = kruskal_p)

density_by_ppbc
```

Show significant comparisons based on multiple testing correction.

```{r}
#bhs <- colnames(density_by_ppbc)[str_detect(colnames(density_by_ppbc), "_bh")]

density_by_ppbc %>%
  #filter(.data[[bhs[1]]] < 0.05) #No groupwise OR?
  filter(
    kruskal_bh < 0.05 |
      prbc_vs_nonprbc_bh < 0.05 |
      inv_vs_nonprbc_bh < 0.05 |
      inv_vs_prbc_bh < 0.05
  )
```

### Beehive plots

The p values in these plots do not include multiple testing correction. Kruskal-Wallis for all PPBC groups alongside pairwise Wilcoxon tests are shown. The y axis is square-root-transformed.

```{r}
plot_density <- function(df = dens,
                       panel = c("MPIF26", "MPIF27"),
                       cell_type, colorby){
  
  stopifnot(cell_type %in% unique(df$cell_type))
  
  df <- filter(df, panel == {{panel}})
  df <- df %>% filter(cell_type == {{cell_type}})
  
  comps <- list(c("nulliparous", "pregnant"),
                c("nulliparous", "involuting"),
                c("pregnant", "involuting")
                )
  
  df %>%
    ggplot(aes(x = study_group, y = density)) +
    geom_boxplot(alpha = 0) +
    geom_jitter(aes(color = get(colorby)), height = 0 ) +
    facet_wrap(~classifier_label) +
    labs(color = colorby, y = paste({{cell_type}}, "density")) +
    stat_compare_means() +#KW test all samples
    stat_compare_means(comparisons = comps) +#pairwise
    ggtitle(paste({{panel}}, {{cell_type}}))
  }

#Testing
#plot_density(panel = "MPIF26", cell_type = "FoxP3+", colorby = "clin_subtype")
```

MPIF26

```{r}
lapply(unique(filter(dens, panel == "MPIF26")$cell_type),
       function(x) {
         plot_density(panel = "MPIF26", cell_type = x, colorby = "clin_subtype") +
           scale_y_sqrt()
       })
```

MPIF27

```{r}
lapply(unique(filter(dens, panel == "MPIF27")$cell_type),
       function(x) {
         plot_density(panel = "MPIF27", cell_type = x, colorby = "clin_subtype") +
           scale_y_sqrt()
       })
```

## Cox regression

Start with a limited number of covariates. Potential additional covariates (see `12_genewise_survival.R`): 

age_at_diagnosis
stage
grade
surgery
radiotherapy
strata(hormonetherapy)
chemotherapy
herceptin
strata(PAM50)

Probably not PAM50, since that will be correlated with immune cell density. Same is possibly true of treatment interventions.

Fit separate models for each cell_type/tumor vs stroma/panel.
Stratify PPBC to allow separate baseline hazards functions for each PPBC subgroup.

```{r}
cox_density <- function(df, panel, cell_type){
  
  df <- df %>% filter(panel == {{panel}}, cell_type == {{cell_type}})
  df <- df %>%
    select(-n, -area) %>%
    pivot_wider(names_from = classifier_label, values_from = density,
                values_fill = NA, names_glue = "{classifier_label}_density")
  
  tum <- coxph(Surv(time = months_of_followup, event = overall_survival) ~ strata(study_group) + Tumor_density,
        data = as.data.frame(df)) %>%
    #Very convenient!
    broom::tidy(conf.int = T) %>%
    mutate(HR = exp(estimate),.after=estimate) %>%
    mutate(cell_type = {{cell_type}},
           panel = {{panel}},
           .after=term)
  
  strom <- coxph(Surv(time = months_of_followup, event = overall_survival) ~ strata(study_group) + Stroma_density,
        data = as.data.frame(df)) %>%
    broom::tidy(conf.int = T) %>%
    mutate(HR = exp(estimate),.after=estimate) %>%
    mutate(cell_type = {{cell_type}},
           panel = {{panel}},
           .after=term)
  
  bind_rows(tum, strom)
}

#testing
cox_density(dens, "MPIF26", "FoxP3+")
cox_density(dens, "MPIF26", "CD20+")
cox_density(dens, "MPIF27", "CD20+")

```

```{r}
all_cox_density <- function(df, cell_type){
  
  df <- df %>% filter(cell_type == {{cell_type}})
  
  mpif26_cells <- df %>% filter(panel == "MPIF26") %>% pull(cell_type) %>%
    unique()
  
  mpif27_cells <- df %>% filter(panel == "MPIF27") %>% pull(cell_type) %>%
    unique()
  
  #Skip regression if cell type is absent
  if(cell_type %in% mpif26_cells & cell_type %in% mpif27_cells){
    res <- bind_rows(
      cox_density(df, "MPIF26", cell_type),
      cox_density(df, "MPIF27", cell_type)
    )
  } else if (cell_type %in% mpif26_cells) {
    res <- cox_density(df, "MPIF26", cell_type)
  } else if (cell_type %in% mpif27_cells){
    res <- cox_density(df, "MPIF27", cell_type)
  } else {
    stop("Provide a valid cell type")
  }
  res
}

relevant_cells <- unique(dens$cell_type)
relevant_cells <- relevant_cells[!relevant_cells %in% c("PanCK+", "Other")]

cox_df <- lapply(relevant_cells, function(x){
  all_cox_density(dens, x)
}) %>%
  bind_rows() %>%
  group_by(panel) %>%
  mutate(fdr = p.adjust(p.value, method = "BH"), .after= panel) %>%
  relocate(p.value, .after=fdr)

cox_df
```


```{r}
sessionInfo()
```

