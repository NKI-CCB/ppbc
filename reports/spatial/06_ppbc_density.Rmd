---
author: "Kat Moore"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    df_print: paged
    highlight: kate
params:
  outcome:
    label: "Survival outcome type"
    value: "OS"
    input: "select"
    choice: ["OS", "DRS"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, libraries}
library(tidyverse)
library(here)
library(ggpubr)
library(survival)
library(survminer)
library(broom) #for converting coxph to tibble

theme_set(theme_bw())
```

This notebook reports on the relationship between cell densities and the following clinical outcome:

```{r}
outcome <- params$outcome
ptitle <- ifelse(outcome == "OS", "Overall survival", "Distant recurrence")
print(ptitle)
```

---
title: `r paste("PPBC density:", ptitle)`
---

## Load data

```{r}
dens <- readRDS(here("data/vectra/processed/density_ppbc.Rds"))
```

## Cell types by panel:

```{r}
bind_cols (
  dens %>%
    filter(panel == "MPIF26") %>%
    select(MPIF26 = cell_type) %>%
    distinct(),
  dens %>%
    filter(panel == "MPIF27") %>%
    select(MPIF27 = cell_type) %>%
    distinct()
)
```

## Samples per group

Number of samples per study group:

```{r}
dens %>%
  select(t_number, panel, study_group, group) %>%
  distinct() %>%
  group_by(panel, group) %>%
  count() %>%
  pivot_wider(names_from = panel, values_from = n)
```


## Cox regression input

Samples per PPBC study group.

```{r}
dens %>%
  select(t_number, stage, study_group, group) %>%
  distinct() %>%
  group_by(stage, group) %>%
  count() %>%
  pivot_wider(names_from = stage, values_from = n)
```

Not enough samples to include prbc and lac, or stage IV samples.

```{r}
cox_dens <- dens %>%
  filter(! group %in% c("prbc", "lac")) %>%
  filter(stage != "stage IV")

cox_dens <- droplevels(cox_dens)

cox_dens %>%
  select(t_number, stage, study_group, group) %>%
  distinct() %>%
  group_by(stage, group) %>%
  count() %>%
  pivot_wider(names_from = stage, values_from = n)
```

## OS density

Overall impact of density independent of study group.

Fit separate models for each cell_type/tumor vs stroma/panel. P value is calculated by a likelihood ratio test (LRT) that compares the fit of the Cox model with the fit of a reduced model that does not contain the covariate of interest. Hazard ratios and confidence intervals are obtained from the covariate of interest in the full model.

### Univariate

```{r}
#Reshapes density data frame prior to running Cox models and separates tumor from stroma
cox_reshape <- function(df){
  #Separate tumor and stroma densities to prevent unintentional sample duplication
  tum_df <- df %>%
    select(-n, -area) %>%
    filter(classifier_label == "Tumor") %>%
    pivot_wider(names_from = classifier_label, values_from = density,
                values_fill = 0, names_glue = "{classifier_label}_density") %>%
    relocate(Tumor_density, .before = everything())
  
  str_df <- df %>%
    select(-n, -area) %>%
    filter(classifier_label == "Stroma") %>%
    pivot_wider(names_from = classifier_label, values_from = density,
                values_fill = 0, names_glue = "{classifier_label}_density") %>%
    relocate(Stroma_density, .before = everything())
  
  return(list(tumor = tum_df, stroma = str_df))
}

#performs both an LRT between the full and reduced Cox models and
#extracts estimates and HR from the coefficient of interest, then tidies results
tidy_cox <- function(reduced_fit, full_fit, cell_type, panel){
  lrt <- anova(reduced_fit, full_fit) %>% broom::tidy()
  full_fit %>%
    broom::tidy(conf.int = T) %>%
    mutate(HR = exp(estimate),.after=estimate) %>%
    mutate(cell_type = {{cell_type}},
           panel = {{panel}},
           .after=term) %>%
    mutate(lrt.pval = lrt$p.value[[2]],
           lrt.logLik = lrt$logLik[[2]],
           lrt.statistic =  lrt$statistic[[2]],
           .after = panel) %>%
    rename(coef.estimate = estimate,
           coef.statistic = statistic,
           coef.pval = p.value)
}

cox_density <- function(df, panel, cell_type, f, testing = F){
  
  #Subset by panel and celltype
  df <- df %>% filter(panel == {{panel}}, cell_type == {{cell_type}})
  
  #Reshape the data frame for Cox regression
  tum_df <- cox_reshape(df)$tumor
  str_df <- cox_reshape(df)$stroma
  
  #If t_numbers are duplicated, something is wrong
  stopifnot(nrow(filter(tum_df, duplicated(t_number)))==0 &
              nrow(filter(str_df, duplicated(t_number)))==0)
  
  #testing
  if(testing){
    reduced_fit = coxph(as.formula(f), data = as.data.frame(tum_df))
    full_fit = coxph(as.formula(paste(f, "Tumor_density", sep = "+")),
                            data = as.data.frame(tum_df))
    return(
      list(fulltumor = coxph(as.formula(paste(f, "Tumor_density", sep = "+")),
                             data = as.data.frame(tum_df)),
           anovatumor = anova(reduced_fit, full_fit)
      ))
  }
  
  #Perform Cox regression and LRT for tumor and stroma
  tum <- tidy_cox(
    reduced_fit = coxph(as.formula(f), data = as.data.frame(tum_df)),
    full_fit = coxph(as.formula(paste(f, "Tumor_density", sep = "+")),
                     data = as.data.frame(tum_df)),
    cell_type, panel
  ) %>%
    mutate(term = str_replace(term, "stage", "tumor "))

  strom <- tidy_cox(
    reduced_fit = coxph(as.formula(f), data = as.data.frame(str_df)),
    full_fit = coxph(as.formula(paste(f, "Stroma_density", sep = "+")),
                     data = as.data.frame(str_df)),
    cell_type, panel
  ) %>%
    mutate(term = str_replace(term, "stage", "tumor "))
  
  bind_rows(tum, strom)
}

#Use the intercept as the reduced formula for univarate analysis
cox_density(cox_dens, "MPIF27", "CD3-CD8+",
            f = "Surv(time = time_OS_months, event = death) ~ 1")
```

#### Results

```{r}
all_cox_density <- function(df, cell_type, f, testing = F){
  
  df <- df %>% filter(cell_type == {{cell_type}})
  
  mpif26_cells <- df %>% filter(panel == "MPIF26") %>% pull(cell_type) %>%
    unique()
  
  mpif27_cells <- df %>% filter(panel == "MPIF27") %>% pull(cell_type) %>%
    unique()
  
  #Skip regression if cell type is absent in that panel
  if(cell_type %in% mpif26_cells & cell_type %in% mpif27_cells){
    res <- bind_rows(
      cox_density(df, "MPIF26", cell_type, f),
      cox_density(df, "MPIF27", cell_type, f)
    )
  } else if (cell_type %in% mpif26_cells) {
    res <- cox_density(df, "MPIF26", cell_type, f)
  } else if (cell_type %in% mpif27_cells){
    res <- cox_density(df, "MPIF27", cell_type, f)
  } else {
    stop("Provide a valid cell type")
  }
  
  #Remove non-density entries from output
  res <- res %>% filter(str_detect(term, "density"))
  res
}

relevant_cells <- unique(cox_dens$cell_type)
relevant_cells <- relevant_cells[!relevant_cells %in% c("PanCK+", "Other")]

univ_cox <- lapply(relevant_cells, function(x){
  all_cox_density(cox_dens, x,
                  f = "Surv(time = time_OS_months, event = death) ~ 1")
}) %>%
  bind_rows() %>%
  # group_by(panel) %>% #Debatable
  mutate(lrt.fdr = p.adjust(lrt.pval, method = "BH"), .after = panel) %>%
  mutate(formula = "Surv(time = time_OS_months, event = death) ~ 1 + Density")

univ_cox %>%
  arrange(lrt.fdr, lrt.pval)
```

Reshape by region, split by panel

```{r}
univ_cox %>%
  select(cell_type, term, lrt.fdr, panel, lrt.pval) %>%
  arrange(lrt.fdr, lrt.pval) %>%
  pivot_wider(names_from = term, values_from = c(lrt.fdr, lrt.pval,
                                                 #n_total
                                                 )) %>%
  split(., .$panel)
```

### Multivariate

Start with a limited number of covariates. Potential covariates (see `12_genewise_survival.R`): 

stage
age_at_diagnosis
grade
surgery
radiotherapy
strata(hormonetherapy)
chemotherapy
herceptin
strata(PAM50)

Probably not PAM50, since that will be correlated with immune cell density. Same is possibly true of treatment interventions.
Stratify PPBC to allow separate baseline hazards functions for each PPBC subgroup.

```{r}
#Example one cell type
#The LRT pval is the same for all the covariates because 
#it's a comparison between the full and reduced model
#However, covariate estimates should be different
cox_density(cox_dens, "MPIF27", "CD3-CD8+",
            f = "Surv(time = time_OS_months, event = death) ~ strata(group) + stage",
            testing=T)

cox_density(cox_dens, "MPIF27", "CD3-CD8+",
            f = "Surv(time = time_OS_months, event = death) ~ strata(group) + stage")

```

#### Results 

```{r}
relevant_cells <- unique(cox_dens$cell_type)
relevant_cells <- relevant_cells[!relevant_cells %in% c("PanCK+", "Other")]

mult_cox <- lapply(relevant_cells, function(x){
  all_cox_density(cox_dens, x,
                  f = "Surv(time = time_OS_months, event = death) ~ strata(group) + stage")
}) %>%
  bind_rows() %>%
  # group_by(panel) %>% #Debatable
  mutate(lrt.fdr = p.adjust(lrt.pval, method = "BH"), .after = panel) %>%
  mutate(formula = "Surv(time = time_OS_months, event = death) ~ strata(group) + stage + density")

mult_cox %>%
  arrange(lrt.fdr, lrt.pval)
```

Reshape by region, split by panel

```{r}
mult_cox %>%
  select(cell_type, term, lrt.fdr, panel, lrt.pval) %>%
  arrange(lrt.fdr, lrt.pval) %>%
  pivot_wider(names_from = term, values_from = c(lrt.fdr, lrt.pval,
                                                 #n_total
                                                 )) %>%
  split(., .$panel)
```

### Standard Kaplan-Meier plots

KMs require categorical variables. Convert density into quantiles.

Separate kaplan meiers are shown for tumor and stroma because the two will be correlated. P values are from logrank tests.

```{r}
km_plot <- function(df, panel, cell_type, f, outcome){
  #Region and km_coef are currently unused, but kept for the wrapper function  
  df <- df %>% filter(panel == {{panel}}, cell_type == {{cell_type}})
  
  #Separate tumor and stroma densities to prevent unintentional sample duplication
  tum_df <- cox_reshape(df)$tumor
  str_df <- cox_reshape(df)$stroma
  
  #Add density ntiles
  tum_df <- tum_df %>%
    mutate(ntile = dplyr::ntile(Tumor_density, 3), .after=Tumor_density)
  #return(tum_df)
  str_df <- str_df %>%
    mutate(ntile = dplyr::ntile(Stroma_density, 3), .after=Stroma_density)
  
  list(
    tumor = survminer::ggsurvplot(
      fit = survminer::surv_fit(as.formula(f), data = as.data.frame(tum_df)), 
      facet.by = "study_group",
      xlab = "Months", 
      ylab = paste(outcome, "probability"),
      title = paste("Kaplan-meier for", cell_type, "tumor density in", panel),
      pval = T #Logrank method
    ),  
    stroma = survminer::ggsurvplot(
      fit = survminer::surv_fit(as.formula(f), data = as.data.frame(str_df)), 
      facet.by = "study_group",
      xlab = "Months", 
      ylab = paste(outcome, "probability"),
      title = paste("Kaplan-meier for", cell_type, "stroma density in", panel),
      pval = T #Logrank method
    )
    )
}

#testing
 km_plot(cox_dens, panel = "MPIF26", cell_type = "CD20+", outcome = "Survival",
         f = "Surv(time = time_OS_months, event = death) ~ ntile")
```

MPIF26

```{r}
cells_to_plot <- unique(filter(cox_dens, panel == "MPIF26")$cell_type)
cells_to_plot <- cells_to_plot[!cells_to_plot %in% c("PanCK+", "Other")]

lapply(cells_to_plot, function(x){
  km_plot(cox_dens, panel = "MPIF26", cell_type = x, outcome = "Survival",
        f = "Surv(time = time_OS_months, event = death) ~ ntile")
}) %>% set_names(cells_to_plot)
```

MPIF27

```{r}
cells_to_plot <- unique(filter(cox_dens, panel == "MPIF27")$cell_type)
cells_to_plot <- cells_to_plot[!cells_to_plot %in% c("PanCK+", "Other")]

lapply(cells_to_plot, function(x){
  km_plot(cox_dens, panel = "MPIF27", cell_type = x, outcome = "Survival",
        f = "Surv(time = time_OS_months, event = death) ~ ntile")
}) %>% set_names(cells_to_plot)
```


## OS grouped subsets

Check significance in involution samples and nulliparous samples separately.

Involution samples:

```{r}
inv_dens <- filter(cox_dens, group == "inv")
inv_dens <- droplevels(inv_dens)

inv_dens %>%
  select(t_number, stage, study_group, group) %>%
  distinct() %>%
  group_by(group, stage) %>%
  distinct() %>%
  count()
```

Nulliparous samples:

```{r}
np_dens <- filter(cox_dens, group == "nonprbc")
np_dens <- droplevels(np_dens)

np_dens %>%
  select(t_number, stage, study_group, group) %>%
  distinct() %>%
  group_by(group, stage) %>%
  distinct() %>%
  count()
```

### Univariate

As above, but split by group.

#### Involution

```{r}
relevant_cells <- unique(cox_dens$cell_type)
relevant_cells <- relevant_cells[!relevant_cells %in% c("PanCK+", "Other")]

inv_univ_cox <- lapply(relevant_cells, function(x){
  all_cox_density(inv_dens, x,
                  f = "Surv(time = time_OS_months, event = death) ~ 1")
}) %>%
  bind_rows() %>%
  # group_by(panel) %>% #Debatable
  mutate(lrt.fdr = p.adjust(lrt.pval, method = "BH"), .after = panel) %>%
  mutate(formula = "Surv(time = time_OS_months, event = death) ~ 1 + Density")

inv_univ_cox %>%
  arrange(lrt.fdr, lrt.pval)
```

Reshape by region, split by panel

```{r}
inv_univ_cox %>%
  select(cell_type, term, lrt.fdr, panel, lrt.pval) %>%
  arrange(lrt.fdr, lrt.pval) %>%
  pivot_wider(names_from = term, values_from = c(lrt.fdr, lrt.pval,
                                                 #n_total
                                                 )) %>%
  split(., .$panel)
```

MPIF26

```{r}
cells_to_plot <- unique(filter(cox_dens, panel == "MPIF26")$cell_type)
cells_to_plot <- cells_to_plot[!cells_to_plot %in% c("PanCK+", "Other")]

lapply(cells_to_plot, function(x){
  km_plot(inv_dens, panel = "MPIF26", cell_type = x, outcome = "Survival",
        f = "Surv(time = time_OS_months, event = death) ~ ntile")
}) %>% set_names(cells_to_plot)
```

MPIF27

```{r}
cells_to_plot <- unique(filter(cox_dens, panel == "MPIF27")$cell_type)
cells_to_plot <- cells_to_plot[!cells_to_plot %in% c("PanCK+", "Other")]

lapply(cells_to_plot, function(x){
  km_plot(inv_dens, panel = "MPIF27", cell_type = x, outcome = "Survival",
        f = "Surv(time = time_OS_months, event = death) ~ ntile")
}) %>% set_names(cells_to_plot)
```

#### Nulliparous

```{r}
relevant_cells <- unique(cox_dens$cell_type)
relevant_cells <- relevant_cells[!relevant_cells %in% c("PanCK+", "Other")]

np_univ_cox <- lapply(relevant_cells, function(x){
  all_cox_density(np_dens, x,
                  f = "Surv(time = time_OS_months, event = death) ~ 1")
}) %>%
  bind_rows() %>%
  # group_by(panel) %>% #Debatable
  mutate(lrt.fdr = p.adjust(lrt.pval, method = "BH"), .after = panel) %>%
  mutate(formula = "Surv(time = time_OS_months, event = death) ~ 1 + Density")

np_univ_cox %>%
  arrange(lrt.fdr, lrt.pval)
```

Reshape by region, split by panel

```{r}
np_univ_cox %>%
  select(cell_type, term, lrt.fdr, panel, lrt.pval) %>%
  arrange(lrt.fdr, lrt.pval) %>%
  pivot_wider(names_from = term, values_from = c(lrt.fdr, lrt.pval,
                                                 #n_total
                                                 )) %>%
  split(., .$panel)
```

MPIF26

```{r}
cells_to_plot <- unique(filter(cox_dens, panel == "MPIF26")$cell_type)
cells_to_plot <- cells_to_plot[!cells_to_plot %in% c("PanCK+", "Other")]

lapply(cells_to_plot, function(x){
  km_plot(np_dens, panel = "MPIF26", cell_type = x, outcome = "Survival",
        f = "Surv(time = time_OS_months, event = death) ~ ntile")
}) %>% set_names(cells_to_plot)
```

MPIF27

```{r}
cells_to_plot <- unique(filter(cox_dens, panel == "MPIF27")$cell_type)
cells_to_plot <- cells_to_plot[!cells_to_plot %in% c("PanCK+", "Other")]

lapply(cells_to_plot, function(x){
  km_plot(np_dens, panel = "MPIF27", cell_type = x, outcome = "Survival",
        f = "Surv(time = time_OS_months, event = death) ~ ntile")
}) %>% set_names(cells_to_plot)
```

### Multivariate

Given the lack of insight from the adjusted multivariate curves, Kaplan-Meiers are omitted from this analysis.

#### Involution

```{r}
inv_mult_cox <- lapply(relevant_cells, function(x){
  all_cox_density(inv_dens, x,
                  f = "Surv(time = time_OS_months, event = death) ~  stage")
}) %>%
  bind_rows() %>%
  # group_by(panel) %>% #Debatable
  mutate(lrt.fdr = p.adjust(lrt.pval, method = "BH"), .after = panel) %>%
  mutate(formula = "Surv(time = time_OS_months, event = death) ~  stage + density")

inv_mult_cox %>%
  arrange(lrt.fdr, lrt.pval)
```

Reshape by region, split by panel

```{r}
inv_mult_cox %>%
  select(cell_type, term, lrt.fdr, panel, lrt.pval) %>%
  arrange(lrt.fdr, lrt.pval) %>%
  pivot_wider(names_from = term, values_from = c(lrt.fdr, lrt.pval,
                                                 #n_total
                                                 )) %>%
  split(., .$panel)
```

#### Nulliparous

```{r}
np_mult_cox <- lapply(relevant_cells, function(x){
  all_cox_density(np_dens, x,
                  f = "Surv(time = time_OS_months, event = death) ~ stage")
}) %>%
  bind_rows() %>%
  # group_by(panel) %>% #Debatable
  mutate(lrt.fdr = p.adjust(lrt.pval, method = "BH"), .after = panel) %>%
  mutate(formula = "Surv(time = time_OS_months, event = death) ~ stage + density")

np_mult_cox %>%
  arrange(lrt.fdr, lrt.pval)
```

```{r}
np_mult_cox %>%
  select(cell_type, term, lrt.fdr, panel, lrt.pval) %>%
  arrange(lrt.fdr, lrt.pval) %>%
  pivot_wider(names_from = term, values_from = c(lrt.fdr, lrt.pval,
                                                 #n_total
                                                 )) %>%
  split(., .$panel)
```


## OS interaction involution

Interaction term between group and cell density. We don't expect much to be significant here due to lack of samples (TODO check with power analysis).

```{r}
#Ensure we have the two levels we expect
levels(cox_dens$group)
```

The formula below works very similarly to `cox_density()`, except that a formula with an interaction term is automatically generated.

```{r}
cox_interaction <- function(df, panel, cell_type, baseform, testing=F){
  
  df <- df %>% filter(panel == {{panel}}, cell_type == {{cell_type}})
  
  tum_df <- cox_reshape(df)$tumor
  str_df <- cox_reshape(df)$stroma
  
  stopifnot(nrow(filter(tum_df, duplicated(t_number)))==0 &
              nrow(filter(str_df, duplicated(t_number)))==0)
  f_tumor <- as.formula(paste(baseform, paste("group", "Tumor_density",sep=":"), sep = "+"))
  f_stroma <- as.formula(paste(baseform, paste("group", "Stroma_density",sep=":"), sep = "+"))
  #return(f_tumor)
  
  
  if(testing){
    reduced_fit = coxph(as.formula(baseform), data = as.data.frame(tum_df))
    full_fit = coxph(as.formula(f_tumor),
                            data = as.data.frame(tum_df))
    return(
      list(fulltumor = coxph(as.formula(f_tumor),
                             data = as.data.frame(tum_df)),
           anovatumor = anova(reduced_fit, full_fit)
      ))
  }
  
  #Perform Cox regression and LRT for tumor and stroma
  tum <- tidy_cox(
    reduced_fit = coxph(as.formula(baseform), data = as.data.frame(tum_df)),
    full_fit = coxph(as.formula(f_tumor),
                     data = as.data.frame(tum_df)),
    cell_type, panel
  ) %>%
    mutate(term = str_replace(term, "stage", "tumor "))

  strom <- tidy_cox(
    reduced_fit = coxph(as.formula(baseform), data = as.data.frame(str_df)),
    full_fit = coxph(as.formula(f_stroma),
                     data = as.data.frame(str_df)),
    cell_type, panel
  ) %>%
    mutate(term = str_replace(term, "stage", "tumor "))

  bind_rows(tum, strom) %>%
    mutate(term = str_remove(term, "group"))
}
#testing
cox_interaction(cox_dens, "MPIF26", "CD20+",
                baseform = "Surv(time = time_OS_months, event = death) ~ stage",
                testing = T)
cox_interaction(cox_dens, "MPIF26", "CD20+",
                baseform = "Surv(time = time_OS_months, event = death) ~ stage")
```

### Results by significance

Also the wrapper function is similar to `all_cox_density()`, except that it invokes `cox_interaction` instead of `cox_density`.

```{r}
all_cox_interaction <- function(df, cell_type, baseform){
  
  df <- df %>% filter(cell_type == {{cell_type}})
  
  mpif26_cells <- df %>% filter(panel == "MPIF26") %>% pull(cell_type) %>%
    unique()
  
  mpif27_cells <- df %>% filter(panel == "MPIF27") %>% pull(cell_type) %>%
    unique()
  
  #Skip regression if cell type is absent
  if(cell_type %in% mpif26_cells & cell_type %in% mpif27_cells){
    res <- bind_rows(
      cox_interaction(df, "MPIF26", cell_type, baseform),
      cox_interaction(df, "MPIF27", cell_type, baseform)
    )
  } else if (cell_type %in% mpif26_cells) {
    res <- cox_interaction(df, "MPIF26", cell_type, baseform)
  } else if (cell_type %in% mpif27_cells){
    res <- cox_interaction(df, "MPIF27", cell_type, baseform)
  } else {
    stop("Provide a valid cell type")
  }
  
  #Remove non-density entries from output
  res <- res %>% filter(str_detect(term, "density"))
  res
}

relevant_cells <- unique(cox_dens$cell_type)
relevant_cells <- relevant_cells[!relevant_cells %in% c("PanCK+", "Other")]

interaction_df <- lapply(relevant_cells, function(x){
  all_cox_interaction(cox_dens, x, 
                      baseform = "Surv(time = time_OS_months, event = death) ~ stage")
}) %>%
 bind_rows() %>%
  #Only show the involution-related interaction terms
  filter(str_detect(term, "inv")) %>%
  mutate(lrt.fdr = p.adjust(lrt.pval, method = "BH"), .after = panel) %>%
  mutate(formula = "Surv(time = time_OS_months, event = death) ~ stage + group:density")

interaction_df %>%
  arrange(lrt.fdr, lrt.pval)
```

```{r}
interaction_df %>%
  select(cell_type, term, lrt.fdr, panel, lrt.pval) %>%
  arrange(lrt.fdr, lrt.pval) %>%
  pivot_wider(names_from = term, values_from = c(lrt.fdr, lrt.pval,
                                                 #n_total
                                                 )) %>%
  split(., .$panel)
```


Kaplan-meiers are not relevant for Cox formulas that contain interaction terms.

```{r}
sessionInfo()
```

