---
title: "Define cell types"
author: "Kat Moore"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    df_print: paged
    highlight: kate
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(fs)
library(tidyverse)

#source(here('src/spatial/read_cells.R'))
theme_set(theme_bw())
```

Define cell types based on marker expression. Also, correct for impossible marker combinations.

MPIF26 exclusive markers:  CD27, FoxP3
MPIF27 exclusive markers: CD138, CD8 
Shared markers: CD20, CD3, PanCK, DAPI

DAPI is used to visualize nuclear DNA. We have already established that all objects exported in this analysis are DAPI positive.

Worth noting is that although PanCk is broadly used as a "cancer marker", cytokeratins are also expressed on healthy epithelium (see: fibroblasts), PanCK double positivity on i.e. immune cells is a frequent problem due to the intensity of the adjacency between epithelial and immune cells. 

Also notable is that while CD138 was included as a plasma B-cell marker, it is [also expressed on malignant cells](https://pubmed.ncbi.nlm.nih.gov/14983940/).

We broadly define the following cell types:

* Cytotoxic T-cell (CD8+, CD3+)
* T-reg (CD3+, FoxP3+)
* Helper T-cell (CD3+, CD8-, FoxP3-)
* B-cell (CD20+, CD138-)
* Plasma B-cell (CD20+, CD138+)
* NK cell (CD8+, CD3- or CD27+, CD3-)
* Epithelial cell (PanCK+ and negative for immune markers)

Here we are assuming that CD3+CD8-FoxP3- are *probably* CD4+, since double-negative T-cells represent a [small (1-5%) populatoin of lymphocytes](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3269300/). One may also argue that not all CD8+ T-cells are by definition cytotoxic, but we lack the data to make such distinctions here.

CD27 is an early immune activation marker and is highly associated with a positive outcome in the PPBC cohort, especially among involuting patients. We therefore consider it as an additional characteristic of immune cells. (TODO: What about cells that are CD27+ but negative for everything else?)

## Load data

We created a data frame for each panel within the previous notebook.

```{r load df1}
mpif26 <- readRDS(here("data/vectra/interim/mpif26_df.Rds"))
colnames(mpif26)
```

```{r load df2}
mpif27 <- readRDS(here("data/vectra/interim/mpif27_df.Rds"))
colnames(mpif27)
```

## Problematic marker combinations

We should not observe:

CD3+ CD20+
CD8+ CD20+
FOXP3+ CD20+

In principle, we should also not observe double positivity of PanCK and immune markers, nor CD138 and T cell markers, but these combinations may occur due to the high abundance of these markers, which causes spillover to adjacent cells.

Abundance of these combinations:

```{r count cells}
cell_counts <- read_csv(here("results/spatial/cell_counts_by_marker.csv")) %>%
    pivot_wider(names_from=classifier_label, values_from=n)
```

Recall that:

MPIF26 exclusive markers:  CD27, FoxP3
MPIF27 exclusive markers: CD138, CD8 
Shared markers: CD20, CD3, PanCK, DAPI

```{r}
panel_markers <- cell_counts %>%
  mutate(count = Tumor + Stroma, .after=Stroma) %>%
  group_by(marker_pos, panel) %>%
  summarize(sum = sum(count), .groups="drop") %>%
  pivot_wider(names_from = panel, values_from=sum, values_fill = 0) %>%
  arrange(desc(MPIF27 + MPIF26))

panel_markers
```

PanCK/immune marker combinations:

```{r}
panel_markers %>%
  filter(str_detect(marker_pos, "PanCK") & str_detect(marker_pos, "CD"))
```


Also address:
CD8+CD3- (MPIF27)
CD27+CD3- (MPIF26)
CD20+_CD3+_CD8+ (MPIF27)
CD138+_CD8+ (MPIF27)
CD20+_CD8+

NK cells may sometimes express [CD8](https://journals.asm.org/doi/10.1128/JVI.01420-14) and [CD27](https://pubmed.ncbi.nlm.nih.gov/18326863/).

```{r}
panel_markers %>%
  filter(marker_pos %in% c(
    "CD20+_CD3+_DAPI+",
    "CD8+_DAPI+",
    "CD27+_DAPI+",
    "CD20+_CD3+_CD8+_DAPI+",
    "CD20+_CD8+_DAPI+"
  )) %>%
  mutate(marker_pos = str_remove(marker_pos, "_DAPI\\+"))
```

Additional impossible combinations exist within the data, but in relatively low numbers.

## Marker coexpression

Because we are plotting a few million points, this does take a few minutes to run, and it will only get worse as new samples come in. We therefore exclude the double negatives for each marker combo to reduce the total number of points.

```{r, coexpression_fn}
coexpression_plot <- function(marker1, marker2, df1 = mpif26, df2 = mpif27){
  
  pos1 <- paste0(marker1, "_positive")
  pos2 <- paste0(marker2, "_positive")
  intens1 <- paste0(marker1, "_intensity")
  intens2 <- paste0(marker2, "_intensity")
  
  if(pos1 %in% colnames(df1) & pos2 %in% colnames(df1) &
     pos1 %in% colnames(df2) & pos2 %in% colnames(df2)){
    #print("markers in both")
    df <- bind_rows(
      df1, df2
    )
  } else if (pos1 %in% colnames(df1) & pos2 %in% colnames(df1)) {
    #print("markers in panel1")
    df <- df1
  } else if (pos1 %in% colnames(df2) & pos2 %in% colnames(df2)) {
    #print("markers in panel2")
    df <- df2
  } else {
    stop("Provide a marker combination that exists in the same panel")
  }
  
  df <- df %>%
    select(t_number, panel, object_id, contains(marker1), contains(marker2))
  
  #Convert positivity logicals into strings
  df$marker1 <- if_else(df[,pos1]==T, paste0(marker1, "+"), paste0(marker1, "-"))
  df$marker2 <- if_else(df[,pos2]==T, paste0(marker2, "+"), paste0(marker2, "-"))
  df <- df %>%
    mutate(markers = paste0(marker1, marker2)) %>%
    select(-marker1, marker2)
  
  #Remove double negatives to improve runtime
  df <- df %>%
    filter(!(.data[[pos1]]==F & .data[[pos2]]==F))
  
  df %>%
    ggplot(aes_string(x = intens1, y = intens2, 
                      color = "markers", shape = "panel")) +
    geom_point(alpha = 0.5) +
    ggtitle(paste(marker1, marker2, "coexpression"))
  

}  

#testing
#coexpression_plot("CD3", "CD20") +
#  facet_wrap(~t_number)
#coexpression_plot("CD3", "CD8")
#coexpression_plot("CD3", "CD27")
#coexpression_plot("CD8", "CD27")
```

### Implausible CD3 combinations

Many of the most abundant problematic markers combinations involve either the unexpected presence or the unexpected absence of CD3. Plot CD3 expression alongside problem markers.

```{r cd3_coexpression}
lapply(c("CD20", "CD138"), function(x){
  coexpression_plot("CD3", x) +
    scale_color_viridis_d()
})
```

There is no FACS-style cloud around which we can "gate" alternatively for any of these combinations.

### PanCK-immune coexpression

```{r panck_coexpression}
lapply(c("CD20", "CD3", "CD8" ,"FoxP3", "CD27"), function(x){
  coexpression_plot("PanCK", x) +
    scale_color_viridis_d()
})
```

PanCK-CD20 coexpression does show signs of bleedthrough from PanCK into the CD20 channel. There is a smaller population of CD3 cells for which the same problem occurs. Check these two markers sample-wise.

```{r, fig.height=6}
lapply(c("CD20", "CD3"), function(x){
  coexpression_plot("PanCK", x) +
    scale_color_viridis_d() +
    facet_wrap(~t_number)
})
```

There is definitely some sample-specific weirdness going on with PanCK-CD20 coexpression. PanCK-CD3 coexpression is less bizarre, but still shows aberrant behavior between samples. TODO: discuss with Tycho.

### Implausible CD20 coexpression

CD3-CD20 coexpression was covered above, let's look at the other exclusive T cell markers.

```{r, cd20_coexpression}
lapply(c("CD8", "FoxP3"), function(x){
  coexpression_plot("CD20", x) +
    scale_color_viridis_d()
})
```

There is more overlap than usual between CD20-FoxP3+ and double positive cells than is usual - or maybe there are just fewer points here so they show up better?

```{r, cd20_coexpression_sample}
lapply(c("CD8", "FoxP3"), function(x){
  coexpression_plot("CD20", x) +
    scale_color_viridis_d() +
    facet_wrap(~t_number)
})
```

These do not appear to show any major sample-specific aberrations.

## Correcting double positivity

For "impossible" combinations of immune markers, consider the cell positive for the marker with the highest expression.

CD3+ CD20+
CD8+ CD20+
FOXP3+ CD20+

Although not canonical, FoxP3+CD8+ T-cells [do exist](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4397865/) (and these cells are often CD25+.

```{r}
disallowed_markers <- list(
  c("CD3", "CD20"),
  c("CD8", "CD20"),
  c("FoxP3", "CD20")
)
```

```{r}
#Not the fastest code, perhaps there is a more efficient way?
correct_double_positivity <- function(df, blacklist, verbose=T){
  
  marker1 <- blacklist[1]
  marker2 <- blacklist[2]
  if(verbose){print(paste("Correcting for:", paste0(marker1,"/", marker2), "double positivity"))}
  
  pos1 <- paste0(marker1,"_positive")
  pos2 <- paste0(marker2,"_positive")
  
  if(!pos1 %in% colnames(df)){
    stop(paste(pos1, "not in input"))
  }
  if(!pos2 %in% colnames(df)){
    stop(paste(pos2, "not in input"))
  }
  
  int1 <- paste0(marker1,"_intensity")
  int2 <- paste0(marker2,"_intensity")
  ind <- df[,paste0(marker1,"_positive")] & df[,paste0(marker2,"_positive")]
 
  #Correct the double positive rows by marking the lower of the two markers as false
  fixed <- df[ind,] %>%
    mutate({{pos1}} := ifelse(
      .data[[int1]] < .data[[int2]],
      F, T)
    ) 
  
  fixed <- fixed %>%
    mutate({{pos2}} := ifelse(
      .data[[int2]] < .data[[int1]],
      F, T)
    )

  #Return corrected rows to data frame
  res <- rbind(fixed, df[!ind,])
  res <- res[order(as.numeric(row.names(res))),]
  
  #There should be no more double positives
  stopifnot(nrow(filter(res, .data[[pos1]] & .data[[pos2]]))==0)
  if(verbose){print(paste("Corrected", nrow(fixed), "double positives"))}
  res
  
}

#testing
#correct_double_positivity(mpif26,disallowed_markers[[1]])
#
```

Recall that:

MPIF26 exclusive markers:  CD27, FoxP3
MPIF27 exclusive markers: CD138, CD8 
Shared markers: CD20, CD3, PanCK, DAPI

MPIF26

```{r}
clean_mpif26 <- correct_double_positivity(mpif26,disallowed_markers[[1]])
clean_mpif26 <- correct_double_positivity(clean_mpif26,disallowed_markers[[3]])
```

MPIF27

```{r}
clean_mpif27 <- correct_double_positivity(mpif27,disallowed_markers[[1]])
clean_mpif27 <- correct_double_positivity(clean_mpif27,disallowed_markers[[2]])
```

Sanity checks

```{r}
for(i in 1:length(disallowed_markers)){
  m1 <- paste0(disallowed_markers[[i]][1], "_postive")
  m2 <- paste0(disallowed_markers[[i]][2], "_positive")
    if(!m1 %in% colnames(mpif26) & m2 %in% colnames(mpif26)){
      next
    }
  stopifnot(nrow(filter(clean_mpif26, .data[[m1]] & .data[[m2]]))==0)
}
#clean_mpif26 %>%
#  filter(CD3_pos & CD20_pos)
```

```{r}
for(i in 1:length(disallowed_markers)){
  m1 <- paste0(disallowed_markers[[i]][1], "_positive")
  m2 <- paste0(disallowed_markers[[i]][2], "_positive")
    if(!m1 %in% colnames(mpif27) & m2 %in% colnames(mpif27)){
      next
    }
  stopifnot(nrow(filter(clean_mpif27, .data[[m1]] & .data[[m2]]))==0)
}
```

## Cell definitions

* Cytotoxic T-cell (CD8+, CD3+)
* T-reg (CD3+, FoxP3+)
* Helper T-cell (CD3+, CD8-, FoxP3-)
* B-cell (CD20+, CD138-)
* Plasma B-cell (CD20+, CD138+)
* NK cell (CD8+, CD3-)
* Epithelial cell (PanCK+ and negative for immune markers)

MPIF26 exclusive markers:  CD27, FoxP3
MPIF27 exclusive markers: CD138, CD8 
Shared markers: CD20, CD3, PanCK, DAPI

```{r}
#Still WIP
define_cells <- function(df, markers = c("MPIF26", "MPIF27")){
  
  if(markers == "MPIF26"){
    df <- df %>%
      #Rules are executed in order and will not overwrite the previous
      mutate(cell_type = case_when(
        #CD8_positive & CD3_positive ~ "cytotoxic T",
        CD3_positive & FoxP3_positive ~ "T-reg",
        CD3_positive ~ "helper T",
        CD27_positive & !CD3_positive ~ "NK cell",
        #CD20_positive & CD138_positive ~ "plasma B",
        CD20_positive ~ "B cell",
        PanCK_positive ~ "epithelial",
        #DAPI only
        !CD27_positive & !FoxP3_positive & !CD3_positive &
          !CD20_positive & !PanCK_positive ~ "non-epithelial", #better name?
        TRUE ~ "fixme"
      ), .after=object_id)
  }
  
  df
}

define_cells(mpif26, markers = "MPIF26")
```


```{r}
sessionInfo()
```

