---
title: "Isotype figures"
author: "Kat Moore"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    toc: yes
    df_print: tibble
    highlight: kate
params:
    figuredata: "data/figures/00_figuredata.Rds"
    boxplot_abs: "figures/Fig3a_boxplot_isotypes.pdf"
    km_iso: "figures/Fig3bc_km_isotypes.pdf"
    cor_IG_TAPC: "figures/Fig3d_cor_Ig_TAPC.pdf"
---

## Dependencies

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(ggpubr)
library(survival)
library(survminer)
library(RColorBrewer)
library(ggrepel)
library(conflicted)

conflict_prefer("filter", "dplyr")

theme_set(theme_bw())
```

```{r}
source(here("src/figures/faceted_risktable.R"))
```

## Load data

```{r}
figuredata <- readRDS(here(params$figuredata))
```

## Colors

```{r}
study_colors <- c("NP-BC"="#521262", "Pr-BC"="#AA96DA", "PP-BCdl"="#112D4E", "PP-BCpw"="#46CDCF")
```

## Figure 3A - Boxplot Ig expression

```{r, fig.height=6, fig.width=8}
boxplot_abs <- figuredata %>%
  select(study_group, IgA:IgM) %>%
  pivot_longer(cols = c(IgA, IgD, IgG, IgM),
               names_to = "isotype", values_to = "normCount") %>%
  filter(!is.na(normCount)) %>%
  ggplot(aes(x = study_group, y = normCount)) +
  geom_jitter(aes(color = isotype), shape = 15, height = 0, width = 0.2) +
  geom_boxplot(alpha = 0) +
  facet_wrap(~isotype, scale = "free_y") +
  scale_colour_discrete() +
  stat_compare_means(method = "wilcox.test",
                     comparisons = list(c("PP-BCpw", "PP-BCdl"),
                                        c("PP-BCpw", "Pr-BC"),
                                        c("PP-BCpw", "NP-BC"))) +
  stat_compare_means() +
  #theme(text = element_text(size=18)) +
  ylab("Normalized Expression Levels") +
  xlab("Study group")

boxplot_abs
```

### Save output

```{r}
figureDir <- file.path(here("figures"))
dir.create(figureDir, showWarnings = F)
pdf(file = here(params$boxplot_abs), width = 12, height = 8)
boxplot_abs
dev.off()
```

## Fig 3BC - IG expression KMs

IG expression level is split around the median. Exclude lac from RNAseq analyses due to lack of samples.

```{r}
ig_km <- function(df, event_type = c("OS", "DRS"), returndata = F){
  
  event_type <- match.arg(event_type)
  
  df <- df %>%
    filter(
      study_group %in% c("PP-BCpw", "Pr-BC", "NP-BC")
    )
  
  df <- df %>%
    select(study_group, IgA_rank:IgM_rank,
           death, time_OS_months,
           distant_recurrence, time_DRS_months,
           reason_death) %>%
    pivot_longer(cols = c(IgA_rank:IgM_rank), names_to = "isotype",
                 values_to = "rank") %>%
    mutate(isotype = str_remove(isotype, "_rank")) %>%
    mutate(isotype_group = paste(isotype, rank)) %>%
    filter(!is.na(rank)) %>%
    droplevels()
  
  if(returndata){return(df)}
  
  # There are a lot of facets, we can either make the chart very large, or
  # Use a for loop to plot the isotypes separately

  plt <- list()

  for(ig in c("IgA", "IgD", "IgM", "IgG")){
    
    dfi <- df[df$isotype == ig,]

    if(event_type == "OS"){
      dfi <- dfi %>% filter(!is.na(death), !is.na(time_OS_months)) %>%
        filter(time_OS_months > 20 | reason_death == "BC") %>%
        as.data.frame()
      y <- "Overall survival"
      fit <- survfit(Surv(time=time_OS_months, event=death) ~ study_group + isotype_group, data = dfi)
    } else {
      dfi <- dfi %>% filter(!is.na(distant_recurrence), !is.na(time_DRS_months)) %>%
        filter(time_DRS_months > 20 | reason_death == "BC") %>%
        as.data.frame()
      y <- "Distant recurrence"
      fit <- survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + isotype_group, data = dfi)
    }
    #return(fit)
    plt[[length(plt)+1]] <- ggsurvplot(
      fit, data = dfi,
      xlab = "Months", 
      ylab = paste(y,"probability"),
      palette = study_colors[names(study_colors) %in% unique(dfi$study_group)],
      ggtheme = theme_bw(),
      pval = T,
      facet.by = "isotype_group",
      legend.title="Study group:"
    )
  }
   
  names(plt) <-  c("IgA", "IgD", "IgM", "IgG")
  plt
}

km_iso <- ig_km(figuredata, event_type = "OS", returndata = F)

km_iso
```

### Risk table

```{r}
rt_km_iso <- lapply(names(km_iso), function(x){
  faceted_risktable(km_iso[[x]], faceted.by = "isotype_group") +
    ggtitle(paste("Risk table for", x))
}) %>% set_names(names(km_iso))
rt_km_iso
```

### Save output

```{r}
pdf(file = here(params$km_iso), width = 9, height = 6)
km_iso
rt_km_iso
dev.off()
```

## Fig 3D - Correlation IgA/IgG and TAPC in PP-BCpw

```{r}
cor_IG_TAPC <- 
  list(
    IgA = figuredata %>%
      filter(study_group == "PP-BCpw") %>%
      filter(!is.na(TAPC_score)) %>%
      ggplot(aes(x=TAPC_score, y = IgA)) +
      geom_jitter(aes(color = as.factor(TAPC_score)), height = 0, width = 0.15) +
      geom_boxplot(alpha = 0, aes(group = TAPC_score), color = "darkgray"#, linetype="dashed"
      ) +
      geom_smooth(method = "lm", formula = y ~ x, linetype="dashed") +
      ggpubr::stat_cor(method = "kendall", label.y = 3.5, label.x = -0.2,
                       aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~"))) +
      ggtitle("Kendall's correlation IgA and TAPC in PP-BCpw") +
      xlab("TAPC score") + ylab("Normalized IgA expression") +
      labs(color = "TAPC score") +
      scale_color_brewer(palette = "Spectral"),
    
    IgD = figuredata %>%
      filter(study_group == "PP-BCpw") %>%
      filter(!is.na(TAPC_score)) %>%
      ggplot(aes(x=TAPC_score, y = IgG)) +
      geom_jitter(aes(color = as.factor(TAPC_score)), height = 0, width = 0.15) +
      geom_boxplot(alpha = 0, aes(group = TAPC_score), color = "darkgray"#, linetype="dashed"
      ) +
      geom_smooth(method = "lm", formula = y ~ x, linetype="dashed") +
      ggpubr::stat_cor(method = "kendall", #label.y = 3.5, label.x = -0.2,
                       aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~"))) +
      ggtitle("Kendall's correlation IgG and TAPC in PP-BCpw") +
      xlab("TAPC score") + ylab("Normalized IgG expression") +
      labs(color = "TAPC score") +
      scale_color_brewer(palette = "Spectral")
  )

cor_IG_TAPC
```

### Save output

```{r}
pdf(file = here(params$cor_IG_TAPC), width = 12, height = 8)
cor_IG_TAPC
dev.off()
```

## Session info

```{r}
sessionInfo()
```

