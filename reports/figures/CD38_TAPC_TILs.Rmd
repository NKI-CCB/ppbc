---
title: "CD38 and TAPC"
author: "Kat Moore"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    toc: yes
    df_print: tibble
    highlight: kate
params:
    figuredata: "data/figures/00_figuredata.Rds"
    fig2h: "figures/Fig2h_TAPC_PPBC_cor.pdf"
    fig2i: "figures/Fig2i_TAPC_KM.pdf"
    fig2k: "figures/Fig2k_CD38_boxplot.pdf"
    fig2l: "figures/Fig2l_CD38_KM.pdf"
    fig4a: "figures/Fig4a_TIL_boxplot.pdf"
---

## Dependencies

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(ggpubr)
library(survival)
library(survminer)
library(ggrepel)
library(ggcorrplot)
library(conflicted)

conflict_prefer("filter", "dplyr")

theme_set(theme_bw())
```

```{r}
source(here("src/figures/faceted_risktable.R"))
```

## Load data

```{r}
figuredata <- readRDS(here(params$figuredata))

head(figuredata)
```

## Colors

```{r}
study_colors <- c("NP-BC"="#521262", "Pr-BC"="#AA96DA", "PP-BCdl"="#112D4E", "PP-BCpw"="#46CDCF")
```

## Figure 2H - Relationship TAPC and study group

### Current version

```{r}
fig2h <- figuredata %>%
  filter(!is.na(TAPC_score)) %>%
  ggplot(aes(x = as.integer(study_group), y = TAPC_score)) +
  geom_jitter(aes(color = study_group)) + geom_smooth(method = "lm") +
  #p value in stat_cor comes from `cor.test`
  ggpubr::stat_cor(method = "kendall",
                   aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~"))) +
  scale_color_manual(values = study_colors) +
  scale_x_continuous(breaks = seq(1,4,1), labels= levels(figuredata$study_group)) +
  xlab("Study group") + ylab("TAPC score")

fig2h
```

### Save output

```{r}
figureDir = file.path(here("figures"))
dir.create(figureDir, showWarnings = F)
pdf(file = here(params$fig2h), width = 10, height = 7)
fig2h
dev.off()
```

## Fig 2i - KM TAPC

```{r}
figuredata %>%
  filter(!is.na(TAPC)) %>%
  group_by(TAPC, study_group) %>% count() %>%
  pivot_wider(names_from = TAPC, values_from = n, values_fill = 0)
```

Due to power issues, omit lac. High/low is around the median density.

```{r}
TAPC_km <- function(df, event_type = c("OS", "DRS"), returndata = F){
  
event_type <- match.arg(event_type)
  
  df <- df %>% 
    filter(
      study_group %in% c("PP-BCpw", "Pr-BC", "NP-BC"),
      !is.na(TAPC)
    )
  
  df <- df[,c("TAPC", "study_group", "sample_name", "time_OS_months", "death",
              "reason_death", "time_DRS_months", "distant_recurrence")]
  
  if(returndata){return(df)}
  
  if(event_type == "OS"){
    df <- df %>% filter(!is.na(death), !is.na(time_OS_months)) %>%
      filter(time_OS_months > 20 | reason_death == "BC") %>%
      as.data.frame()
    y <- "Overall survival"
    fit <- survfit(Surv(time=time_OS_months, event=death) ~ study_group + TAPC, data = df)
  } else {
    df <- df %>% filter(!is.na(distant_recurrence), !is.na(time_DRS_months)) %>%
      filter(time_DRS_months > 20 | reason_death == "BC") %>%
      as.data.frame()
    y <- "Distant recurrence"
    fit <- survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + TAPC, data = df)
  }
  
  ggsurvplot(
    fit, data = df,
    xlab = "Months", 
    ylab = paste(y,"probability"),
    #title = paste(y, cell, "stratified by median density:", signif(med, 2)),
    palette = study_colors[names(study_colors) %in% unique(df$study_group)],
    ggtheme = theme_bw(),
    pval = T,
    facet.by = "TAPC",
    legend.title="Study group:"
  )
}

fig2i <- TAPC_km(figuredata, event_type = "OS", returndata = F)
fig2i
```

### Risk table

```{r}
rt_fig2i <-faceted_risktable(fig2i, faceted.by = "TAPC")
rt_fig2i
```

### Save output

```{r}
pdf(file = here(params$fig2i), width = 12, height = 7)
fig2i
rt_fig2i
dev.off()
```

## Fig 2K - Boxplot CD38

Using intratumoral CD38.

```{r}
fig2k <- figuredata %>%
  rename(CD38 = TI_CD38_total) %>%
  filter(!is.na(CD38)) %>%
  ggplot(aes(x = factor(study_group,
                        levels = c("NP-BC", "Pr-BC", "PP-BCdl","PP-BCpw")),
             y = CD38, color = study_group)) +
  geom_point(position = position_jitter(height = 0), shape = 15) +
  geom_boxplot(alpha = 0) +
  scale_color_manual(values = study_colors) +
  xlab("Study group") + 
  stat_compare_means(method = "wilcox.test",
                     comparisons = list(c("PP-BCpw", "NP-BC"))) +
  stat_compare_means(label.y = 65) +
  ggtitle("CD38+ density by study group")

fig2k
```

### Save output

```{r}
pdf(file = here(params$fig2k), width = 12, height = 7)
fig2k
dev.off()
```

## Fig 2L - KM CD38

Due to power issues, omit lac and prbc. High/low is around the median density.

```{r}
figuredata %>%
  rename(CD38 = TI_CD38) %>%
  filter(!is.na(CD38)) %>%
  group_by(CD38, study_group) %>% count() %>%
  pivot_wider(names_from = CD38, values_from = n, values_fill = 0)
```


```{r}
CD38_km <- function(df, event_type = c("OS", "DRS"), returndata = F){
  
event_type <- match.arg(event_type)
  
  df <- df %>%
    rename(CD38 = TI_CD38) %>%
    filter(
      study_group %in% c("PP-BCpw", "NP-BC"),
      !is.na(CD38)
    )
  
  df <- df[,c("CD38", "study_group", "sample_name", "time_OS_months", "death",
              "reason_death", "time_DRS_months", "distant_recurrence")]
  
  if(returndata){return(df)}
  
  if(event_type == "OS"){
    df <- df %>% filter(!is.na(death), !is.na(time_OS_months)) %>%
      filter(time_OS_months > 20 | reason_death == "BC") %>%
      as.data.frame()
    y <- "Overall survival"
    fit <- survfit(Surv(time=time_OS_months, event=death) ~ study_group + CD38, data = df)
  } else {
    df <- df %>% filter(!is.na(distant_recurrence), !is.na(time_DRS_months)) %>%
      filter(time_DRS_months > 20 | reason_death == "BC") %>%
      as.data.frame()
    y <- "Distant recurrence"
    fit <- survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + CD38, data = df)
  }
  
  ggsurvplot(
    fit, data = df,
    xlab = "Months", 
    ylab = paste(y,"probability"),
    #title = paste(y, cell, "stratified by median density:", signif(med, 2)),
    palette = study_colors[names(study_colors) %in% unique(df$study_group)],
    ggtheme = theme_bw(),
    pval = T,
    facet.by = "CD38",
    legend.title="Study group:"
  )
}

fig2l <- CD38_km(figuredata, event_type = "OS", returndata = F)
fig2l
```

### Risk table

```{r}
rt_fig2l <-faceted_risktable(fig2l, faceted.by = "CD38")
rt_fig2l
```

### Save output

```{r}
pdf(file = here(params$fig2l), width = 12, height = 7)
fig2l
rt_fig2l
dev.off()
```

## Fig 4A - TIL% boxplot

Include lac for visualization but exclude it from statistical tests.

```{r}
fig4a <- figuredata %>%
  filter(!is.na(TILpercent)) %>%
  ggplot(aes(x = study_group, y = TILpercent)) +
  geom_jitter(aes(color = study_group), height=0, width = 0.15) +
  geom_boxplot(alpha = 0) +
  scale_color_manual(values = study_colors) +
  stat_compare_means(method = "wilcox.test", comparisons = list(
    c("PP-BCpw", "Pr-BC"),
    c("PP-BCpw", "NP-BC")
  )) +
  stat_compare_means(label.y = 100) +
  xlab("Study group") + ylab("TIL %") +
  labs(color = "Study group")

fig4a
```

### Save output

```{r}
pdf(file = here(params$fig4a), width = 12, height = 7)
fig4a
dev.off()
```

## Session info

```{r}
sessionInfo()
```
