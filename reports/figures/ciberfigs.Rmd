---
title: "Cibersort Figures"
author: "Kat Moore"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    toc: yes
    df_print: tibble
    highlight: kate
params:
    figuredata: "data/figures/00_figuredata.Rds"
    boxplot_cd8: "figures/Fig4b_cibersort_CD8_boxplot.pdf"
    km_cd8: "figures/Fig4c_cibersort_CD8_km.pdf"
    boxplot_b_subtypes: "figures/supfigs/Supfig12b_boxplot_cibersort_B_subtypes.pdf"
    km_plasmaB: "figures/supfigs/Supfig12c_kaplan_cibersort_plasmaB_OS_DRS.pdf"
    km_memoryB: "figures/supfigs/Supfig12d_kaplan_cibersort_memoryB_OS_DRS.pdf"
---

## Dependencies

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(ggpubr)
library(survival)
library(survminer)
library(ggrepel)
library(ggcorrplot)
library(conflicted)

conflict_prefer("filter", "dplyr")
conflict_prefer("count", "dplyr")
conflict_prefer("rename", "dplyr")

theme_set(theme_bw())
```

```{r}
source(here("src/figures/faceted_risktable.R"))
```

## Load data

```{r}
figuredata <- readRDS(here(params$figuredata))

head(figuredata)
```

## Colors

```{r}
study_colors <- c("NP-BC"="#521262", "Pr-BC"="#AA96DA",
                  "PP-BCdl"="#112D4E", "PP-BCpw"="#46CDCF")
```

## Cibersort CD8 boxplot

```{r}
boxplot_cd8 <- figuredata %>%
  filter(!is.na(CD8_fraction)) %>%
  ggplot(aes(x = study_group, y = CD8_fraction)) +
  geom_jitter(aes(color = study_group), height = 0, width = 0.15) +
  geom_boxplot(alpha = 0) +
  scale_color_manual(values = study_colors) +
  stat_compare_means(method = "wilcox.test", comparisons = list(
    c("PP-BCpw", "Pr-BC"),
    c("PP-BCpw", "NP-BC")
  )) +
  stat_compare_means(label.y = 0.2) +
  xlab("Study group") + ylab("Relative CibersortX Fraction") +
  labs(color = "Study group")

boxplot_cd8
```

### Save output

```{r}
figureDir <- file.path(here("figures"))
dir.create(figureDir, showWarnings = F)
pdf(file = here(params$boxplot_cd8), width = 10, height = 7)
boxplot_cd8
dev.off()
```

## KM CD8 Cibersort

```{r}
figuredata %>%
  filter(!is.na(CD8_cat)) %>%
  group_by(CD8_cat, study_group) %>% count() %>%
  pivot_wider(names_from = CD8_cat, values_from = n, values_fill = 0)
```

Due to power issues, omit lac. High/low is around the median density.

Filtering for this and other KMs is either `time_OS_months > 20 | reason_death == "BC"` or `time_DRS_months > 20 | reason_death == "BC"`, depending on the formula.

```{r}
ciber_km <- function(df, cell_type, surv_formula, event_type = c("OS", "DRS"),
                     omit_lac = T, returndata = F, returnfit = F){
  
  df <- df[!is.na(df[,cell_type]),]
  
  if(omit_lac){
    df <- df %>% dplyr::filter(study_group %in% c("PP-BCpw", "Pr-BC", "NP-BC"))
  }
  
  # For debugging or manual exploration of relevant columns
  if(returndata){
    return(df[,c(cell_type, "study_group", "sample_name", "time_OS_months", "death",
                 "reason_death", "time_DRS_months", "distant_recurrence")])
  }
  
  # Perform filtering depending on time variable
  if(event_type == "OS"){
    df <- df %>% filter(!is.na(death), !is.na(time_OS_months)) %>%
      filter(time_OS_months > 20 | reason_death == "BC") %>%
      as.data.frame()
    y <- "Overall survival"
    #fit <- survfit(Surv(time=time_OS_months, event=death) ~ study_group + CD8_CD3, data = df)
  } else {
    df <- df %>% filter(!is.na(distant_recurrence), !is.na(time_DRS_months)) %>%
      filter(time_DRS_months > 20 | reason_death == "BC") %>%
      as.data.frame()
    y <- "Distant recurrence"
    #fit <- survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + CD8_CD3, data = df)
  }
  
  # This is a weird workaround to avoid "object of type 'symbol' is not subsettable" errors
  # Which would occur if you used fit <- survfit(surv_formula, data = df)
  # See https://github.com/kassambara/survminer/issues/252
  fit <- do.call(survfit, args = list(formula = surv_formula, data = df))
  if(returnfit){return(fit)}
  
  ggsurvplot(
    fit, data = df,
    xlab = "Months", 
    ylab = paste(y,"probability"),
    title = paste(y, cell_type, "stratified by median Cibersort fraction"),
    palette = study_colors[names(study_colors) %in% unique(df$study_group)],
    ggtheme = theme_bw(),
    pval = T,
    facet.by = cell_type,
    legend.title="Study group:"
  )
}

km_cd8 <- ciber_km(
  rename(figuredata, CD8_CD3 = CD8_cat), cell_type = "CD8_CD3", event_type = "OS",
  surv_formula=as.formula("Surv(time=time_OS_months, event=death) ~ study_group + CD8_CD3"),
  returndata = F, returnfit = F
)

km_cd8
```

### Risk table

```{r}
rt_km_cd8 <- faceted_risktable(km_cd8, faceted.by = "CD8_CD3")
rt_km_cd8
```

### Save output

```{r}
pdf(file = here(params$km_cd8), width = 12, height = 7)
km_cd8
rt_km_cd8
dev.off()
```

## Boxplot B cell subtypes

```{r, fig.height=5, fig.width=8}
boxplot_b_subtypes <- figuredata %>%
  filter(!is.na(Plasma_fraction)) %>%
  select(study_group, Plasma_fraction, naive_B_fraction, memory_B_fraction) %>%
  pivot_longer(cols = c(Plasma_fraction, naive_B_fraction, memory_B_fraction),
               names_to = "B_subtype", values_to = "relative_fraction") %>%
  ggplot(aes(x = study_group, y = relative_fraction)) +
  facet_wrap(~B_subtype) +
  geom_jitter(aes(color = study_group), height = 0, width = 0.15) +
  geom_boxplot(alpha = 0) +
  scale_color_manual(values = study_colors) +
  stat_compare_means(method = "wilcox.test", comparisons = list(
    c("PP-BCpw", "Pr-BC"),
    c("PP-BCpw", "NP-BC")
  )) +
  stat_compare_means(label.y = 0.3) +
  xlab("Study group") + ylab("Relative CibersortX Fraction") +
  labs(color = "Study group")

boxplot_b_subtypes
```

### Save output

```{r}
supFigDir <- file.path(here("figures/supfigs"))
dir.create(figureDir, showWarnings = F)
pdf(file = here(params$boxplot_b_subtypes), width = 10, height = 7)
boxplot_b_subtypes
dev.off()
```

## Cibersort Plasma B OS and DRS

### Overall survival

```{r}
km_plasmaB_OS <- ciber_km(
  rename(figuredata, plasma_B = Plasma_cat), cell_type = "plasma_B", event_type = "OS",
  surv_formula=as.formula("Surv(time=time_OS_months, event=death) ~ study_group + plasma_B"),
  returndata = F, returnfit = F
)

km_plasmaB_OS
```

### OS Risk table

```{r}
rt_km_plasmaB_OS <- faceted_risktable(km_plasmaB_OS, faceted.by = "plasma_B") +
  ggtitle("Risk table for OS plasma B")
rt_km_plasmaB_OS
```

### Distant recurrence

```{r}
km_plasmaB_DRS <- ciber_km(
  rename(figuredata, plasma_B = Plasma_cat), cell_type = "plasma_B", event_type = "DRS",
  surv_formula=as.formula("Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + plasma_B"),
  returndata = F, returnfit = F
)

km_plasmaB_DRS
```

### DRS Risk table

```{r}
rt_km_plasmaB_DRS <- faceted_risktable(km_plasmaB_DRS, faceted.by = "plasma_B") +
  ggtitle("Risk table for DRS plasma B")
rt_km_plasmaB_DRS
```

### Save output

```{r}
pdf(file = here(params$km_plasmaB), width = 12, height = 7)
km_plasmaB_OS
rt_km_plasmaB_OS
km_plasmaB_DRS
rt_km_plasmaB_DRS
dev.off()
```


## Cibersort Memory B OS and DRS

### Overall survival

```{r}
km_memoryB_OS <- ciber_km(
  rename(figuredata, memory_B = memory_B_cat), cell_type = "memory_B", event_type = "OS",
  surv_formula=as.formula("Surv(time=time_OS_months, event=death) ~ study_group + memory_B"),
  returndata = F, returnfit = F
)

km_memoryB_OS
```

### OS Risk table

```{r}
rt_km_memoryB_OS <- faceted_risktable(km_memoryB_OS, faceted.by = "memory_B") +
  ggtitle("Risk table for OS memory B")
rt_km_memoryB_OS
```

### Distant recurrence

```{r}
km_memoryB_DRS <- ciber_km(
  rename(figuredata, memory_B = Plasma_cat), cell_type = "memory_B", event_type = "DRS",
  surv_formula=as.formula("Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + memory_B"),
  returndata = F, returnfit = F
)

km_memoryB_DRS
```

### DRS Risk table

```{r}
rt_km_memoryB_DRS <- faceted_risktable(km_memoryB_DRS, faceted.by = "memory_B") +
  ggtitle("Risk table for DRS memory B")
rt_km_memoryB_DRS
```

### Save output

```{r}
pdf(file = here(params$km_memoryB), width = 12, height = 7)
km_memoryB_OS
rt_km_memoryB_OS
km_memoryB_DRS
rt_km_memoryB_DRS
dev.off()
```

## Session info

```{r}
sessionInfo()
```
