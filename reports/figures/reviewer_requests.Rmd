---
title: "Reviewer requests"
author: "Kat Moore"
date: "`r Sys.Date()`"
output:
    html_document:
      toc: yes
      df_print: paged
      highlight: kate
params:
    figuredata: "data/figures/00_figuredata.Rds"
    study_km: "src/figures/study_km.R"
    reviewer_requests: "figures/reviewer_requests.pdf"
---

## Dependencies

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(tinytex.verbose = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(ggpubr)
library(survival)
library(survminer)
library(ggrepel)
library(ggcorrplot)
library(conflicted)

conflict_prefer("filter", "dplyr")
conflict_prefer("rename", "dplyr")
theme_set(theme_bw())
```

```{r}
source(here("src/figures/faceted_risktable.R"))
source(here("src/figures/study_km.R"))
```

## Load data

```{r}
figuredata <- readRDS(here(params$figuredata))

head(figuredata)
```

## Colors

```{r}
study_colors <- c("NP-BC"="#521262", "Pr-BC"="#AA96DA", "PP-BCdl"="#112D4E", "PP-BCpw"="#46CDCF")
```

## Functions

```{r}
cor_plot <- function(df=figuredata, x, y, colorby, met, ...){
  
  df <- df[!is.na(df[,x]) & !is.na(df[,y]),]

  df %>%
    ggplot(aes(get(x), get(y))) +
    geom_jitter(aes(color = get(colorby)), height = 1, width = 0.2, shape = 15) +
    geom_smooth(method = "lm", formula = y ~ x) +
    ggpubr::stat_cor(method = met, #label.y = 3.5, label.x = -0.2,
                     aes(label = paste(..rr.label.., ..r.label.., ..p.label..,
                                       sep = "~`,`~"))) +
    xlab(str_replace_all(x, "_", " ")) +
    ylab(str_replace_all(y, "_", " ")) +
    labs(color = str_replace_all(colorby, "_", " "))
}
```


## CD38 and Ig mRNA

### CD38 high/low categories

```{r}
igs <- c("blue", "red","darkgreen","purple")
names(igs) <- c("IgA", "IgG", "IgM", "IgD")

tmpdf <- figuredata %>%
  rename(CD38 = TI_CD38) %>%
  filter(!is.na(CD38)) %>%
  select(CD38, IgA, IgM, IgG, IgD) %>%
  pivot_longer(cols = starts_with("Ig"), names_to = "isotype", values_to = "expression") %>%
  filter(!is.na(expression)) 

boxplot_ig_CD38 <- lapply(names(igs), function(x){
  tmpdf %>%
    filter(isotype == !!x) %>%
    ggplot(aes(x = CD38, y = expression, color = isotype)) +
    geom_point(position = position_jitter(height = 0), shape = 15) +
    geom_boxplot(alpha = 0) +
    xlab("CD38 category") + 
    stat_compare_means(method = "wilcox.test",
                       comparisons = list(c("low", "high"))) +
    #stat_compare_means() +
    ggtitle(paste("CD38+ and", x, "expression")) +
    scale_color_manual(values = igs)
  })

boxplot_ig_CD38
```

### CD38 numeric correlation

```{r}
CD38_Ig_cor_all <- lapply(c(names(igs)), function(ig){
  cor_plot(figuredata, x= "TI_CD38_total", y=ig, colorby = "study_group",
           met = "spearman") +
    scale_color_manual(values = study_colors[names(study_colors) != "rest"]) +
    ggtitle(paste("Spearman correlation between CD38 and", ig, "in all samples"))
}) %>% set_names(igs)

CD38_Ig_cor_all
```

```{r}
CD38_Ig_cor_group <- lapply(names(igs), function(ig){
  cor_plot(figuredata, x="TI_CD38_total", y=ig, colorby = "study_group",
           met = "spearman") +
    scale_color_manual(values = study_colors[names(study_colors) != "rest"]) +
    ggtitle(paste("Spearman correlation between CD38 and", ig, "by study group")) +
    facet_wrap(~study_group)
}) %>% set_names(names(igs))

CD38_Ig_cor_group
```

## TILs and TAPCs

```{r}
TIL_TAPC_cor_all <- 
  figuredata %>% filter(!is.na(TILpercent)) %>%
  cor_plot(figuredata, x= "TAPC_score", y="TILpercent", colorby = "study_group",
           met = "kendall") +
    scale_color_manual(values = study_colors[names(study_colors) != "rest"]) +
    ggtitle("Kendall correlation between TAPCs and TILs in all samples")

TIL_TAPC_cor_all
```

```{r}
TIL_TAPC_cor_group <- 
  figuredata %>% filter(!is.na(TILpercent)) %>%
  cor_plot(figuredata, x= "TAPC_score", y="TILpercent", colorby = "study_group", met = "kendall") +
  scale_color_manual(values = study_colors[names(study_colors) != "rest"]) +
  ggtitle("Kendall correlation between TAPCs and TILs per study group") +
  facet_wrap(~study_group)

TIL_TAPC_cor_group
```

## Save output

```{r}
pdf(file = here(params$reviewer_requests), width = 12, height = 7)
CD38_Ig_cor_all
CD38_Ig_cor_group
TIL_TAPC_cor_all
TIL_TAPC_cor_group
#boxplot_ig_CD38 #is this one useful?
dev.off()
```