---
title: "TAPC Scoring"
output:
  html_notebook:
    toc: yes
    toc_float: yes
---

# Loading Packages 

```{r}
#install.packages("tidyverse")
library(tidyverse)
library(readxl)
#if (!requireNamespace("BiocManager", quietly = TRUE))
   # install.packages("BiocManager")
#BiocManager::install("tximport")
library(tximport)
#install.packages("here")
library(here)
library(dplyr)
library(tidyr)
library(gplots)
library(ggplot2)
library(grid)
#install.packages("vcd")
library(vcd)
#install.packages("corrplot")
library(corrplot)
#install.packages("ca")
library(ca)
library(scales)
#install.packages("ggthemes")
library(ggthemes)
#install.packages("ztable")
library(ztable)
library(survival)
library(ggpubr)
library(magrittr)
library(survminer)
library(prodlim)
library(Publish)
library(tidyverse)
library(readxl)
#source("https://bioconductor.org/biocLite.R")
#biocLite("tximport")
library(tximport)
library(here)
library(dplyr)
library(tidyr)
#install.packages("gplots")
library(gplots)
library(ggplot2)
library(grid)
#install.packages("vcd")
library(vcd)
#install.packages("corrplot")
library(corrplot)
#install.packages("ca")
library(ca)
library(scales)
#install.packages("ggthemes")
library(ggthemes)
#install.packages("ztable")
library(ztable)
library(devtools)
library(ggpubr)
#install.packages("multcomp")
library(multcomp)
#install.packages("car")
library(car)
library(ggpubr)
library(multcomp)
#install.packages("rstatix")
library(rstatix)
```





# Load data

```{r}
PPBC_metadata <- readRDS("PPBC_metadata.RDS")
```


```{r}
PPBC_metadata[sapply(PPBC_metadata, function(x) as.character(x) == "NA")] <- NA
```


remove NA data from study_group and TAPC_score 
```{r}
PPBC_metadata <- PPBC_metadata[!(is.na(PPBC_metadata$TAPC_score)),]
PPBC_metadata <- PPBC_metadata[!(is.na(PPBC_metadata$study_group)),]
```




```{r}
table(PPBC_metadata$study_group)
```


```{r}
PPBC_metadata$study_group <- factor(PPBC_metadata$study_group,
                                           levels = c("ppbcpw","ppbcdl","prbc","npbc"))
```


```{r}
table(PPBC_metadata$study_group)
```


```{r}
PPBC_metadata$TAPC_score_v2 <- NA
PPBC_metadata$TAPC_score_v2[PPBC_metadata$TAPC_score=="0"] <- 0
PPBC_metadata$TAPC_score_v2[PPBC_metadata$TAPC_score=="1"] <- 1
PPBC_metadata$TAPC_score_v2[PPBC_metadata$TAPC_score=="2"] <- 2
PPBC_metadata$TAPC_score_v2[PPBC_metadata$TAPC_score=="3"] <- 3


table(PPBC_metadata$TAPC_score)
table(PPBC_metadata$TAPC_score_v2)


PPBC_metadata$TAPC_score_v2 <- factor(PPBC_metadata$TAPC_score_v2,
                                           levels = c(0,1,2,3),
                                           labels = c("score 0", "score 1", "score 2", "score 3"))

table(PPBC_metadata$TAPC_score_v2)
table(PPBC_metadata$study_group, PPBC_metadata$TAPC_score_v2)
```



```{r}
PPBC_metadata$TAPC_score <- as.numeric(PPBC_metadata$TAPC_score)
```


#subset data without lac

```{r}
PPBC_metadata_withoutLAC <- subset(PPBC_metadata, study_group %in% c("ppbcpw","prbc", "npbc"), )
```




# ANOVA Plasma cells 

```{r}
group_by(PPBC_metadata, study_group) %>%
  summarise(
    count = n(),
    mean = mean(TAPC_score, na.rm = TRUE),
    sd = sd(TAPC_score, na.rm = TRUE)
  )
```



## ANOVA test

```{r}
res.aov <- aov(TAPC_score ~ study_group, data = PPBC_metadata)
summary(res.aov)
```

## Tukey multiple pairwise-comparisons

```{r}
TukeyHSD(res.aov)
```

```{r}
pwc <- PPBC_metadata %>% tukey_hsd(TAPC_score ~ study_group)
pwc
```


## Pairewise t-test

The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.

```{r}
pairwise.t.test(PPBC_metadata$TAPC_score, PPBC_metadata$study_group,
                 p.adjust.method = "BH")
```



## Check the homogeneity of variance assumption

The classical one-way ANOVA test requires an assumption of equal variances for all groups.


```{r}
# 1. Homogeneity of variances
plot(res.aov, 1)
```


```{r}
leveneTest(TAPC_score ~ study_group, data = PPBC_metadata)
```

From the output above we can see that the p-value is NOT less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is NOT statistically significantly different. Therefore, we CAN assume the homogeneity of variances in the different treatment groups.


## Check the normality assumption

```{r}
# 2. Normality
plot(res.aov, 2)
```

As all the points do not fall approximately along this reference line, we cannot assume normality.

Shapiro-Wilk test on the ANOVA residuals - significant p-value - so data are not normal! 

```{r}
# Extract the residuals
aov_residuals <- residuals(object = res.aov )
# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals )

```


## Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.


```{r}
kruskal.test(TAPC_score ~ study_group, data = PPBC_metadata)
kruskal.test(TAPC_score ~ study_group, data = PPBC_metadata_withoutLAC)
```


## Visualization 

```{r}
table(PPBC_metadata$study_group)
table(PPBC_metadata$study_group, PPBC_metadata$TAPC_score)
table(PPBC_metadata$TAPC_score)
```




```{r}
TAPC_plot_all <- ggboxplot(PPBC_metadata, x="study_group", y="TAPC_score",
          color = "study_group", palette = c("#49CE5B", "#112D4E", "#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "TAPC score", xlab = "study group") + 
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.05, aes(colour = study_group)) + stat_compare_means(method = "kruskal") + ylim(0,3.6) + stat_pvalue_manual(pwc, hide.ns = TRUE, y.position = c(3.2))

TAPC_plot_all
```


```{r}
my_comparisons <- list( c("PPBCPW", "PPBCDL"), c("PPBCPW", "PrBC"), c("PPBCPW", "NPBC") )

TAPC_plot_all <- ggboxplot(PPBC_metadata, x="study_group", y="TAPC_score",
          color = "study_group", palette = c("#49CE5B", "#112D4E", "#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "TAPC score", xlab = "study group") + 
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.05, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 80) # + stat_pvalue_manual(pwc_delta_estimate_CD3CD8pos_CD20, hide.ns = TRUE, y.position = c(1.25))) + ylim(0,3.6) + stat_pvalue_manual(pwc, hide.ns = TRUE, y.position = c(3.2))

TAPC_plot_all
```


## without lac

```{r}
group_by(PPBC_metadata_withoutLAC, study_group) %>%
  summarise(
    count = n(),
    mean = mean(TAPC_score, na.rm = TRUE),
    sd = sd(TAPC_score, na.rm = TRUE)
  )
```

```{r}
TAPC_plot <- ggboxplot(PPBC_metadata_withoutLAC, x = "study_group", y = "TAPC_score",
          color = "study_group", order = c("ppbcpw", "prbc", "npbc"),ylab = "TAPC score", xlab = "Study Group")
TAPC_plot
```

ANOVA
```{r}
res.aov <- aov(TAPC_score ~ study_group, data = PPBC_metadata_withoutLAC)
summary(res.aov)
```

Tukey multiple pairwise-comparisons
```{r}
TukeyHSD(res.aov)
```

```{r}
pwc <- PPBC_metadata_withoutLAC %>% tukey_hsd(TAPC_score ~ study_group)
pwc
```


Non-parametric alternative to one-way ANOVA test
Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.
```{r}
kruskal.test(TAPC_score ~ study_group, data = PPBC_metadata_withoutLAC)
```


Visualization 
```{r}
table(PPBC_metadata_withoutLAC$study_group)
table(PPBC_metadata_withoutLAC$study_group, PPBC_metadata_withoutLAC$TAPC_score)
table(PPBC_metadata_withoutLAC$TAPC_score)
```




```{r}
my_comparisons <- list( c("ppbcpw", "prbc"), c("ppbcpw", "npbc"), c("prbc", "npbc") )

TAPC_plot_all_withoutlac <- ggboxplot(PPBC_metadata_withoutLAC, x="study_group", y="TAPC_score",
          color = "study_group", palette = c("#49CE5B", "#AA96DA", "#521262"),
          order = c("ppbcpw", "prbc", "npbc"),
          ylab = "TAPC score", xlab = "study group") + 
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.06, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 4) #) + ylim(0,3.6) + stat_pvalue_manual(pwc, hide.ns = TRUE, y.position = c(3.2, 3.4))

TAPC_plot_all_withoutlac
```


# OS - plasma count 

```{r}
table(PPBC_metadata$TAPC_score)
table(PPBC_metadata$TAPC)
```


```{r}
surv_OS <- Surv(time = PPBC_metadata$time_OS_months, event = PPBC_metadata$death)
fit_OS <- survfit(surv_OS ~ study_group, data = PPBC_metadata) 
```

```{r}
fit_OS_plasma <- survfit(surv_OS ~ TAPC_score, data = PPBC_metadata) 
fit_OS_plasma_short <- survfit(surv_OS ~ TAPC, data = PPBC_metadata) 
```


```{r, fig.width=7, fig.height=5}
OS_univariate_plasma <- ggsurvplot(fit_OS_plasma, data = PPBC_metadata,
    xlab = "Months", 
    ylab = "OS probability",
    title =  paste0("A. OS univariate (n = ", nrow(PPBC_metadata), ")"),
    #linetype = "strata",
    palette = c("#521262", "#46CDCF","#112D4E", "#AA96DA"),
    ggtheme = theme_bw(),
    pval = T,
    risk.table = F,
    cumevents = F, cumcensor = F,
    test.for.trend = F,
    legend.labs = c("score 0", "score 1", "score 2", "score 3"))
OS_univariate_plasma <- ggpar(OS_univariate_plasma, xlim = c(0,250))
OS_univariate_plasma

OS_univariate_plasma_short <- ggsurvplot(fit_OS_plasma_short, data = PPBC_metadata,
    xlab = "Months", 
    ylab = "OS probability",
    title =  paste0("A. OS univariate (n = ", nrow(PPBC_metadata), ")"),
    #linetype = "strata",
    palette = c("#ffb600", "#a10702"),
    ggtheme = theme_bw(),
    pval = T,
    risk.table = F,
    cumevents = F, cumcensor = F,
    test.for.trend = F,
    legend.labs = c("low", "high"))
OS_univariate_plasma_short <- ggpar(OS_univariate_plasma_short, xlim = c(0,250))
OS_univariate_plasma_short
```


```{r}
cox_OS_univariate_plasma <- coxph(Surv(time_OS_months, death) ~ TAPC_score_v2, data = PPBC_metadata)
summary(cox_OS_univariate_plasma)

cox_OS_univariate_plasma_short <- coxph(Surv(time_OS_months, death) ~ TAPC, data = PPBC_metadata)
summary(cox_OS_univariate_plasma_short)
```



#### KM by plasma score

```{r}
table(PPBC_metadata$study_group, PPBC_metadata$TAPC_score_v2)
table(PPBC_metadata_withoutLAC$study_group, PPBC_metadata_withoutLAC$TAPC_score_v2)
```


```{r}
table(PPBC_metadata$study_group, PPBC_metadata$TAPC)
```


```{r}
PPBC_metadata <- as.data.frame(PPBC_metadata)
PPBC_metadata_withoutLAC <- as.data.frame(PPBC_metadata_withoutLAC)
```

```{r, fig.width=7, fig.height=4}
sg_plasma_os <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + TAPC_score_v2, data = PPBC_metadata), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "TAPC count by study_group",
    palette = c("#46CDCF", "#112D4E", "#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "TAPC_score_v2")

sg_plasma_os

sg_plasma_os_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + TAPC, data = PPBC_metadata), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "TAPC count by study_group",
    palette = c("#46CDCF", "#112D4E", "#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "TAPC")

sg_plasma_os_short
```


without PPBCDL
```{r, fig.width=7, fig.height=4}
sg_plasma_os <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + TAPC_score_v2, data = PPBC_metadata_withoutLAC), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "TAPC count by study_group",
    palette = c("#46CDCF", "#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "TAPC_score_v2")

sg_plasma_os

sg_plasma_os_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + TAPC, data = PPBC_metadata_withoutLAC), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "TAPC count by study_group",
    palette = c("#46CDCF", "#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "TAPC")

sg_plasma_os_short
```




#### KM by study group

```{r}
sg_plasma_os_group <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + TAPC, data = PPBC_metadata), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "TAPC count by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

sg_plasma_os_group

#sg_plasma_os <-  ggsurvplot(
 #   fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + TAPC_score_v2, data = PPBC_metadata_withoutLAC), 
  #  xlab = "Months", 
   # ylab = "Overall survival probability",
    #title = "TAPC count by study_group",
    #pval = T, facet.by = "study_group")

#sg_plasma_os
```


### within study groups 

subset data low TAPC signature versus high TAPC signature 

```{r}
PPBC_metadata_withoutLAC_low <- subset(PPBC_metadata_withoutLAC, TAPC_score %in% c(0,1), )
PPBC_metadata_withoutLAC_high <- subset(PPBC_metadata_withoutLAC, TAPC_score %in% c(2,3), )
```

```{r}
#univariate
cox_OS_TAPC_low <- coxph(Surv(time_OS_months, death) ~ study_group, data = PPBC_metadata_withoutLAC_low)
summary(cox_OS_TAPC_low)

cox_OS_TAPC_high <- coxph(Surv(time_OS_months, death) ~ study_group, data = PPBC_metadata_withoutLAC_high)
summary(cox_OS_TAPC_high)
```


Only include grade, stage, PAM50 - otherwise overfitting the model!! 
```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + clin_subtype,
  data = PPBC_metadata_withoutLAC_low) %>%
  cox.zph()
```

multivariate low 
```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    study_group + strata(clin_subtype),
  data = PPBC_metadata_withoutLAC_low)
summary(clin.cov.cox)
```

```{r}
#with study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + study_group + clin_subtype, data = PPBC_metadata_withoutLAC_low)
study_strata
plot_OS_TAPC_low <- ggadjustedcurves(study_strata, data=PPBC_metadata_withoutLAC_low, method="conditional", variable="study_group", palette = c("#46CDCF", "#521262", "#AA96DA"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_OS_TAPC_low
```


multivariate high 

--> PROBLEM: no events in PrBC and NPBC groups!! 

```{r}
table(PPBC_metadata_withoutLAC_high$study_group)
table(PPBC_metadata_withoutLAC_high$study_group, PPBC_metadata_withoutLAC_high$clin_subtype)
```




```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    study_group + strata(clin_subtype),
  data = PPBC_metadata_withoutLAC_high)
summary(clin.cov.cox)
```


```{r}
#with study study_group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + study_group + clin_subtype, data = PPBC_metadata_withoutLAC_high)
study_strata
plot_OS_TAPC_high <- ggadjustedcurves(study_strata, data=PPBC_metadata_withoutLAC_high, method="conditional", variable="study_group", palette = c("#46CDCF", "#521262", "#AA96DA"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_OS_TAPC_high
```


# DRS - plasma count 

```{r}
table(PPBC_metadata$TAPC_score)
table(PPBC_metadata$TAPC)
```


```{r}
surv_DRS <- Surv(time = PPBC_metadata$time_DRS_months, event = PPBC_metadata$distant_recurrence)
fit_DRS <- survfit(surv_DRS ~ study_group, data = PPBC_metadata) 
```

```{r}
fit_DRS_plasma <- survfit(surv_DRS ~ TAPC_score, data = PPBC_metadata) 
fit_DRS_plasma_short <- survfit(surv_DRS ~ TAPC, data = PPBC_metadata) 
```



```{r, fig.width=7, fig.height=5}
DRS_univariate_plasma <- ggsurvplot(fit_DRS_plasma, data = PPBC_metadata,
    xlab = "Months", 
    ylab = "DRS probability",
    title =  paste0("A. DRS univariate (n = ", nrow(PPBC_metadata), ")"),
    #linetype = "strata",
    palette = c("#521262", "#46CDCF","#112D4E", "#AA96DA"),
    ggtheme = theme_bw(),
    pval = T,
    risk.table = F,
    cumevents = F, cumcensor = F,
    test.for.trend = F,
    legend.labs = c("score 0", "score 1", "score 2", "score 3"))
DRS_univariate_plasma <- ggpar(DRS_univariate_plasma, xlim = c(0,250))
DRS_univariate_plasma

DRS_univariate_plasma_short <- ggsurvplot(fit_DRS_plasma_short, data = PPBC_metadata,
    xlab = "Months", 
    ylab = "DRS probability",
    title =  paste0("A. DRS univariate (n = ", nrow(PPBC_metadata), ")"),
    #linetype = "strata",
    palette = c("#ffb600", "#a10702"),
    ggtheme = theme_bw(),
    pval = T,
    risk.table = F,
    cumevents = F, cumcensor = F,
    test.for.trend = F,
    legend.labs = c(" score_low", "score_high"))
DRS_univariate_plasma_short <- ggpar(DRS_univariate_plasma_short, xlim = c(0,250))
DRS_univariate_plasma_short
```


```{r}
cox_DRS_univariate_plasma <- coxph(Surv(time_DRS_months, distant_recurrence) ~ TAPC_score_v2, data = PPBC_metadata)
summary(cox_DRS_univariate_plasma)

cox_DRS_univariate_plasma_short <- coxph(Surv(time_DRS_months, distant_recurrence) ~ TAPC, data = PPBC_metadata)
summary(cox_DRS_univariate_plasma_short)
```




#### KM by plasma score

```{r}
table(PPBC_metadata$study_group, PPBC_metadata$TAPC_score_v2)
table(PPBC_metadata_withoutLAC$study_group, PPBC_metadata_withoutLAC$TAPC_score_v2)
```


```{r}
table(PPBC_metadata$study_group, PPBC_metadata$TAPC)
```


```{r, fig.width=7, fig.height=4}
sg_plasma_drs <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + TAPC_score_v2, data = PPBC_metadata), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "TAPC count by study_group",
    palette = c("#46CDCF", "#112D4E", "#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "TAPC_score_v2")

sg_plasma_drs

sg_plasma_drs_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + TAPC, data = PPBC_metadata), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "TAPC count by study_group",
    palette = c("#46CDCF", "#112D4E", "#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "TAPC")

sg_plasma_drs_short
```

without PPBCDL
```{r, fig.width=7, fig.height=4}
sg_plasma_drs <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + TAPC_score_v2, data = PPBC_metadata_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "TAPC count by study_group",
    palette = c("#46CDCF", "#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "TAPC_score_v2")

sg_plasma_drs

sg_plasma_drs_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + TAPC, data = PPBC_metadata_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "TAPC count by study_group",
    palette = c("#46CDCF", "#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "TAPC")

sg_plasma_drs_short
```


#### KM by study group

```{r}
sg_plasma_drs_group <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + TAPC, data = PPBC_metadata), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "TAPC count by study_group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

sg_plasma_drs_group

#sg_plasma_drs_group_short <-  ggsurvplot(
    #fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + TAPC_score_v2, data = PPBC_metadata_withoutLAC), 
    #xlab = "Months", 
    #ylab = "DRS probability",
    #title = "TAPC count by study_group",
    #ggtheme = theme_bw(),
    #pval = T, facet.by = "study_group")

#sg_plasma_drs_group_short
```



### within study groups 
Only include grade, stage, PAM50 - otherwise overfitting the model!! 

multivariate low 
```{r}
coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ study_group + stage + clin_subtype,
  data = PPBC_metadata_withoutLAC_low) %>%
  cox.zph()

```

multivariate low 

```{r}
table(PPBC_metadata_withoutLAC_low$study_group)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    study_group + strata(clin_subtype),
  data = PPBC_metadata_withoutLAC_low)
summary(clin.cov.cox)
```

multivariate high 

```{r}
table(PPBC_metadata_withoutLAC_high$study_group)
table(PPBC_metadata_withoutLAC_high$study_group, PPBC_metadata_withoutLAC_high$clin_subtype)
```


```{r}
#coxph(
 # Surv(time=time_DRS_months,
  #     event=distant_recurrence) ~ study_group + stage,
  #data = PPBC_metadata_withoutLAC_high) %>%
  #cox.zph()
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    study_group,
  data = PPBC_metadata_withoutLAC_high)
summary(clin.cov.cox)

clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage + strata(clin_subtype) +
    study_group,
  data = PPBC_metadata_withoutLAC_high)
summary(clin.cov.cox)
```





# scatterplot 

# correlation TAPC - study_group

create logical variable TAPC

```{r}
PPBC_metadata_withoutLAC$TAPC_short <- NA
PPBC_metadata_withoutLAC$TAPC_short[PPBC_metadata_withoutLAC$TAPC=="low"] <- 0
PPBC_metadata_withoutLAC$TAPC_short[PPBC_metadata_withoutLAC$TAPC=="high"] <- 1

table(PPBC_metadata_withoutLAC$TAPC)
table(PPBC_metadata_withoutLAC$TAPC_short)

PPBC_metadata_withoutLAC$TAPC_short <- as.numeric(PPBC_metadata_withoutLAC$TAPC_short)
```

```{r}
PPBC_metadata_withoutLAC$TAPC_score <- as.numeric(PPBC_metadata_withoutLAC$TAPC_score)
```


remove NA values 


```{r}
PPBC_metadata_withoutLAC <- PPBC_metadata_withoutLAC[!is.na(PPBC_metadata_withoutLAC$TAPC_score),]

group_by(PPBC_metadata_withoutLAC, study_group) %>%
  summarise(
    count = n(),
    mean = mean(TAPC_short, na.rm = TRUE),
    sd = sd(TAPC_short, na.rm = TRUE)
  )
```


```{r}
PPBC_metadata_withoutLAC$study_group_tem <- NA
PPBC_metadata_withoutLAC$study_group_tem[PPBC_metadata_withoutLAC$study_group=="ppbcpw"] <- 1
PPBC_metadata_withoutLAC$study_group_tem[PPBC_metadata_withoutLAC$study_group=="prbc"] <- 2
PPBC_metadata_withoutLAC$study_group_tem[PPBC_metadata_withoutLAC$study_group=="npbc"] <- 3

PPBC_metadata_withoutLAC$study_group_tem <- as.numeric(PPBC_metadata_withoutLAC$study_group_tem)
table(PPBC_metadata_withoutLAC$study_group_tem)
```

```{r}
PPBC_metadata$study_group_ordinal <- NA
PPBC_metadata$study_group_ordinal[PPBC_metadata$study_group=="ppbcpw"] <- 1
PPBC_metadata$study_group_ordinal[PPBC_metadata$study_group=="ppbcdl"] <- 2
PPBC_metadata$study_group_ordinal[PPBC_metadata$study_group=="prbc"] <- 3
PPBC_metadata$study_group_ordinal[PPBC_metadata$study_group=="npbc"] <- 4
```

## overall


### all cases 

```{r}
scatterplot_TAPC_PPBC <- PPBC_metadata %>%
    ggplot(aes(x = study_group_ordinal, y = TAPC_score)) +
    geom_jitter(aes(color = study_group)) + geom_smooth(method = "lm") +
    #p value in stat_cor comes from `cor.test`
    ggpubr::stat_cor(method = "kendall",
                     aes(label = paste(..r.label.., ..p.label.., sep = 
"~`,`~")))
scatterplot_TAPC_PPBC
```


### without lactation


```{r}
scatterplot_TAPC_PPBC <- PPBC_metadata_withoutLAC %>%
    ggplot(aes(x = study_group_tem, y = TAPC_score)) +
    geom_jitter(aes(color = study_group)) + geom_smooth(method = "lm") +
    #p value in stat_cor comes from `cor.test`
    ggpubr::stat_cor(method = "kendall",
                     aes(label = paste(..r.label.., ..p.label.., sep = 
"~`,`~")))
scatterplot_TAPC_PPBC
```



```{r}
scatterplot_TAPC_PPBC <- PPBC_metadata_withoutLAC %>%
    ggplot(aes(x = study_group_tem, y = TAPC_short)) +
    geom_jitter(aes(color = study_group)) + geom_smooth(method = "lm") +
    #p value in stat_cor comes from `cor.test`
    ggpubr::stat_cor(method = "kendall",
                     aes(label = paste(..r.label.., ..p.label.., sep = 
"~`,`~")))
scatterplot_TAPC_PPBC
```


### ppbcpw versus prbc


```{r}
PPBC_inv_prbc <- subset(PPBC_metadata_withoutLAC, study_group_tem %in% c("1","2"), )
PPBC_inv_npbc <- subset(PPBC_metadata_withoutLAC, study_group_tem %in% c("1", "3"), )
```


```{r}
scatterplot_TAPC_PPBC_inv_prbc <- PPBC_inv_prbc %>%
    ggplot(aes(x = study_group_tem, y = TAPC_score)) +
    geom_jitter(aes(color = study_group)) + geom_smooth(method = "lm") +
    #p value in stat_cor comes from `cor.test`
    ggpubr::stat_cor(method = "kendall",
                     aes(label = paste(..r.label.., ..p.label.., sep = 
"~`,`~")))
scatterplot_TAPC_PPBC_inv_prbc
```

```{r}
scatterplot_TAPC_PPBC_inv_prbc <- PPBC_inv_prbc %>%
    ggplot(aes(x = study_group_tem, y = TAPC_short)) +
    geom_jitter(aes(color = study_group)) + geom_smooth(method = "lm") +
    #p value in stat_cor comes from `cor.test`
    ggpubr::stat_cor(method = "kendall",
                     aes(label = paste(..r.label.., ..p.label.., sep = 
"~`,`~")))
scatterplot_TAPC_PPBC_inv_prbc
```


### ppbcpw versus npbc


```{r}
scatterplot_TAPC_PPBC_inv_npbc <- PPBC_inv_npbc %>%
    ggplot(aes(x = study_group_tem, y = TAPC_score)) +
    geom_jitter(aes(color = study_group)) + geom_smooth(method = "lm") +
    #p value in stat_cor comes from `cor.test`
    ggpubr::stat_cor(method = "kendall",
                     aes(label = paste(..r.label.., ..p.label.., sep = 
"~`,`~")))
scatterplot_TAPC_PPBC_inv_npbc
```




```{r}
scatterplot_TAPC_PPBC_inv_npbc <- PPBC_inv_npbc %>%
    ggplot(aes(x = study_group_tem, y = TAPC_short)) +
    geom_jitter(aes(color = study_group)) + geom_smooth(method = "lm") +
    #p value in stat_cor comes from `cor.test`
    ggpubr::stat_cor(method = "kendall",
                     aes(label = paste(..r.label.., ..p.label.., sep = 
"~`,`~")))
scatterplot_TAPC_PPBC_inv_npbc
```







