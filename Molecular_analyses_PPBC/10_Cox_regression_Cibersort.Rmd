---
title: "Cox Regression analyses - Cibersort RELATIVE fractions"
output:
  html_notebook:
    toc: yes
    toc_float: yes
---

# Loading Packages 

```{r}
library(tidyverse)
library(readxl)
#source("https://bioconductor.org/biocLite.R")
#biocLite("tximport")
library(tximport)
library(here)
library(dplyr)
library(tidyr)
library(ggplot2)
#install.packages("survival")
library(survival)
library(ggpubr)
library(magrittr)
#install.packages("survminer")
library(survminer)
library(KMsurv)
#install.packages("prodlim")
library(prodlim)
#install.packages("Publish")
library(Publish)
library(tidyverse)
library(readxl)
```


# Load the data

```{r}
MCP_Data <- readRDS("PPBC_metadata.RDS")
MCP_IG <- readRDS("MCP_IG.RDS")
MCP_IG_low <- readRDS("MCP_IG_low.RDS")
MCP_IG_medium <- readRDS("MCP_IG_medium.RDS")
MCP_IG_high <- readRDS("MCP_IG_high.RDS")
MCP_Filtered <- readRDS("MCP_Filtered.RDS")
MCP_Final <- readRDS("MCP_Final.RDS")
MCP_inv <- subset(MCP_Final, PPBC %in% c("involuting"), )
```

```{r}
MCP_Data$study_group <- ordered(MCP_Data$study_group,
                                levels = c("ppbcpw", "ppbcdl", "prbc", "npbc"))

MCP_Final$study_group <- ordered(MCP_Final$study_group,
                                levels = c("ppbcpw", "ppbcdl", "prbc", "npbc"))
```


# PPBC-lac exclusion

If we would not want to include PPBC-lac in the analyses: 

```{r}
MCP_Final_withoutLAC <- subset(MCP_Final, PPBC %in% c("involuting","nulliparous", "pregnant"), )
MCP_inv_npbc <- subset(MCP_Final, PPBC %in% c("involuting","nulliparous"), )
MCP_inv_prbc <- subset(MCP_Final, PPBC %in% c("involuting","pregnant"), )
```

```{r}
MCP_Data$study_group <- ordered(MCP_Data$study_group,
                                levels = c("ppbcpw", "ppbcdl", "prbc", "npbc"))

MCP_Final$study_group <- ordered(MCP_Final$study_group,
                                levels = c("ppbcpw", "ppbcdl", "prbc", "npbc"))

MCP_Final_withoutLAC$study_group <- ordered(MCP_Final_withoutLAC$study_group,
                                levels = c("ppbcpw", "prbc", "npbc"))
```


```{r}
table(MCP_Final$PPBC)
table(MCP_inv$PPBC)
```


# OS and DR defentition

```{r}
surv_OS <- Surv(time = MCP_Final$time_OS_months, event = MCP_Final$death)
surv_OS_without_lac <- Surv(time = MCP_Final_withoutLAC$time_OS_months, event = MCP_Final_withoutLAC$death)
```

```{r}
surv_DR <- Surv(time = MCP_Final$time_DRS_months, event = MCP_Final$distant_recurrence)
surv_DR_without_lac <- Surv(time = MCP_Final_withoutLAC$time_DRS_months, event = MCP_Final_withoutLAC$distant_recurrence)
```

```{r}
MCP_Final <- as.data.frame(MCP_Final)
MCP_Final_withoutLAC <- as.data.frame(MCP_Final_withoutLAC)
MCP_inv <- as.data.frame(MCP_inv)
```



# Plasma cells - Tertiles

Plasma_ID --> BASED ON TERTILES

low = lowest tertile
high = intermediate or high tertile

## OS 
### Kaplan-Meier

```{r}
fit_Plasma_OS <- survfit(surv_OS ~ Plasma_ID_short, data = MCP_Final)
fit_Plasma_OS_without_lac <- survfit(surv_OS_without_lac ~ Plasma_ID_short, data = MCP_Final_withoutLAC)
```

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_Plasma_OS, data = MCP_Final, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "Plasma cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)


ggsurvplot(fit_Plasma_OS_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "Plasma cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```

#### KM by study group

```{r, fig.width=7, fig.height=5}
plot_OS_Plasma_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + Plasma_ID_short, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - Plasma cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_Plasma_studygroup_short

plot_OS_Plasma_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + Plasma_ID_short, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - Plasma cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_Plasma_studygroup_short_without_lac
```


#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_OS_Plasma_highVSlow_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + Plasma_ID_short, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - Plasma cluster by study-group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Plasma_ID_short")

plot_OS_Plasma_highVSlow_short


plot_OS_Plasma_highVSlow_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + Plasma_ID_short, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - Plasma cluster by study-group",
    palette = c("#46CDCF","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Plasma_ID_short")

plot_OS_Plasma_highVSlow_short_without_lac
```

### Univariate

```{r}
#univariate
cox_OS_Plasma_cluster <- coxph(Surv(time_OS_months, death) ~ Plasma_ID_short, data = MCP_Final)
summary(cox_OS_Plasma_cluster)
```

### multivariate

#### all covariates

```{r}
#multivariate
cox_OS_Plasma_cluster_multivariate <- coxph(Surv(time_OS_months, death) ~ Plasma_ID_short + study_group + stage + clin_subtype, data = MCP_Final)
summary(cox_OS_Plasma_cluster_multivariate)
```


```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + clin_subtype + strata(Plasma_ID_short), data = MCP_Final)
study_strata
ggadjustedcurves(study_strata, data=MCP_Final, method="conditional", variable="Plasma_ID_short", palette = c("#a10702", "#ffb600")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```

```{r}
#with study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + clin_subtype + study_group + strata(Plasma_ID_short), data = MCP_Final)
study_strata
ggadjustedcurves(study_strata, data=MCP_Final, method="conditional", variable="Plasma_ID_short", palette = c("#a10702", "#ffb600"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```

Testing proportional hazards assumption 

```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + Plasma_ID_short + clin_subtype,
  data = MCP_Final) %>%
  cox.zph()
```

-> To solve our problem: we stratified 

```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + Plasma_ID_short + strata(clin_subtype),
  data = MCP_Final) %>%
  cox.zph()
```

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    Plasma_ID_short +
    study_group +
    strata(clin_subtype),
  data = MCP_Final)
summary(clin.cov.cox)
```


#### within study groups

subset data low plasma B-cell signature versus high Plasma B-cell signature 
```{r}
MCP_Final_withoutLAC_Plasmalow <- subset(MCP_Final_withoutLAC, Plasma_ID_short %in% c("low"), )
MCP_Final_withoutLAC_Plasmahigh <- subset(MCP_Final_withoutLAC, Plasma_ID_short %in% c("high"), )
```

Testing proportional hazards assumption
```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_Plasmahigh) %>%
  cox.zph()
```


low Plasma cluster 

univariate 
```{r}
#univariate
cox_OS_Plasmalow <- coxph(Surv(time_OS_months, death) ~ study_group, data = MCP_Final_withoutLAC_Plasmalow)
summary(cox_OS_Plasmalow)
```

multivariate 
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    study_group + strata(clin_subtype),
  data = MCP_Final_withoutLAC_Plasmalow)
summary(clin.cov.cox)
```


High Plasma cluster 

univariate 
```{r}
#univariate
cox_OS_Plasmahigh <- coxph(Surv(time_OS_months, death) ~ study_group, data = MCP_Final_withoutLAC_Plasmahigh)
summary(cox_OS_Plasmahigh)
```

multivariate
```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    study_group +
    strata(clin_subtype),
  data = MCP_Final_withoutLAC_Plasmahigh)
summary(clin.cov.cox)
```

## DR 

```{r}
fit_Plasma_DR <- survfit(surv_DR ~ Plasma_ID_short, data = MCP_Final)
fit_Plasma_DR_without_lac <- survfit(surv_DR_without_lac ~ Plasma_ID_short, data = MCP_Final_withoutLAC)
```

### Kaplan-Meier
```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_Plasma_DR, data = MCP_Final, pval = TRUE, legend = "top", legend.title = "Plasma cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)

ggsurvplot(fit_Plasma_DR_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.title = "Plasma cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```


#### KM by study group

```{r, fig.width=7, fig.height=5}
plot_DRS_Plasma_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + Plasma_ID_short, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - Plasma cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
plot_DRS_Plasma_studygroup_short

plot_DRS_Plasma_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + Plasma_ID_short, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - Plasma cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_DRS_Plasma_studygroup_short_without_lac
```

#### KM high vs low

```{r, fig.width=7, fig.height=5}
plot_DRS_Plasma_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + Plasma_ID_short, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - Plasma cluster by study_group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    pval = T, facet.by = "Plasma_ID_short")
plot_DRS_Plasma_studygroup_short

plot_DRS_Plasma_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + Plasma_ID_short, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - Plasma cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF","#AA96DA", "#521262"),
    pval = T, facet.by = "Plasma_ID_short")
plot_DRS_Plasma_studygroup_short_without_lac
```

### univariate
```{r}
#univariate
cox_DR_Plasma_cluster <- coxph(Surv(time_DRS_months, distant_recurrence) ~ Plasma_ID_short, data = MCP_Final)
summary(cox_DR_Plasma_cluster)
```

### multivariate
```{r}
#multivariate 
cox_DR_Plasma_cluster_multivariate <- coxph(Surv(time_DRS_months, distant_recurrence) ~ Plasma_ID_short + study_group + stage + clin_subtype, data = MCP_Final)
summary(cox_DR_Plasma_cluster_multivariate)
```


```{r}
MCP_Final <- as.data.frame(MCP_Final)
```

```{r}
study_strata <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer + clin_subtype + study_group + strata(Plasma_ID_short), data = MCP_Final)
study_strata
ggadjustedcurves(study_strata, data=MCP_Final, method="conditional", variable="Plasma_ID_short", palette = c("#a10702", "#ffb600", "#ff7900")) +
  ggtitle("Adjusted DR curve for clinical covariates: Stratified")
```


Testing proportional hazards assumption 
```{r}
coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ study_group + stage_short_integer + Plasma_ID_short + clin_subtype,
  data = MCP_Final) %>%
  cox.zph()
```


-> To solve our problem: we stratified for clin_subtype

```{r}
coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ study_group + stage_short_integer + Plasma_ID_short + strata(clin_subtype),
  data = MCP_Final) %>%
  cox.zph()
```

```{r}
#with study group 
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer +
    Plasma_ID_short +
    study_group +
    strata(clin_subtype),
  data = MCP_Final)
summary(clin.cov.cox)
```


#### within plasma high low

Testing proportional hazards assumption 
```{r}
coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ study_group + stage_short_integer + clin_subtype,
  data = MCP_Final_withoutLAC_Plasmahigh) %>%
  cox.zph()

coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ study_group + stage_short_integer + strata(clin_subtype),
  data = MCP_Final_withoutLAC_Plasmahigh) %>%
  cox.zph()
```


low Plasma cluster 
univariate 
```{r}
#univariate
cox_DR_Plasmalow <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = MCP_Final_withoutLAC_Plasmalow)
summary(cox_DR_Plasmalow)
```

multivariate 
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer +
    study_group +
    strata(clin_subtype),
  data = MCP_Final_withoutLAC_Plasmalow)
summary(clin.cov.cox)
```

High Plasma cluster 
univariate 
```{r}
#univariate
cox_OS_Plasmahigh <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = MCP_Final_withoutLAC_Plasmahigh)
summary(cox_OS_Plasmahigh)
```

multivariate
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer +
    study_group +
    strata(clin_subtype),
  data = MCP_Final_withoutLAC_Plasmahigh)
summary(clin.cov.cox)
```


# Plasma cells - based on median

Plasma_cat --> BASED ON MEDIAN

low = below median 
high = above median 

## OS 
### Kaplan-Meier

```{r}
fit_Plasma_OS <- survfit(surv_OS ~ Plasma_cat, data = MCP_Final)
fit_Plasma_OS_without_lac <- survfit(surv_OS_without_lac ~ Plasma_cat, data = MCP_Final_withoutLAC)
```

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_Plasma_OS, data = MCP_Final, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "Plasma cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)

ggsurvplot(fit_Plasma_OS_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "Plasma cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```


#### KM by study group

```{r, fig.width=7, fig.height=5}
plot_OS_Plasma_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + Plasma_cat, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - Plasma cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_Plasma_studygroup_short

plot_OS_Plasma_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + Plasma_cat, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - Plasma cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_Plasma_studygroup_short_without_lac
```

#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_OS_Plasma_highVSlow_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + Plasma_cat, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - Plasma cluster by study-group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Plasma_cat")

plot_OS_Plasma_highVSlow_short


plot_OS_Plasma_highVSlow_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + Plasma_cat, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - Plasma cluster by study-group",
    palette = c("#46CDCF","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "Plasma_cat")

plot_OS_Plasma_highVSlow_short_without_lac
```


### Univariate

```{r}
#univariate
cox_OS_Plasma_cluster <- coxph(Surv(time_OS_months, death) ~ Plasma_cat, data = MCP_Final)
summary(cox_OS_Plasma_cluster)
```

### multivariate

```{r}
table(MCP_Final$study_group)
```


```{r}
#multivariate
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    PPBC +
    Plasma_cat +
    clin_subtype,
  data = MCP_Final)
summary(clin.cov.cox)
```

```{r}
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ Plasma_cat + strata(study_group), data = MCP_Final)
study_strata
MCP_OS_multivariate_Plasma <- ggadjustedcurves(study_strata, data=MCP_Final, method="conditional", variable="study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"), ylab = "DRS Probability", xlab = "Months", ggtheme = theme_bw()) + ggtitle("OS multivariate")
MCP_OS_multivariate_Plasma
```


```{r}
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ Plasma_cat + stage + clin_subtype + strata(study_group), data = MCP_Final)
study_strata
MCP_OS_multivariate_Plasma <- ggadjustedcurves(study_strata, data=MCP_Final, method="conditional", variable="study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"), ylab = "DRS Probability", xlab = "Months", ggtheme = theme_bw()) + ggtitle("OS multivariate")
MCP_OS_multivariate_Plasma
```


#### within study groups
subset data low IG signature versus high IG signature 
```{r}
MCP_Final_withoutLAC_Plasmalow <- subset(MCP_Final_withoutLAC, Plasma_cat %in% c("low"), )
MCP_Final_withoutLAC_Plasmahigh <- subset(MCP_Final_withoutLAC, Plasma_cat %in% c("high"), )
```

Testing proportional hazards assumption 
```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_Plasmalow) %>%
  cox.zph()

coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_Plasmahigh) %>%
  cox.zph()
```


low Plasma cluster 

univariate 
```{r}
#univariate
cox_OS_Plasmalow <- coxph(Surv(time_OS_months, death) ~ study_group, data = MCP_Final_withoutLAC_Plasmalow)
summary(cox_OS_Plasmalow)
```

multivariate 
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    stage_short_integer +
    study_group +
    clin_subtype,
  data = MCP_Final_withoutLAC_Plasmalow)
summary(clin.cov.cox)
```


High Plasma cluster 

univariate 
```{r}
#univariate
cox_OS_Plasmahigh <- coxph(Surv(time_OS_months, death) ~ study_group, data = MCP_Final_withoutLAC_Plasmahigh)
summary(cox_OS_Plasmahigh)
```

multivariate
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    study_group +
    clin_subtype,
  data = MCP_Final_withoutLAC_Plasmahigh)
summary(clin.cov.cox)
```

## DR 
```{r}
fit_Plasma_DR <- survfit(surv_DR ~ Plasma_cat, data = MCP_Final)
fit_Plasma_DR_without_lac <- survfit(surv_DR_without_lac ~ Plasma_cat, data = MCP_Final_withoutLAC)
```

### Kaplan-Meier
```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_Plasma_DR, data = MCP_Final, pval = TRUE, legend = "top", legend.title = "Plasma cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)

ggsurvplot(fit_Plasma_DR_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.title = "Plasma cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```

#### KM by study group

```{r, fig.width=7, fig.height=5}
plot_DRS_Plasma_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + Plasma_cat, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - Plasma cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
plot_DRS_Plasma_studygroup_short

plot_DRS_Plasma_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + Plasma_cat, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - Plasma cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_DRS_Plasma_studygroup_short_without_lac
```

#### KM high vs low

```{r, fig.width=7, fig.height=5}
plot_DRS_Plasma_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + Plasma_cat, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - Plasma cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    pval = T, facet.by = "Plasma_cat")
plot_DRS_Plasma_studygroup_short

plot_DRS_Plasma_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + Plasma_cat, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - Plasma cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF","#AA96DA", "#521262"),
    pval = T, facet.by = "Plasma_cat")
plot_DRS_Plasma_studygroup_short_without_lac
```


### univariate

```{r}
#univariate
cox_DR_Plasma_cluster <- coxph(Surv(time_DRS_months, distant_recurrence) ~ Plasma_cat, data = MCP_Final)
summary(cox_DR_Plasma_cluster)
```

### multivariate

```{r}
#multivariate 
cox_DR_Plasma_cluster_multivariate <- coxph(Surv(time_DRS_months, distant_recurrence) ~ Plasma_cat + PPBC + stage + clin_subtype, data = MCP_Final)
summary(cox_DR_Plasma_cluster_multivariate)
```


```{r}
study_strata <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ Plasma_cat + stage + clin_subtype + strata(study_group), data = MCP_Final)
study_strata
MCP_DRS_multivariate_Plasma <- ggadjustedcurves(study_strata, data=MCP_Final, method="conditional", variable="study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"), ylab = "DRS Probability", xlab = "Months", ggtheme = theme_bw()) + ggtitle("OS multivariate")
MCP_DRS_multivariate_Plasma
```

#### within study groups

subset data low IG signature versus high IG signature 

low Plasma cluster 
univariate 
```{r}
#univariate
cox_OS_Plasmalow <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = MCP_Final_withoutLAC_Plasmalow)
summary(cox_OS_Plasmalow)
```


multivariate 
```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer +
    study_group +
    clin_subtype,
  data = MCP_Final_withoutLAC_Plasmalow)
summary(clin.cov.cox)
```


High Plasma cluster 

univariate 
```{r}
#univariate
cox_OS_Plasmahigh <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = MCP_Final_withoutLAC_Plasmahigh)
summary(cox_OS_Plasmahigh)
```

multivariate
```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer +
    study_group +
    clin_subtype,
  data = MCP_Final_withoutLAC_Plasmahigh)
summary(clin.cov.cox)
```

# memoryB+ cells - tertiles

memoryB_cat --> BASED ON TERTILES
low = lowest tertile
high = intermediate or high tertile

## OS 

### Kaplan-Meier
```{r}
fit_memoryB_OS <- survfit(surv_OS ~ memoryB_cat, data = MCP_Final)
fit_memoryB_OS_without_lac <- survfit(surv_OS_without_lac ~ memoryB_cat, data = MCP_Final_withoutLAC)
```

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_memoryB_OS, data = MCP_Final, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "memoryB cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)

ggsurvplot(fit_memoryB_OS_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "memoryB cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)
```

#### KM by study group

```{r, fig.width=7, fig.height=5}
plot_OS_memoryB_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + memoryB_cat, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - memoryB cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_memoryB_studygroup_short

plot_OS_memoryB_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + memoryB_cat, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - memoryB cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_memoryB_studygroup_short_without_lac
```

#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_OS_memoryB_highVSlow_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + memoryB_cat, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - memoryB cluster by study-group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "memoryB_cat")

plot_OS_memoryB_highVSlow_short

plot_OS_memoryB_highVSlow_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + memoryB_cat, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - memoryB cluster by study-group",
    palette = c("#46CDCF","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "memoryB_cat")

plot_OS_memoryB_highVSlow_short_without_lac
```

### Univariate
```{r}
#univariate
cox_OS_memoryB_cluster <- coxph(Surv(time_OS_months, death) ~ memoryB_cat, data = MCP_Final)
summary(cox_OS_memoryB_cluster)
```

### multivariate
```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + memoryB_cat + study_group + clin_subtype,
  data = MCP_Final) %>%
  cox.zph()

coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + memoryB_cat + study_group+ strata(clin_subtype),
  data = MCP_Final) %>%
  cox.zph()
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    memoryB_cat +
    study_group +
    strata(clin_subtype),
  data = MCP_Final)
summary(clin.cov.cox)
```

#### within study groups
subset data low IG signature versus high IG signature 
```{r}
MCP_Final_withoutLAC_memoryBlow <- subset(MCP_Final_withoutLAC, memoryB_cat %in% c("low"), )
MCP_Final_withoutLAC_memoryBhigh <- subset(MCP_Final_withoutLAC, memoryB_cat %in% c("high"), )
```

Testing proportional hazards assumption
```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_memoryBlow) %>%
  cox.zph()

coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_memoryBhigh) %>%
  cox.zph()
```


low memoryB cluster 
univariate 
```{r}
#univariate
cox_OS_memoryBlow <- coxph(Surv(time_OS_months, death) ~ study_group, data = MCP_Final_withoutLAC_memoryBlow)
summary(cox_OS_memoryBlow)
```


multivariate 
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    study_group +
    clin_subtype,
  data = MCP_Final_withoutLAC_memoryBlow)
summary(clin.cov.cox)
```


High memoryB cluster 
univariate 
```{r}
#univariate
cox_OS_memoryBhigh <- coxph(Surv(time_OS_months, death) ~ study_group, data = MCP_Final_withoutLAC_memoryBhigh)
summary(cox_OS_memoryBhigh)
```

multivariate
```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    study_group +
    clin_subtype,
  data = MCP_Final_withoutLAC_memoryBhigh)
summary(clin.cov.cox)
```

## DR 
```{r}
fit_memoryB_DR <- survfit(surv_DR ~ memoryB_cat, data = MCP_Final)
fit_memoryB_DR_without_lac <- survfit(surv_DR_without_lac ~ memoryB_cat, data = MCP_Final_withoutLAC)
```

### Kaplan-Meier
```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_memoryB_DR, data = MCP_Final, pval = TRUE, legend = "top", legend.title = "memoryB cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)

ggsurvplot(fit_memoryB_DR_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.title = "memoryB cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```

#### KM by study group

```{r, fig.width=7, fig.height=5}
plot_DRS_memoryB_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + memoryB_cat, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - memoryB cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
plot_DRS_memoryB_studygroup_short

plot_DRS_memoryB_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + memoryB_cat, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - memoryB cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_DRS_memoryB_studygroup_short_without_lac
```

#### KM high vs low

```{r, fig.width=7, fig.height=5}
plot_DRS_memoryB_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + memoryB_cat, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - memoryB cluster by study_group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    pval = T, facet.by = "memoryB_cat")
plot_DRS_memoryB_studygroup_short

plot_DRS_memoryB_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + memoryB_cat, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - memoryB cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF","#AA96DA", "#521262"),
    pval = T, facet.by = "memoryB_cat")
plot_DRS_memoryB_studygroup_short_without_lac
```

### univariate
```{r}
#univariate
cox_DR_memoryB_cluster <- coxph(Surv(time_DRS_months, distant_recurrence) ~ memoryB_cat, data = MCP_Final)
summary(cox_DR_memoryB_cluster)
```

### multivariate

Testing proportional hazards assumption
```{r}
coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage + memoryB_cat + study_group +  clin_subtype,
  data = MCP_Final) %>%
  cox.zph()
```

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    memoryB_cat +
    study_group +
    strata(clin_subtype),
  data = MCP_Final)
summary(clin.cov.cox)
```

#### within memory B
```{r}
coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_memoryBlow) %>%
  cox.zph()

coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_memoryBhigh) %>%
  cox.zph()
```


low memoryB cluster 
univariate 
```{r}
#univariate
cox_OS_memoryBlow <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = MCP_Final_withoutLAC_memoryBlow)
summary(cox_OS_memoryBlow)
```

multivariate 
```{r}
clin.cov.cox_3 <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    study_group +
    clin_subtype,
  data = MCP_Final_withoutLAC_memoryBlow)
summary(clin.cov.cox_3)
```

High memoryB cluster 
univariate 
```{r}
#univariate
cox_OS_memoryBhigh <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = MCP_Final_withoutLAC_memoryBhigh)
summary(cox_OS_memoryBhigh)
```

multivariate
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    study_group +
    clin_subtype,
  data = MCP_Final_withoutLAC_memoryBhigh)
summary(clin.cov.cox)
```


# memoryB+ cells - median

memoryB_ID --> BASED ON MEDIAN

## OS 

### Kaplan-Meier
```{r}
fit_memoryB_OS <- survfit(surv_OS ~ memoryB_ID, data = MCP_Final)
fit_memoryB_OS_without_lac <- survfit(surv_OS_without_lac ~ memoryB_ID, data = MCP_Final_withoutLAC)
```

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_memoryB_OS, data = MCP_Final, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "memoryB cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)

ggsurvplot(fit_memoryB_OS_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "memoryB cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)
```

#### KM by study group

```{r, fig.width=7, fig.height=5}
plot_OS_memoryB_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + memoryB_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - memoryB cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_memoryB_studygroup_short

plot_OS_memoryB_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + memoryB_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - memoryB cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_memoryB_studygroup_short_without_lac
```

#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_OS_memoryB_highVSlow_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + memoryB_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - memoryB cluster by study-group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "memoryB_ID")

plot_OS_memoryB_highVSlow_short

plot_OS_memoryB_highVSlow_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + memoryB_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - memoryB cluster by study-group",
    palette = c("#46CDCF","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "memoryB_ID")

plot_OS_memoryB_highVSlow_short_without_lac
```


### Univariate
```{r}
#univariate
cox_OS_memoryB_cluster <- coxph(Surv(time_OS_months, death) ~ memoryB_ID, data = MCP_Final)
summary(cox_OS_memoryB_cluster)
```

### multivariate
```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + memoryB_ID + study_group + clin_subtype,
  data = MCP_Final) %>%
  cox.zph()

coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + memoryB_ID + study_group+ strata(clin_subtype),
  data = MCP_Final) %>%
  cox.zph()
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    memoryB_ID +
    study_group +
    strata(clin_subtype),
  data = MCP_Final)
summary(clin.cov.cox)
```

#### within study groups
subset data low IG signature versus high IG signature 
```{r}
MCP_Final_withoutLAC_memoryBlow <- subset(MCP_Final_withoutLAC, memoryB_ID %in% c("low"), )
MCP_Final_withoutLAC_memoryBhigh <- subset(MCP_Final_withoutLAC, memoryB_ID %in% c("high"), )
```

Testing proportional hazards assumption
```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_memoryBlow) %>%
  cox.zph()

coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_memoryBhigh) %>%
  cox.zph()
```


low memoryB cluster 
univariate 
```{r}
#univariate
cox_OS_memoryBlow <- coxph(Surv(time_OS_months, death) ~ study_group, data = MCP_Final_withoutLAC_memoryBlow)
summary(cox_OS_memoryBlow)
```


multivariate 
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    study_group +
    clin_subtype,
  data = MCP_Final_withoutLAC_memoryBlow)
summary(clin.cov.cox)
```


High memoryB cluster 
univariate 
```{r}
#univariate
cox_OS_memoryBhigh <- coxph(Surv(time_OS_months, death) ~ study_group, data = MCP_Final_withoutLAC_memoryBhigh)
summary(cox_OS_memoryBhigh)
```

multivariate
```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    study_group +
    clin_subtype,
  data = MCP_Final_withoutLAC_memoryBhigh)
summary(clin.cov.cox)
```

## DR 
```{r}
fit_memoryB_DR <- survfit(surv_DR ~ memoryB_ID, data = MCP_Final)
fit_memoryB_DR_without_lac <- survfit(surv_DR_without_lac ~ memoryB_ID, data = MCP_Final_withoutLAC)
```

### Kaplan-Meier
```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_memoryB_DR, data = MCP_Final, pval = TRUE, legend = "top", legend.title = "memoryB cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)

ggsurvplot(fit_memoryB_DR_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.title = "memoryB cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```

#### KM by study group

```{r, fig.width=7, fig.height=5}
plot_DRS_memoryB_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + memoryB_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - memoryB cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
plot_DRS_memoryB_studygroup_short

plot_DRS_memoryB_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + memoryB_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - memoryB cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_DRS_memoryB_studygroup_short_without_lac
```

#### KM high vs low

```{r, fig.width=7, fig.height=5}
plot_DRS_memoryB_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + memoryB_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - memoryB cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    pval = T, facet.by = "memoryB_ID")
plot_DRS_memoryB_studygroup_short

plot_DRS_memoryB_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + memoryB_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - memoryB cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF","#AA96DA", "#521262"),
    pval = T, facet.by = "memoryB_ID")
plot_DRS_memoryB_studygroup_short_without_lac
```

### univariate
```{r}
#univariate
cox_DR_memoryB_cluster <- coxph(Surv(time_DRS_months, distant_recurrence) ~ memoryB_ID, data = MCP_Final)
summary(cox_DR_memoryB_cluster)
```

### multivariate

Testing proportional hazards assumption
```{r}
coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage + memoryB_ID + study_group +  clin_subtype,
  data = MCP_Final) %>%
  cox.zph()
```

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    memoryB_ID +
    study_group +
    strata(clin_subtype),
  data = MCP_Final)
summary(clin.cov.cox)
```

#### within smemory B
```{r}
coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_memoryBlow) %>%
  cox.zph()

coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_memoryBhigh) %>%
  cox.zph()
```


low memoryB cluster 
univariate 
```{r}
#univariate
cox_OS_memoryBlow <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = MCP_Final_withoutLAC_memoryBlow)
summary(cox_OS_memoryBlow)
```

multivariate 
```{r}
clin.cov.cox_3 <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    study_group +
    clin_subtype,
  data = MCP_Final_withoutLAC_memoryBlow)
summary(clin.cov.cox_3)
```

High memoryB cluster 
univariate 
```{r}
#univariate
cox_OS_memoryBhigh <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = MCP_Final_withoutLAC_memoryBhigh)
summary(cox_OS_memoryBhigh)
```

multivariate
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    study_group +
    clin_subtype,
  data = MCP_Final_withoutLAC_memoryBhigh)
summary(clin.cov.cox)
```


# naiveB+ cells - median 

naiveB_ID --> Based on MEDIAN

## OS 
### Kaplan-Meier

```{r}
fit_naiveB_OS <- survfit(surv_OS ~ naiveB_ID, data = MCP_Final)
fit_naiveB_OS_without_lac <- survfit(surv_OS_without_lac ~ naiveB_ID, data = MCP_Final_withoutLAC)
```

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_naiveB_OS, data = MCP_Final, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "naiveB cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)

ggsurvplot(fit_naiveB_OS_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "naiveB cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```

#### KM by study group

```{r, fig.width=7, fig.height=5}
plot_OS_naiveB_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + naiveB_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - naiveB cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_naiveB_studygroup_short

plot_OS_naiveB_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + naiveB_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - naiveB cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_naiveB_studygroup_short_without_lac
```

#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_OS_naiveB_highVSlow_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + naiveB_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - naiveB cluster by study-group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "naiveB_ID")

plot_OS_naiveB_highVSlow_short


plot_OS_naiveB_highVSlow_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + naiveB_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - naiveB cluster by study-group",
    palette = c("#46CDCF","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "naiveB_ID")

plot_OS_naiveB_highVSlow_short_without_lac
```

### Univariate

```{r}
#univariate
cox_OS_naiveB_cluster <- coxph(Surv(time_OS_months, death) ~ naiveB_ID, data = MCP_Final_withoutLAC)
summary(cox_OS_naiveB_cluster)
```

### multivariate

```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + naiveB_ID + study_group +  clin_subtype,
  data = MCP_Final_withoutLAC) %>%
  cox.zph()

coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + naiveB_ID + study_group + strata(clin_subtype),
  data = MCP_Final_withoutLAC) %>%
  cox.zph()
```

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    naiveB_ID +
    study_group +
    strata(clin_subtype),
  data = MCP_Final_withoutLAC)
summary(clin.cov.cox)
```

#### within study groups
subset data low IG signature versus high IG signature 
```{r}
MCP_Final_withoutLAC_naiveBlow <- subset(MCP_Final_withoutLAC, naiveB_ID %in% c("low"), )
MCP_Final_withoutLAC_naiveBhigh <- subset(MCP_Final_withoutLAC, naiveB_ID %in% c("high"), )
```

Testing proportional hazards assumption 
```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_naiveBlow) %>%
  cox.zph()

coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_naiveBhigh) %>%
  cox.zph()
```


low naiveB cluster 

univariate 
```{r}
#univariate
cox_OS_naiveBlow <- coxph(Surv(time_OS_months, death) ~ study_group, data = MCP_Final_withoutLAC_naiveBlow)
summary(cox_OS_naiveBlow)
```

multivariate 
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    study_group +
    clin_subtype,
  data = MCP_Final_withoutLAC_naiveBlow)
summary(clin.cov.cox)
```


High naiveB cluster 

univariate 
```{r}
#univariate
cox_OS_naiveBhigh <- coxph(Surv(time_OS_months, death) ~ study_group, data = MCP_Final_withoutLAC_naiveBhigh)
summary(cox_OS_naiveBhigh)
```

multivariate
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    study_group +
    clin_subtype,
  data = MCP_Final_withoutLAC_naiveBhigh)
summary(clin.cov.cox)
```

## DR 

```{r}
fit_naiveB_DR <- survfit(surv_DR ~ naiveB_ID, data = MCP_Final)
fit_naiveB_DR_without_lac <- survfit(surv_DR_without_lac ~ naiveB_ID, data = MCP_Final_withoutLAC)
```

### Kaplan-Meier
```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_naiveB_DR, data = MCP_Final, pval = TRUE, legend = "top", legend.title = "naiveB cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)

ggsurvplot(fit_naiveB_DR_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.title = "naiveB cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```

#### KM by study group
```{r, fig.width=7, fig.height=5}
plot_DRS_naiveB_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + naiveB_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - naiveB cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
plot_DRS_naiveB_studygroup_short

plot_DRS_naiveB_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + naiveB_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - naiveB cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_DRS_naiveB_studygroup_short_without_lac
```


#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_DRS_naiveB_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + naiveB_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - naiveB cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    pval = T, facet.by = "naiveB_ID")
plot_DRS_naiveB_studygroup_short

plot_DRS_naiveB_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + naiveB_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - naiveB cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF","#AA96DA", "#521262"),
    pval = T, facet.by = "naiveB_ID")
plot_DRS_naiveB_studygroup_short_without_lac
```



### univariate
```{r}
#univariate
cox_DR_naiveB_cluster <- coxph(Surv(time_DRS_months, distant_recurrence) ~ naiveB_ID, data = MCP_Final)
summary(cox_DR_naiveB_cluster)
```

### multivariate

```{r}
coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ study_group + stage_short_integer + naiveB_ID + clin_subtype,
  data = MCP_Final) %>%
  cox.zph()

coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ study_group + stage_short_integer + naiveB_ID + strata(clin_subtype),
  data = MCP_Final) %>%
  cox.zph()
```

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer +
    naiveB_ID +
    study_group + 
    strata(clin_subtype),
  data = MCP_Final)
summary(clin.cov.cox)
```

#### within study groups
subset data low IG signature versus high IG signature 

Testing proportional hazards assumption 
```{r}
coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_naiveBlow) %>%
  cox.zph()

coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_naiveBhigh) %>%
  cox.zph()
```


low naiveB cluster 
univariate 
```{r}
#univariate
cox_OS_naiveBlow <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = MCP_Final_withoutLAC_naiveBlow)
summary(cox_OS_naiveBlow)
```

multivariate 
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer +
    study_group +
    clin_subtype,
  data = MCP_Final_withoutLAC_naiveBlow)
summary(clin.cov.cox)
```

High naiveB cluster 
univariate 
```{r}
#univariate
cox_OS_naiveBhigh <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = MCP_Final_withoutLAC_naiveBhigh)
summary(cox_OS_naiveBhigh)
```

multivariate
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer +
    study_group +
    clin_subtype,
  data = MCP_Final_withoutLAC_naiveBhigh)
summary(clin.cov.cox)
```


# CD8+ cells - tertiles

CD8_cat --> tertiles

## OS 

### Kaplan-Meier

```{r}
fit_CD8_OS <- survfit(surv_OS ~ CD8_cat, data = MCP_Final)
fit_CD8_OS_without_lac <- survfit(surv_OS_without_lac ~ CD8_cat, data = MCP_Final_withoutLAC)
```

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_CD8_OS, data = MCP_Final, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "CD8 cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)

ggsurvplot(fit_CD8_OS_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "CD8 cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)
```

#### KM by study group

```{r, fig.width=7, fig.height=5}
plot_OS_CD8_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + CD8_cat, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD8 cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_CD8_studygroup_short

plot_OS_CD8_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + CD8_cat, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD8 cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_CD8_studygroup_short_without_lac
```

#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_OS_CD8_highVSlow_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + CD8_cat, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD8 cluster by study-group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "CD8_cat")

plot_OS_CD8_highVSlow_short


plot_OS_CD8_highVSlow_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + CD8_cat, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD8 cluster by study-group",
    palette = c("#46CDCF","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "CD8_cat")

plot_OS_CD8_highVSlow_short_without_lac
```

### Univariate
```{r}
#univariate
cox_OS_CD8_cluster <- coxph(Surv(time_OS_months, death) ~ CD8_cat, data = MCP_Final)
summary(cox_OS_CD8_cluster)
```

### multivariate
Testing proportional hazards assumption 

```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + CD8_cat + study_group + clin_subtype,
  data = MCP_Final) %>%
  cox.zph()

coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + CD8_cat + study_group + strata(clin_subtype),
  data = MCP_Final) %>%
  cox.zph()
```

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    CD8_cat +
    study_group +
    strata(clin_subtype),
  data = MCP_Final)
summary(clin.cov.cox)
```

#### within study groups

subset data low IG signature versus high IG signature 
```{r}
MCP_Final_withoutLAC_CD8low <- subset(MCP_Final_withoutLAC, CD8_cat %in% c("low"), )
MCP_Final_withoutLAC_CD8high <- subset(MCP_Final_withoutLAC, CD8_cat %in% c("high"), )
```

Testing proportional hazards assumption 

```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_CD8low) %>%
  cox.zph()

coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + strata(clin_subtype),
  data = MCP_Final_withoutLAC_CD8high) %>%
  cox.zph()
```

low CD8 cluster 
univariate 
```{r}
#univariate
cox_OS_CD8low <- coxph(Surv(time_OS_months, death) ~ study_group, data = MCP_Final_withoutLAC_CD8low)
summary(cox_OS_CD8low)
```

multivariate 
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    study_group +
    strata(clin_subtype),
  data = MCP_Final_withoutLAC_CD8low)
summary(clin.cov.cox)
```


High CD8 cluster 
univariate 
```{r}
#univariate
cox_OS_CD8high <- coxph(Surv(time_OS_months, death) ~ study_group, data = MCP_Final_withoutLAC_CD8high)
summary(cox_OS_CD8high)
```

multivariate
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    study_group +
    strata(clin_subtype),
  data = MCP_Final_withoutLAC_CD8high)
summary(clin.cov.cox)
```

## DR 

```{r}
fit_CD8_DR <- survfit(surv_DR ~ CD8_cat, data = MCP_Final)
fit_CD8_DR_without_lac <- survfit(surv_DR_without_lac ~ CD8_cat, data = MCP_Final_withoutLAC)
```

### Kaplan-Meier

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_CD8_DR, data = MCP_Final, pval = TRUE, legend = "top", legend.title = "CD8 cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)

ggsurvplot(fit_CD8_DR_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.title = "CD8 cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```

#### KM by study group

```{r, fig.width=7, fig.height=5}
plot_DRS_CD8_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + CD8_cat, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - CD8 cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
plot_DRS_CD8_studygroup_short

plot_DRS_CD8_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + CD8_cat, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - CD8 cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_DRS_CD8_studygroup_short_without_lac
```

#### KM high vs low

```{r, fig.width=7, fig.height=5}
plot_DRS_CD8_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + CD8_cat, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - CD8 cluster by study_group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    pval = T, facet.by = "CD8_cat")
plot_DRS_CD8_studygroup_short

plot_DRS_CD8_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + CD8_cat, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - CD8 cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF","#AA96DA", "#521262"),
    pval = T, facet.by = "CD8_cat")
plot_DRS_CD8_studygroup_short_without_lac
```

### univariate

```{r}
#univariate
cox_DR_CD8_cluster <- coxph(Surv(time_DRS_months, distant_recurrence) ~ CD8_cat, data = MCP_Final)
summary(cox_DR_CD8_cluster)
```

### multivariate

Testing proportional hazards assumption 

```{r}
coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer + CD8_cat + study_group + clin_subtype,
  data = MCP_Final) %>%
  cox.zph()

coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer + CD8_cat + study_group + strata(clin_subtype),
  data = MCP_Final) %>%
  cox.zph()
```

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer +
    CD8_cat +
    study_group +
    strata(clin_subtype),
  data = MCP_Final)
summary(clin.cov.cox)
```

#### within study groups

```{r}
coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_CD8low) %>%
  cox.zph()

coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_CD8high) %>%
  cox.zph()
```


low CD8 cluster 
univariate 
```{r}
#univariate
cox_OS_CD8low <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = MCP_Final_withoutLAC_CD8low)
summary(cox_OS_CD8low)
```

multivariate 
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ study_group + stage_short_integer + strata(clin_subtype),
  data = MCP_Final_withoutLAC_CD8low)
summary(clin.cov.cox)
```


High CD8 cluster 

univariate 

```{r}
#univariate
cox_OS_CD8high <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = MCP_Final_withoutLAC_CD8high)
summary(cox_OS_CD8high)
```

multivariate
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer +
    study_group +
    strata(clin_subtype),
  data = MCP_Final_withoutLAC_CD8high)
summary(clin.cov.cox)
```


# CD8+ cells - Median

CD8_ID --> Median

## OS 

### Kaplan-Meier

```{r}
fit_CD8_OS <- survfit(surv_OS ~ CD8_ID, data = MCP_Final)
fit_CD8_OS_without_lac <- survfit(surv_OS_without_lac ~ CD8_ID, data = MCP_Final_withoutLAC)
```

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_CD8_OS, data = MCP_Final, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "CD8 cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)

ggsurvplot(fit_CD8_OS_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "CD8 cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)
```

#### KM by study group
```{r, fig.width=7, fig.height=5}
plot_OS_CD8_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + CD8_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD8 cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_CD8_studygroup_short

plot_OS_CD8_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + CD8_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD8 cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_CD8_studygroup_short_without_lac
```

#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_OS_CD8_highVSlow_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + CD8_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD8 cluster by study-group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "CD8_ID")

plot_OS_CD8_highVSlow_short

plot_OS_CD8_highVSlow_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + CD8_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD8 cluster by study-group",
    palette = c("#46CDCF","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "CD8_ID")

plot_OS_CD8_highVSlow_short_without_lac
```

```{r}
MCP_inv_npbc <- as.data.frame(MCP_inv_npbc)
MCP_inv_prbc <- as.data.frame(MCP_inv_prbc)
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + CD8_ID, data = MCP_inv_npbc), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD8 cluster by study-group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "CD8_ID")

ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + CD8_ID, data = MCP_inv_prbc), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD8 cluster by study-group",
    palette = c("#46CDCF", "#AA96DA"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "CD8_ID")
```


### Univariate

```{r}
#univariate
cox_OS_CD8_cluster <- coxph(Surv(time_OS_months, death) ~ CD8_ID, data = MCP_Final)
summary(cox_OS_CD8_cluster)
```

### multivariate

Testing proportional hazards assumption 

```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + CD8_ID + study_group + clin_subtype,
  data = MCP_Final_withoutLAC) %>%
  cox.zph()

coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + CD8_ID + strata(clin_subtype),
  data = MCP_Final_withoutLAC) %>%
  cox.zph()
```

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    CD8_ID +
    study_group +
    strata(clin_subtype),
  data = MCP_Final_withoutLAC)
summary(clin.cov.cox)
```

#### within CD8 subgroups

```{r}
MCP_Final_withoutLAC_CD8low <- subset(MCP_Final_withoutLAC, CD8_ID %in% c("low"), )
MCP_Final_withoutLAC_CD8high <- subset(MCP_Final_withoutLAC, CD8_ID %in% c("high"), )
```

Testing proportional hazards assumption 
```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_CD8low) %>%
  cox.zph()

coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + strata(clin_subtype),
  data = MCP_Final_withoutLAC_CD8high) %>%
  cox.zph()
```


low CD8 cluster 
univariate 
```{r}
#univariate
cox_OS_CD8low <- coxph(Surv(time_OS_months, death) ~ study_group, data = MCP_Final_withoutLAC_CD8low)
summary(cox_OS_CD8low)
```


multivariate 
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    study_group +
    strata(clin_subtype),
  data = MCP_Final_withoutLAC_CD8low)
summary(clin.cov.cox)
```


High CD8 cluster 

univariate 
```{r}
#univariate
cox_OS_CD8high <- coxph(Surv(time_OS_months, death) ~ study_group, data = MCP_Final_withoutLAC_CD8high)
summary(cox_OS_CD8high)
```

multivariate
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    study_group +
    strata(clin_subtype),
  data = MCP_Final_withoutLAC_CD8high)
summary(clin.cov.cox)
```

## DR 
```{r}
fit_CD8_DR <- survfit(surv_DR ~ CD8_ID, data = MCP_Final)
fit_CD8_DR_without_lac <- survfit(surv_DR_without_lac ~ CD8_ID, data = MCP_Final_withoutLAC)
```

### Kaplan-Meier
```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_CD8_DR, data = MCP_Final, pval = TRUE, legend = "top", legend.title = "CD8 cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)

ggsurvplot(fit_CD8_DR_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.title = "CD8 cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```

#### KM by study group

```{r, fig.width=7, fig.height=5}
plot_DRS_CD8_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + CD8_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - CD8 cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
plot_DRS_CD8_studygroup_short

plot_DRS_CD8_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + CD8_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - CD8 cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_DRS_CD8_studygroup_short_without_lac
```

#### KM high vs low

```{r, fig.width=7, fig.height=5}
plot_DRS_CD8_highVSlow_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + CD8_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - CD8 cluster by study_group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "CD8_ID")
plot_DRS_CD8_highVSlow_short

plot_DRS_CD8_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + CD8_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - CD8 cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF","#AA96DA", "#521262"),
    pval = T, facet.by = "CD8_ID")
plot_DRS_CD8_studygroup_short_without_lac
```

```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + CD8_ID, data = MCP_inv_npbc), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - CD8 cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#521262", "#46CDCF"),
    pval = T, facet.by = "CD8_ID")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + CD8_ID, data = MCP_inv_prbc), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - CD8 cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF", "#AA96DA"),
    pval = T, facet.by = "CD8_ID")
```



### univariate
```{r}
#univariate
cox_DR_CD8_cluster <- coxph(Surv(time_DRS_months, distant_recurrence) ~ CD8_ID, data = MCP_Final)
summary(cox_DR_CD8_cluster)
```

### multivariate
Testing proportional hazards assumption 

```{r}
coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ study_group + stage_short_integer + CD8_ID + clin_subtype,
  data = MCP_Final) %>%
  cox.zph()

coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ study_group + stage_short_integer + CD8_ID + strata(clin_subtype),
  data = MCP_Final) %>%
  cox.zph()
```

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer +
    CD8_ID +
    study_group +
    strata(clin_subtype),
  data = MCP_Final)
summary(clin.cov.cox)
```

#### within CD8 groups
```{r}
coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_CD8low) %>%
  cox.zph()

coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer + study_group + clin_subtype,
  data = MCP_Final_withoutLAC_CD8high) %>%
  cox.zph()
```


low CD8 cluster 
univariate 
```{r}
#univariate
cox_OS_CD8low <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = MCP_Final_withoutLAC_CD8low)
summary(cox_OS_CD8low)
```

multivariate 
```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer + study_group + strata(clin_subtype),
  data = MCP_Final_withoutLAC_CD8low)
summary(clin.cov.cox)
```

High CD8 cluster 
univariate 
```{r}
#univariate
cox_OS_CD8high <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = MCP_Final_withoutLAC_CD8high)
summary(cox_OS_CD8high)
```

multivariate
```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer +
    study_group +
    strata(clin_subtype),
  data = MCP_Final_withoutLAC_CD8high)
summary(clin.cov.cox)
```


# naive CD4+ cells - median

## OS 
### Kaplan-Meier

```{r}
fit_CD4_OS <- survfit(surv_OS ~ CD4naive_ID, data = MCP_Final)
fit_CD4_OS_without_lac <- survfit(surv_OS_without_lac ~ CD4naive_ID, data = MCP_Final_withoutLAC)
```

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_CD4_OS, data = MCP_Final, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "CD4 cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)

ggsurvplot(fit_CD4_OS_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "CD4 cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```


#### KM by study group

```{r, fig.width=7, fig.height=5}
plot_OS_CD4_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + CD4naive_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD4 cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_CD4_studygroup_short

plot_OS_CD4_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + CD4naive_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD4 cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_CD4_studygroup_short_without_lac
```


#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_OS_CD4_highVSlow_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + CD4naive_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD4 cluster by study-group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "CD4naive_ID")

plot_OS_CD4_highVSlow_short


plot_OS_CD4_highVSlow_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + CD4naive_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD4 cluster by study-group",
    palette = c("#46CDCF","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "CD4naive_ID")

plot_OS_CD4_highVSlow_short_without_lac
```


### Univariate

```{r}
#univariate
cox_OS_CD4_cluster <- coxph(Surv(time_OS_months, death) ~ CD4naive_ID, data = MCP_Final)
summary(cox_OS_CD4_cluster)
```

### multivariate
Testing proportional hazards assumption

```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + study_group + CD4naive_ID + clin_subtype,
  data = MCP_Final) %>%
  cox.zph()

coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + CD4naive_ID + strata(clin_subtype),
  data = MCP_Final) %>%
  cox.zph()
```

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    study_group +
    CD4naive_ID +
    strata(clin_subtype),
  data = MCP_Final)
summary(clin.cov.cox)
```


## DR 

```{r}
fit_CD4_DR <- survfit(surv_DR ~ CD4naive_cat, data = MCP_Final)
fit_CD4_DR_without_lac <- survfit(surv_DR_without_lac ~ CD4naive_ID, data = MCP_Final_withoutLAC)
```

### Kaplan-Meier

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_CD4_DR, data = MCP_Final, pval = TRUE, legend = "top", legend.title = "CD4 cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)

ggsurvplot(fit_CD4_DR_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.title = "CD4 cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```

#### KM by study group

```{r, fig.width=7, fig.height=5}
plot_DRS_CD4_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + CD4naive_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - CD4 cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
plot_DRS_CD4_studygroup_short

plot_DRS_CD4_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + CD4naive_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - CD4 cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_DRS_CD4_studygroup_short_without_lac
```

#### KM high vs low

```{r, fig.width=7, fig.height=5}
plot_DRS_CD4_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + CD4naive_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - CD4 cluster by study_group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    pval = T, facet.by = "CD4naive_ID")
plot_DRS_CD4_studygroup_short

plot_DRS_CD4_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + CD4naive_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - CD4 cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF","#AA96DA", "#521262"),
    pval = T, facet.by = "CD4naive_ID")
plot_DRS_CD4_studygroup_short_without_lac
```

### univariate

```{r}
#univariate
cox_DR_CD4_cluster <- coxph(Surv(time_DRS_months, distant_recurrence) ~ CD4naive_ID, data = MCP_Final)
summary(cox_DR_CD4_cluster)
```

### multivariate

Testing proportional hazards assumption

```{r}
coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ study_group + stage_short_integer + CD4naive_ID + clin_subtype,
  data = MCP_Final) %>%
  cox.zph()

coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ study_group + stage_short_integer + CD4naive_ID + strata(clin_subtype),
  data = MCP_Final) %>%
  cox.zph()
```

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage_short_integer +
    CD4naive_ID +
    study_group +
    strata(clin_subtype),
  data = MCP_Final)
summary(clin.cov.cox)
```


# GDT cells - median

## OS 

### Kaplan-Meier

```{r}
fit_GDT_OS <- survfit(surv_OS ~ GDT_ID, data = MCP_Final)
fit_GDT_OS_without_lac <- survfit(surv_OS_without_lac ~ GDT_ID, data = MCP_Final_withoutLAC)
```

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_GDT_OS, data = MCP_Final, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "GDT cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)

ggsurvplot(fit_GDT_OS_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "GDT cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)
```

#### KM by study group

```{r, fig.width=7, fig.height=5}
plot_OS_GDT_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + GDT_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - GDT cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_GDT_studygroup_short

plot_OS_GDT_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + GDT_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - GDT cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_GDT_studygroup_short_without_lac
```

#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_OS_GDT_highVSlow_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + GDT_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - GDT cluster by study-group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "GDT_ID")

plot_OS_GDT_highVSlow_short


plot_OS_GDT_highVSlow_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + GDT_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - GDT cluster by study-group",
    palette = c("#46CDCF","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "GDT_ID")

plot_OS_GDT_highVSlow_short_without_lac
```

### Univariate

```{r}
#univariate
cox_OS_GDT_cluster <- coxph(Surv(time_OS_months, death) ~ GDT_ID, data = MCP_Final)
summary(cox_OS_GDT_cluster)
```

### multivariate
Testing proportional hazards assumption

```{r}
coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + + GDT_ID + clin_subtype,
  data = MCP_Final) %>%
  cox.zph()

coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer + study_group + GDT_ID + strata(clin_subtype),
  data = MCP_Final) %>%
  cox.zph()
```

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage_short_integer +
    GDT_ID +
    study_group +
    strata(clin_subtype),
  data = MCP_Final_withoutLAC)
summary(clin.cov.cox)
```


## DR 

```{r}
fit_GDT_DR <- survfit(surv_DR ~ GDT_ID, data = MCP_Final)
fit_GDT_DR_without_lac <- survfit(surv_DR_without_lac ~ GDT_ID, data = MCP_Final_withoutLAC)
```

### Kaplan-Meier

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_GDT_DR, data = MCP_Final, pval = TRUE, legend = "top", legend.title = "GDT cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)

ggsurvplot(fit_GDT_DR_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.title = "GDT cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```

#### KM by study group

```{r, fig.width=7, fig.height=5}
plot_DRS_GDT_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + GDT_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - GDT cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
plot_DRS_GDT_studygroup_short

plot_DRS_GDT_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + GDT_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - GDT cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_DRS_GDT_studygroup_short_without_lac
```

#### KM high vs low

```{r, fig.width=7, fig.height=5}
plot_DRS_GDT_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + GDT_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - GDT cluster by study_group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    pval = T, facet.by = "GDT_ID")
plot_DRS_GDT_studygroup_short

plot_DRS_GDT_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + GDT_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - GDT cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF","#AA96DA", "#521262"),
    pval = T, facet.by = "GDT_ID")
plot_DRS_GDT_studygroup_short_without_lac
```

### univariate

```{r}
#univariate
cox_DR_GDT_cluster <- coxph(Surv(time_DRS_months, distant_recurrence) ~ GDT_ID, data = MCP_Final)
summary(cox_DR_GDT_cluster)
```

### multivariate

```{r}
#multivariate 
cox_DR_GDT_cluster_multivariate <- coxph(Surv(time_DRS_months, distant_recurrence) ~ GDT_ID + study_group + stage + clin_subtype, data = MCP_Final)
summary(cox_DR_GDT_cluster_multivariate)

cox_DR_GDT_cluster_multivariate_withoutlac <- coxph(Surv(time_DRS_months, distant_recurrence) ~ GDT_ID + study_group + stage + clin_subtype, data = MCP_Final_withoutLAC)
summary(cox_DR_GDT_cluster_multivariate_withoutlac)
```


# M0+ cells - median

## OS 

### Kaplan-Meier

```{r}
fit_M0_OS <- survfit(surv_OS ~ M0_ID, data = MCP_Final)
fit_M0_OS_without_lac <- survfit(surv_OS_without_lac ~ M0_ID, data = MCP_Final_withoutLAC)
```

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_M0_OS, data = MCP_Final, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "M0 cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)

ggsurvplot(fit_M0_OS_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "M0 cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)
```

#### KM by study group
```{r, fig.width=7, fig.height=5}
plot_OS_M0_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + M0_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - M0 cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_M0_studygroup_short

plot_OS_M0_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + M0_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - M0 cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_M0_studygroup_short_without_lac
```

#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_OS_M0_highVSlow_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + M0_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - M0 cluster by study-group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "M0_ID")

plot_OS_M0_highVSlow_short


plot_OS_M0_highVSlow_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + M0_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - M0 cluster by study-group",
    palette = c("#46CDCF","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "M0_ID")

plot_OS_M0_highVSlow_short_without_lac
```


### Univariate

```{r}
#univariate
cox_OS_M0_cluster <- coxph(Surv(time_OS_months, death) ~ M0_ID, data = MCP_Final)
summary(cox_OS_M0_cluster)
```

### multivariate

```{r}
#multivariate
cox_OS_M0_cluster_multivariate <- coxph(Surv(time_OS_months, death) ~ M0_ID + study_group + stage, data = MCP_Final)
summary(cox_OS_M0_cluster_multivariate)

cox_OS_M0_cluster_multivariate_withoutlac <- coxph(Surv(time_OS_months, death) ~ M0_ID + study_group + stage + clin_subtype, data = MCP_Final_withoutLAC)
summary(cox_OS_M0_cluster_multivariate_withoutlac)
```


## DR 

```{r}
fit_M0_DR <- survfit(surv_DR ~ M0_ID, data = MCP_Final)
fit_M0_DR_without_lac <- survfit(surv_DR_without_lac ~ M0_ID, data = MCP_Final_withoutLAC)
```

### Kaplan-Meier

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_M0_DR, data = MCP_Final, pval = TRUE, legend = "top", legend.title = "M0 cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)

ggsurvplot(fit_M0_DR_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.title = "M0 cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```


#### KM by study group
```{r, fig.width=7, fig.height=5}
plot_DRS_M0_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + M0_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - M0 cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
plot_DRS_M0_studygroup_short

plot_DRS_M0_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + M0_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - M0 cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_DRS_M0_studygroup_short_without_lac
```

#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_DRS_M0_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + M0_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - M0 cluster by study_group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    pval = T, facet.by = "M0_ID")
plot_DRS_M0_studygroup_short

plot_DRS_M0_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + M0_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - M0 cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF","#AA96DA", "#521262"),
    pval = T, facet.by = "M0_ID")
plot_DRS_M0_studygroup_short_without_lac
```

### univariate

```{r}
#univariate
cox_DR_M0_cluster <- coxph(Surv(time_DRS_months, distant_recurrence) ~ M0_ID, data = MCP_Final)
summary(cox_DR_M0_cluster)
```

### multivariate

```{r}
#multivariate 
cox_DR_M0_cluster_multivariate <- coxph(Surv(time_DRS_months, distant_recurrence) ~ M0_ID + study_group + stage + clin_subtype, data = MCP_Final)
summary(cox_DR_M0_cluster_multivariate)

cox_DR_M0_cluster_multivariate_withoutlac <- coxph(Surv(time_DRS_months, distant_recurrence) ~ M0_ID + study_group + stage + clin_subtype, data = MCP_Final_withoutLAC)
summary(cox_DR_M0_cluster_multivariate_withoutlac)
```


# M1+ cells - median

## OS 

### Kaplan-Meier

```{r}
fit_M1_OS <- survfit(surv_OS ~ M1_ID, data = MCP_Final)
fit_M1_OS_without_lac <- survfit(surv_OS_without_lac ~ M1_ID, data = MCP_Final_withoutLAC)
```

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_M1_OS, data = MCP_Final, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "M1 cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)

ggsurvplot(fit_M1_OS_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "M1 cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)
```

#### KM by study group
```{r, fig.width=7, fig.height=5}
plot_OS_M1_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + M1_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - M1 cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_M1_studygroup_short

plot_OS_M1_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + M1_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - M1 cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_M1_studygroup_short_without_lac
```

#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_OS_M1_highVSlow_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + M1_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - M1 cluster by study-group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "M1_ID")

plot_OS_M1_highVSlow_short

plot_OS_M1_highVSlow_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + M1_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - M1 cluster by study-group",
    palette = c("#46CDCF","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "M1_ID")

plot_OS_M1_highVSlow_short_without_lac
```

### Univariate

```{r}
#univariate
cox_OS_M1_cluster <- coxph(Surv(time_OS_months, death) ~ M1_ID, data = MCP_Final)
summary(cox_OS_M1_cluster)
```

### multivariate

```{r}
#multivariate
cox_OS_M1_cluster_multivariate <- coxph(Surv(time_OS_months, death) ~ M1_ID + study_group + stage + clin_subtype, data = MCP_Final)
summary(cox_OS_M1_cluster_multivariate)

cox_OS_M1_cluster_multivariate_withoutlac <- coxph(Surv(time_OS_months, death) ~ M1_ID + study_group + stage + clin_subtype, data = MCP_Final_withoutLAC)
summary(cox_OS_M1_cluster_multivariate_withoutlac)
```

## DR 

```{r}
fit_M1_DR <- survfit(surv_DR ~ M1_ID, data = MCP_Final)
fit_M1_DR_without_lac <- survfit(surv_DR_without_lac ~ M1_ID, data = MCP_Final_withoutLAC)
```

### Kaplan-Meier

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_M1_DR, data = MCP_Final, pval = TRUE, legend = "top", legend.title = "M1 cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)

ggsurvplot(fit_M1_DR_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.title = "M1 cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```

#### KM by study group
```{r, fig.width=7, fig.height=5}
plot_DRS_M1_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + M1_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - M1 cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
plot_DRS_M1_studygroup_short

plot_DRS_M1_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + M1_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - M1 cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_DRS_M1_studygroup_short_without_lac
```


#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_DRS_M1_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + M1_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - M1 cluster by study_group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    pval = T, facet.by = "M1_ID")
plot_DRS_M1_studygroup_short

plot_DRS_M1_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + M1_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - M1 cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF","#AA96DA", "#521262"),
    pval = T, facet.by = "M1_ID")
plot_DRS_M1_studygroup_short_without_lac
```

### univariate
```{r}
#univariate
cox_DR_M1_cluster <- coxph(Surv(time_DRS_months, distant_recurrence) ~ M1_ID, data = MCP_Final)
summary(cox_DR_M1_cluster)
```

### multivariate
```{r}
#multivariate 
cox_DR_M1_cluster_multivariate <- coxph(Surv(time_DRS_months, distant_recurrence) ~ M1_ID + study_group + stage + clin_subtype, data = MCP_Final)
summary(cox_DR_M1_cluster_multivariate)

cox_DR_M1_cluster_multivariate_withoutlac <- coxph(Surv(time_DRS_months, distant_recurrence) ~ M1_ID + study_group + stage + clin_subtype, data = MCP_Final_withoutLAC)
summary(cox_DR_M1_cluster_multivariate_withoutlac)
```


# M2+ cells - median

## OS 

### Kaplan-Meier

```{r}
fit_M2_OS <- survfit(surv_OS ~ M2_ID, data = MCP_Final)
fit_M2_OS_without_lac <- survfit(surv_OS_without_lac ~ M2_ID, data = MCP_Final_withoutLAC)
```

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_M2_OS, data = MCP_Final, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "M2 cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)

ggsurvplot(fit_M2_OS_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "M2 cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```

#### KM by study group
```{r, fig.width=7, fig.height=5}
plot_OS_M2_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + M2_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - M2 cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_M2_studygroup_short

plot_OS_M2_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + M2_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - M2 cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_M2_studygroup_short_without_lac
```

#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_OS_M2_highVSlow_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + M2_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - M2 cluster by study-group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "M2_ID")

plot_OS_M2_highVSlow_short


plot_OS_M2_highVSlow_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + M2_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - M2 cluster by study-group",
    palette = c("#46CDCF","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "M2_ID")

plot_OS_M2_highVSlow_short_without_lac
```

### Univariate
```{r}
#univariate
cox_OS_M2_cluster <- coxph(Surv(time_OS_months, death) ~ M2_ID, data = MCP_Final)
summary(cox_OS_M2_cluster)
```

### multivariate
```{r}
#multivariate
cox_OS_M2_cluster_multivariate <- coxph(Surv(time_OS_months, death) ~ M2_ID + study_group + stage + clin_subtype, data = MCP_Final)
summary(cox_OS_M2_cluster_multivariate)

cox_OS_M2_cluster_multivariate_withoutlac <- coxph(Surv(time_OS_months, death) ~ M2_ID + study_group + stage + clin_subtype, data = MCP_Final_withoutLAC)
summary(cox_OS_M2_cluster_multivariate_withoutlac)
```


## DR 

```{r}
fit_M2_DR <- survfit(surv_DR ~ M2_ID, data = MCP_Final)
fit_M2_DR_without_lac <- survfit(surv_DR_without_lac ~ M2_ID, data = MCP_Final_withoutLAC)
```

### Kaplan-Meier

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_M2_DR, data = MCP_Final, pval = TRUE, legend = "top", legend.title = "M2 cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)

ggsurvplot(fit_M2_DR_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.title = "M2 cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)
```

#### KM by study group
```{r, fig.width=7, fig.height=5}
plot_DRS_M2_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + M2_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - M2 cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
plot_DRS_M2_studygroup_short

plot_DRS_M2_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + M2_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - M2 cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_DRS_M2_studygroup_short_without_lac
```

#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_DRS_M2_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + M2_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - M2 cluster by study_group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    pval = T, facet.by = "M2_ID")
plot_DRS_M2_studygroup_short

plot_DRS_M2_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + M2_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - M2 cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF","#AA96DA", "#521262"),
    pval = T, facet.by = "M2_ID")
plot_DRS_M2_studygroup_short_without_lac
```

### univariate
```{r}
#univariate
cox_DR_M2_cluster <- coxph(Surv(time_DRS_months, distant_recurrence) ~ M2_ID, data = MCP_Final)
summary(cox_DR_M2_cluster)
```

### multivariate
```{r}
#multivariate 
cox_DR_M2_cluster_multivariate <- coxph(Surv(time_DRS_months, distant_recurrence) ~ M2_ID + study_group + stage + clin_subtype , data = MCP_Final)
summary(cox_DR_M2_cluster_multivariate)

cox_DR_M2_cluster_multivariate_withoutlac <- coxph(Surv(time_DRS_months, distant_recurrence) ~ M2_ID + study_group + stage + clin_subtype , data = MCP_Final_withoutLAC)
summary(cox_DR_M2_cluster_multivariate_withoutlac)
```


# Dendritic cells - median

## OS 

### Kaplan-Meier

```{r}
fit_DA_OS <- survfit(surv_OS ~ DA_ID, data = MCP_Final)
fit_DA_OS_without_lac <- survfit(surv_OS_without_lac ~ DA_ID, data = MCP_Final_withoutLAC)
```

```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_DA_OS, data = MCP_Final, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "DA cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table=TRUE)

ggsurvplot(fit_DA_OS_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.labs = c("high", "low"), legend.title = "DA cluster", title = "OS - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```

#### KM by study group
```{r, fig.width=7, fig.height=5}
plot_OS_DA_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + DA_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - DA cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_DA_studygroup_short

plot_OS_DA_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + DA_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - DA cluster by study-group",
    palette = c("#a10702", "#ffb600", "#ff7900"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_OS_DA_studygroup_short_without_lac
```

#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_OS_DA_highVSlow_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + DA_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - DA cluster by study-group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "DA_ID")

plot_OS_DA_highVSlow_short


plot_OS_DA_highVSlow_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + DA_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - DA cluster by study-group",
    palette = c("#46CDCF","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "DA_ID")

plot_OS_DA_highVSlow_short_without_lac
```

### Univariate
```{r}
#univariate
cox_OS_DA_cluster <- coxph(Surv(time_OS_months, death) ~ DA_ID, data = MCP_Final)
summary(cox_OS_DA_cluster)
```

### multivariate
```{r}
#multivariate
cox_OS_DA_cluster_multivariate <- coxph(Surv(time_OS_months, death) ~ DA_ID + study_group + stage + clin_subtype, data = MCP_Final)
summary(cox_OS_DA_cluster_multivariate)

cox_OS_DA_cluster_multivariate_withoutlac <- coxph(Surv(time_OS_months, death) ~ DA_ID + study_group + stage + clin_subtype, data = MCP_Final_withoutLAC)
summary(cox_OS_DA_cluster_multivariate_withoutlac)
```

## DR 

```{r}
fit_DA_DR <- survfit(surv_DR ~ DA_ID, data = MCP_Final)
fit_DA_DR_without_lac <- survfit(surv_DR_without_lac ~ DA_ID, data = MCP_Final_withoutLAC)
```

### Kaplan-Meier
```{r, fig.width=7, fig.height=5}
ggsurvplot(fit_DA_DR, data = MCP_Final, pval = TRUE, legend = "top", legend.title = "DA cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)

ggsurvplot(fit_DA_DR_without_lac, data = MCP_Final_withoutLAC, pval = TRUE, legend = "top", legend.title = "DA cluster",legend.labs = c("high", "low"), title = "DR - Univariate Analysis", palette = c("#a10702", "#ffb600"), risk.table = TRUE)
```

#### KM by study group
```{r, fig.width=7, fig.height=5}
plot_DRS_DA_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + DA_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - DA cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
plot_DRS_DA_studygroup_short

plot_DRS_DA_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + DA_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - DA cluster by study_group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

plot_DRS_DA_studygroup_short_without_lac
```

#### KM high vs low
```{r, fig.width=7, fig.height=5}
plot_DRS_DA_studygroup_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + DA_ID, data = MCP_Final), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - DA cluster by study_group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    pval = T, facet.by = "DA_ID")
plot_DRS_DA_studygroup_short

plot_DRS_DA_studygroup_short_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + DA_ID, data = MCP_Final_withoutLAC), 
    xlab = "Months", 
    ylab = "DRS probability",
    title = "DRS - DA cluster by study_group",
    ggtheme = theme_bw(),
    palette = c("#46CDCF","#AA96DA", "#521262"),
    pval = T, facet.by = "DA_ID")
plot_DRS_DA_studygroup_short_without_lac
```

### univariate
```{r}
#univariate
cox_DR_DA_cluster <- coxph(Surv(time_DRS_months, distant_recurrence) ~ DA_ID, data = MCP_Final)
summary(cox_DR_DA_cluster)
```

### multivariate
```{r}
#multivariate 
cox_DR_DA_cluster_multivariate <- coxph(Surv(time_DRS_months, distant_recurrence) ~ DA_ID + study_group +stage + clin_subtype, data = MCP_Final)
summary(cox_DR_DA_cluster_multivariate)

cox_DR_DA_cluster_multivariate_withoutlac <- coxph(Surv(time_DRS_months, distant_recurrence) ~ DA_ID + study_group +stage + clin_subtype, data = MCP_Final_withoutLAC)
summary(cox_DR_DA_cluster_multivariate_withoutlac)
```












