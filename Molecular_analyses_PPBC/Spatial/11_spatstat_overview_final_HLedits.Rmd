---
title: "Spatstat"
author: "Tycho Bismeijer & Kat Moore - Hanne edits"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    df_print: paged
    highlight: kate
---

```{r preliminaries, include=F}
library(conflicted)

ggplot2::theme_set(ggplot2::theme_bw())
```


```{r libraries, message=F}
library(broom)
library(here)
library(spatstat)
library(survival)
library(survminer)
library(tidyverse)
library(yaml)

source(here('src/spatial/outcome.R'))
```

```{r load-data-spatstat}
read_spatstat <- function(fn, cross) {
  col_spec <- list( 
    measure = col_character(),
    model = col_character(),
    null_estimate = col_double(),
    observed_estimate = col_double(),
    radius = col_double(),
    delta_estimate = col_double())
  if (cross) {
    col_spec[['cell_type1']] = col_character()
    col_spec[['cell_type2']] = col_character()
  } else {
    col_spec[['cell_type']] = col_character()
  }
  col_spec <- do.call(cols_only, col_spec)
  df <- list.files(fn, '*.tsv', full.names=T) %>%
    set_names() %>%
    map_dfr(read_tsv, col_types = col_spec, .id = 'filename') %>%
    mutate(
      measure = factor(measure),
      model = factor(model)) %>%
    tidyr::extract(filename, c('sample_ID', '_slide', 'experimental_platform', 'batch_HALO'),
                   '(T[0-9]+-[0-9]+(_I+[0-9]+)?)_(MPIF[0-9]+)_(batch[0-9]+)') %>%
      select(-`_slide`)
  if (cross) {
    df <- mutate(df, cell_type1 = factor(cell_type1), cell_type2 = factor(cell_type2))
  } else {
    df <- mutate(df, cell_type = factor(cell_type))
  }
  df
}
sample_id_vars <- c('sample_ID', 'experimental_platform', 'batch_HALO')

spatstat_l <- read_spatstat(here('results/spatial/l'), cross = F)
spatstat_lcross_panck <- read_spatstat(here('results/spatial/lcross_panck'), cross = T) %>%
  mutate(measure = "Lcross_PanCK") %>%
  dplyr::filter(!is.na(cell_type2)) #8 rows have NA for all stats
spatstat_lcross_immune <- read_spatstat(here('results/spatial/lcross_immune'), cross = T) %>%
  mutate(measure = "Lcross_immune")  %>%
  # Current implementation has redundancy with L_cross-PanCK, where PanCK is always cell type 1
  # We are also not interested in Other for this comparison
  dplyr::filter(!cell_type1 %in% c("PanCK+", "Other")) %>%
  # Keep PanCK+ in cell_type2 because different start points may yield different results
  dplyr::filter(!cell_type2 %in% c("Other")) %>%
  dplyr::filter(!is.na(cell_type2)) #62 NA rows

spatstat <- bind_rows(spatstat_l, spatstat_lcross_panck, spatstat_lcross_immune) %>%
  mutate(cell_types = coalesce(cell_type, paste0(cell_type1, "/", cell_type2)))
```

```{r load-data-outcome}
outcome <- read_outcome(here('data/metadata/PPBC_metadata_tycho.xlsx'))
```

Samples with outcome but no spatstat:
```{r missing-a}
print(anti_join(outcome, spatstat_l,
                by = c('sample_ID', 'batch_HALO', 'experimental_platform')) %>%
        mutate(stat_missing = "l", .before = everything())) 
print(anti_join(outcome, spatstat_lcross_panck,
                by = c('sample_ID', 'batch_HALO', 'experimental_platform')) %>%
  mutate(stat_missing = "lcross_panck", .before = everything())) 
print(anti_join(outcome, spatstat_lcross_immune,
                by = c('sample_ID', 'batch_HALO', 'experimental_platform')) %>%
  mutate(stat_missing = "lcross_immune", .before = everything())) 
```

Samples with spatstat but no outcome:

```{r missing-b}
print(anti_join(spatstat, outcome,
                by = c('sample_ID', 'batch_HALO', 'experimental_platform')))
```




```{r filter-patients}
outcome_all <- dplyr::filter(outcome,
  study_group %in% c("non_prbc", "ppbc_inv", "ppbc_lac", "prbc"),
  stage != "stage IV")
```

```{r filter-patients}
outcome_inv_np <- dplyr::filter(outcome,
  study_group %in% c("non_prbc", "ppbc_inv"),
  stage != "stage IV")
```

```{r filter-patients}
outcome_inv_pr <- dplyr::filter(outcome,
  study_group %in% c("non_prbc", "prbc"),
  stage != "stage IV")
```

```{r filter-patients}
outcome_inv <- dplyr::filter(outcome,
  study_group %in% c("ppbc_inv"),
  stage != "stage IV")
```

```{r filter-patients}
outcome_np <- dplyr::filter(outcome,
  study_group %in% c("non_prbc"),
  stage != "stage IV")
```

```{r filter-patients}
outcome_pr <- dplyr::filter(outcome,
  study_group %in% c("prbc"),
  stage != "stage IV")
```

```{r filter-patients}
outcome <- dplyr::filter(outcome,
  study_group %in% c("non_prbc", "ppbc_inv"),
  stage != "stage IV")
```





```{r}
outcome_inv <- inner_join(outcome_inv, spatstat, by = sample_id_vars)
```

```{r}
outcome_np <- inner_join(outcome_np, spatstat, by = sample_id_vars)
```

```{r}
outcome_pr <- inner_join(outcome_pr, spatstat, by = sample_id_vars)
```

```{r}
outcome_inv_np <- inner_join(outcome_inv_np, spatstat, by = sample_id_vars)
```

```{r}
outcome_inv_pr <- inner_join(outcome_inv_pr, spatstat, by = sample_id_vars)
```

```{r}
outcome_all <- inner_join(outcome_all, spatstat, by = sample_id_vars)
```


## Overview

### L over radius

```{r l-plot}
for (ct in levels(spatstat$cell_type)) {
  plt <- spatstat %>%
    dplyr::filter(measure == 'L', cell_type == ct) %>%
    ggplot(aes(x = radius, y = sample_ID)) +
    geom_tile(aes(fill = observed_estimate)) +
    scale_x_continuous('Radius (mm)') +
    scale_y_discrete('Sample') +
    ggtitle(paste0('L estimate of ', ct))
  print(plt)
}
```

### Lcross panCK+ over radius

Crosses:

```{r}
spatstat %>%
  dplyr::filter(measure == 'Lcross_PanCK') %>%
  select(cell_type1, cell_type2) %>% distinct()
```


```{r lcross-panck-plot}
for (ct in unique(spatstat_lcross_panck$cell_type2)) {
  plt <- spatstat %>%
    dplyr::filter(measure == 'Lcross_PanCK', cell_type1 == 'PanCK+', cell_type2 == ct) %>%
    ggplot(aes(x = radius, y = sample_ID)) +
    geom_tile(aes(fill = observed_estimate)) +
    scale_x_continuous('Radius (mm)') +
    scale_y_discrete('Sample') +
    ggtitle(paste0('Lcross estimate of ', ct, ' to panCK+'))
  print(plt)
}
```

### Lcross immune over radius

Available crosses. x -> y and y -> x comparisons exist, since the starting point differs.

```{r}
immune_crosses <- spatstat %>%
  dplyr::filter(measure == 'Lcross_immune') %>%
  select(cell_type1, cell_type2) %>% 
  dplyr::filter(!cell_type1 %in% c("PanCK+", "Other")) %>%
  dplyr::filter(!cell_type2 %in% c("PanCK+", "Other")) %>%
  distinct()

immune_crosses
```

```{r lcross-immune-plot}
for (i in 1:nrow(immune_crosses)) {
  ct1 <- immune_crosses$cell_type1[i]
  ct2 <- immune_crosses$cell_type2[i]
  plt <- spatstat %>%
    dplyr::filter(measure == 'Lcross_immune', cell_type1 == ct1, cell_type2 == ct2) %>%
    ggplot(aes(x = radius, y = sample_ID)) +
    geom_tile(aes(fill = observed_estimate)) +
    scale_x_continuous('Radius (mm)') +
    scale_y_discrete('Sample') +
    ggtitle(paste0('Lcross estimate of ', ct1, ' to ', ct2))
  print(plt)
}
```

### Histogram at radius 0.03 mm

```{r, de_hist}
inner_join(outcome, spatstat, by = sample_id_vars) %>%
  dplyr::filter(
    radius == 0.03,
    !is.na(death),
    !is.na(time_OS_months),
    !is.na(delta_estimate)) %>%
  group_by(cell_types, measure, model, radius) %>%
  group_walk(function (df_group, key) {
    plt <- ggplot(df_group, aes(x = delta_estimate)) +
      geom_histogram(bins = 30) +
      ggtitle(paste0(names(key), '=', map_chr(key, as.character), collapse = ' '))
    print(plt)
  })
```

## Comparison between groups

```{r compare-groups, message=F}
non_par_test <- function(x, y) {
  valid_obs <- is.finite(x) & is.finite(y)
  x <- x[valid_obs]
  y <- factor(y[valid_obs])
  if (min(table(y) < 2) | length(levels(y)) != 2) {
    str(y)
    tibble()
  } else {
    tidy(wilcox.test(x ~ y))
  }
}


inner_join(outcome, spatstat, by = sample_id_vars) %>%
  dplyr::filter(radius == 0.05) %>%
  group_by(cell_types, measure, model, radius) %>%
  summarize(non_par_test(delta_estimate, study_group)) %>%
  arrange(p.value)
```

## Cox-models

```{r fit-cox}
fit_cox <- function(survival, predictor) {
  model <- coxph(survival ~ predictor)
  model_summary <- summary(model)
  tibble(
    loglikelihood = model$loglik[2],
    n_event = model$nevent,
    statistic_lr = model_summary$logtest[1],
    p_lr = model_summary$logtest[3],
    statistic_score = model_summary$sctest[1],
    statistic_p = model_summary$sctest[3],
    statistic_wald = model_summary$waldtest[1],
    p_wald = model_summary$waldtest[3],
    nominal_p = model_summary$coefficients[1, 5],
    hr = model_summary$conf.int[1, 1],
    hr_min = model_summary$conf.int[1, 3],
    hr_max = model_summary$conf.int[1, 4])
}

cox_results <- inner_join(outcome, spatstat, by = sample_id_vars) %>%
  dplyr::filter(radius < 0.1) %>%
  group_by(cell_types, measure, model, radius) %>%
  summarize(
    fit_cox(Surv(time = time_OS_months, event = death), delta_estimate),
    n = n(),
    n_samples = n_distinct(sample_ID),
    n_data = sum(!is.na(delta_estimate)),
    .groups = 'drop')
```

```{r}
cox_results <- cox_results %>%
  dplyr::filter(!is.na(nominal_p)) %>%
  group_by(cell_types, measure, model) %>%
  mutate(fdr_per_ct = p.adjust(nominal_p, 'fdr')) %>%
  ungroup() %>%
  mutate(fdr = fdr_per_ct / n_distinct(cell_types, measure, model))
```

```{r}
cox_results %>%
  group_by(cell_types, measure, model) %>%
  arrange(-fdr) %>%
  relocate(fdr, .before = everything())
```

Min FDR, average HR, and overall impact (good/bad) across all radii. Note: impact may be different at different distances. See graphs below.

```{r}
cox_results %>%
  group_by(cell_types, measure, model) %>%
  summarize(min_fdr = min(fdr), ave_hr = signif(mean(hr_min, na.rm=T),2)) %>%
  arrange(min_fdr) %>%
  mutate(impact = ifelse(ave_hr > 1, "harmful", "beneficial"))
```


1### HR by radius and cell type

Split by metric for legibility.

```{r, fig.width=10}
for(metric in unique(cox_results$measure)){
  plt <- cox_results[cox_results$measure == metric,] %>%
    ggplot(aes(x=radius, y=hr, group='')) +
    geom_ribbon(aes(ymin=hr_min, ymax=hr_max), fill = 'grey70') +
    geom_line(aes(color=!is.na(fdr) & fdr < 0.05)) +
    facet_wrap(~cell_types) +
    scale_y_continuous(trans = scales::log_trans(base=2)) + 
    geom_hline(yintercept=1.0)
  print(plt +
          ggtitle(metric) +
          coord_cartesian(ylim = c(1/10, 10), xlim = c(0, 0.1)))
}


```

CD20-specific graphs.

```{r, fig.height = 4, fig.width=7}
plt <- cox_results %>%
  dplyr::filter(cell_types %in% c("CD20+","PanCK+/CD20+", "CD20+/PanCK+")) %>%
  mutate(cell_types = paste(cell_types, measure)) %>%
  ggplot(aes(x=radius, y=hr, group='')) +
  geom_ribbon(aes(ymin=hr_min, ymax=hr_max), fill = 'grey70') +
  geom_line(aes(color=!is.na(fdr) & fdr < 0.05)) +
  facet_grid(cols = vars(cell_types)) +
  scale_y_continuous(trans = scales::log_trans(base=2)) + 
  geom_hline(yintercept=1.0)
print(plt +
  coord_cartesian(ylim = c(1/10, 10), xlim = c(0, 0.1)))
```

## Kaplan-Meier

Difficult to first generate kaplan-meier estimates before plotting because of limitations in
survfit and ggsurvplot, resultign in ggsurvplot needing the original data.

```{r}
inner_join(outcome, spatstat, by = sample_id_vars) %>%
  dplyr::filter(
    radius == 0.03,
    !is.na(death),
    !is.na(time_OS_months),
    !is.na(delta_estimate)) %>%
  #Cox filter, sig only
  dplyr::filter(cell_types %in% dplyr::filter(cox_results, radius == 0.03, fdr < 0.05)$cell_types) %>%
  group_by(cell_types, measure, model, radius) %>%
  group_walk(function (df_group, key) {
    df_group$de_split <- df_group$delta_estimate > median(df_group$delta_estimate, na.rm=T)
    fit = survfit(Surv(time = time_OS_months, event = death) ~ de_split, data = df_group)
    plt <- ggsurvplot(fit, data = df_group, risk.table = T, conf.int = T, pval = T, pval.method = T) +
      ggtitle(paste0(names(key), '=', map_chr(key, as.character), collapse = ' '))
    print(plt)
  })
```

Look at some CD20 graphs specifically.

```{r}
inner_join(outcome, spatstat, by = sample_id_vars) %>%
  dplyr::filter(
    radius == 0.03,
    !is.na(death),
    !is.na(time_OS_months),
    !is.na(delta_estimate)) %>%
  #CD20-PanCK filter
  dplyr::filter(cell_types %in% c("CD20+","PanCK+/CD20+", "CD20+/PanCK+")) %>%
  group_by(cell_types, measure, model, radius) %>%
  group_walk(function (df_group, key) {
    df_group$de_split <- df_group$delta_estimate > median(df_group$delta_estimate, na.rm=T)
    fit = survfit(Surv(time = time_OS_months, event = death) ~ de_split, data = df_group)
    plt <- ggsurvplot(fit, data = df_group, risk.table = T, conf.int = T, pval = T, pval.method = T) +
      ggtitle(paste0(names(key), '=', map_chr(key, as.character), collapse = ' '))
    print(plt)
  })
```

A different result is seen with a higher radius, as observed by the histogram above.

```{r, fig.width=8}
inner_join(outcome, spatstat, by = sample_id_vars) %>%
  dplyr::filter(
    radius == 0.055,
    !is.na(death),
    !is.na(time_OS_months),
    !is.na(delta_estimate)) %>%
  dplyr::filter(cell_types %in% c("CD20+","PanCK+/CD20+", "CD20+/PanCK+")) %>%
  group_by(cell_types, measure, model, radius) %>%
  group_walk(function (df_group, key) {
    df_group$de_split <- df_group$delta_estimate > median(df_group$delta_estimate, na.rm=T)
    fit = survfit(Surv(time = time_OS_months, event = death) ~ de_split, data = df_group)
    plt <- ggsurvplot(fit, data = df_group, risk.table = T, conf.int = T, pval = T, pval.method = T) +
      ggtitle(paste0(names(key), '=', map_chr(key, as.character), collapse = ' '))
    print(plt)
  })
```


# Hanne Edits 

```{r}
library(rstatix)
library(multcomp)
```


Subset all data in Radius == 0.03
```{r}
outcome_all_rad3 <- subset(outcome_all, radius %in% c("0.03"), )
outcome_inv_rad3 <- subset(outcome_inv, radius %in% c("0.03"), )
outcome_np_rad3 <- subset(outcome_np, radius %in% c("0.03"), )
outcome_pr_rad3 <- subset(outcome_pr, radius %in% c("0.03"), )
```




# L-measure - similar immune cell subsets
```{r}
outcome_all_rad3_CD20 <- subset(outcome_all_rad3, cell_type %in% c("CD20+"), )
outcome_inv_rad3_CD20 <- subset(outcome_inv_rad3, cell_type %in% c("CD20+"), )
outcome_np_rad3_CD20 <- subset(outcome_np_rad3, cell_type %in% c("CD20+"), )
outcome_pr_rad3_CD20 <- subset(outcome_pr_rad3, cell_type %in% c("CD20+"), )
```


```{r}
outcome_all_rad3_CD3_foxp3neg <- subset(outcome_all_rad3, cell_type %in% c("CD3+FoxP3-"), )
outcome_inv_rad3_CD3_foxp3neg <- subset(outcome_inv_rad3, cell_type %in% c("CD3+FoxP3-"), )
outcome_np_rad3_CD3_foxp3neg <- subset(outcome_np_rad3, cell_type %in% c("CD3+FoxP3-"), )
outcome_pr_rad3_CD3_foxp3neg <- subset(outcome_pr_rad3, cell_type %in% c("CD3+FoxP3-"), )
```


```{r}
outcome_all_rad3_CD3_CD8neg <- subset(outcome_all_rad3, cell_type %in% c("CD3+CD8-"), )
outcome_inv_rad3_CD3_CD8neg <- subset(outcome_inv_rad3, cell_type %in% c("CD3+CD8-"), )
outcome_np_rad3_CD3_CD8neg <- subset(outcome_np_rad3, cell_type %in% c("CD3+CD8-"), )
outcome_pr_rad3_CD3_CD8neg <- subset(outcome_pr_rad3, cell_type %in% c("CD3+CD8-"), )
```

```{r}
outcome_all_rad3_CD3_CD8pos <- subset(outcome_all_rad3, cell_type %in% c("CD3+CD8+"), )
outcome_inv_rad3_CD3_CD8pos <- subset(outcome_inv_rad3, cell_type %in% c("CD3+CD8+"), )
outcome_np_rad3_CD3_CD8pos <- subset(outcome_np_rad3, cell_type %in% c("CD3+CD8+"), )
outcome_pr_rad3_CD3_CD8pos <- subset(outcome_pr_rad3, cell_type %in% c("CD3+CD8+"), )
```


```{r}
outcome_all_rad3_foxp3 <- subset(outcome_all_rad3, cell_type %in% c("FoxP3+"), )
outcome_inv_rad3_foxp3 <- subset(outcome_inv_rad3, cell_type %in% c("FoxP3+"), )
outcome_np_rad3_foxp3 <- subset(outcome_np_rad3, cell_type %in% c("FoxP3+"), )
outcome_pr_rad3_foxp3 <- subset(outcome_pr_rad3, cell_type %in% c("FoxP3+"), )
```


create variable that subsets data into above or below the median:

FALSE = under the median 
TRUE = above the median 

```{r}
outcome_all_rad3_CD20$median <- outcome_all_rad3_CD20$delta_estimate > median(outcome_all_rad3_CD20$delta_estimate, na.rm=T)
outcome_all_rad3_CD3_foxp3neg$median <- outcome_all_rad3_CD3_foxp3neg$delta_estimate > median(outcome_all_rad3_CD3_foxp3neg$delta_estimate, na.rm=T)
outcome_all_rad3_CD3_CD8neg$median <- outcome_all_rad3_CD3_CD8neg$delta_estimate > median(outcome_all_rad3_CD3_CD8neg$delta_estimate, na.rm=T)
outcome_all_rad3_CD3_CD8pos$median <- outcome_all_rad3_CD3_CD8pos$delta_estimate > median(outcome_all_rad3_CD3_CD8pos$delta_estimate, na.rm=T)
outcome_all_rad3_foxp3$median <- outcome_all_rad3_foxp3$delta_estimate > median(outcome_all_rad3_foxp3$delta_estimate, na.rm=T)

outcome_inv_rad3_CD20$median <- outcome_inv_rad3_CD20$delta_estimate > median(outcome_inv_rad3_CD20$delta_estimate, na.rm=T)
outcome_inv_rad3_CD3_foxp3neg$median <- outcome_inv_rad3_CD3_foxp3neg$delta_estimate > median(outcome_inv_rad3_CD3_foxp3neg$delta_estimate, na.rm=T)
outcome_inv_rad3_CD3_CD8neg$median <- outcome_inv_rad3_CD3_CD8neg$delta_estimate > median(outcome_inv_rad3_CD3_CD8neg$delta_estimate, na.rm=T)
outcome_inv_rad3_CD3_CD8pos$median <- outcome_inv_rad3_CD3_CD8pos$delta_estimate > median(outcome_inv_rad3_CD3_CD8pos$delta_estimate, na.rm=T)
outcome_inv_rad3_foxp3$median <- outcome_inv_rad3_foxp3$delta_estimate > median(outcome_inv_rad3_foxp3$delta_estimate, na.rm=T)

outcome_np_rad3_CD20$median <- outcome_np_rad3_CD20$delta_estimate > median(outcome_np_rad3_CD20$delta_estimate, na.rm=T)
outcome_np_rad3_CD3_foxp3neg$median <- outcome_np_rad3_CD3_foxp3neg$delta_estimate > median(outcome_np_rad3_CD3_foxp3neg$delta_estimate, na.rm=T)
outcome_np_rad3_CD3_CD8neg$median <- outcome_np_rad3_CD3_CD8neg$delta_estimate > median(outcome_np_rad3_CD3_CD8neg$delta_estimate, na.rm=T)
outcome_np_rad3_CD3_CD8pos$median <- outcome_np_rad3_CD3_CD8pos$delta_estimate > median(outcome_np_rad3_CD3_CD8pos$delta_estimate, na.rm=T)
outcome_np_rad3_foxp3$median <- outcome_np_rad3_foxp3$delta_estimate > median(outcome_np_rad3_foxp3$delta_estimate, na.rm=T)

outcome_pr_rad3_CD20$median <- outcome_pr_rad3_CD20$delta_estimate > median(outcome_pr_rad3_CD20$delta_estimate, na.rm=T)
outcome_pr_rad3_CD3_foxp3neg$median <- outcome_pr_rad3_CD3_foxp3neg$delta_estimate > median(outcome_pr_rad3_CD3_foxp3neg$delta_estimate, na.rm=T)
outcome_pr_rad3_CD3_CD8neg$median <- outcome_pr_rad3_CD3_CD8neg$delta_estimate > median(outcome_pr_rad3_CD3_CD8neg$delta_estimate, na.rm=T)
outcome_pr_rad3_CD3_CD8pos$median <- outcome_pr_rad3_CD3_CD8pos$delta_estimate > median(outcome_pr_rad3_CD3_CD8pos$delta_estimate, na.rm=T)
outcome_pr_rad3_foxp3$median <- outcome_pr_rad3_foxp3$delta_estimate > median(outcome_pr_rad3_foxp3$delta_estimate, na.rm=T)
```



Make data frames 

```{r}
outcome_all_rad3_CD20 <- as.data.frame(outcome_all_rad3_CD20)
outcome_all_rad3_CD3_foxp3neg <- as.data.frame(outcome_all_rad3_CD3_foxp3neg)
outcome_all_rad3_CD3_CD8neg <- as.data.frame(outcome_all_rad3_CD3_CD8neg)
outcome_all_rad3_CD3_CD8pos <- as.data.frame(outcome_all_rad3_CD3_CD8pos)
outcome_all_rad3_foxp3 <- as.data.frame(outcome_all_rad3_foxp3)

outcome_inv_rad3_CD20 <- as.data.frame(outcome_inv_rad3_CD20)
outcome_inv_rad3_CD3_foxp3neg <- as.data.frame(outcome_inv_rad3_CD3_foxp3neg)
outcome_inv_rad3_CD3_CD8neg <- as.data.frame(outcome_inv_rad3_CD3_CD8neg)
outcome_inv_rad3_CD3_CD8pos <- as.data.frame(outcome_inv_rad3_CD3_CD8pos)
outcome_inv_rad3_foxp3 <- as.data.frame(outcome_inv_rad3_foxp3)

outcome_np_rad3_CD20 <- as.data.frame(outcome_np_rad3_CD20)
outcome_np_rad3_CD3_foxp3neg <- as.data.frame(outcome_np_rad3_CD3_foxp3neg)
outcome_np_rad3_CD3_CD8neg <- as.data.frame(outcome_np_rad3_CD3_CD8neg)
outcome_np_rad3_CD3_CD8pos <- as.data.frame(outcome_np_rad3_CD3_CD8pos)
outcome_np_rad3_foxp3 <- as.data.frame(outcome_np_rad3_foxp3)

outcome_pr_rad3_CD20 <- as.data.frame(outcome_pr_rad3_CD20)
outcome_pr_rad3_CD3_foxp3neg <- as.data.frame(outcome_pr_rad3_CD3_foxp3neg)
outcome_pr_rad3_CD3_CD8neg <- as.data.frame(outcome_pr_rad3_CD3_CD8neg)
outcome_pr_rad3_CD3_CD8pos <- as.data.frame(outcome_pr_rad3_CD3_CD8pos)
outcome_pr_rad3_foxp3 <- as.data.frame(outcome_pr_rad3_foxp3)
```


Median FALSE = below median delta_estimate 
Median TRUE = above median delta_estimate


#### CD20

##### ANOVA

```{r}
group_by(outcome_all_rad3_CD20, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```


Remove NA values
```{r}
outcome_all_rad3_CD20 <- outcome_all_rad3_CD20[!is.na(outcome_all_rad3_CD20$delta_estimate),]

group_by(outcome_all_rad3_CD20, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
outcome_all_rad3_CD20$study_group <- gsub("non_prbc", "nonPrBC", outcome_all_rad3_CD20$study_group)
outcome_all_rad3_CD20$study_group <- gsub("ppbc_inv", "PPBCinv", outcome_all_rad3_CD20$study_group)
outcome_all_rad3_CD20$study_group <- gsub("ppbc_lac", "PPBClac", outcome_all_rad3_CD20$study_group)
outcome_all_rad3_CD20$study_group <- gsub("prbc", "PrBC", outcome_all_rad3_CD20$study_group)

outcome_all_rad3_CD20$study_group <- ordered(outcome_all_rad3_CD20$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(outcome_all_rad3_CD20$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(outcome_all_rad3_CD20$delta_estimate)
```


```{r}
outcome_all_rad3_CD20 %>% 
  group_by(study_group) %>%
  identify_outliers(delta_estimate)
```



Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.delta_estimate_CD20 <- aov(delta_estimate ~ study_group, data = outcome_all_rad3_CD20)
# summary of the analysis
summary(res.aov.delta_estimate_CD20)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.delta_estimate_CD20)
```

```{r}
pwc_delta_estimate_CD20 <- outcome_all_rad3_CD20 %>% tukey_hsd(delta_estimate ~ study_group)
pwc_delta_estimate_CD20
```



Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.delta_estimate_CD20, 1)
```


From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD20)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(outcome_all_rad3_CD20$delta_estimate, outcome_all_rad3_CD20$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.delta_estimate_CD20, 2)

model_delta_estimate_CD20 <- lm(delta_estimate ~ study_group, data=outcome_all_rad3_CD20)
ggqqplot(residuals(model_delta_estimate_CD20))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_delta_estimate_CD20 <- residuals(object = res.aov.delta_estimate_CD20)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_delta_estimate_CD20)
shapiro_test(residuals(model_delta_estimate_CD20))
```



Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD20)
```


wilcoxon pairwise test

The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.

```{r}
pairwise.t.test(outcome_all_rad3_CD20$delta_estimate, outcome_all_rad3_CD20$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
#pairwise_CD20 <- pairwise_CD20 %>% add_xy_position(x = "study_group")
my_comparisons <- list( c("PPBCinv", "nonPrBC"), c("PPBCinv", "PrBC"), c("PrBC", "nonPrBC") )


ANOVA_delta_estimate_CD20 <- ggboxplot(outcome_all_rad3_CD20, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD20 at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.009, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 1.0) # Add pairwise comparisons p-value #+ stat_pvalue_manual(pairwise_CD20, hide.ns = TRUE, y.position = c(1.25))
ANOVA_delta_estimate_CD20
```

```{r, fig.width=7, fig.height=4.5}
#pairwise_CD20 <- pairwise_CD20 %>% add_xy_position(x = "study_group")
my_comparisons <- list( c("PPBCinv", "nonPrBC"), c("PPBCinv", "PrBC"), c("PrBC", "nonPrBC") )


ANOVA_delta_estimate_CD20 <- ggboxplot(outcome_all_rad3_CD20, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD20 at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.009, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 1.0) + ylim(0,0.5) # Add pairwise comparisons p-value #+ stat_pvalue_manual(pairwise_CD20, hide.ns = TRUE, y.position = c(1.25))
ANOVA_delta_estimate_CD20
```

```{r}
pdf(file="ANOVA_delta_estimate_CD20.pdf", width = 7, height=4.5)
ANOVA_delta_estimate_CD20
dev.off()
```

##### Kaplan-meier

```{r}
Lanalysis_OS_CD20_studygroup <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD20), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD20 by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
Lanalysis_OS_CD20_studygroup

Lanalysis_DRS_CD20_studygroup <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD20), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD20 by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
Lanalysis_DRS_CD20_studygroup
```

```{r}
pdf(file="Lanalysis_OS_CD20_studygroup.pdf", width = 7, height=4.5)
Lanalysis_OS_CD20_studygroup
dev.off()

pdf(file="Lanalysis_DRS_CD20_studygroup.pdf", width = 7, height=4.5)
Lanalysis_DRS_CD20_studygroup
dev.off()
```

```{r}
outcome_all_rad3_CD20_withoutprbc <- subset(outcome_all_rad3_CD20, study_group %in% c("PPBCinv", "nonPrBC"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD20_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD20 by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD20_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD20 by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```


```{r}
Lanalysis_OS_CD20_median <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD20), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD20 by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
Lanalysis_OS_CD20_median

Lanalysis_DRS_CD20_median <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD20), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD20 by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
Lanalysis_DRS_CD20_median
```

```{r}
pdf(file="Lanalysis_OS_CD20_median.pdf", width = 7, height=4.5)
Lanalysis_OS_CD20_median
dev.off()

pdf(file="Lanalysis_DRS_CD20_median.pdf", width = 7, height=4.5)
Lanalysis_DRS_CD20_median
dev.off()
```


#### CD3+ FoxP3-

##### ANOVA

```{r}
group_by(outcome_all_rad3_CD3_foxp3neg, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```


Remove NA values
```{r}
outcome_all_rad3_CD3_foxp3neg <- outcome_all_rad3_CD3_foxp3neg[!is.na(outcome_all_rad3_CD3_foxp3neg$delta_estimate),]

group_by(outcome_all_rad3_CD3_foxp3neg, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
outcome_all_rad3_CD3_foxp3neg$study_group <- gsub("non_prbc", "nonPrBC", outcome_all_rad3_CD3_foxp3neg$study_group)
outcome_all_rad3_CD3_foxp3neg$study_group <- gsub("ppbc_lac", "PPBClac", outcome_all_rad3_CD3_foxp3neg$study_group)
outcome_all_rad3_CD3_foxp3neg$study_group <- gsub("ppbc_inv", "PPBCinv", outcome_all_rad3_CD3_foxp3neg$study_group)
outcome_all_rad3_CD3_foxp3neg$study_group <- gsub("prbc", "PrBC", outcome_all_rad3_CD3_foxp3neg$study_group)

outcome_all_rad3_CD3_foxp3neg$study_group <- ordered(outcome_all_rad3_CD3_foxp3neg$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(outcome_all_rad3_CD3_foxp3neg$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(outcome_all_rad3_CD3_foxp3neg$delta_estimate)
```


```{r}
outcome_all_rad3_CD3_foxp3neg %>% 
  group_by(study_group) %>%
  identify_outliers(delta_estimate)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.delta_estimate_CD3_foxp3neg <- aov(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_foxp3neg)
# summary of the analysis
summary(res.aov.delta_estimate_CD3_foxp3neg)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.delta_estimate_CD3_foxp3neg)
```

```{r}
pwc_delta_estimate_CD3_foxp3neg <- outcome_all_rad3_CD3_foxp3neg %>% tukey_hsd(delta_estimate ~ study_group)
pwc_delta_estimate_CD3_foxp3neg
```



Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.delta_estimate_CD3_foxp3neg, 1)
```


From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_foxp3neg)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(outcome_all_rad3_CD3_foxp3neg$delta_estimate, outcome_all_rad3_CD3_foxp3neg$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.delta_estimate_CD3_foxp3neg, 2)

model_delta_estimate_CD3_foxp3neg <- lm(delta_estimate ~ study_group, data=outcome_all_rad3_CD3_foxp3neg)
ggqqplot(residuals(model_delta_estimate_CD3_foxp3neg))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_delta_estimate_CD3_foxp3neg <- residuals(object = res.aov.delta_estimate_CD3_foxp3neg)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_delta_estimate_CD3_foxp3neg)
shapiro_test(residuals(model_delta_estimate_CD3_foxp3neg))
```



Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_foxp3neg)
```

```{r}
pairwise.t.test(outcome_all_rad3_CD3_foxp3neg$delta_estimate, outcome_all_rad3_CD3_foxp3neg$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
my_comparisons <- list( c("PPBCinv", "nonPrBC"), c("PPBCinv", "PrBC"), c("PrBC", "nonPrBC") )

ANOVA_delta_estimate_CD3_foxp3neg <- ggboxplot(outcome_all_rad3_CD3_foxp3neg, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD3_foxp3neg at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 1) # + stat_pvalue_manual(pwc_delta_estimate_CD3_foxp3neg, hide.ns = TRUE, y.position = c(1.25))
ANOVA_delta_estimate_CD3_foxp3neg
```

```{r}
pdf(file="ANOVA_delta_estimate_CD3_foxp3neg.pdf", width = 7, height=4.5)
ANOVA_delta_estimate_CD3_foxp3neg
dev.off()
```

##### Kaplan-meier
```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_foxp3neg), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_foxp3neg), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```

```{r}
outcome_all_rad3_CD3_foxp3neg_withoutprbc <- subset(outcome_all_rad3_CD3_foxp3neg, study_group %in% c("PPBCinv", "nonPrBC"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_foxp3neg_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#46CDCF", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_foxp3neg_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#46CDCF", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```



```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_foxp3neg), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_foxp3neg), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
```


#### CD3+ CD8-

##### ANOVA

```{r}
group_by(outcome_all_rad3_CD3_CD8neg, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```


Remove NA values
```{r}
outcome_all_rad3_CD3_CD8neg <- outcome_all_rad3_CD3_CD8neg[!is.na(outcome_all_rad3_CD3_CD8neg$delta_estimate),]

group_by(outcome_all_rad3_CD3_CD8neg, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
outcome_all_rad3_CD3_CD8neg$study_group <- gsub("non_prbc", "nonPrBC", outcome_all_rad3_CD3_CD8neg$study_group)
outcome_all_rad3_CD3_CD8neg$study_group <- gsub("ppbc_inv", "PPBCinv", outcome_all_rad3_CD3_CD8neg$study_group)
outcome_all_rad3_CD3_CD8neg$study_group <- gsub("ppbc_lac", "PPBClac", outcome_all_rad3_CD3_CD8neg$study_group)
outcome_all_rad3_CD3_CD8neg$study_group <- gsub("prbc", "PrBC", outcome_all_rad3_CD3_CD8neg$study_group)

outcome_all_rad3_CD3_CD8neg$study_group <- ordered(outcome_all_rad3_CD3_CD8neg$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(outcome_all_rad3_CD3_CD8neg$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(outcome_all_rad3_CD3_CD8neg$delta_estimate)
```


```{r}
outcome_all_rad3_CD3_CD8neg %>% 
  group_by(study_group) %>%
  identify_outliers(delta_estimate)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.delta_estimate_CD3_CD8neg <- aov(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_CD8neg)
# summary of the analysis
summary(res.aov.delta_estimate_CD3_CD8neg)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.delta_estimate_CD3_CD8neg)
```

```{r}
pwc_delta_estimate_CD3_CD8neg <- outcome_all_rad3_CD3_CD8neg %>% tukey_hsd(delta_estimate ~ study_group)
pwc_delta_estimate_CD3_CD8neg
```



Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.delta_estimate_CD3_CD8neg, 1)
```


From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_CD8neg)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(outcome_all_rad3_CD3_CD8neg$delta_estimate, outcome_all_rad3_CD3_CD8neg$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.delta_estimate_CD3_CD8neg, 2)

model_delta_estimate_CD3_CD8neg <- lm(delta_estimate ~ study_group, data=outcome_all_rad3_CD3_CD8neg)
ggqqplot(residuals(model_delta_estimate_CD3_CD8neg))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_delta_estimate_CD3_CD8neg <- residuals(object = res.aov.delta_estimate_CD3_CD8neg)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_delta_estimate_CD3_CD8neg)
shapiro_test(residuals(model_delta_estimate_CD3_CD8neg))
```



Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_CD8neg)
```

Wilcox pairwise test

```{r}
pairwise.t.test(outcome_all_rad3_CD3_CD8neg$delta_estimate, outcome_all_rad3_CD3_CD8neg$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
ANOVA_delta_estimate_CD3_CD8neg <- ggboxplot(outcome_all_rad3_CD3_CD8neg, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD3_CD8neg at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.3) + ylim(0,0.3) # + stat_pvalue_manual(pwc_delta_estimate_CD3_CD8neg, hide.ns = TRUE, y.position = c(1.25))
ANOVA_delta_estimate_CD3_CD8neg
```

```{r}
pdf(file="ANOVA_delta_estimate_CD3_CD8neg.pdf", width = 7, height=4.5)
ANOVA_delta_estimate_CD3_CD8neg
dev.off()
```


##### Kaplan-meier
```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_CD8neg), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+CD8- by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_CD8neg), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+CD8- by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```

```{r}
outcome_all_rad3_CD3_CD8neg_withoutprbc <- subset(outcome_all_rad3_CD3_CD8neg, study_group %in% c("PPBCinv", "nonPrBC"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_CD8neg_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_CD8neg_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_CD8neg), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD3+CD8- by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_CD8neg), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD3+CD8- by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
```

#### CD3+ CD8+

##### ANOVA

```{r}
group_by(outcome_all_rad3_CD3_CD8pos, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```


Remove NA values
```{r}
outcome_all_rad3_CD3_CD8pos <- outcome_all_rad3_CD3_CD8pos[!is.na(outcome_all_rad3_CD3_CD8pos$delta_estimate),]

group_by(outcome_all_rad3_CD3_CD8pos, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
outcome_all_rad3_CD3_CD8pos$study_group <- gsub("non_prbc", "nonPrBC", outcome_all_rad3_CD3_CD8pos$study_group)
outcome_all_rad3_CD3_CD8pos$study_group <- gsub("ppbc_inv", "PPBCinv", outcome_all_rad3_CD3_CD8pos$study_group)
outcome_all_rad3_CD3_CD8pos$study_group <- gsub("ppbc_lac", "PPBClac", outcome_all_rad3_CD3_CD8pos$study_group)
outcome_all_rad3_CD3_CD8pos$study_group <- gsub("prbc", "PrBC", outcome_all_rad3_CD3_CD8pos$study_group)

outcome_all_rad3_CD3_CD8pos$study_group <- ordered(outcome_all_rad3_CD3_CD8pos$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(outcome_all_rad3_CD3_CD8pos$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(outcome_all_rad3_CD3_CD8pos$delta_estimate)
```


```{r}
outcome_all_rad3_CD3_CD8pos %>% 
  group_by(study_group) %>%
  identify_outliers(delta_estimate)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.delta_estimate_CD3_CD8pos <- aov(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_CD8pos)
# summary of the analysis
summary(res.aov.delta_estimate_CD3_CD8pos)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.delta_estimate_CD3_CD8pos)
```

```{r}
pwc_delta_estimate_CD3_CD8pos <- outcome_all_rad3_CD3_CD8pos %>% tukey_hsd(delta_estimate ~ study_group)
pwc_delta_estimate_CD3_CD8pos
```


Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.delta_estimate_CD3_CD8pos, 1)
```


From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_CD8pos)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(outcome_all_rad3_CD3_CD8pos$delta_estimate, outcome_all_rad3_CD3_CD8pos$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.delta_estimate_CD3_CD8pos, 2)

model_delta_estimate_CD3_CD8pos <- lm(delta_estimate ~ study_group, data=outcome_all_rad3_CD3_CD8pos)
ggqqplot(residuals(model_delta_estimate_CD3_CD8pos))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_delta_estimate_CD3_CD8pos <- residuals(object = res.aov.delta_estimate_CD3_CD8pos)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_delta_estimate_CD3_CD8pos)
shapiro_test(residuals(model_delta_estimate_CD3_CD8pos))
```



Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_CD8pos)
```

Wilcox pairwise test

```{r}
pairwise.t.test(outcome_all_rad3_CD3_CD8pos$delta_estimate, outcome_all_rad3_CD3_CD8pos$study_group,
                 p.adjust.method = "BH")
```



Visualization

```{r, fig.width=7, fig.height=4.5}
ANOVA_delta_estimate_CD3_CD8pos <- ggboxplot(outcome_all_rad3_CD3_CD8pos, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD3_CD8pos at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.4) # + stat_pvalue_manual(pwc_delta_estimate_CD3_CD8pos, hide.ns = TRUE, y.position = c(0.3))
ANOVA_delta_estimate_CD3_CD8pos
```

```{r, fig.width=7, fig.height=4.5}
ANOVA_delta_estimate_CD3_CD8pos <- ggboxplot(outcome_all_rad3_CD3_CD8pos, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD3_CD8pos at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.4) + ylim(0,0.2) # + stat_pvalue_manual(pwc_delta_estimate_CD3_CD8pos, hide.ns = TRUE, y.position = c(0.3))
ANOVA_delta_estimate_CD3_CD8pos
```


```{r}
pdf(file="ANOVA_delta_estimate_CD3_CD8pos.pdf", width = 7, height=4.5)
ANOVA_delta_estimate_CD3_CD8pos
dev.off()
```

##### kaplan-meier
```{r}
CD8_DE_OS_spatial <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_CD8pos), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+CD8+ by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
CD8_DE_OS_spatial

CD8_DE_DRS_spatial <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_CD8pos), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+CD8+ by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
CD8_DE_DRS_spatial
```

```{r}
pdf(file="CD8_DE_OS_spatial.pdf", width = 7, height=5)
CD8_DE_OS_spatial
dev.off()

pdf(file="CD8_DE_DRS_spatial.pdf", width = 7, height=5)
CD8_DE_DRS_spatial
dev.off()
```


```{r}
outcome_all_rad3_CD3_CD8pos_withoutprbc <- subset(outcome_all_rad3_CD3_CD8pos, study_group %in% c("PPBCinv", "nonPrBC"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_CD8pos_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_CD8pos_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_CD8pos), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD3+CD8+ by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_CD8pos), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD3+CD8+ by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
```


#### within study groups OS

subset data low IG signature versus high IG signature 

```{r}
outcome_all_rad3_CD3_CD8pos_low <- subset(outcome_all_rad3_CD3_CD8pos, median %in% c("FALSE"), )
outcome_all_rad3_CD3_CD8pos_high <- subset(outcome_all_rad3_CD3_CD8pos, median %in% c("TRUE"), )
```


Testing proportional hazards assumption -> zie file Kat: stratify for PAM50


```{r}
table(outcome_all_rad3_CD3_CD8pos_low$study_group)
table(outcome_all_rad3_CD3_CD8pos_high$study_group)
```



low CD8 cluster 

univariate 

```{r}
#univariate
cox_OS_CD8low <- coxph(Surv(time_OS_months, death) ~ study_group, data = outcome_all_rad3_CD3_CD8pos_low)
summary(cox_OS_CD8low)
```


multivariate 

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    study_group, #+
    #strata(clin_subtype),
  data = outcome_all_rad3_CD3_CD8pos_low)
summary(clin.cov.cox)
```



```{r}
#with study study_group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~  stage + study_group, data = outcome_all_rad3_CD3_CD8pos_low)
study_strata
plot_OS_CD8low_multivariate <- ggadjustedcurves(study_strata, data=outcome_all_rad3_CD3_CD8pos_low, method="conditional", variable="study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_OS_CD8low_multivariate
```

```{r}
pdf(here("plot_OS_CD8low_multivariate.pdf"), width = 7, height = 5)
plot_OS_CD8low_multivariate
dev.off()
```

High CD8 cluster 

univariate 

```{r}
#univariate
cox_OS_CD8high <- coxph(Surv(time_OS_months, death) ~ study_group, data = outcome_all_rad3_CD3_CD8pos_high)
summary(cox_OS_CD8high)
```

multivariate


```{r}
#with study_group
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    study_group, #+
    #strata(clin_subtype),
  data = outcome_all_rad3_CD3_CD8pos_high)
summary(clin.cov.cox)
```

```{r}
#with study study_group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + study_group, data = outcome_all_rad3_CD3_CD8pos_high)
study_strata
plot_OS_CD8high_multivariate <- ggadjustedcurves(study_strata, data=outcome_all_rad3_CD3_CD8pos_high, method="conditional", variable="study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_OS_CD8high_multivariate
```




#### within study study_groups DRS

low CD8 cluster 

univariate 

```{r}
#univariate
cox_DRS_CD8low <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = outcome_all_rad3_CD3_CD8pos_low)
summary(cox_DRS_CD8low)
```


multivariate 


```{r}
table(outcome_all_rad3_CD3_CD8pos_low$study_group)
```



```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    study_group, #+
    #strata(clin_subtype),
  data = outcome_all_rad3_CD3_CD8pos_low)
summary(clin.cov.cox)
```



```{r}
#with study study_group as covariate 
study_strata <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~  stage + study_group, data = outcome_all_rad3_CD3_CD8pos_low)
study_strata
plot_DRS_CD8low_multivariate <- ggadjustedcurves(study_strata, data=outcome_all_rad3_CD3_CD8pos_low, method="conditional", variable="study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_DRS_CD8low_multivariate
```


High CD8 cluster 

univariate 

```{r}
#univariate
cox_DRS_CD8high <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = outcome_all_rad3_CD3_CD8pos_high)
summary(cox_DRS_CD8high)
```

multivariate



```{r}
#with study_group
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    study_group, #+
    #strata(clin_subtype),
  data = outcome_all_rad3_CD3_CD8pos_high)
summary(clin.cov.cox)
```

```{r}
#with study study_group as covariate 
study_strata <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage + study_group, data = outcome_all_rad3_CD3_CD8pos_high)
study_strata
plot_DRS_CD8high_multivariate <- ggadjustedcurves(study_strata, data=outcome_all_rad3_CD3_CD8pos_high, method="conditional", variable="study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_DRS_CD8high_multivariate
```



#### FoxP3+


##### ANOVA

```{r}
group_by(outcome_all_rad3_foxp3, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```


Remove NA values
```{r}
outcome_all_rad3_foxp3 <- outcome_all_rad3_foxp3[!is.na(outcome_all_rad3_foxp3$delta_estimate),]

group_by(outcome_all_rad3_foxp3, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
outcome_all_rad3_foxp3$study_group <- gsub("non_prbc", "nonPrBC", outcome_all_rad3_foxp3$study_group)
outcome_all_rad3_foxp3$study_group <- gsub("ppbc_inv", "PPBCinv", outcome_all_rad3_foxp3$study_group)
outcome_all_rad3_foxp3$study_group <- gsub("ppbc_lac", "PPBClac", outcome_all_rad3_foxp3$study_group)
outcome_all_rad3_foxp3$study_group <- gsub("prbc", "PrBC", outcome_all_rad3_foxp3$study_group)

outcome_all_rad3_foxp3$study_group <- ordered(outcome_all_rad3_foxp3$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(outcome_all_rad3_foxp3$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(outcome_all_rad3_foxp3$delta_estimate)
```


```{r}
outcome_all_rad3_foxp3 %>% 
  group_by(study_group) %>%
  identify_outliers(delta_estimate)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.delta_estimate_foxp3 <- aov(delta_estimate ~ study_group, data = outcome_all_rad3_foxp3)
# summary of the analysis
summary(res.aov.delta_estimate_foxp3)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.delta_estimate_foxp3)
```

```{r}
pwc_delta_estimate_foxp3 <- outcome_all_rad3_foxp3 %>% tukey_hsd(delta_estimate ~ study_group)
pwc_delta_estimate_foxp3
```


Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.delta_estimate_foxp3, 1)
```


From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(delta_estimate ~ study_group, data = outcome_all_rad3_foxp3)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(outcome_all_rad3_foxp3$delta_estimate, outcome_all_rad3_foxp3$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.delta_estimate_foxp3, 2)

model_delta_estimate_foxp3 <- lm(delta_estimate ~ study_group, data=outcome_all_rad3_foxp3)
ggqqplot(residuals(model_delta_estimate_foxp3))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_delta_estimate_foxp3 <- residuals(object = res.aov.delta_estimate_foxp3)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_delta_estimate_foxp3)
shapiro_test(residuals(model_delta_estimate_foxp3))
```



Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(delta_estimate ~ study_group, data = outcome_all_rad3_foxp3)
```

Wilcox pairwise test

```{r}
pairwise.t.test(outcome_all_rad3_foxp3$delta_estimate, outcome_all_rad3_foxp3$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
ANOVA_delta_estimate_foxp3 <- ggboxplot(outcome_all_rad3_foxp3, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_foxp3 at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 5) # + stat_pvalue_manual(pwc_delta_estimate_foxp3, hide.ns = TRUE, y.position = c(1.25))
ANOVA_delta_estimate_foxp3
```

```{r}
pdf(file="ANOVA_delta_estimate_foxp3.pdf", width = 7, height=4.5)
ANOVA_delta_estimate_foxp3
dev.off()
```



##### kalpan-meier
```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_foxp3), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - FoxP3 by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_foxp3), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - FoxP3 by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```


```{r}
outcome_all_rad3_foxp3_withoutprbc <- subset(outcome_all_rad3_foxp3, study_group %in% c("PPBCinv", "nonPrBC"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_foxp3_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_foxp3_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```



```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_foxp3), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - FoxP3 by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_foxp3), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - FoxP3 by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
```


### Univariate 

CD20
```{r}
cox_OS_L_CD20 <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_all_rad3_CD20)
summary(cox_OS_L_CD20)

cox_OS_L_CD20_inv <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_inv_rad3_CD20)
summary(cox_OS_L_CD20_inv)

cox_OS_L_CD20_np <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_np_rad3_CD20)
summary(cox_OS_L_CD20_np)

cox_OS_L_CD20_pr <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_pr_rad3_CD20)
summary(cox_OS_L_CD20_pr)
```




CD3+ FoxP3-
```{r}
cox_OS_L_CD3_foxp3neg <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_all_rad3_CD3_foxp3neg)
summary(cox_OS_L_CD3_foxp3neg)

cox_OS_L_CD3_foxp3neg_inv <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_inv_rad3_CD3_foxp3neg)
summary(cox_OS_L_CD3_foxp3neg_inv)

cox_OS_L_CD3_foxp3neg_np <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_np_rad3_CD3_foxp3neg)
summary(cox_OS_L_CD3_foxp3neg_np)

cox_OS_L_CD3_foxp3neg_pr <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_pr_rad3_CD3_foxp3neg)
summary(cox_OS_L_CD3_foxp3neg_pr)
```


CD3+ CD8-
```{r}
cox_OS_L_CD3_CD8neg <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_all_rad3_CD3_CD8neg)
summary(cox_OS_L_CD3_CD8neg)

cox_OS_L_CD3_CD8neg_inv <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_inv_rad3_CD3_CD8neg)
summary(cox_OS_L_CD3_CD8neg_inv)

cox_OS_L_CD3_CD8neg_np <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_np_rad3_CD3_CD8neg)
summary(cox_OS_L_CD3_CD8neg_np)

cox_OS_L_CD3_CD8neg_pr <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_pr_rad3_CD3_CD8neg)
summary(cox_OS_L_CD3_CD8neg_pr)
```


CD3+ CD8+
```{r}
cox_OS_L_CD3_CD8pos <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_all_rad3_CD3_CD8pos)
summary(cox_OS_L_CD3_CD8pos)

cox_OS_L_CD3_CD8pos_inv <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_inv_rad3_CD3_CD8pos)
summary(cox_OS_L_CD3_CD8pos_inv)

cox_OS_L_CD3_CD8pos_np <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_np_rad3_CD3_CD8pos)
summary(cox_OS_L_CD3_CD8pos_np)

cox_OS_L_CD3_CD8pos_pr <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_pr_rad3_CD3_CD8pos)
summary(cox_OS_L_CD3_CD8pos_pr)
```


FoxP3+
```{r}
cox_OS_L_foxp3 <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_all_rad3_foxp3)
summary(cox_OS_L_foxp3)

cox_OS_L_foxp3_inv <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_inv_rad3_foxp3)
summary(cox_OS_L_foxp3_inv)

cox_OS_L_foxp3_np <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_np_rad3_foxp3)
summary(cox_OS_L_foxp3_np)

cox_OS_L_foxp3_pr <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_pr_rad3_foxp3)
summary(cox_OS_L_foxp3_pr)
```



### Multiavariate 

CD20
```{r}
#multivariate
multicox_OS_CD20 <- coxph(Surv(time_OS_months, death) ~ study_group + median + stage, data = outcome_all_rad3_CD20)
summary(multicox_OS_CD20)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group +
    stage +
    median,
  data = outcome_all_rad3_CD20)
summary(clin.cov.cox)
```

```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + strata(median), data = outcome_all_rad3_CD20)
study_strata
ggadjustedcurves(study_strata, data=outcome_all_rad3_CD20, method="conditional", variable="median", palette = c("#a10702", "#ffb600")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```






CD3+ FoxP3-
```{r}
#multivariate
multicox_OS_CD3_foxp3neg <- coxph(Surv(time_OS_months, death) ~ study_group + median + stage, data = outcome_all_rad3_CD3_foxp3neg)
summary(multicox_OS_CD3_foxp3neg)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group +
    stage +
    median,
  data = outcome_all_rad3_CD3_foxp3neg)
summary(clin.cov.cox)
```

```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + strata(median), data = outcome_all_rad3_CD3_foxp3neg)
study_strata
ggadjustedcurves(study_strata, data=outcome_all_rad3_CD3_foxp3neg, method="conditional", variable="median", palette = c("#a10702", "#ffb600")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```


CD3+CD8-
```{r}
#multivariate
multicox_OS_CD3_CD8neg <- coxph(Surv(time_OS_months, death) ~ study_group + median + stage, data = outcome_all_rad3_CD3_CD8neg)
summary(multicox_OS_CD3_CD8neg)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group +
    stage +
    median,
  data = outcome_all_rad3_CD3_CD8neg)
summary(clin.cov.cox)
```

```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + strata(median), data = outcome_all_rad3_CD3_CD8neg)
study_strata
ggadjustedcurves(study_strata, data=outcome_all_rad3_CD3_CD8neg, method="conditional", variable="median", palette = c("#a10702", "#ffb600")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```


CD3_CD8pos
```{r}
#multivariate
multicox_OS_CD3_CD8pos <- coxph(Surv(time_OS_months, death) ~ study_group + median + stage, data = outcome_all_rad3_CD3_CD8pos)
summary(multicox_OS_CD3_CD8pos)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group +
    stage +
    median,
  data = outcome_all_rad3_CD3_CD8pos)
summary(clin.cov.cox)
```

```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + strata(median), data = outcome_all_rad3_CD3_CD8pos)
study_strata
ggadjustedcurves(study_strata, data=outcome_all_rad3_CD3_CD8pos, method="conditional", variable="median", palette = c("#a10702", "#ffb600")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```


foxp3
```{r}
#multivariate
multicox_OS_foxp3 <- coxph(Surv(time_OS_months, death) ~ study_group + median + stage, data = outcome_all_rad3_foxp3)
summary(multicox_OS_foxp3)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group +
    stage +
    median,
  data = outcome_all_rad3_foxp3)
summary(clin.cov.cox)
```

```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + strata(median), data = outcome_all_rad3_foxp3)
study_strata
ggadjustedcurves(study_strata, data=outcome_all_rad3_foxp3, method="conditional", variable="median", palette = c("#a10702", "#ffb600")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```




# Lcross-measure - tumor versus immune cell subset


```{r}
outcome_all_rad3_CD20 <- subset(outcome_all_rad3, cell_types %in% c("PanCK+/CD20+"), )
outcome_inv_rad3_CD20 <- subset(outcome_inv_rad3, cell_types %in% c("PanCK+/CD20+"), )
outcome_np_rad3_CD20 <- subset(outcome_np_rad3, cell_types %in% c("PanCK+/CD20+"), )
outcome_pr_rad3_CD20 <- subset(outcome_pr_rad3, cell_types %in% c("PanCK+/CD20+"), )
```


```{r}
outcome_all_rad3_CD3_foxp3neg <- subset(outcome_all_rad3, cell_types %in% c("PanCK+/CD3+FoxP3-"), )
outcome_inv_rad3_CD3_foxp3neg <- subset(outcome_inv_rad3, cell_types %in% c("PanCK+/CD3+FoxP3-"), )
outcome_np_rad3_CD3_foxp3neg <- subset(outcome_np_rad3, cell_types %in% c("PanCK+/CD3+FoxP3-"), )
outcome_pr_rad3_CD3_foxp3neg <- subset(outcome_pr_rad3, cell_types %in% c("PanCK+/CD3+FoxP3-"), )
```


```{r}
outcome_all_rad3_CD3_CD8neg <- subset(outcome_all_rad3, cell_types %in% c("PanCK+/CD3+CD8-"), )
outcome_inv_rad3_CD3_CD8neg <- subset(outcome_inv_rad3, cell_types %in% c("PanCK+/CD3+CD8-"), )
outcome_np_rad3_CD3_CD8neg <- subset(outcome_np_rad3, cell_types %in% c("PanCK+/CD3+CD8-"), )
outcome_pr_rad3_CD3_CD8neg <- subset(outcome_pr_rad3, cell_types %in% c("PanCK+/CD3+CD8-"), )
```

```{r}
outcome_all_rad3_CD3_CD8pos <- subset(outcome_all_rad3, cell_types %in% c("PanCK+/CD3+CD8+"), )
outcome_inv_rad3_CD3_CD8pos <- subset(outcome_inv_rad3, cell_types %in% c("PanCK+/CD3+CD8+"), )
outcome_np_rad3_CD3_CD8pos <- subset(outcome_np_rad3, cell_types %in% c("PanCK+/CD3+CD8+"), )
outcome_pr_rad3_CD3_CD8pos <- subset(outcome_pr_rad3, cell_types %in% c("PanCK+/CD3+CD8+"), )
```


```{r}
outcome_all_rad3_foxp3 <- subset(outcome_all_rad3, cell_types %in% c("PanCK+/FoxP3+"), )
outcome_inv_rad3_foxp3 <- subset(outcome_inv_rad3, cell_types %in% c("PanCK+/FoxP3+"), )
outcome_np_rad3_foxp3 <- subset(outcome_np_rad3, cell_types %in% c("PanCK+/FoxP3+"), )
outcome_pr_rad3_foxp3 <- subset(outcome_pr_rad3, cell_types %in% c("PanCK+/FoxP3+"), )
```


create variable that subsets data into above or below the median:

FALSE = under the median 
TRUE = above the median 

```{r}
outcome_all_rad3_CD20$median <- outcome_all_rad3_CD20$delta_estimate > median(outcome_all_rad3_CD20$delta_estimate, na.rm=T)
outcome_all_rad3_CD3_foxp3neg$median <- outcome_all_rad3_CD3_foxp3neg$delta_estimate > median(outcome_all_rad3_CD3_foxp3neg$delta_estimate, na.rm=T)
outcome_all_rad3_CD3_CD8neg$median <- outcome_all_rad3_CD3_CD8neg$delta_estimate > median(outcome_all_rad3_CD3_CD8neg$delta_estimate, na.rm=T)
outcome_all_rad3_CD3_CD8pos$median <- outcome_all_rad3_CD3_CD8pos$delta_estimate > median(outcome_all_rad3_CD3_CD8pos$delta_estimate, na.rm=T)
outcome_all_rad3_foxp3$median <- outcome_all_rad3_foxp3$delta_estimate > median(outcome_all_rad3_foxp3$delta_estimate, na.rm=T)

outcome_inv_rad3_CD20$median <- outcome_inv_rad3_CD20$delta_estimate > median(outcome_inv_rad3_CD20$delta_estimate, na.rm=T)
outcome_inv_rad3_CD3_foxp3neg$median <- outcome_inv_rad3_CD3_foxp3neg$delta_estimate > median(outcome_inv_rad3_CD3_foxp3neg$delta_estimate, na.rm=T)
outcome_inv_rad3_CD3_CD8neg$median <- outcome_inv_rad3_CD3_CD8neg$delta_estimate > median(outcome_inv_rad3_CD3_CD8neg$delta_estimate, na.rm=T)
outcome_inv_rad3_CD3_CD8pos$median <- outcome_inv_rad3_CD3_CD8pos$delta_estimate > median(outcome_inv_rad3_CD3_CD8pos$delta_estimate, na.rm=T)
outcome_inv_rad3_foxp3$median <- outcome_inv_rad3_foxp3$delta_estimate > median(outcome_inv_rad3_foxp3$delta_estimate, na.rm=T)

outcome_np_rad3_CD20$median <- outcome_np_rad3_CD20$delta_estimate > median(outcome_np_rad3_CD20$delta_estimate, na.rm=T)
outcome_np_rad3_CD3_foxp3neg$median <- outcome_np_rad3_CD3_foxp3neg$delta_estimate > median(outcome_np_rad3_CD3_foxp3neg$delta_estimate, na.rm=T)
outcome_np_rad3_CD3_CD8neg$median <- outcome_np_rad3_CD3_CD8neg$delta_estimate > median(outcome_np_rad3_CD3_CD8neg$delta_estimate, na.rm=T)
outcome_np_rad3_CD3_CD8pos$median <- outcome_np_rad3_CD3_CD8pos$delta_estimate > median(outcome_np_rad3_CD3_CD8pos$delta_estimate, na.rm=T)
outcome_np_rad3_foxp3$median <- outcome_np_rad3_foxp3$delta_estimate > median(outcome_np_rad3_foxp3$delta_estimate, na.rm=T)

outcome_pr_rad3_CD20$median <- outcome_pr_rad3_CD20$delta_estimate > median(outcome_pr_rad3_CD20$delta_estimate, na.rm=T)
outcome_pr_rad3_CD3_foxp3neg$median <- outcome_pr_rad3_CD3_foxp3neg$delta_estimate > median(outcome_pr_rad3_CD3_foxp3neg$delta_estimate, na.rm=T)
outcome_pr_rad3_CD3_CD8neg$median <- outcome_pr_rad3_CD3_CD8neg$delta_estimate > median(outcome_pr_rad3_CD3_CD8neg$delta_estimate, na.rm=T)
outcome_pr_rad3_CD3_CD8pos$median <- outcome_pr_rad3_CD3_CD8pos$delta_estimate > median(outcome_pr_rad3_CD3_CD8pos$delta_estimate, na.rm=T)
outcome_pr_rad3_foxp3$median <- outcome_pr_rad3_foxp3$delta_estimate > median(outcome_pr_rad3_foxp3$delta_estimate, na.rm=T)
```



Make data frames 

```{r}
outcome_all_rad3_CD20 <- as.data.frame(outcome_all_rad3_CD20)
outcome_all_rad3_CD3_foxp3neg <- as.data.frame(outcome_all_rad3_CD3_foxp3neg)
outcome_all_rad3_CD3_CD8neg <- as.data.frame(outcome_all_rad3_CD3_CD8neg)
outcome_all_rad3_CD3_CD8pos <- as.data.frame(outcome_all_rad3_CD3_CD8pos)
outcome_all_rad3_foxp3 <- as.data.frame(outcome_all_rad3_foxp3)

outcome_inv_rad3_CD20 <- as.data.frame(outcome_inv_rad3_CD20)
outcome_inv_rad3_CD3_foxp3neg <- as.data.frame(outcome_inv_rad3_CD3_foxp3neg)
outcome_inv_rad3_CD3_CD8neg <- as.data.frame(outcome_inv_rad3_CD3_CD8neg)
outcome_inv_rad3_CD3_CD8pos <- as.data.frame(outcome_inv_rad3_CD3_CD8pos)
outcome_inv_rad3_foxp3 <- as.data.frame(outcome_inv_rad3_foxp3)

outcome_np_rad3_CD20 <- as.data.frame(outcome_np_rad3_CD20)
outcome_np_rad3_CD3_foxp3neg <- as.data.frame(outcome_np_rad3_CD3_foxp3neg)
outcome_np_rad3_CD3_CD8neg <- as.data.frame(outcome_np_rad3_CD3_CD8neg)
outcome_np_rad3_CD3_CD8pos <- as.data.frame(outcome_np_rad3_CD3_CD8pos)
outcome_np_rad3_foxp3 <- as.data.frame(outcome_np_rad3_foxp3)

outcome_pr_rad3_CD20 <- as.data.frame(outcome_pr_rad3_CD20)
outcome_pr_rad3_CD3_foxp3neg <- as.data.frame(outcome_pr_rad3_CD3_foxp3neg)
outcome_pr_rad3_CD3_CD8neg <- as.data.frame(outcome_pr_rad3_CD3_CD8neg)
outcome_pr_rad3_CD3_CD8pos <- as.data.frame(outcome_pr_rad3_CD3_CD8pos)
outcome_pr_rad3_foxp3 <- as.data.frame(outcome_pr_rad3_foxp3)
```


### Kaplan-meier

Median FALSE = below median delta_estimate 
Median TRUE = above median delta_estimate


#### CD20

##### ANOVA

```{r}
group_by(outcome_all_rad3_CD20, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```


Remove NA values
```{r}
outcome_all_rad3_CD20 <- outcome_all_rad3_CD20[!is.na(outcome_all_rad3_CD20$delta_estimate),]

group_by(outcome_all_rad3_CD20, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
outcome_all_rad3_CD20$study_group <- gsub("non_prbc", "nonPrBC", outcome_all_rad3_CD20$study_group)
outcome_all_rad3_CD20$study_group <- gsub("ppbc_inv", "PPBCinv", outcome_all_rad3_CD20$study_group)
outcome_all_rad3_CD20$study_group <- gsub("ppbc_lac", "PPBClac", outcome_all_rad3_CD20$study_group)
outcome_all_rad3_CD20$study_group <- gsub("prbc", "PrBC", outcome_all_rad3_CD20$study_group)

outcome_all_rad3_CD20$study_group <- ordered(outcome_all_rad3_CD20$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(outcome_all_rad3_CD20$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(outcome_all_rad3_CD20$delta_estimate)
```


```{r}
outcome_all_rad3_CD20 %>% 
  group_by(study_group) %>%
  identify_outliers(delta_estimate)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.delta_estimate_CD20 <- aov(delta_estimate ~ study_group, data = outcome_all_rad3_CD20)
# summary of the analysis
summary(res.aov.delta_estimate_CD20)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.delta_estimate_CD20)
```

```{r}
pwc_delta_estimate_CD20 <- outcome_all_rad3_CD20 %>% tukey_hsd(delta_estimate ~ study_group)
pwc_delta_estimate_CD20
```



Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.delta_estimate_CD20, 1)
```


From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD20)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(outcome_all_rad3_CD20$delta_estimate, outcome_all_rad3_CD20$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.delta_estimate_CD20, 2)

model_delta_estimate_CD20 <- lm(delta_estimate ~ study_group, data=outcome_all_rad3_CD20)
ggqqplot(residuals(model_delta_estimate_CD20))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_delta_estimate_CD20 <- residuals(object = res.aov.delta_estimate_CD20)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_delta_estimate_CD20)
shapiro_test(residuals(model_delta_estimate_CD20))
```



Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD20)
```


Wilcox pairwise test

```{r}
pairwise.t.test(outcome_all_rad3_CD20$delta_estimate, outcome_all_rad3_CD20$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
ANOVA_delta_estimate_CD20_Lcross <- ggboxplot(outcome_all_rad3_CD20, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD20 at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.0005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.05) # + stat_pvalue_manual(pwc_delta_estimate_CD20, hide.ns = TRUE, y.position = c(1.25))
ANOVA_delta_estimate_CD20_Lcross
```


```{r, fig.width=7, fig.height=4.5}
ANOVA_delta_estimate_CD20_Lcross <- ggboxplot(outcome_all_rad3_CD20, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD20 at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.0007, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.05) + ylim(0,0.03) # + stat_pvalue_manual(pwc_delta_estimate_CD20, hide.ns = TRUE, y.position = c(1.25))
ANOVA_delta_estimate_CD20_Lcross
```

```{r}
pdf(file="ANOVA_delta_estimate_CD20_Lcross.pdf", width = 7, height=4.5)
ANOVA_delta_estimate_CD20_Lcross
dev.off()
```

##### Kaplan-meier

```{r}
Lanalysis_OS_CD20_studygroup_Lcross <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD20), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD20 by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
Lanalysis_OS_CD20_studygroup_Lcross

Lanalysis_DRS_CD20_studygroup_Lcross <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD20), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD20 by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
Lanalysis_DRS_CD20_studygroup_Lcross
```

```{r}
pdf(file="Lanalysis_OS_CD20_studygroup_Lcross.pdf", width = 7, height=4.5)
Lanalysis_OS_CD20_studygroup_Lcross
dev.off()

pdf(file="Lanalysis_DRS_CD20_studygroup_Lcross.pdf", width = 7, height=4.5)
Lanalysis_DRS_CD20_studygroup_Lcross
dev.off()
```


```{r}
outcome_all_rad3_CD20_withoutprbc <- subset(outcome_all_rad3_CD20, study_group %in% c("PPBCinv", "nonPrBC"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD20_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD20_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```



```{r}
Lanalysis_OS_CD20_median_Lcross <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD20), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD20 by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
Lanalysis_OS_CD20_median_Lcross

Lanalysis_DRS_CD20_median_Lcross <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD20), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD20 by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
Lanalysis_DRS_CD20_median_Lcross
```

```{r}
pdf(file="Lanalysis_OS_CD20_median_Lcross.pdf", width = 7, height=4.5)
Lanalysis_OS_CD20_median_Lcross
dev.off()

pdf(file="Lanalysis_DRS_CD20_median_Lcross.pdf", width = 7, height=4.5)
Lanalysis_DRS_CD20_median_Lcross
dev.off()
```


#### CD3+ FoxP3-

##### ANOVA

```{r}
group_by(outcome_all_rad3_CD3_foxp3neg, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```


Remove NA values
```{r}
outcome_all_rad3_CD3_foxp3neg <- outcome_all_rad3_CD3_foxp3neg[!is.na(outcome_all_rad3_CD3_foxp3neg$delta_estimate),]

group_by(outcome_all_rad3_CD3_foxp3neg, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
outcome_all_rad3_CD3_foxp3neg$study_group <- gsub("non_prbc", "nonPrBC", outcome_all_rad3_CD3_foxp3neg$study_group)
outcome_all_rad3_CD3_foxp3neg$study_group <- gsub("ppbc_inv", "PPBCinv", outcome_all_rad3_CD3_foxp3neg$study_group)
outcome_all_rad3_CD3_foxp3neg$study_group <- gsub("ppbc_lac", "PPBClac", outcome_all_rad3_CD3_foxp3neg$study_group)
outcome_all_rad3_CD3_foxp3neg$study_group <- gsub("prbc", "PrBC", outcome_all_rad3_CD3_foxp3neg$study_group)

outcome_all_rad3_CD3_foxp3neg$study_group <- ordered(outcome_all_rad3_CD3_foxp3neg$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(outcome_all_rad3_CD3_foxp3neg$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(outcome_all_rad3_CD3_foxp3neg$delta_estimate)
```


```{r}
outcome_all_rad3_CD3_foxp3neg %>% 
  group_by(study_group) %>%
  identify_outliers(delta_estimate)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.delta_estimate_CD3_foxp3neg <- aov(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_foxp3neg)
# summary of the analysis
summary(res.aov.delta_estimate_CD3_foxp3neg)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.delta_estimate_CD3_foxp3neg)
```

```{r}
pwc_delta_estimate_CD3_foxp3neg <- outcome_all_rad3_CD3_foxp3neg %>% tukey_hsd(delta_estimate ~ study_group)
pwc_delta_estimate_CD3_foxp3neg
```


Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.delta_estimate_CD3_foxp3neg, 1)
```


From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_foxp3neg)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(outcome_all_rad3_CD3_foxp3neg$delta_estimate, outcome_all_rad3_CD3_foxp3neg$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.delta_estimate_CD3_foxp3neg, 2)

model_delta_estimate_CD3_foxp3neg <- lm(delta_estimate ~ study_group, data=outcome_all_rad3_CD3_foxp3neg)
ggqqplot(residuals(model_delta_estimate_CD3_foxp3neg))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_delta_estimate_CD3_foxp3neg <- residuals(object = res.aov.delta_estimate_CD3_foxp3neg)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_delta_estimate_CD3_foxp3neg)
shapiro_test(residuals(model_delta_estimate_CD3_foxp3neg))
```



Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_foxp3neg)
```

Wilcox pairwise test

```{r}
pairwise.t.test(outcome_all_rad3_CD3_foxp3neg$delta_estimate, outcome_all_rad3_CD3_foxp3neg$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
ANOVA_delta_estimate_CD3_foxp3neg_Lcross <- ggboxplot(outcome_all_rad3_CD3_foxp3neg, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD3_foxp3neg at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.0005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.02) # + stat_pvalue_manual(pwc_delta_estimate_CD3_foxp3neg, hide.ns = TRUE, y.position = c(1.25))
ANOVA_delta_estimate_CD3_foxp3neg_Lcross
```

```{r}
pdf(file="ANOVA_delta_estimate_CD3_foxp3neg_Lcross.pdf", width = 7, height=4.5)
ANOVA_delta_estimate_CD3_foxp3neg_Lcross
dev.off()
```

##### Kaplan-meier
```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_foxp3neg), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_foxp3neg), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```

```{r}
outcome_all_rad3_CD3_foxp3neg_withoutprbc <- subset(outcome_all_rad3_CD3_foxp3neg, study_group %in% c("PPBCinv", "nonPrBC"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_foxp3neg_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_foxp3neg_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_foxp3neg), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_foxp3neg), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
```


#### CD3+ CD8-

##### ANOVA

```{r}
group_by(outcome_all_rad3_CD3_CD8neg, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```


Remove NA values
```{r}
outcome_all_rad3_CD3_CD8neg <- outcome_all_rad3_CD3_CD8neg[!is.na(outcome_all_rad3_CD3_CD8neg$delta_estimate),]

group_by(outcome_all_rad3_CD3_CD8neg, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
outcome_all_rad3_CD3_CD8neg$study_group <- gsub("non_prbc", "nonPrBC", outcome_all_rad3_CD3_CD8neg$study_group)
outcome_all_rad3_CD3_CD8neg$study_group <- gsub("ppbc_inv", "PPBCinv", outcome_all_rad3_CD3_CD8neg$study_group)
outcome_all_rad3_CD3_CD8neg$study_group <- gsub("ppbc_lac", "PPBClac", outcome_all_rad3_CD3_CD8neg$study_group)
outcome_all_rad3_CD3_CD8neg$study_group <- gsub("prbc", "PrBC", outcome_all_rad3_CD3_CD8neg$study_group)

outcome_all_rad3_CD3_CD8neg$study_group <- ordered(outcome_all_rad3_CD3_CD8neg$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(outcome_all_rad3_CD3_CD8neg$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(outcome_all_rad3_CD3_CD8neg$delta_estimate)
```


```{r}
outcome_all_rad3_CD3_CD8neg %>% 
  group_by(study_group) %>%
  identify_outliers(delta_estimate)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.delta_estimate_CD3_CD8neg <- aov(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_CD8neg)
# summary of the analysis
summary(res.aov.delta_estimate_CD3_CD8neg)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.delta_estimate_CD3_CD8neg)
```

```{r}
pwc_delta_estimate_CD3_CD8neg <- outcome_all_rad3_CD3_CD8neg %>% tukey_hsd(delta_estimate ~ study_group)
pwc_delta_estimate_CD3_CD8neg
```


Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.delta_estimate_CD3_CD8neg, 1)
```


From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_CD8neg)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(outcome_all_rad3_CD3_CD8neg$delta_estimate, outcome_all_rad3_CD3_CD8neg$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.delta_estimate_CD3_CD8neg, 2)

model_delta_estimate_CD3_CD8neg <- lm(delta_estimate ~ study_group, data=outcome_all_rad3_CD3_CD8neg)
ggqqplot(residuals(model_delta_estimate_CD3_CD8neg))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_delta_estimate_CD3_CD8neg <- residuals(object = res.aov.delta_estimate_CD3_CD8neg)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_delta_estimate_CD3_CD8neg)
shapiro_test(residuals(model_delta_estimate_CD3_CD8neg))
```



Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_CD8neg)
```

Wilcox pairwise test

```{r}
pairwise.t.test(outcome_all_rad3_CD3_CD8neg$delta_estimate, outcome_all_rad3_CD3_CD8neg$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
ANOVA_delta_estimate_CD3_CD8neg_Lcross <- ggboxplot(outcome_all_rad3_CD3_CD8neg, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD3_CD8neg at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.0005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.03) # + stat_pvalue_manual(pwc_delta_estimate_CD3_CD8neg, hide.ns = TRUE, y.position = c(1.25))
ANOVA_delta_estimate_CD3_CD8neg_Lcross
```

```{r}
pdf(file="ANOVA_delta_estimate_CD3_CD8neg_Lcross.pdf", width = 7, height=4.5)
ANOVA_delta_estimate_CD3_CD8neg_Lcross
dev.off()
```


##### Kaplan-meier
```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_CD8neg), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+CD8- by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_CD8neg), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+CD8- by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```

```{r}
outcome_all_rad3_CD3_CD8neg_withoutprbc <- subset(outcome_all_rad3_CD3_CD8neg, study_group %in% c("PPBCinv", "nonPrBC"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_CD8neg_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_CD8neg_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_CD8neg), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD3+CD8- by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_CD8neg), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD3+CD8- by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
```

#### CD3+ CD8+

##### ANOVA

```{r}
group_by(outcome_all_rad3_CD3_CD8pos, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```


Remove NA values
```{r}
outcome_all_rad3_CD3_CD8pos <- outcome_all_rad3_CD3_CD8pos[!is.na(outcome_all_rad3_CD3_CD8pos$delta_estimate),]

group_by(outcome_all_rad3_CD3_CD8pos, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
outcome_all_rad3_CD3_CD8pos$study_group <- gsub("non_prbc", "nonPrBC", outcome_all_rad3_CD3_CD8pos$study_group)
outcome_all_rad3_CD3_CD8pos$study_group <- gsub("ppbc_inv", "PPBCinv", outcome_all_rad3_CD3_CD8pos$study_group)
outcome_all_rad3_CD3_CD8pos$study_group <- gsub("ppbc_lac", "PPBClac", outcome_all_rad3_CD3_CD8pos$study_group)
outcome_all_rad3_CD3_CD8pos$study_group <- gsub("prbc", "PrBC", outcome_all_rad3_CD3_CD8pos$study_group)

outcome_all_rad3_CD3_CD8pos$study_group <- ordered(outcome_all_rad3_CD3_CD8pos$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(outcome_all_rad3_CD3_CD8pos$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(outcome_all_rad3_CD3_CD8pos$delta_estimate)
```


```{r}
outcome_all_rad3_CD3_CD8pos %>% 
  group_by(study_group) %>%
  identify_outliers(delta_estimate)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.delta_estimate_CD3_CD8pos <- aov(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_CD8pos)
# summary of the analysis
summary(res.aov.delta_estimate_CD3_CD8pos)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.delta_estimate_CD3_CD8pos)
```

```{r}
pwc_delta_estimate_CD3_CD8pos <- outcome_all_rad3_CD3_CD8pos %>% tukey_hsd(delta_estimate ~ study_group)
pwc_delta_estimate_CD3_CD8pos
```


Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.delta_estimate_CD3_CD8pos, 1)
```


From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_CD8pos)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(outcome_all_rad3_CD3_CD8pos$delta_estimate, outcome_all_rad3_CD3_CD8pos$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.delta_estimate_CD3_CD8pos, 2)

model_delta_estimate_CD3_CD8pos <- lm(delta_estimate ~ study_group, data=outcome_all_rad3_CD3_CD8pos)
ggqqplot(residuals(model_delta_estimate_CD3_CD8pos))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_delta_estimate_CD3_CD8pos <- residuals(object = res.aov.delta_estimate_CD3_CD8pos)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_delta_estimate_CD3_CD8pos)
shapiro_test(residuals(model_delta_estimate_CD3_CD8pos))
```



Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD3_CD8pos)
```


Wilcox pairwise test

```{r}
pairwise.t.test(outcome_all_rad3_CD3_CD8pos$delta_estimate, outcome_all_rad3_CD3_CD8pos$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
ANOVA_delta_estimate_CD3_CD8pos_Lcross <- ggboxplot(outcome_all_rad3_CD3_CD8pos, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD3_CD8pos at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.0005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.025) # + stat_pvalue_manual(pwc_delta_estimate_CD3_CD8pos, hide.ns = TRUE, y.position = c(0.3))
ANOVA_delta_estimate_CD3_CD8pos_Lcross
```

```{r, fig.width=7, fig.height=4.5}
ANOVA_delta_estimate_CD3_CD8pos_Lcross <- ggboxplot(outcome_all_rad3_CD3_CD8pos, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD3_CD8pos at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.0005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.025) + ylim(-0.025,0.001)# + stat_pvalue_manual(pwc_delta_estimate_CD3_CD8pos, hide.ns = TRUE, y.position = c(0.3))
ANOVA_delta_estimate_CD3_CD8pos_Lcross
```


```{r}
pdf(file="ANOVA_delta_estimate_CD3_CD8pos_Lcross.pdf", width = 7, height=4.5)
ANOVA_delta_estimate_CD3_CD8pos_Lcross
dev.off()
```

##### kaplan-meier
```{r}
CD8_DE_OS_spatial_Lcross <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_CD8pos), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+CD8+ by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
CD8_DE_OS_spatial_Lcross

CD8_DE_DRS_spatial_Lcross <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_CD8pos), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+CD8+ by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
CD8_DE_DRS_spatial_Lcross
```

```{r}
pdf(file="CD8_DE_OS_spatial_Lcross.pdf", width = 7, height=5)
CD8_DE_OS_spatial_Lcross
dev.off()

pdf(file="CD8_DE_DRS_spatial_Lcross.pdf", width = 7, height=5)
CD8_DE_DRS_spatial_Lcross
dev.off()
```

```{r}
outcome_all_rad3_CD3_CD8pos_withoutprbc <- subset(outcome_all_rad3_CD3_CD8pos, study_group %in% c("PPBCinv", "nonPrBC"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_CD8pos_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_CD8pos_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3_CD8pos), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD3+CD8+ by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3_CD8pos), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD3+CD8+ by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
```


#### within study groups OS

subset data low IG signature versus high IG signature 

```{r}
outcome_all_rad3_CD3_CD8pos_low <- subset(outcome_all_rad3_CD3_CD8pos, median %in% c("FALSE"), )
outcome_all_rad3_CD3_CD8pos_high <- subset(outcome_all_rad3_CD3_CD8pos, median %in% c("TRUE"), )
```


Testing proportional hazards assumption -> zie file Kat: stratify for PAM50


```{r}
table(outcome_all_rad3_CD3_CD8pos_low$study_group)
table(outcome_all_rad3_CD3_CD8pos_high$study_group)
```



low CD8 cluster 

univariate 

```{r}
#univariate
cox_OS_CD8low <- coxph(Surv(time_OS_months, death) ~ study_group, data = outcome_all_rad3_CD3_CD8pos_low)
summary(cox_OS_CD8low)
```


multivariate 

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    study_group, #+
    #strata(clin_subtype),
  data = outcome_all_rad3_CD3_CD8pos_low)
summary(clin.cov.cox)
```



```{r}
#with study study_group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~  stage + study_group, data = outcome_all_rad3_CD3_CD8pos_low)
study_strata
plot_OS_CD8low_multivariate <- ggadjustedcurves(study_strata, data=outcome_all_rad3_CD3_CD8pos_low, method="conditional", variable="study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_OS_CD8low_multivariate
```

```{r}
pdf(here("plot_OS_CD8low_multivariate.pdf"), width = 7, height = 5)
plot_OS_CD8low_multivariate
dev.off()
```

High CD8 cluster 

univariate 

```{r}
#univariate
cox_OS_CD8high <- coxph(Surv(time_OS_months, death) ~ study_group, data = outcome_all_rad3_CD3_CD8pos_high)
summary(cox_OS_CD8high)
```

multivariate


```{r}
#with study_group
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    study_group, #+
    #strata(clin_subtype),
  data = outcome_all_rad3_CD3_CD8pos_high)
summary(clin.cov.cox)
```

```{r}
#with study study_group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + study_group, data = outcome_all_rad3_CD3_CD8pos_high)
study_strata
plot_OS_CD8high_multivariate <- ggadjustedcurves(study_strata, data=outcome_all_rad3_CD3_CD8pos_high, method="conditional", variable="study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_OS_CD8high_multivariate
```




#### within study study_groups DRS

low CD8 cluster 

univariate 

```{r}
#univariate
cox_DRS_CD8low <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = outcome_all_rad3_CD3_CD8pos_low)
summary(cox_DRS_CD8low)
```


multivariate 


```{r}
table(outcome_all_rad3_CD3_CD8pos_low$study_group)
```



```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    study_group, #+
    #strata(clin_subtype),
  data = outcome_all_rad3_CD3_CD8pos_low)
summary(clin.cov.cox)
```



```{r}
#with study study_group as covariate 
study_strata <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~  stage + study_group, data = outcome_all_rad3_CD3_CD8pos_low)
study_strata
plot_DRS_CD8low_multivariate <- ggadjustedcurves(study_strata, data=outcome_all_rad3_CD3_CD8pos_low, method="conditional", variable="study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_DRS_CD8low_multivariate
```


High CD8 cluster 

univariate 

```{r}
#univariate
cox_DRS_CD8high <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = outcome_all_rad3_CD3_CD8pos_high)
summary(cox_DRS_CD8high)
```

multivariate



```{r}
#with study_group
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    study_group, #+
    #strata(clin_subtype),
  data = outcome_all_rad3_CD3_CD8pos_high)
summary(clin.cov.cox)
```

```{r}
#with study study_group as covariate 
study_strata <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage + study_group, data = outcome_all_rad3_CD3_CD8pos_high)
study_strata
plot_DRS_CD8high_multivariate <- ggadjustedcurves(study_strata, data=outcome_all_rad3_CD3_CD8pos_high, method="conditional", variable="study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_DRS_CD8high_multivariate
```



#### FoxP3+


##### ANOVA

```{r}
group_by(outcome_all_rad3_foxp3, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```


Remove NA values
```{r}
outcome_all_rad3_foxp3 <- outcome_all_rad3_foxp3[!is.na(outcome_all_rad3_foxp3$delta_estimate),]

group_by(outcome_all_rad3_foxp3, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
outcome_all_rad3_foxp3$study_group <- gsub("non_prbc", "nonPrBC", outcome_all_rad3_foxp3$study_group)
outcome_all_rad3_foxp3$study_group <- gsub("ppbc_inv", "PPBCinv", outcome_all_rad3_foxp3$study_group)
outcome_all_rad3_foxp3$study_group <- gsub("ppbc_lac", "PPBClac", outcome_all_rad3_foxp3$study_group)
outcome_all_rad3_foxp3$study_group <- gsub("prbc", "PrBC", outcome_all_rad3_foxp3$study_group)

outcome_all_rad3_foxp3$study_group <- ordered(outcome_all_rad3_foxp3$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(outcome_all_rad3_foxp3$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(outcome_all_rad3_foxp3$delta_estimate)
```


```{r}
outcome_all_rad3_foxp3 %>% 
  group_by(study_group) %>%
  identify_outliers(delta_estimate)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.delta_estimate_foxp3 <- aov(delta_estimate ~ study_group, data = outcome_all_rad3_foxp3)
# summary of the analysis
summary(res.aov.delta_estimate_foxp3)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.delta_estimate_foxp3)
```

```{r}
pwc_delta_estimate_foxp3 <- outcome_all_rad3_foxp3 %>% tukey_hsd(delta_estimate ~ study_group)
pwc_delta_estimate_foxp3
```


Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.delta_estimate_foxp3, 1)
```


From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(delta_estimate ~ study_group, data = outcome_all_rad3_foxp3)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(outcome_all_rad3_foxp3$delta_estimate, outcome_all_rad3_foxp3$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.delta_estimate_foxp3, 2)

model_delta_estimate_foxp3 <- lm(delta_estimate ~ study_group, data=outcome_all_rad3_foxp3)
ggqqplot(residuals(model_delta_estimate_foxp3))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_delta_estimate_foxp3 <- residuals(object = res.aov.delta_estimate_foxp3)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_delta_estimate_foxp3)
shapiro_test(residuals(model_delta_estimate_foxp3))
```



Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(delta_estimate ~ study_group, data = outcome_all_rad3_foxp3)
```

Wilcox pairwise test

```{r}
pairwise.t.test(outcome_all_rad3_foxp3$delta_estimate, outcome_all_rad3_foxp3$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
ANOVA_delta_estimate_foxp3_Lcross <- ggboxplot(outcome_all_rad3_foxp3, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_foxp3 at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.0005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.05) # + stat_pvalue_manual(pwc_delta_estimate_foxp3, hide.ns = TRUE, y.position = c(1.25))
ANOVA_delta_estimate_foxp3_Lcross
```

```{r}
pdf(file="ANOVA_delta_estimate_foxp3_Lcross.pdf", width = 7, height=4.5)
ANOVA_delta_estimate_foxp3_Lcross
dev.off()
```



##### kalpan-meier
```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_foxp3), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - FoxP3 by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_foxp3), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - FoxP3 by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```

```{r}
outcome_all_rad3_foxp3_withoutprbc <- subset(outcome_all_rad3_foxp3, study_group %in% c("PPBCinv", "nonPrBC"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_foxp3_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_foxp3_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_foxp3), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - FoxP3 by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_foxp3), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - FoxP3 by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
```


### univariate 

CD20
```{r}
cox_OS_L_CD20 <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_all_rad3_CD20)
summary(cox_OS_L_CD20)

cox_OS_L_CD20_inv <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_inv_rad3_CD20)
summary(cox_OS_L_CD20_inv)

cox_OS_L_CD20_np <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_np_rad3_CD20)
summary(cox_OS_L_CD20_np)

cox_OS_L_CD20_pr <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_pr_rad3_CD20)
summary(cox_OS_L_CD20_pr)
```




CD3+ FoxP3-
```{r}
cox_OS_L_CD3_foxp3neg <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_all_rad3_CD3_foxp3neg)
summary(cox_OS_L_CD3_foxp3neg)

cox_OS_L_CD3_foxp3neg_inv <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_inv_rad3_CD3_foxp3neg)
summary(cox_OS_L_CD3_foxp3neg_inv)

cox_OS_L_CD3_foxp3neg_np <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_np_rad3_CD3_foxp3neg)
summary(cox_OS_L_CD3_foxp3neg_np)

cox_OS_L_CD3_foxp3neg_pr <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_pr_rad3_CD3_foxp3neg)
summary(cox_OS_L_CD3_foxp3neg_pr)
```


CD3+ CD8-
```{r}
cox_OS_L_CD3_CD8neg <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_all_rad3_CD3_CD8neg)
summary(cox_OS_L_CD3_CD8neg)

cox_OS_L_CD3_CD8neg_inv <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_inv_rad3_CD3_CD8neg)
summary(cox_OS_L_CD3_CD8neg_inv)

cox_OS_L_CD3_CD8neg_np <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_np_rad3_CD3_CD8neg)
summary(cox_OS_L_CD3_CD8neg_np)

cox_OS_L_CD3_CD8neg_pr <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_pr_rad3_CD3_CD8neg)
summary(cox_OS_L_CD3_CD8neg_pr)
```


CD3+ CD8+
```{r}
cox_OS_L_CD3_CD8pos <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_all_rad3_CD3_CD8pos)
summary(cox_OS_L_CD3_CD8pos)

cox_OS_L_CD3_CD8pos_inv <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_inv_rad3_CD3_CD8pos)
summary(cox_OS_L_CD3_CD8pos_inv)

cox_OS_L_CD3_CD8pos_np <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_np_rad3_CD3_CD8pos)
summary(cox_OS_L_CD3_CD8pos_np)

cox_OS_L_CD3_CD8pos_pr <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_pr_rad3_CD3_CD8pos)
summary(cox_OS_L_CD3_CD8pos_pr)
```


FoxP3+
```{r}
cox_OS_L_foxp3 <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_all_rad3_foxp3)
summary(cox_OS_L_foxp3)

cox_OS_L_foxp3_inv <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_inv_rad3_foxp3)
summary(cox_OS_L_foxp3_inv)

cox_OS_L_foxp3_np <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_np_rad3_foxp3)
summary(cox_OS_L_foxp3_np)

cox_OS_L_foxp3_pr <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_pr_rad3_foxp3)
summary(cox_OS_L_foxp3_pr)
```



### multiavariate 

CD20
```{r}
#multivariate
multicox_OS_CD20 <- coxph(Surv(time_OS_months, death) ~ study_group + median + stage, data = outcome_all_rad3_CD20)
summary(multicox_OS_CD20)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group +
    stage +
    median,
  data = outcome_all_rad3_CD20)
summary(clin.cov.cox)
```

```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + strata(median), data = outcome_all_rad3_CD20)
study_strata
ggadjustedcurves(study_strata, data=outcome_all_rad3_CD20, method="conditional", variable="study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```






CD3+ FoxP3-
```{r}
#multivariate
multicox_OS_CD3_foxp3neg <- coxph(Surv(time_OS_months, death) ~ study_group + median + stage, data = outcome_all_rad3_CD3_foxp3neg)
summary(multicox_OS_CD3_foxp3neg)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group +
    stage +
    median,
  data = outcome_all_rad3_CD3_foxp3neg)
summary(clin.cov.cox)
```

```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + strata(median), data = outcome_all_rad3_CD3_foxp3neg)
study_strata
ggadjustedcurves(study_strata, data=outcome_all_rad3_CD3_foxp3neg, method="conditional", variable="median", palette = c("#a10702", "#ffb600")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```


CD3+CD8-
```{r}
#multivariate
multicox_OS_CD3_CD8neg <- coxph(Surv(time_OS_months, death) ~ study_group + median + stage, data = outcome_all_rad3_CD3_CD8neg)
summary(multicox_OS_CD3_CD8neg)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group +
    stage +
    median,
  data = outcome_all_rad3_CD3_CD8neg)
summary(clin.cov.cox)
```

```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + strata(median), data = outcome_all_rad3_CD3_CD8neg)
study_strata
ggadjustedcurves(study_strata, data=outcome_all_rad3_CD3_CD8neg, method="conditional", variable="median", palette = c("#a10702", "#ffb600")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```


CD3_CD8pos
```{r}
#multivariate
multicox_OS_CD3_CD8pos <- coxph(Surv(time_OS_months, death) ~ study_group + median + stage, data = outcome_all_rad3_CD3_CD8pos)
summary(multicox_OS_CD3_CD8pos)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group +
    stage +
    median,
  data = outcome_all_rad3_CD3_CD8pos)
summary(clin.cov.cox)
```

```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + strata(median), data = outcome_all_rad3_CD3_CD8pos)
study_strata
ggadjustedcurves(study_strata, data=outcome_all_rad3_CD3_CD8pos, method="conditional", variable="median", palette = c("#a10702", "#ffb600")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```


foxp3
```{r}
#multivariate
multicox_OS_foxp3 <- coxph(Surv(time_OS_months, death) ~ study_group + median + stage, data = outcome_all_rad3_foxp3)
summary(multicox_OS_foxp3)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group +
    stage +
    median,
  data = outcome_all_rad3_foxp3)
summary(clin.cov.cox)
```

```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + strata(median), data = outcome_all_rad3_foxp3)
study_strata
ggadjustedcurves(study_strata, data=outcome_all_rad3_foxp3, method="conditional", variable="median", palette = c("#a10702", "#ffb600")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```



# Lcross-immune - different immune cell subset


```{r}
outcome_all_rad3_CD20_CD3CD8pos <- subset(outcome_all_rad3, cell_types %in% c("CD20+/CD3+CD8+"), )
outcome_inv_rad3_CD20_CD3CD8pos <- subset(outcome_inv_rad3, cell_types %in% c("CD20+/CD3+CD8+"), )
outcome_np_rad3_CD20_CD3CD8pos <- subset(outcome_np_rad3, cell_types %in% c("CD20+/CD3+CD8+"), )
outcome_pr_rad3_CD20_CD3CD8pos <- subset(outcome_pr_rad3, cell_types %in% c("CD20+/CD3+CD8+"), )
```

```{r}
outcome_all_rad3_CD3CD8pos_CD20 <- subset(outcome_all_rad3, cell_types %in% c("CD3+CD8+/CD20+"), )
outcome_inv_rad3_CD3CD8pos_CD20 <- subset(outcome_inv_rad3, cell_types %in% c("CD3+CD8+/CD20+"), )
outcome_np_rad3_CD3CD8pos_CD20 <- subset(outcome_np_rad3, cell_types %in% c("CD3+CD8+/CD20+"), )
outcome_pr_rad3_CD3CD8pos_CD20 <- subset(outcome_pr_rad3, cell_types %in% c("CD3+CD8+/CD20+"), )
```


```{r}
outcome_all_rad3_CD20_CD3CD8neg <- subset(outcome_all_rad3, cell_types %in% c("CD20+/CD3+CD8-"), )
outcome_inv_rad3_CD20_CD3CD8neg <- subset(outcome_inv_rad3, cell_types %in% c("CD20+/CD3+CD8-"), )
outcome_np_rad3_CD20_CD3CD8neg <- subset(outcome_np_rad3, cell_types %in% c("CD20+/CD3+CD8-"), )
outcome_pr_rad3_CD20_CD3CD8neg <- subset(outcome_pr_rad3, cell_types %in% c("CD20+/CD3+CD8-"), )
```

```{r}
outcome_all_rad3_CD3CD8neg_CD20 <- subset(outcome_all_rad3, cell_types %in% c("CD3+CD8-/CD20+"), )
outcome_inv_rad3_CD3CD8neg_CD20 <- subset(outcome_inv_rad3, cell_types %in% c("CD3+CD8-/CD20+"), )
outcome_np_rad3_CD3CD8neg_CD20 <- subset(outcome_np_rad3, cell_types %in% c("CD3+CD8-/CD20+"), )
outcome_pr_rad3_CD3CD8neg_CD20 <- subset(outcome_pr_rad3, cell_types %in% c("CD3+CD8-/CD20+"), )
```



```{r}
outcome_all_rad3_CD8neg_CD8pos <- subset(outcome_all_rad3, cell_types %in% c("CD3+CD8-/CD3+CD8+"), )
outcome_inv_rad3_CD8neg_CD8pos <- subset(outcome_inv_rad3, cell_types %in% c("CD3+CD8-/CD3+CD8+"), )
outcome_np_rad3_CD8neg_CD8pos <- subset(outcome_np_rad3, cell_types %in% c("CD3+CD8-/CD3+CD8+"), )
outcome_pr_rad3_CD8neg_CD8pos <- subset(outcome_pr_rad3, cell_types %in% c("CD3+CD8-/CD3+CD8+"), )
```

```{r}
outcome_all_rad3_CD8pos_CD8neg <- subset(outcome_all_rad3, cell_types %in% c("CD3+CD8+/CD3+CD8-"), )
outcome_inv_rad3_CD8pos_CD8neg <- subset(outcome_inv_rad3, cell_types %in% c("CD3+CD8+/CD3+CD8-"), )
outcome_np_rad3_CD8pos_CD8neg <- subset(outcome_np_rad3, cell_types %in% c("CD3+CD8+/CD3+CD8-"), )
outcome_pr_rad3_CD8pos_CD8neg <- subset(outcome_pr_rad3, cell_types %in% c("CD3+CD8+/CD3+CD8-"), )
```



create variable that subsets data into above or below the median:

FALSE = under the median 
TRUE = above the median 

```{r}
outcome_all_rad3_CD20_CD3CD8pos$median <- outcome_all_rad3_CD20_CD3CD8pos$delta_estimate > median(outcome_all_rad3_CD20_CD3CD8pos$delta_estimate, na.rm=T)
outcome_all_rad3_CD3CD8pos_CD20$median <- outcome_all_rad3_CD3CD8pos_CD20$delta_estimate > median(outcome_all_rad3_CD3CD8pos_CD20$delta_estimate, na.rm=T)
outcome_all_rad3_CD20_CD3CD8neg$median <- outcome_all_rad3_CD20_CD3CD8neg$delta_estimate > median(outcome_all_rad3_CD20_CD3CD8neg$delta_estimate, na.rm=T)
outcome_all_rad3_CD3CD8neg_CD20$median <- outcome_all_rad3_CD3CD8neg_CD20$delta_estimate > median(outcome_all_rad3_CD3CD8neg_CD20$delta_estimate, na.rm=T)
outcome_all_rad3_CD8neg_CD8pos$median <- outcome_all_rad3_CD8neg_CD8pos$delta_estimate > median(outcome_all_rad3_CD8neg_CD8pos$delta_estimate, na.rm=T)
outcome_all_rad3_CD8pos_CD8neg$median <- outcome_all_rad3_CD8pos_CD8neg$delta_estimate > median(outcome_all_rad3_CD8pos_CD8neg$delta_estimate, na.rm=T)

outcome_inv_rad3_CD20_CD3CD8pos$median <- outcome_inv_rad3_CD20_CD3CD8pos$delta_estimate > median(outcome_inv_rad3_CD20_CD3CD8pos$delta_estimate, na.rm=T)
outcome_inv_rad3_CD3CD8pos_CD20$median <- outcome_inv_rad3_CD3CD8pos_CD20$delta_estimate > median(outcome_inv_rad3_CD3CD8pos_CD20$delta_estimate, na.rm=T)
outcome_inv_rad3_CD20_CD3CD8neg$median <- outcome_inv_rad3_CD20_CD3CD8neg$delta_estimate > median(outcome_inv_rad3_CD20_CD3CD8neg$delta_estimate, na.rm=T)
outcome_inv_rad3_CD3CD8neg_CD20$median <- outcome_inv_rad3_CD3CD8neg_CD20$delta_estimate > median(outcome_inv_rad3_CD3CD8neg_CD20$delta_estimate, na.rm=T)
outcome_inv_rad3_CD8neg_CD8pos$median <- outcome_inv_rad3_CD8neg_CD8pos$delta_estimate > median(outcome_inv_rad3_CD8neg_CD8pos$delta_estimate, na.rm=T)
outcome_inv_rad3_CD8pos_CD8neg$median <- outcome_inv_rad3_CD8pos_CD8neg$delta_estimate > median(outcome_inv_rad3_CD8pos_CD8neg$delta_estimate, na.rm=T)

outcome_pr_rad3_CD20_CD3CD8pos$median <- outcome_pr_rad3_CD20_CD3CD8pos$delta_estimate > median(outcome_pr_rad3_CD20_CD3CD8pos$delta_estimate, na.rm=T)
outcome_pr_rad3_CD3CD8pos_CD20$median <- outcome_pr_rad3_CD3CD8pos_CD20$delta_estimate > median(outcome_pr_rad3_CD3CD8pos_CD20$delta_estimate, na.rm=T)
outcome_pr_rad3_CD3CD8pos_CD20$median <- outcome_pr_rad3_CD3CD8pos_CD20$delta_estimate > median(outcome_pr_rad3_CD3CD8pos_CD20$delta_estimate, na.rm=T)
outcome_pr_rad3_CD3CD8neg_CD20$median <- outcome_pr_rad3_CD3CD8neg_CD20$delta_estimate > median(outcome_pr_rad3_CD3CD8neg_CD20$delta_estimate, na.rm=T)
outcome_pr_rad3_CD8neg_CD8pos$median <- outcome_pr_rad3_CD8neg_CD8pos$delta_estimate > median(outcome_pr_rad3_CD8neg_CD8pos$delta_estimate, na.rm=T)
outcome_pr_rad3_CD8pos_CD8neg$median <- outcome_pr_rad3_CD8pos_CD8neg$delta_estimate > median(outcome_pr_rad3_CD8pos_CD8neg$delta_estimate, na.rm=T)

outcome_np_rad3_CD20_CD3CD8pos$median <- outcome_np_rad3_CD20_CD3CD8pos$delta_estimate > median(outcome_np_rad3_CD20_CD3CD8pos$delta_estimate, na.rm=T)
outcome_np_rad3_CD3CD8pos_CD20$median <- outcome_np_rad3_CD3CD8pos_CD20$delta_estimate > median(outcome_np_rad3_CD3CD8pos_CD20$delta_estimate, na.rm=T)
outcome_np_rad3_CD20_CD3CD8neg$median <- outcome_np_rad3_CD20_CD3CD8neg$delta_estimate > median(outcome_np_rad3_CD20_CD3CD8neg$delta_estimate, na.rm=T)
outcome_np_rad3_CD3CD8neg_CD20$median <- outcome_np_rad3_CD3CD8neg_CD20$delta_estimate > median(outcome_np_rad3_CD3CD8neg_CD20$delta_estimate, na.rm=T)
outcome_np_rad3_CD8neg_CD8pos$median <- outcome_np_rad3_CD8neg_CD8pos$delta_estimate > median(outcome_np_rad3_CD8neg_CD8pos$delta_estimate, na.rm=T)
outcome_np_rad3_CD8pos_CD8neg$median <- outcome_np_rad3_CD8pos_CD8neg$delta_estimate > median(outcome_np_rad3_CD8pos_CD8neg$delta_estimate, na.rm=T)
```



Make data frames 

```{r}
outcome_all_rad3_CD20_CD3CD8pos <- as.data.frame(outcome_all_rad3_CD20_CD3CD8pos)
outcome_all_rad3_CD3CD8pos_CD20 <- as.data.frame(outcome_all_rad3_CD3CD8pos_CD20)
outcome_all_rad3_CD20_CD3CD8neg <- as.data.frame(outcome_all_rad3_CD20_CD3CD8neg)
outcome_all_rad3_CD3CD8neg_CD20 <- as.data.frame(outcome_all_rad3_CD3CD8neg_CD20)
outcome_all_rad3_CD8neg_CD8pos <- as.data.frame(outcome_all_rad3_CD8neg_CD8pos)
outcome_all_rad3_CD8pos_CD8neg <- as.data.frame(outcome_all_rad3_CD8pos_CD8neg)

outcome_inv_rad3_CD20_CD3CD8pos <- as.data.frame(outcome_inv_rad3_CD20_CD3CD8pos)
outcome_inv_rad3_CD3CD8pos_CD20 <- as.data.frame(outcome_inv_rad3_CD3CD8pos_CD20)
outcome_inv_rad3_CD20_CD3CD8neg <- as.data.frame(outcome_inv_rad3_CD20_CD3CD8neg)
outcome_inv_rad3_CD3CD8neg_CD20 <- as.data.frame(outcome_inv_rad3_CD3CD8neg_CD20)
outcome_inv_rad3_CD8neg_CD8pos <- as.data.frame(outcome_inv_rad3_CD8neg_CD8pos)
outcome_inv_rad3_CD8pos_CD8neg <- as.data.frame(outcome_inv_rad3_CD8pos_CD8neg)

outcome_pr_rad3_CD20_CD3CD8pos <- as.data.frame(outcome_pr_rad3_CD20_CD3CD8pos)
outcome_pr_rad3_CD3CD8pos_CD20 <- as.data.frame(outcome_pr_rad3_CD3CD8pos_CD20)
outcome_pr_rad3_CD20_CD3CD8neg <- as.data.frame(outcome_pr_rad3_CD20_CD3CD8neg)
outcome_pr_rad3_CD3CD8neg_CD20 <- as.data.frame(outcome_pr_rad3_CD3CD8neg_CD20)
outcome_pr_rad3_CD8neg_CD8pos <- as.data.frame(outcome_pr_rad3_CD8neg_CD8pos)
outcome_pr_rad3_CD8pos_CD8neg <- as.data.frame(outcome_pr_rad3_CD8pos_CD8neg)

outcome_np_rad3_CD20_CD3CD8pos <- as.data.frame(outcome_np_rad3_CD20_CD3CD8pos)
outcome_np_rad3_CD3CD8pos_CD20 <- as.data.frame(outcome_np_rad3_CD3CD8pos_CD20)
outcome_np_rad3_CD20_CD3CD8neg <- as.data.frame(outcome_np_rad3_CD20_CD3CD8neg)
outcome_np_rad3_CD3CD8neg_CD20 <- as.data.frame(outcome_np_rad3_CD3CD8neg_CD20)
outcome_np_rad3_CD8neg_CD8pos <- as.data.frame(outcome_np_rad3_CD8neg_CD8pos)
outcome_np_rad3_CD8pos_CD8neg <- as.data.frame(outcome_np_rad3_CD8pos_CD8neg)
```


Median FALSE = below median delta_estimate 
Median TRUE = above median delta_estimate


#### CD20+/CD3+CD8+

##### ANOVA

```{r}
group_by(outcome_all_rad3_CD20_CD3CD8pos, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```


Remove NA values
```{r}
outcome_all_rad3_CD20_CD3CD8pos <- outcome_all_rad3_CD20_CD3CD8pos[!is.na(outcome_all_rad3_CD20_CD3CD8pos$delta_estimate),]

group_by(outcome_all_rad3_CD20_CD3CD8pos, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
outcome_all_rad3_CD20_CD3CD8pos$study_group <- gsub("non_prbc", "nonPrBC", outcome_all_rad3_CD20_CD3CD8pos$study_group)
outcome_all_rad3_CD20_CD3CD8pos$study_group <- gsub("ppbc_inv", "PPBCinv", outcome_all_rad3_CD20_CD3CD8pos$study_group)
outcome_all_rad3_CD20_CD3CD8pos$study_group <- gsub("ppbc_lac", "PPBClac", outcome_all_rad3_CD20_CD3CD8pos$study_group)
outcome_all_rad3_CD20_CD3CD8pos$study_group <- gsub("prbc", "PrBC", outcome_all_rad3_CD20_CD3CD8pos$study_group)

outcome_all_rad3_CD20_CD3CD8pos$study_group <- ordered(outcome_all_rad3_CD20_CD3CD8pos$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(outcome_all_rad3_CD20_CD3CD8pos$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(outcome_all_rad3_CD20_CD3CD8pos$delta_estimate)
```


```{r}
outcome_all_rad3_CD20_CD3CD8pos %>% 
  group_by(study_group) %>%
  identify_outliers(delta_estimate)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.delta_estimate_CD20_CD3CD8pos <- aov(delta_estimate ~ study_group, data = outcome_all_rad3_CD20_CD3CD8pos)
# summary of the analysis
summary(res.aov.delta_estimate_CD20_CD3CD8pos)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.delta_estimate_CD20_CD3CD8pos)
```

```{r}
pwc_delta_estimate_CD20_CD3CD8pos <- outcome_all_rad3_CD20_CD3CD8pos %>% tukey_hsd(delta_estimate ~ study_group)
pwc_delta_estimate_CD20_CD3CD8pos
```



Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.delta_estimate_CD20_CD3CD8pos, 1)
```


From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD20_CD3CD8pos)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(outcome_all_rad3_CD20_CD3CD8pos$delta_estimate, outcome_all_rad3_CD20_CD3CD8pos$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.delta_estimate_CD20_CD3CD8pos, 2)

model_delta_estimate_CD20_CD3CD8pos <- lm(delta_estimate ~ study_group, data=outcome_all_rad3_CD20_CD3CD8pos)
ggqqplot(residuals(model_delta_estimate_CD20_CD3CD8pos))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_delta_estimate_CD20_CD3CD8pos <- residuals(object = res.aov.delta_estimate_CD20_CD3CD8pos)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_delta_estimate_CD20_CD3CD8pos)
shapiro_test(residuals(model_delta_estimate_CD20_CD3CD8pos))
```



Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD20_CD3CD8pos)
```

Wilcox pairwise test

```{r}
pairwise.t.test(outcome_all_rad3_CD20_CD3CD8pos$delta_estimate, outcome_all_rad3_CD20_CD3CD8pos$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
Lcorssimmune_CD20_CD3CD8pos <- ggboxplot(outcome_all_rad3_CD20_CD3CD8pos, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD20_CD3CD8pos at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.0005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.2)# + stat_pvalue_manual(pwc_delta_estimate_CD20_CD3CD8pos, hide.ns = TRUE, y.position = c(0.15))
Lcorssimmune_CD20_CD3CD8pos
```


```{r, fig.width=7, fig.height=4.5}
Lcorssimmune_CD20_CD3CD8pos <- ggboxplot(outcome_all_rad3_CD20_CD3CD8pos, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD20_CD3CD8pos at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.002, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.2) + ylim(0,0.1)# + stat_pvalue_manual(pwc_delta_estimate_CD20_CD3CD8pos, hide.ns = TRUE, y.position = c(0.15))
Lcorssimmune_CD20_CD3CD8pos
```

```{r}
pdf(file="Lcorssimmune_CD20_CD3CD8pos.pdf", width = 7, height=4.5)
Lcorssimmune_CD20_CD3CD8pos
dev.off()
```

##### Kaplan-meier

```{r}
Lanalysis_OS_CD20_CD3CD8pos_studygroup <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD20_CD3CD8pos), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD20_CD3CD8pos by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
Lanalysis_OS_CD20_CD3CD8pos_studygroup

Lanalysis_DRS_CD20_CD3CD8pos_studygroup <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD20_CD3CD8pos), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD20_CD3CD8pos by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
Lanalysis_DRS_CD20_CD3CD8pos_studygroup
```

```{r}
pdf(file="Lanalysis_OS_CD20_CD3CD8pos_studygroup.pdf", width = 7, height=4.5)
Lanalysis_OS_CD20_CD3CD8pos_studygroup
dev.off()

pdf(file="Lanalysis_DRS_CD20_CD3CD8pos_studygroup.pdf", width = 7, height=4.5)
Lanalysis_DRS_CD20_CD3CD8pos_studygroup
dev.off()
```

```{r}
outcome_all_rad3_CD20_CD3CD8pos_withoutprbc <- subset(outcome_all_rad3_CD20_CD3CD8pos, study_group %in% c("PPBCinv", "nonPrBC"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD20_CD3CD8pos_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD20_CD3CD8pos_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```


```{r}
Lanalysis_OS_CD20_CD3CD8pos_median <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD20_CD3CD8pos), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD20_CD3CD8pos by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
Lanalysis_OS_CD20_CD3CD8pos_median

Lanalysis_DRS_CD20_CD3CD8pos_median <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD20_CD3CD8pos), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD20_CD3CD8pos by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
Lanalysis_DRS_CD20_CD3CD8pos_median
```

```{r}
pdf(file="Lanalysis_OS_CD20_CD3CD8pos_median.pdf", width = 7, height=4.5)
Lanalysis_OS_CD20_CD3CD8pos_median
dev.off()

pdf(file="Lanalysis_DRS_CD20_CD3CD8pos_median.pdf", width = 7, height=4.5)
Lanalysis_DRS_CD20_CD3CD8pos_median
dev.off()
```




#### CD3+CD8+/CD20+

##### ANOVA

```{r}
group_by(outcome_all_rad3_CD3CD8pos_CD20, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```


Remove NA values
```{r}
outcome_all_rad3_CD3CD8pos_CD20 <- outcome_all_rad3_CD3CD8pos_CD20[!is.na(outcome_all_rad3_CD3CD8pos_CD20$delta_estimate),]

group_by(outcome_all_rad3_CD3CD8pos_CD20, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
outcome_all_rad3_CD3CD8pos_CD20$study_group <- gsub("non_prbc", "nonPrBC", outcome_all_rad3_CD3CD8pos_CD20$study_group)
outcome_all_rad3_CD3CD8pos_CD20$study_group <- gsub("ppbc_inv", "PPBCinv", outcome_all_rad3_CD3CD8pos_CD20$study_group)
outcome_all_rad3_CD3CD8pos_CD20$study_group <- gsub("ppbc_lac", "PPBClac", outcome_all_rad3_CD3CD8pos_CD20$study_group)
outcome_all_rad3_CD3CD8pos_CD20$study_group <- gsub("prbc", "PrBC", outcome_all_rad3_CD3CD8pos_CD20$study_group)

outcome_all_rad3_CD3CD8pos_CD20$study_group <- ordered(outcome_all_rad3_CD3CD8pos_CD20$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(outcome_all_rad3_CD3CD8pos_CD20$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(outcome_all_rad3_CD3CD8pos_CD20$delta_estimate)
```


```{r}
outcome_all_rad3_CD3CD8pos_CD20 %>% 
  group_by(study_group) %>%
  identify_outliers(delta_estimate)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.delta_estimate_CD3CD8pos_CD20 <- aov(delta_estimate ~ study_group, data = outcome_all_rad3_CD3CD8pos_CD20)
# summary of the analysis
summary(res.aov.delta_estimate_CD3CD8pos_CD20)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.delta_estimate_CD3CD8pos_CD20)
```

```{r}
pwc_delta_estimate_CD3CD8pos_CD20 <- outcome_all_rad3_CD3CD8pos_CD20 %>% tukey_hsd(delta_estimate ~ study_group)
pwc_delta_estimate_CD3CD8pos_CD20
```


Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.delta_estimate_CD3CD8pos_CD20, 1)
```


From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD3CD8pos_CD20)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(outcome_all_rad3_CD3CD8pos_CD20$delta_estimate, outcome_all_rad3_CD3CD8pos_CD20$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.delta_estimate_CD3CD8pos_CD20, 2)

model_delta_estimate_CD3CD8pos_CD20 <- lm(delta_estimate ~ study_group, data=outcome_all_rad3_CD3CD8pos_CD20)
ggqqplot(residuals(model_delta_estimate_CD3CD8pos_CD20))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_delta_estimate_CD3CD8pos_CD20 <- residuals(object = res.aov.delta_estimate_CD3CD8pos_CD20)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_delta_estimate_CD3CD8pos_CD20)
shapiro_test(residuals(model_delta_estimate_CD3CD8pos_CD20))
```



Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD3CD8pos_CD20)
```


Wilcox pairwise test

```{r}
pairwise.t.test(outcome_all_rad3_CD3CD8pos_CD20$delta_estimate, outcome_all_rad3_CD3CD8pos_CD20$study_group,
                 p.adjust.method = "BH")
```





Visualization

```{r, fig.width=7, fig.height=4.5}
Lcorssimmune_CD3CD8pos_CD20 <- ggboxplot(outcome_all_rad3_CD3CD8pos_CD20, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD3CD8pos_CD20 at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.0005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.2) # + stat_pvalue_manual(pwc_delta_estimate_CD3CD8pos_CD20, hide.ns = TRUE, y.position = c(1.25))
Lcorssimmune_CD3CD8pos_CD20
```

```{r}
pdf(file="Lcorssimmune_CD3CD8pos_CD20.pdf", width = 7, height=4.5)
Lcorssimmune_CD3CD8pos_CD20
dev.off()
```

##### Kaplan-meier

```{r}
Lanalysis_OS_CD3CD8pos_CD20_studygroup <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3CD8pos_CD20), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD3CD8pos_CD20 by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
Lanalysis_OS_CD3CD8pos_CD20_studygroup

Lanalysis_DRS_CD3CD8pos_CD20_studygroup <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3CD8pos_CD20), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD3CD8pos_CD20 by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
Lanalysis_DRS_CD3CD8pos_CD20_studygroup
```

```{r}
pdf(file="Lanalysis_OS_CD3CD8pos_CD20_studygroup.pdf", width = 7, height=4.5)
Lanalysis_OS_CD3CD8pos_CD20_studygroup
dev.off()

pdf(file="Lanalysis_DRS_CD3CD8pos_CD20_studygroup.pdf", width = 7, height=4.5)
Lanalysis_DRS_CD3CD8pos_CD20_studygroup
dev.off()
```

```{r}
outcome_all_rad3_CD3CD8pos_CD20_withoutprbc <- subset(outcome_all_rad3_CD3CD8pos_CD20, study_group %in% c("PPBCinv", "nonPrBC"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3CD8pos_CD20_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3CD8pos_CD20_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```


```{r}
Lanalysis_OS_CD3CD8pos_CD20_median <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3CD8pos_CD20), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD3CD8pos_CD20 by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
Lanalysis_OS_CD3CD8pos_CD20_median

Lanalysis_DRS_CD3CD8pos_CD20_median <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3CD8pos_CD20), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD3CD8pos_CD20 by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
Lanalysis_DRS_CD3CD8pos_CD20_median
```

```{r}
pdf(file="Lanalysis_OS_CD3CD8pos_CD20_median.pdf", width = 7, height=4.5)
Lanalysis_OS_CD3CD8pos_CD20_median
dev.off()

pdf(file="Lanalysis_DRS_CD3CD8pos_CD20_median.pdf", width = 7, height=4.5)
Lanalysis_DRS_CD3CD8pos_CD20_median
dev.off()
```



#### CD20+/CD3+CD8-

##### ANOVA

```{r}
group_by(outcome_all_rad3_CD20_CD3CD8neg, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```


Remove NA values
```{r}
outcome_all_rad3_CD20_CD3CD8neg <- outcome_all_rad3_CD20_CD3CD8neg[!is.na(outcome_all_rad3_CD20_CD3CD8neg$delta_estimate),]

group_by(outcome_all_rad3_CD20_CD3CD8neg, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
outcome_all_rad3_CD20_CD3CD8neg$study_group <- gsub("non_prbc", "nonPrBC", outcome_all_rad3_CD20_CD3CD8neg$study_group)
outcome_all_rad3_CD20_CD3CD8neg$study_group <- gsub("ppbc_inv", "PPBCinv", outcome_all_rad3_CD20_CD3CD8neg$study_group)
outcome_all_rad3_CD20_CD3CD8neg$study_group <- gsub("ppbc_lac", "PPBClac", outcome_all_rad3_CD20_CD3CD8neg$study_group)
outcome_all_rad3_CD20_CD3CD8neg$study_group <- gsub("prbc", "PrBC", outcome_all_rad3_CD20_CD3CD8neg$study_group)

outcome_all_rad3_CD20_CD3CD8neg$study_group <- ordered(outcome_all_rad3_CD20_CD3CD8neg$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(outcome_all_rad3_CD20_CD3CD8neg$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(outcome_all_rad3_CD20_CD3CD8neg$delta_estimate)
```


```{r}
outcome_all_rad3_CD20_CD3CD8neg %>% 
  group_by(study_group) %>%
  identify_outliers(delta_estimate)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.delta_estimate_CD20_CD3CD8neg <- aov(delta_estimate ~ study_group, data = outcome_all_rad3_CD20_CD3CD8neg)
# summary of the analysis
summary(res.aov.delta_estimate_CD20_CD3CD8neg)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.delta_estimate_CD20_CD3CD8neg)
```

```{r}
pwc_delta_estimate_CD20_CD3CD8neg <- outcome_all_rad3_CD20_CD3CD8neg %>% tukey_hsd(delta_estimate ~ study_group)
pwc_delta_estimate_CD20_CD3CD8neg
```


Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.delta_estimate_CD20_CD3CD8neg, 1)
```


From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD20_CD3CD8neg)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(outcome_all_rad3_CD20_CD3CD8neg$delta_estimate, outcome_all_rad3_CD20_CD3CD8neg$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.delta_estimate_CD20_CD3CD8neg, 2)

model_delta_estimate_CD20_CD3CD8neg <- lm(delta_estimate ~ study_group, data=outcome_all_rad3_CD20_CD3CD8neg)
ggqqplot(residuals(model_delta_estimate_CD20_CD3CD8neg))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_delta_estimate_CD20_CD3CD8neg <- residuals(object = res.aov.delta_estimate_CD20_CD3CD8neg)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_delta_estimate_CD20_CD3CD8neg)
shapiro_test(residuals(model_delta_estimate_CD20_CD3CD8neg))
```



Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD20_CD3CD8neg)
```

Wilcox pairwise test

```{r}
pairwise.t.test(outcome_all_rad3_CD20_CD3CD8neg$delta_estimate, outcome_all_rad3_CD20_CD3CD8neg$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
Lcorssimmune_CD20_CD3CD8neg <- ggboxplot(outcome_all_rad3_CD20_CD3CD8neg, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD20_CD3CD8neg at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.0005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.35) # + stat_pvalue_manual(pwc_delta_estimate_CD20_CD3CD8neg, hide.ns = TRUE, y.position = c(0.4))
Lcorssimmune_CD20_CD3CD8neg
```

```{r, fig.width=7, fig.height=4.5}
Lcorssimmune_CD20_CD3CD8neg <- ggboxplot(outcome_all_rad3_CD20_CD3CD8neg, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD20_CD3CD8neg at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.002, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.35) + ylim(0,0.12) # + stat_pvalue_manual(pwc_delta_estimate_CD20_CD3CD8neg, hide.ns = TRUE, y.position = c(0.4))
Lcorssimmune_CD20_CD3CD8neg
```

```{r}
pdf(file="Lcorssimmune_CD20_CD3CD8neg.pdf", width = 7, height=4.5)
Lcorssimmune_CD20_CD3CD8neg
dev.off()
```

##### Kaplan-meier

```{r}
Lanalysis_OS_CD20_CD3CD8neg_studygroup <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD20_CD3CD8neg), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD20_CD3CD8neg by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
Lanalysis_OS_CD20_CD3CD8neg_studygroup

Lanalysis_DRS_CD20_CD3CD8neg_studygroup <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD20_CD3CD8neg), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD20_CD3CD8neg by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
Lanalysis_DRS_CD20_CD3CD8neg_studygroup
```

```{r}
pdf(file="Lanalysis_OS_CD20_CD3CD8neg_studygroup.pdf", width = 7, height=4.5)
Lanalysis_OS_CD20_CD3CD8neg_studygroup
dev.off()

pdf(file="Lanalysis_DRS_CD20_CD3CD8neg_studygroup.pdf", width = 7, height=4.5)
Lanalysis_DRS_CD20_CD3CD8neg_studygroup
dev.off()
```


```{r}
outcome_all_rad3_CD20_CD3CD8neg_withoutprbc <- subset(outcome_all_rad3_CD20_CD3CD8neg, study_group %in% c("PPBCinv", "nonPrBC"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD20_CD3CD8neg_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS -  CD20CD8+ by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD20_CD3CD8neg_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD20CD8+ by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```


```{r}
Lanalysis_OS_CD20_CD3CD8neg_median <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD20_CD3CD8neg), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD20_CD3CD8neg by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
Lanalysis_OS_CD20_CD3CD8neg_median

Lanalysis_DRS_CD20_CD3CD8neg_median <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD20_CD3CD8neg), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD20_CD3CD8neg by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
Lanalysis_DRS_CD20_CD3CD8neg_median
```

```{r}
pdf(file="Lanalysis_OS_CD20_CD3CD8neg_median.pdf", width = 7, height=4.5)
Lanalysis_OS_CD20_CD3CD8neg_median
dev.off()

pdf(file="Lanalysis_DRS_CD20_CD3CD8neg_median.pdf", width = 7, height=4.5)
Lanalysis_DRS_CD20_CD3CD8neg_median
dev.off()
```




#### CD3+CD8-/CD20+

##### ANOVA

```{r}
group_by(outcome_all_rad3_CD3CD8neg_CD20, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```


Remove NA values
```{r}
outcome_all_rad3_CD3CD8neg_CD20 <- outcome_all_rad3_CD3CD8neg_CD20[!is.na(outcome_all_rad3_CD3CD8neg_CD20$delta_estimate),]

group_by(outcome_all_rad3_CD3CD8neg_CD20, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
outcome_all_rad3_CD3CD8neg_CD20$study_group <- gsub("non_prbc", "nonPrBC", outcome_all_rad3_CD3CD8neg_CD20$study_group)
outcome_all_rad3_CD3CD8neg_CD20$study_group <- gsub("ppbc_inv", "PPBCinv", outcome_all_rad3_CD3CD8neg_CD20$study_group)
outcome_all_rad3_CD3CD8neg_CD20$study_group <- gsub("ppbc_lac", "PPBClac", outcome_all_rad3_CD3CD8neg_CD20$study_group)
outcome_all_rad3_CD3CD8neg_CD20$study_group <- gsub("prbc", "PrBC", outcome_all_rad3_CD3CD8neg_CD20$study_group)

outcome_all_rad3_CD3CD8neg_CD20$study_group <- ordered(outcome_all_rad3_CD3CD8neg_CD20$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(outcome_all_rad3_CD3CD8neg_CD20$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(outcome_all_rad3_CD3CD8neg_CD20$delta_estimate)
```


```{r}
outcome_all_rad3_CD3CD8neg_CD20 %>% 
  group_by(study_group) %>%
  identify_outliers(delta_estimate)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.delta_estimate_CD3CD8neg_CD20 <- aov(delta_estimate ~ study_group, data = outcome_all_rad3_CD3CD8neg_CD20)
# summary of the analysis
summary(res.aov.delta_estimate_CD3CD8neg_CD20)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.delta_estimate_CD3CD8neg_CD20)
```

```{r}
pwc_delta_estimate_CD3CD8neg_CD20 <- outcome_all_rad3_CD3CD8neg_CD20 %>% tukey_hsd(delta_estimate ~ study_group)
pwc_delta_estimate_CD3CD8neg_CD20
```



Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.delta_estimate_CD3CD8neg_CD20, 1)
```


From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD3CD8neg_CD20)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(outcome_all_rad3_CD3CD8neg_CD20$delta_estimate, outcome_all_rad3_CD3CD8neg_CD20$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.delta_estimate_CD3CD8neg_CD20, 2)

model_delta_estimate_CD3CD8neg_CD20 <- lm(delta_estimate ~ study_group, data=outcome_all_rad3_CD3CD8neg_CD20)
ggqqplot(residuals(model_delta_estimate_CD3CD8neg_CD20))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_delta_estimate_CD3CD8neg_CD20 <- residuals(object = res.aov.delta_estimate_CD3CD8neg_CD20)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_delta_estimate_CD3CD8neg_CD20)
shapiro_test(residuals(model_delta_estimate_CD3CD8neg_CD20))
```



Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD3CD8neg_CD20)
```

Wilcox pairwise test

```{r}
pairwise.t.test(outcome_all_rad3_CD3CD8neg_CD20$delta_estimate, outcome_all_rad3_CD3CD8neg_CD20$study_group,
                 p.adjust.method = "BH")
```




Visualization

```{r, fig.width=7, fig.height=4.5}
Lcorssimmune_CD3CD8neg_CD20 <- ggboxplot(outcome_all_rad3_CD3CD8neg_CD20, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD3CD8neg_CD20 at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.34) # + stat_pvalue_manual(pwc_delta_estimate_CD3CD8neg_CD20, hide.ns = TRUE, y.position = c(0.4))
Lcorssimmune_CD3CD8neg_CD20
```

```{r}
pdf(file="Lcorssimmune_CD3CD8neg_CD20.pdf", width = 7, height=4.5)
Lcorssimmune_CD3CD8neg_CD20
dev.off()
```

##### Kaplan-meier

```{r}
Lanalysis_OS_CD3CD8neg_CD20_studygroup <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3CD8neg_CD20), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD3CD8neg_CD20 by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
Lanalysis_OS_CD3CD8neg_CD20_studygroup

Lanalysis_DRS_CD3CD8neg_CD20_studygroup <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3CD8neg_CD20), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD3CD8neg_CD20 by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
Lanalysis_DRS_CD3CD8neg_CD20_studygroup
```

```{r}
pdf(file="Lanalysis_OS_CD3CD8neg_CD20_studygroup.pdf", width = 7, height=4.5)
Lanalysis_OS_CD3CD8neg_CD20_studygroup
dev.off()

pdf(file="Lanalysis_DRS_CD3CD8neg_CD20_studygroup.pdf", width = 7, height=4.5)
Lanalysis_DRS_CD3CD8neg_CD20_studygroup
dev.off()
```

```{r}
outcome_all_rad3_CD3CD8neg_CD20_withoutprbc <- subset(outcome_all_rad3_CD3CD8neg_CD20, study_group %in% c("PPBCinv", "nonPrBC"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3CD8neg_CD20_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3CD8neg_CD20_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```


```{r}
Lanalysis_OS_CD3CD8neg_CD20_median <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD3CD8neg_CD20), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD3CD8neg_CD20 by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
Lanalysis_OS_CD3CD8neg_CD20_median

Lanalysis_DRS_CD3CD8neg_CD20_median <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD3CD8neg_CD20), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD3CD8neg_CD20 by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
Lanalysis_DRS_CD3CD8neg_CD20_median
```

```{r}
pdf(file="Lanalysis_OS_CD3CD8neg_CD20_median.pdf", width = 7, height=4.5)
Lanalysis_OS_CD3CD8neg_CD20_median
dev.off()

pdf(file="Lanalysis_DRS_CD3CD8neg_CD20_median.pdf", width = 7, height=4.5)
Lanalysis_DRS_CD3CD8neg_CD20_median
dev.off()
```



#### CD3+CD8-/CD3+CD8+

##### ANOVA

```{r}
group_by(outcome_all_rad3_CD8neg_CD8pos, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```


Remove NA values
```{r}
outcome_all_rad3_CD8neg_CD8pos <- outcome_all_rad3_CD8neg_CD8pos[!is.na(outcome_all_rad3_CD8neg_CD8pos$delta_estimate),]

group_by(outcome_all_rad3_CD8neg_CD8pos, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
outcome_all_rad3_CD8neg_CD8pos$study_group <- gsub("non_prbc", "nonPrBC", outcome_all_rad3_CD8neg_CD8pos$study_group)
outcome_all_rad3_CD8neg_CD8pos$study_group <- gsub("ppbc_inv", "PPBCinv", outcome_all_rad3_CD8neg_CD8pos$study_group)
outcome_all_rad3_CD8neg_CD8pos$study_group <- gsub("ppbc_lac", "PPBClac", outcome_all_rad3_CD8neg_CD8pos$study_group)
outcome_all_rad3_CD8neg_CD8pos$study_group <- gsub("prbc", "PrBC", outcome_all_rad3_CD8neg_CD8pos$study_group)

outcome_all_rad3_CD8neg_CD8pos$study_group <- ordered(outcome_all_rad3_CD8neg_CD8pos$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(outcome_all_rad3_CD8neg_CD8pos$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(outcome_all_rad3_CD8neg_CD8pos$delta_estimate)
```


```{r}
outcome_all_rad3_CD8neg_CD8pos %>% 
  group_by(study_group) %>%
  identify_outliers(delta_estimate)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.delta_estimate_CD8neg_CD8pos <- aov(delta_estimate ~ study_group, data = outcome_all_rad3_CD8neg_CD8pos)
# summary of the analysis
summary(res.aov.delta_estimate_CD8neg_CD8pos)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.delta_estimate_CD8neg_CD8pos)
```

```{r}
pwc_delta_estimate_CD8neg_CD8pos <- outcome_all_rad3_CD8neg_CD8pos %>% tukey_hsd(delta_estimate ~ study_group)
pwc_delta_estimate_CD8neg_CD8pos
```



Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.delta_estimate_CD8neg_CD8pos, 1)
```


From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD8neg_CD8pos)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(outcome_all_rad3_CD8neg_CD8pos$delta_estimate, outcome_all_rad3_CD8neg_CD8pos$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.delta_estimate_CD8neg_CD8pos, 2)

model_delta_estimate_CD8neg_CD8pos <- lm(delta_estimate ~ study_group, data=outcome_all_rad3_CD8neg_CD8pos)
ggqqplot(residuals(model_delta_estimate_CD8neg_CD8pos))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_delta_estimate_CD8neg_CD8pos <- residuals(object = res.aov.delta_estimate_CD8neg_CD8pos)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_delta_estimate_CD8neg_CD8pos)
shapiro_test(residuals(model_delta_estimate_CD8neg_CD8pos))
```



Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD8neg_CD8pos)
```


Wilcox pairwise test

```{r}
pairwise.t.test(outcome_all_rad3_CD8neg_CD8pos$delta_estimate, outcome_all_rad3_CD8neg_CD8pos$study_group,
                 p.adjust.method = "BH")
```




Visualization

```{r, fig.width=7, fig.height=4.5}
Lcorssimmune_CD8neg_CD8pos <- ggboxplot(outcome_all_rad3_CD8neg_CD8pos, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD8neg_CD8pos at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.0005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.25) # + stat_pvalue_manual(pwc_delta_estimate_CD8neg_CD8pos, hide.ns = TRUE, y.position = c(1.25))
Lcorssimmune_CD8neg_CD8pos
```


```{r, fig.width=7, fig.height=4.5}
Lcorssimmune_CD8neg_CD8pos <- ggboxplot(outcome_all_rad3_CD8neg_CD8pos, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD8neg_CD8pos at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.002, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.25) + ylim(0,0.1) # + stat_pvalue_manual(pwc_delta_estimate_CD8neg_CD8pos, hide.ns = TRUE, y.position = c(1.25))
Lcorssimmune_CD8neg_CD8pos
```

```{r}
pdf(file="Lcorssimmune_CD8neg_CD8pos.pdf", width = 7, height=4.5)
Lcorssimmune_CD8neg_CD8pos
dev.off()
```

##### Kaplan-meier

```{r}
Lanalysis_OS_CD8neg_CD8pos_studygroup <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD8neg_CD8pos), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD8neg_CD8pos by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
Lanalysis_OS_CD8neg_CD8pos_studygroup

Lanalysis_DRS_CD8neg_CD8pos_studygroup <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD8neg_CD8pos), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD8neg_CD8pos by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
Lanalysis_DRS_CD8neg_CD8pos_studygroup
```

```{r}
pdf(file="Lanalysis_OS_CD8neg_CD8pos_studygroup.pdf", width = 7, height=4.5)
Lanalysis_OS_CD8neg_CD8pos_studygroup
dev.off()

pdf(file="Lanalysis_DRS_CD8neg_CD8pos_studygroup.pdf", width = 7, height=4.5)
Lanalysis_DRS_CD8neg_CD8pos_studygroup
dev.off()
```

```{r}
outcome_all_rad3_CD8neg_CD8pos_withoutprbc <- subset(outcome_all_rad3_CD8neg_CD8pos, study_group %in% c("PPBCinv", "nonPrBC"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD8neg_CD8pos_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD8neg_CD8pos_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```


```{r}
Lanalysis_OS_CD8neg_CD8pos_median <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD8neg_CD8pos), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD8neg_CD8pos by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
Lanalysis_OS_CD8neg_CD8pos_median

Lanalysis_DRS_CD8neg_CD8pos_median <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD8neg_CD8pos), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD8neg_CD8pos by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
Lanalysis_DRS_CD8neg_CD8pos_median
```

```{r}
pdf(file="Lanalysis_OS_CD8neg_CD8pos_median.pdf", width = 7, height=4.5)
Lanalysis_OS_CD8neg_CD8pos_median
dev.off()

pdf(file="Lanalysis_DRS_CD8neg_CD8pos_median.pdf", width = 7, height=4.5)
Lanalysis_DRS_CD8neg_CD8pos_median
dev.off()
```




#### CD3+CD8+/CD3+CD8-

##### ANOVA

```{r}
group_by(outcome_all_rad3_CD8pos_CD8neg, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```


Remove NA values
```{r}
outcome_all_rad3_CD8pos_CD8neg <- outcome_all_rad3_CD8pos_CD8neg[!is.na(outcome_all_rad3_CD8pos_CD8neg$delta_estimate),]

group_by(outcome_all_rad3_CD8pos_CD8neg, study_group) %>%
  summarise(
    count = n(),
    mean = mean(delta_estimate, na.rm = TRUE),
    sd = sd(delta_estimate, na.rm = TRUE)
  )
```

Rename study group (This is needed for visualizing Tukey HSD test on plots):
```{r}
outcome_all_rad3_CD8pos_CD8neg$study_group <- gsub("non_prbc", "nonPrBC", outcome_all_rad3_CD8pos_CD8neg$study_group)
outcome_all_rad3_CD8pos_CD8neg$study_group <- gsub("ppbc_inv", "PPBCinv", outcome_all_rad3_CD8pos_CD8neg$study_group)
outcome_all_rad3_CD8pos_CD8neg$study_group <- gsub("ppbc_lac", "PPBClac", outcome_all_rad3_CD8pos_CD8neg$study_group)
outcome_all_rad3_CD8pos_CD8neg$study_group <- gsub("prbc", "PrBC", outcome_all_rad3_CD8pos_CD8neg$study_group)

outcome_all_rad3_CD8pos_CD8neg$study_group <- ordered(outcome_all_rad3_CD8pos_CD8neg$study_group,
                         levels = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"))

unique(unlist(outcome_all_rad3_CD8pos_CD8neg$study_group))
```

Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(outcome_all_rad3_CD8pos_CD8neg$delta_estimate)
```


```{r}
outcome_all_rad3_CD8pos_CD8neg %>% 
  group_by(study_group) %>%
  identify_outliers(delta_estimate)
```
--> NO extreme outliers!!!! 


Compute one-way ANOVA

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.


```{r}
# compute the analysis of variance
res.aov.delta_estimate_CD8pos_CD8neg <- aov(delta_estimate ~ study_group, data = outcome_all_rad3_CD8pos_CD8neg)
# summary of the analysis
summary(res.aov.delta_estimate_CD8pos_CD8neg)
```


Tukey multiple pairwise-comparisons

As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.

with outliers:
```{r}
TukeyHSD(res.aov.delta_estimate_CD8pos_CD8neg)
```

```{r}
pwc_delta_estimate_CD8pos_CD8neg <- outcome_all_rad3_CD8pos_CD8neg %>% tukey_hsd(delta_estimate ~ study_group)
pwc_delta_estimate_CD8pos_CD8neg
```



Check ANOVA assumptions: test validity? 

The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.

homogeneity of variance assumption


```{r}
plot(res.aov.delta_estimate_CD8pos_CD8neg, 1)
```


From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption

How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?

An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().

```{r}
# ANOVA test with no assumption of equal variances
oneway.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD8pos_CD8neg)
```


```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(outcome_all_rad3_CD8pos_CD8neg$delta_estimate, outcome_all_rad3_CD8pos_CD8neg$study_group,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption

Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.

The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.

```{r}
plot(res.aov.delta_estimate_CD8pos_CD8neg, 2)

model_delta_estimate_CD8pos_CD8neg <- lm(delta_estimate ~ study_group, data=outcome_all_rad3_CD8pos_CD8neg)
ggqqplot(residuals(model_delta_estimate_CD8pos_CD8neg))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.

```{r}
# Extract the reisudals 
aov_residuals_delta_estimate_CD8pos_CD8neg <- residuals(object = res.aov.delta_estimate_CD8pos_CD8neg)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_delta_estimate_CD8pos_CD8neg)
shapiro_test(residuals(model_delta_estimate_CD8pos_CD8neg))
```



Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.

```{r}
kruskal.test(delta_estimate ~ study_group, data = outcome_all_rad3_CD8pos_CD8neg)
```

Wilcox pairwise test

```{r}
pairwise.t.test(outcome_all_rad3_CD8pos_CD8neg$delta_estimate, outcome_all_rad3_CD8pos_CD8neg$study_group,
                 p.adjust.method = "BH")
```


Visualization

```{r, fig.width=7, fig.height=4.5}
Lcorssimmune_CD8pos_CD8neg <- ggboxplot(outcome_all_rad3_CD8pos_CD8neg, x="study_group", y="delta_estimate",
          color = "study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("PPBCinv", "PPBClac", "PrBC", "nonPrBC"),
          ylab = "delta_estimate_CD8pos_CD8neg at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.0005, aes(colour = study_group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.25) # + stat_pvalue_manual(pwc_delta_estimate_CD8pos_CD8neg, hide.ns = TRUE, y.position = c(1.25))
Lcorssimmune_CD8pos_CD8neg
```

```{r}
pdf(file="Lcorssimmune_CD8pos_CD8neg.pdf", width = 7, height=4.5)
Lcorssimmune_CD8pos_CD8neg
dev.off()
```

##### Kaplan-meier

```{r}
Lanalysis_OS_CD8pos_CD8neg_studygroup <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD8pos_CD8neg), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD8pos_CD8neg by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
Lanalysis_OS_CD8pos_CD8neg_studygroup

Lanalysis_DRS_CD8pos_CD8neg_studygroup <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD8pos_CD8neg), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD8pos_CD8neg by study group",
    palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
Lanalysis_DRS_CD8pos_CD8neg_studygroup
```

```{r}
pdf(file="Lanalysis_OS_CD8pos_CD8neg_studygroup.pdf", width = 7, height=4.5)
Lanalysis_OS_CD8pos_CD8neg_studygroup
dev.off()

pdf(file="Lanalysis_DRS_CD8pos_CD8neg_studygroup.pdf", width = 7, height=4.5)
Lanalysis_DRS_CD8pos_CD8neg_studygroup
dev.off()
```

```{r}
outcome_all_rad3_CD8pos_CD8neg_withoutprbc <- subset(outcome_all_rad3_CD8pos_CD8neg, study_group %in% c("PPBCinv", "nonPrBC"), )
```


```{r}
ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD8pos_CD8neg_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "OS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")

ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD8pos_CD8neg_withoutprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "DRS - CD3+FoxP3- by study group",
    palette = c("#521262", "#46CDCF"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "median")
```


```{r}
Lanalysis_OS_CD8pos_CD8neg_median <- ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ study_group + median, data = outcome_all_rad3_CD8pos_CD8neg), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "OS - CD8pos_CD8neg by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
Lanalysis_OS_CD8pos_CD8neg_median

Lanalysis_DRS_CD8pos_CD8neg_median <- ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ study_group + median, data = outcome_all_rad3_CD8pos_CD8neg), 
    xlab = "Months", 
    ylab = "OS probability",
    title = "DRS - CD8pos_CD8neg by study group",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T, facet.by = "study_group")
Lanalysis_DRS_CD8pos_CD8neg_median
```

```{r}
pdf(file="Lanalysis_OS_CD8pos_CD8neg_median.pdf", width = 7, height=4.5)
Lanalysis_OS_CD8pos_CD8neg_median
dev.off()

pdf(file="Lanalysis_DRS_CD8pos_CD8neg_median.pdf", width = 7, height=4.5)
Lanalysis_DRS_CD8pos_CD8neg_median
dev.off()
```



#### within study groups OS

subset data low IG signature versus high IG signature 

```{r}
outcome_all_rad3_CD20_CD3CD8pos_low <- subset(outcome_all_rad3_CD20_CD3CD8pos, median %in% c("FALSE"), )
outcome_all_rad3_CD20_CD3CD8pos_high <- subset(outcome_all_rad3_CD20_CD3CD8pos, median %in% c("TRUE"), )
```


Testing proportional hazards assumption -> zie file Kat: stratify for PAM50


```{r}
table(outcome_all_rad3_CD20_CD3CD8pos_low$study_group)
table(outcome_all_rad3_CD20_CD3CD8pos_high$study_group)
```



low CD8 cluster 

univariate 

```{r}
#univariate
cox_OS_CD8low <- coxph(Surv(time_OS_months, death) ~ study_group, data = outcome_all_rad3_CD20_CD3CD8pos_low)
summary(cox_OS_CD8low)
```


multivariate 

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    study_group, #+
    #strata(clin_subtype),
  data = outcome_all_rad3_CD20_CD3CD8pos_low)
summary(clin.cov.cox)
```



```{r}
#with study study_group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~  stage + study_group, data = outcome_all_rad3_CD20_CD3CD8pos_low)
study_strata
plot_OS_CD8low_multivariate <- ggadjustedcurves(study_strata, data=outcome_all_rad3_CD20_CD3CD8pos_low, method="conditional", variable="study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_OS_CD8low_multivariate
```

```{r}
pdf(here("plot_OS_CD8low_multivariate.pdf"), width = 7, height = 5)
plot_OS_CD8low_multivariate
dev.off()
```

High CD8 cluster 

univariate 

```{r}
#univariate
cox_OS_CD8high <- coxph(Surv(time_OS_months, death) ~ study_group, data = outcome_all_rad3_CD20_CD3CD8pos_high)
summary(cox_OS_CD8high)
```

multivariate


```{r}
#with study_group
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    study_group, #+
    #strata(clin_subtype),
  data = outcome_all_rad3_CD20_CD3CD8pos_high)
summary(clin.cov.cox)
```

```{r}
#with study study_group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + study_group, data = outcome_all_rad3_CD20_CD3CD8pos_high)
study_strata
plot_OS_CD8high_multivariate <- ggadjustedcurves(study_strata, data=outcome_all_rad3_CD20_CD3CD8pos_high, method="conditional", variable="study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_OS_CD8high_multivariate
```




#### within study study_groups DRS

low CD8 cluster 

univariate 

```{r}
#univariate
cox_DRS_CD8low <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = outcome_all_rad3_CD20_CD3CD8pos_low)
summary(cox_DRS_CD8low)
```


multivariate 


```{r}
table(outcome_all_rad3_CD20_CD3CD8pos_low$study_group)
```



```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    study_group, #+
    #strata(clin_subtype),
  data = outcome_all_rad3_CD20_CD3CD8pos_low)
summary(clin.cov.cox)
```



```{r}
#with study study_group as covariate 
study_strata <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~  stage + study_group, data = outcome_all_rad3_CD20_CD3CD8pos_low)
study_strata
plot_DRS_CD8low_multivariate <- ggadjustedcurves(study_strata, data=outcome_all_rad3_CD20_CD3CD8pos_low, method="conditional", variable="study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_DRS_CD8low_multivariate
```


High CD8 cluster 

univariate 

```{r}
#univariate
cox_DRS_CD8high <- coxph(Surv(time_DRS_months, distant_recurrence) ~ study_group, data = outcome_all_rad3_CD20_CD3CD8pos_high)
summary(cox_DRS_CD8high)
```

multivariate



```{r}
#with study_group
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    study_group, #+
    #strata(clin_subtype),
  data = outcome_all_rad3_CD20_CD3CD8pos_high)
summary(clin.cov.cox)
```

```{r}
#with study study_group as covariate 
study_strata <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage + study_group, data = outcome_all_rad3_CD20_CD3CD8pos_high)
study_strata
plot_DRS_CD8high_multivariate <- ggadjustedcurves(study_strata, data=outcome_all_rad3_CD20_CD3CD8pos_high, method="conditional", variable="study_group", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_DRS_CD8high_multivariate
```



### univariate 

CD20/CD3+CD8+
```{r}
cox_OS_L_CD20_CD3CD8pos <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_all_rad3_CD20_CD3CD8pos)
summary(cox_OS_L_CD20_CD3CD8pos)

cox_OS_L_CD20_CD3CD8pos_inv <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_inv_rad3_CD20_CD3CD8pos)
summary(cox_OS_L_CD20_CD3CD8pos_inv)

cox_OS_L_CD20_CD3CD8pos_np <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_np_rad3_CD20_CD3CD8pos)
summary(cox_OS_L_CD20_CD3CD8pos_np)

cox_OS_L_CD20_CD3CD8pos_pr <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_pr_rad3_CD20_CD3CD8pos)
summary(cox_OS_L_CD20_CD3CD8pos_pr)
```


CD3+CD8+/CD20
```{r}
cox_OS_L_CD3CD8pos_CD20 <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_all_rad3_CD3CD8pos_CD20)
summary(cox_OS_L_CD3CD8pos_CD20)

cox_OS_L_CD3CD8pos_CD20_inv <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_inv_rad3_CD3CD8pos_CD20)
summary(cox_OS_L_CD3CD8pos_CD20_inv)

cox_OS_L_CD3CD8pos_CD20_np <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_np_rad3_CD3CD8pos_CD20)
summary(cox_OS_L_CD3CD8pos_CD20_np)

cox_OS_L_CD3CD8pos_CD20_pr <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_pr_rad3_CD3CD8pos_CD20)
summary(cox_OS_L_CD3CD8pos_CD20_pr)
```


CD20/CD3+CD8-
```{r}
cox_OS_L_CD20_CD3CD8neg <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_all_rad3_CD20_CD3CD8neg)
summary(cox_OS_L_CD20_CD3CD8neg)

cox_OS_L_CD20_CD3CD8neg_inv <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_inv_rad3_CD20_CD3CD8neg)
summary(cox_OS_L_CD20_CD3CD8neg_inv)

cox_OS_L_CD20_CD3CD8neg_np <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_np_rad3_CD20_CD3CD8neg)
summary(cox_OS_L_CD20_CD3CD8neg_np)

#cox_OS_L_CD20_CD3CD8neg_pr <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_pr_rad3_CD20_CD3CD8neg)
#summary(cox_OS_L_CD20_CD3CD8neg_pr)
```


CD3+CD8-/CD20
```{r}
cox_OS_L_CD3CD8neg_CD20 <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_all_rad3_CD3CD8neg_CD20)
summary(cox_OS_L_CD3CD8neg_CD20)

cox_OS_L_CD3CD8neg_CD20_inv <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_inv_rad3_CD3CD8neg_CD20)
summary(cox_OS_L_CD3CD8neg_CD20_inv)

cox_OS_L_CD3CD8neg_CD20_np <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_np_rad3_CD3CD8neg_CD20)
summary(cox_OS_L_CD3CD8neg_CD20_np)

cox_OS_L_CD3CD8neg_CD20_pr <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_pr_rad3_CD3CD8neg_CD20)
summary(cox_OS_L_CD3CD8neg_CD20_pr)
```

CD3+CD8+/CD3+CD8-
```{r}
cox_OS_L_CD8pos_CD8neg <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_all_rad3_CD8pos_CD8neg)
summary(cox_OS_L_CD8pos_CD8neg)

cox_OS_L_CD8pos_CD8neg_inv <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_inv_rad3_CD8pos_CD8neg)
summary(cox_OS_L_CD8pos_CD8neg_inv)

cox_OS_L_CD8pos_CD8neg_np <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_np_rad3_CD8pos_CD8neg)
summary(cox_OS_L_CD8pos_CD8neg_np)

cox_OS_L_CD8pos_CD8neg_pr <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_pr_rad3_CD8pos_CD8neg)
summary(cox_OS_L_CD8pos_CD8neg_pr)
```

CD3+CD8-/CD3+CD8+
```{r}
cox_OS_L_CD8neg_CD8pos <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_all_rad3_CD8neg_CD8pos)
summary(cox_OS_L_CD8neg_CD8pos)

cox_OS_L_CD8neg_CD8pos_inv <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_inv_rad3_CD8neg_CD8pos)
summary(cox_OS_L_CD8neg_CD8pos_inv)

cox_OS_L_CD8neg_CD8pos_np <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_np_rad3_CD8neg_CD8pos)
summary(cox_OS_L_CD8neg_CD8pos_np)

cox_OS_L_CD8neg_CD8pos_pr <- coxph(Surv(time_OS_months, death) ~ median, data = outcome_pr_rad3_CD8neg_CD8pos)
summary(cox_OS_L_CD8neg_CD8pos_pr)
```



### multiavariate 

CD20/CD3+CD8+
```{r}
#multivariate
multicox_OS_CD20_CD3CD8pos <- coxph(Surv(time_OS_months, death) ~ study_group + median + stage, data = outcome_all_rad3_CD20_CD3CD8pos)
summary(multicox_OS_CD20_CD3CD8pos)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group +
    stage +
    median,
  data = outcome_all_rad3_CD20_CD3CD8pos)
summary(clin.cov.cox)
```

```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + strata(median), data = outcome_all_rad3_CD20_CD3CD8pos)
study_strata
ggadjustedcurves(study_strata, data=outcome_all_rad3_CD20_CD3CD8pos, method="conditional", variable="median", palette = c("#a10702", "#ffb600")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```


CD3+CD8+/CD20
```{r}
#multivariate
multicox_OS_CD3CD8pos_CD20 <- coxph(Surv(time_OS_months, death) ~ study_group + median + stage, data = outcome_all_rad3_CD3CD8pos_CD20)
summary(multicox_OS_CD3CD8pos_CD20)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group +
    stage +
    median,
  data = outcome_all_rad3_CD3CD8pos_CD20)
summary(clin.cov.cox)
```

```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + strata(median), data = outcome_all_rad3_CD3CD8pos_CD20)
study_strata
ggadjustedcurves(study_strata, data=outcome_all_rad3_CD3CD8pos_CD20, method="conditional", variable="median", palette = c("#a10702", "#ffb600")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```


CD20/CD3+CD8-
```{r}
#multivariate
multicox_OS_CD20_CD3CD8neg <- coxph(Surv(time_OS_months, death) ~ study_group + median + stage, data = outcome_all_rad3_CD20_CD3CD8neg)
summary(multicox_OS_CD20_CD3CD8neg)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group +
    stage +
    median,
  data = outcome_all_rad3_CD20_CD3CD8neg)
summary(clin.cov.cox)
```

```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + strata(median), data = outcome_all_rad3_CD20_CD3CD8neg)
study_strata
ggadjustedcurves(study_strata, data=outcome_all_rad3_CD20_CD3CD8neg, method="conditional", variable="median", palette = c("#a10702", "#ffb600")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```

CD3+CD8-/CD20+
```{r}
#multivariate
multicox_OS_CD3CD8neg_CD20 <- coxph(Surv(time_OS_months, death) ~ study_group + median + stage, data = outcome_all_rad3_CD3CD8neg_CD20)
summary(multicox_OS_CD3CD8neg_CD20)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group +
    stage +
    median,
  data = outcome_all_rad3_CD3CD8neg_CD20)
summary(clin.cov.cox)
```

```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + strata(median), data = outcome_all_rad3_CD3CD8neg_CD20)
study_strata
ggadjustedcurves(study_strata, data=outcome_all_rad3_CD3CD8neg_CD20, method="conditional", variable="median", palette = c("#a10702", "#ffb600")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```

CD3+CD8+/CD3+CD8-
```{r}
#multivariate
multicox_OS_CD8pos_CD8neg <- coxph(Surv(time_OS_months, death) ~ study_group + median + stage, data = outcome_all_rad3_CD8pos_CD8neg)
summary(multicox_OS_CD8pos_CD8neg)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group +
    stage +
    median,
  data = outcome_all_rad3_CD8pos_CD8neg)
summary(clin.cov.cox)
```

```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + strata(median), data = outcome_all_rad3_CD8pos_CD8neg)
study_strata
ggadjustedcurves(study_strata, data=outcome_all_rad3_CD8pos_CD8neg, method="conditional", variable="median", palette = c("#a10702", "#ffb600")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```

CD3+CD8-/CD3+CD8+
```{r}
#multivariate
multicox_OS_CD8neg_CD8pos <- coxph(Surv(time_OS_months, death) ~ study_group + median + stage, data = outcome_all_rad3_CD8neg_CD8pos)
summary(multicox_OS_CD8neg_CD8pos)
```

```{r}
#with PPBC
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group +
    stage +
    median,
  data = outcome_all_rad3_CD8neg_CD8pos)
summary(clin.cov.cox)
```

```{r}
#without study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ study_group + stage + strata(median), data = outcome_all_rad3_CD8neg_CD8pos)
study_strata
ggadjustedcurves(study_strata, data=outcome_all_rad3_CD8neg_CD8pos, method="conditional", variable="median", palette = c("#a10702", "#ffb600")) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
```




















