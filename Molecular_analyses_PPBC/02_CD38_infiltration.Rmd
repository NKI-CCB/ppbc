---
title: "CD38 Scoring"
output:
  html_notebook:
    toc: yes
    toc_float: yes
---

# Loading Packages 

```{r}
#install.packages("tidyverse")
library(tidyverse)
library(readxl)
#if (!requireNamespace("BiocManager", quietly = TRUE))
   # install.packages("BiocManager")
#BiocManager::install("tximport")
library(tximport)
#install.packages("here")
library(here)
library(dplyr)
library(tidyr)
library(gplots)
library(ggplot2)
library(grid)
#install.packages("vcd")
library(vcd)
#install.packages("corrplot")
library(corrplot)
#install.packages("ca")
library(ca)
library(scales)
#install.packages("ggthemes")
library(ggthemes)
#install.packages("ztable")
library(ztable)
library(survival)
library(ggpubr)
library(magrittr)
library(survminer)
library(prodlim)
library(Publish)
library(tidyverse)
library(readxl)
#source("https://bioconductor.org/biocLite.R")
#biocLite("tximport")
library(tximport)
library(here)
library(dplyr)
library(tidyr)
#install.packages("gplots")
library(gplots)
library(ggplot2)
library(grid)
#install.packages("vcd")
library(vcd)
#install.packages("corrplot")
library(corrplot)
#install.packages("ca")
library(ca)
library(scales)
#install.packages("ggthemes")
library(ggthemes)
#install.packages("ztable")
library(ztable)
library(devtools)
library(ggpubr)
#install.packages("multcomp")
library(multcomp)
#install.packages("car")
library(car)
library(ggpubr)
library(multcomp)
#install.packages("rstatix")
library(rstatix)
```


# Load data

```{r}
PPBC_metadata <- readRDS("PPBC_metadata.RDS")
```

```{r}
PPBC_metadata[sapply(PPBC_metadata, function(x) as.character(x) == " ")] <- NA
```



remove NA data from study_group and SI_CD38,  TI_CD38
```{r}
PPBC_metadata <- PPBC_metadata[!(is.na(PPBC_metadata$SI_CD38)),]
PPBC_metadata <- PPBC_metadata[!(is.na(PPBC_metadata$TI_CD38)),]
PPBC_metadata <- PPBC_metadata[!(is.na(PPBC_metadata$study_group)),]
```


# Data frequencies

```{r}
table(PPBC_metadata$study_group)
table(PPBC_metadata$study_group, PPBC_metadata$SI_CD38)
table(PPBC_metadata$study_group, PPBC_metadata$TI_CD38)
```


# rename and relevel groups

```{r}
PPBC_metadata$group <- NA
PPBC_metadata$group[PPBC_metadata$study_group=="npbc"] <- 4
PPBC_metadata$group[PPBC_metadata$study_group=="ppbcpw"] <- 1
PPBC_metadata$group[PPBC_metadata$study_group=="ppbcdl"] <- 2
PPBC_metadata$group[PPBC_metadata$study_group=="prbc"] <- 3


PPBC_metadata$group <- factor(PPBC_metadata$group,
                                           levels = c(1,2,3,4),
                                           labels = c("PPBCPW", "PPBCDL", "PrBC", "NPBC"))

table(PPBC_metadata$group)
  
```



```{r}
CD38_inv <- subset(PPBC_metadata, group == "PPBCPW", )
CD38_lac <- subset(PPBC_metadata, group == "PPBCDL", )
CD38_prbc <- subset(PPBC_metadata, group == "PrBC", )
CD38_nonprbc <- subset(PPBC_metadata, group == "NPBC", )

CD38_inv_nonprbc <- subset(PPBC_metadata, group %in% c("PPBCPW","NPBC"), )
CD38_inv_prbc <- subset(PPBC_metadata, group %in% c("PPBCPW", "PrBC"), )
CD38_inv_lac <- subset(PPBC_metadata, group %in% c("PPBCPW", "PPBCDL"), )
CD38_prbc_nonprbc <- subset(PPBC_metadata, group %in% c("PrBC", "NPBC"), )
CD38_lac_nonprbc <- subset(PPBC_metadata, group %in% c("PPBCDL", "NPBC"), )
CD38_without_lac <- subset(PPBC_metadata, group %in% c("PPBCPW", "PrBC", "NPBC"), )
```


# ANOVA CD38 ALL intensity 

## stroma

```{r}
group_by(PPBC_metadata, group) %>%
  summarise(
    count = n(),
    mean = mean(SI_CD38_total, na.rm = TRUE),
    sd = sd(SI_CD38_total, na.rm = TRUE)
  )
```


### ANOVA test

```{r}
res.aov_total <- aov(SI_CD38_total ~ group, data = PPBC_metadata)
summary(res.aov_total)
```


### Tukey multiple pairwise-comparisons

```{r}
TukeyHSD(res.aov_total)
```


```{r}
pwc_total <- PPBC_metadata %>% tukey_hsd(SI_CD38_total ~ group)
pwc_total
```


### Pairewise t-test

The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.

```{r}
pairwise.t.test(PPBC_metadata$SI_CD38_total, PPBC_metadata$group,
                 p.adjust.method = "BH")
```


### Check the homogeneity of variance assumption

The classical one-way ANOVA test requires an assumption of equal variances for all groups.


```{r}
# 1. Homogeneity of variances
plot(res.aov_total, 1)
```


```{r}
leveneTest(SI_CD38_total ~ group, data = PPBC_metadata)
```


From the output above we can see that the p-value is NOT less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is NOT statistically significantly different. Therefore, we CAN assume the homogeneity of variances in the different treatment groups.


Check the normality assumption

```{r}
# 2. Normality
plot(res.aov_total, 2)
```

As all the points do not fall approximately along this reference line, we cannot assume normality.

Shapiro-Wilk test on the ANOVA residuals - significant p-value - so data are not normal! 

```{r}
# Extract the residuals
aov_residuals_total <- residuals(object = res.aov_total )
# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals_total )

```


### Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.


```{r}
kruskal.test(SI_CD38_total ~ group, data = PPBC_metadata)
```


### Visualization 

```{r}
table(PPBC_metadata$group)
table(PPBC_metadata$group, PPBC_metadata$SI_CD38_total)
table(PPBC_metadata$SI_CD38_total)
```



```{r}
CD38_plot_SI_total <- ggboxplot(PPBC_metadata, x="group", y="SI_CD38_total",
          color = "group", palette = c("#46CDCF", "#112D4E", "#AA96DA", "#521262"),
          order = c("PPBCPW", "PPBCDL", "PrBC", "NPBC"),
          ylab = "CD38 score", xlab = "study group") + 
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.5, aes(colour = group)) + stat_compare_means(method = "kruskal") + ylim(0,35) 

CD38_plot_SI_total
```


## tumor

```{r}
group_by(PPBC_metadata, group) %>%
  summarise(
    count = n(),
    mean = mean(TI_CD38_total, na.rm = TRUE),
    sd = sd(TI_CD38_total, na.rm = TRUE)
  )
```


### ANOVA test

```{r}
res.aov_TI_total <- aov(TI_CD38_total ~ group, data = PPBC_metadata)
summary(res.aov_TI_total)
```


### Tukey multiple pairwise-comparisons

```{r}
TukeyHSD(res.aov_TI_total)
```


```{r}
pwc_TI_total <- PPBC_metadata %>% tukey_hsd(TI_CD38_total ~ group)
pwc_TI_total
```


### Pairewise t-test

The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.

```{r}
pairwise.t.test(PPBC_metadata$TI_CD38_total, PPBC_metadata$group,
                 p.adjust.method = "BH")
```


### Check the homogeneity of variance assumption

The classical one-way ANOVA test requires an assumption of equal variances for all groups.


```{r}
# 1. Homogeneity of variances
plot(res.aov_TI_total, 1)
```


```{r}
leveneTest(TI_CD38_total ~ group, data = PPBC_metadata)
```


From the output above we can see that the p-value is NOT less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is NOT statistically significantly different. Therefore, we CAN assume the homogeneity of variances in the different treatment groups.


Check the normality assumption

```{r}
# 2. Normality
plot(res.aov_TI_total, 2)
```

As all the points do not fall approximately along this reference line, we cannot assume normality.

Shapiro-Wilk test on the ANOVA residuals - significant p-value - so data are not normal! 

```{r}
# Extract the residuals
aov_residuals_TI_total <- residuals(object = res.aov_TI_total )
# Run Shapiro-Wilk test
shapiro.test(x = aov_residuals_TI_total )

```


### Non-parametric alternative to one-way ANOVA test

Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.


```{r}
kruskal.test(TI_CD38_total ~ group, data = PPBC_metadata)
```





### Visualization 

```{r}
table(PPBC_metadata$group)
table(PPBC_metadata$group, PPBC_metadata$TI_CD38_total)
table(PPBC_metadata$TI_CD38_total)
```


```{r, fig.width=7, fig.height=4.5}
my_comparisons <- list( c("PPBCPW", "PPBCDL"), c("PPBCPW", "PrBC"), c("PPBCPW", "NPBC") )

CD38_plot_TI_total <- ggboxplot(PPBC_metadata, x="group", y="TI_CD38_total",
          color = "group", palette = c("#46CDCF", "#112D4E", "#AA96DA", "#521262"),
          order = c("PPBCPW", "PPBCDL", "PrBC", "NPBC"),
          ylab = "CD38 score", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 1, aes(colour = group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 80) # + stat_pvalue_manual(pwc_delta_estimate_CD3CD8pos_CD20, hide.ns = TRUE, y.position = c(1.25))
CD38_plot_TI_total
```


### without lactation


```{r}
PPBC_metadata_withoutlac <- subset(PPBC_metadata, group %in% c("PPBCPW", "PrBC", "NPBC"), )
```



```{r, fig.width=7, fig.height=4.5}
my_comparisons <- list( c("PrBC", "NPBC"), c("PPBCPW", "PrBC"), c("PPBCPW", "NPBC") )

CD38_plot_TI_total <- ggboxplot(PPBC_metadata_withoutlac, x="group", y="TI_CD38_total",
          color = "group", palette = c("#46CDCF", "#AA96DA", "#521262"),
          order = c("PPBCPW", "PrBC", "NPBC"),
          ylab = "CD38 score", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 1, aes(colour = group)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 80) # + stat_pvalue_manual(pwc_delta_estimate_CD3CD8pos_CD20, hide.ns = TRUE, y.position = c(1.25))
CD38_plot_TI_total
```




# OS - CD38 count 

```{r}
surv_OS <- Surv(time = PPBC_metadata$time_OS_months, event = PPBC_metadata$death)
fit_OS <- survfit(surv_OS ~ group, data = PPBC_metadata) 
```

## stroma


normal : cutoff high-low based on median value of CD38+ (median = 10%)

```{r}
table(PPBC_metadata$SI_CD38)
```

```{r}
fit_OS_SI_CD38 <- survfit(surv_OS ~ SI_CD38, data = PPBC_metadata) 
```



```{r}
OS_univariate_SI <- ggsurvplot(fit_OS_SI_CD38, data = PPBC_metadata,
    xlab = "Months", 
    ylab = "OS probability",
    title =  paste0("A. OS univariate stroma (n = ", nrow(PPBC_metadata), ")"),
    #linetype = "strata",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T,
    risk.table = F,
    cumevents = F, cumcensor = F,
    test.for.trend = F,
    legend.labs = c("high", "low"))
OS_univariate_SI <- ggpar(OS_univariate_SI, xlim = c(0,250))
OS_univariate_SI
```



```{r}
cox_OS_univariate_SI <- coxph(Surv(time_OS_months, death) ~ SI_CD38, data = PPBC_metadata)
summary(cox_OS_univariate_SI)
```


### stratified CD38

```{r}
PPBC_metadata <- as.data.frame(PPBC_metadata)
CD38_inv_nonprbc <- as.data.frame(CD38_inv_nonprbc)
CD38_without_lac <- as.data.frame(CD38_without_lac)
```


```{r}
sg_SI_os <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + SI_CD38, data = PPBC_metadata), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "CD38 count by study group in stroma",
    pval = T, facet.by = "SI_CD38")

sg_SI_os
```



```{r}
sg_SI_os_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + SI_CD38, data = CD38_without_lac), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "CD38 count by study group in stroma",
    pval = T, facet.by = "SI_CD38")

sg_SI_os_without_lac
```





```{r}
sg_SI_os_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + SI_CD38, data = CD38_inv_nonprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "TAPC count by study group in stroma",
    pval = T, facet.by = "SI_CD38")

sg_SI_os_short
```



### stratified subgroup


```{r}
sg_IS_os_group <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + SI_CD38, data = PPBC_metadata), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "CD38 count by study group in stroma",
    pval = T, facet.by = "group")

sg_IS_os_group
```




### within study group 

subset data low CD38+ signature versus high CD38+ signature 

```{r}
CD38_without_lac_low <- subset(CD38_without_lac, SI_CD38 %in% c("low"), )
CD38_without_lac_high <- subset(CD38_without_lac, SI_CD38 %in% c("high"), )
```

low CD38

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    group + clin_subtype,
  data = CD38_without_lac_low)
summary(clin.cov.cox)
```

```{r}
#with study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + clin_subtype + group, data = CD38_without_lac_low)
study_strata
plot_OS_CD38_low <- ggadjustedcurves(study_strata, data=CD38_without_lac_low, method="conditional", variable="group", palette = c("#46CDCF", "#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_OS_CD38_low
```


high CD38

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    group + strata(clin_subtype),
  data = CD38_without_lac_high)
summary(clin.cov.cox)
```

```{r}
#with study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + clin_subtype + group, data = CD38_without_lac_high)
study_strata
plot_OS_CD38_high <- ggadjustedcurves(study_strata, data=CD38_without_lac_high, method="conditional", variable="group", palette = c("#46CDCF", "#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_OS_CD38_high
```




## Tumor

normal : cutoff high-low based on median value of CD38+ (median = 10%)

```{r}
table(PPBC_metadata$TI_CD38)
```

```{r}
fit_OS_TI_CD38 <- survfit(surv_OS ~ TI_CD38, data = PPBC_metadata) 
```



```{r}
OS_univariate_TI <- ggsurvplot(fit_OS_TI_CD38, data = PPBC_metadata,
    xlab = "Months", 
    ylab = "OS probability",
    title =  paste0("A. OS univariate tumor"),
    #linetype = "strata",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T,
    risk.table = F,
    cumevents = F, cumcensor = F,
    test.for.trend = F,
    legend.labs = c("high", "low"))
OS_univariate_TI <- ggpar(OS_univariate_TI, xlim = c(0,250))
OS_univariate_TI
```



```{r}
cox_OS_univariate_TI <- coxph(Surv(time_OS_months, death) ~ TI_CD38, data = PPBC_metadata)
summary(cox_OS_univariate_TI)
```


### stratified CD38

```{r}
PPBC_metadata <- as.data.frame(PPBC_metadata)
CD38_inv_nonprbc <- as.data.frame(CD38_inv_nonprbc)
CD38_without_lac <- as.data.frame(CD38_without_lac)
```


```{r}
sg_TI_os <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + TI_CD38, data = PPBC_metadata), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "CD38 count by study group in tumor",
    pval = T, facet.by = "TI_CD38")

sg_TI_os
```


```{r}
sg_TI_os_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + TI_CD38, data = CD38_without_lac), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "CD38 count by study group in tumor",
    pval = T, facet.by = "TI_CD38")

sg_TI_os_without_lac
```



```{r}
sg_TI_os_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + TI_CD38, data = CD38_inv_nonprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "CD38 count by study group in tumor",
    pval = T, facet.by = "TI_CD38")

sg_TI_os_short
```




### stratified study group

```{r}
sg_TI_os_group <-  ggsurvplot(
    fit = survfit(Surv(time=time_OS_months, event=death) ~ group + TI_CD38, data = PPBC_metadata), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "CD38 count by study group in tumor",
    pval = T, facet.by = "group")

sg_TI_os_group
```



### within study group 

subset data low CD38+ signature versus high CD38+ signature 

```{r}
CD38_without_lac_low <- subset(CD38_without_lac, TI_CD38 %in% c("low"), )
CD38_without_lac_high <- subset(CD38_without_lac, TI_CD38 %in% c("high"), )
```

low CD38

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    group + clin_subtype,
  data = CD38_without_lac_low)
summary(clin.cov.cox)
```

```{r}
#with study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + clin_subtype + group, data = CD38_without_lac_low)
study_strata
plot_OS_CD38_low <- ggadjustedcurves(study_strata, data=CD38_without_lac_low, method="conditional", variable="group", palette = c("#46CDCF", "#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_OS_CD38_low
```


high CD38

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage +
    group + clin_subtype,
  data = CD38_without_lac_high)
summary(clin.cov.cox)
```

```{r}
#with study group as covariate 
study_strata <- coxph(
  Surv(time=time_OS_months,
       event=death) ~ stage + group, data = CD38_without_lac_high)
study_strata
plot_OS_CD38_high <- ggadjustedcurves(study_strata, data=CD38_without_lac_high, method="conditional", variable="group", palette = c("#46CDCF", "#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_OS_CD38_high
```




# DRS - CD38 count

```{r}
surv_DRS <- Surv(time = PPBC_metadata$time_DRS_months, event = PPBC_metadata$distant_recurrence)
fit_DRS <- survfit(surv_DRS ~ group, data = PPBC_metadata) 
```

## stroma

normal : cutoff high-low based on median value of CD38+ (median = 10%)

```{r}
table(PPBC_metadata$SI_CD38)
```

```{r}
fit_DRS_SI_CD38 <- survfit(surv_DRS ~ SI_CD38, data = PPBC_metadata) 
```



```{r}
DRS_univariate_SI <- ggsurvplot(fit_DRS_SI_CD38, data = PPBC_metadata,
    xlab = "Months", 
    ylab = "DRS probability",
    title =  paste0("A. DRS univariate stroma (n = ", nrow(PPBC_metadata), ")"),
    #linetype = "strata",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T,
    risk.table = F,
    cumevents = F, cumcensor = F,
    test.for.trend = F,
    legend.labs = c("high", "low"))
DRS_univariate_SI <- ggpar(DRS_univariate_SI, xlim = c(0,250))
DRS_univariate_SI
```


```{r}
cox_DRS_univariate_SI <- coxph(Surv(time_DRS_months, distant_recurrence) ~ SI_CD38, data = PPBC_metadata)
summary(cox_DRS_univariate_SI)
```


### stratified CD38


```{r}
sg_SI_DRS <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + SI_CD38, data = PPBC_metadata), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "CD38 count by study group in stroma",
    pval = T, facet.by = "SI_CD38")

sg_SI_DRS
```


```{r}
sg_SI_DRS_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + SI_CD38, data = CD38_without_lac), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "CD38 count by study group in stroma",
    pval = T, facet.by = "SI_CD38")

sg_SI_DRS_without_lac
```



```{r}
sg_SI_DRS_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + SI_CD38, data = CD38_inv_nonprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "CD38 count by study group in stroma",
    pval = T, facet.by = "SI_CD38")

sg_SI_DRS_short
```



### stratified subgroup

```{r}
sg_IS_DRS_group <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + SI_CD38, data = PPBC_metadata), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "CD38 count by study group in stroma",
    pval = T, facet.by = "group")

sg_IS_DRS_group
```



### within study group 

subset data low CD38+ signature versus high CD38+ signature 

```{r}
CD38_without_lac_low <- subset(CD38_without_lac, SI_CD38 %in% c("low"), )
CD38_without_lac_high <- subset(CD38_without_lac, SI_CD38 %in% c("high"), )
```

low CD38

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    group + clin_subtype,
  data = CD38_without_lac_low)
summary(clin.cov.cox)
```

```{r}
#with study group as covariate 
study_strata <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage + clin_subtype + group, data = CD38_without_lac_low)
study_strata
plot_DRS_CD38_low <- ggadjustedcurves(study_strata, data=CD38_without_lac_low, method="conditional", variable="group", palette = c("#46CDCF", "#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_DRS_CD38_low
```


high CD38

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    group + clin_subtype,
  data = CD38_without_lac_high)
summary(clin.cov.cox)
```

```{r}
#with study group as covariate 
study_strata <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage + clin_subtype + group, data = CD38_without_lac_high)
study_strata
plot_DRS_CD38_high <- ggadjustedcurves(study_strata, data=CD38_without_lac_high, method="conditional", variable="group", palette = c("#46CDCF", "#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_DRS_CD38_high
```


## tumor

normal : cutoff high-low based on median value of CD38+ (median = 10%)

```{r}
table(PPBC_metadata$TI_CD38)
```

```{r}
fit_DRS_TI_CD38 <- survfit(surv_DRS ~ TI_CD38, data = PPBC_metadata) 
```



```{r}
DRS_univariate_TI <- ggsurvplot(fit_DRS_TI_CD38, data = PPBC_metadata,
    xlab = "Months", 
    ylab = "DRS probability",
    title =  paste0("A. DRS univariate tumor (n = ", nrow(PPBC_metadata), ")"),
    #linetype = "strata",
    palette = c("#a10702", "#ffb600"),
    ggtheme = theme_bw(),
    pval = T,
    risk.table = F,
    cumevents = F, cumcensor = F,
    test.for.trend = F,
    legend.labs = c("high", "low"))
DRS_univariate_TI <- ggpar(DRS_univariate_TI, xlim = c(0,250))
DRS_univariate_TI
```


```{r}
cox_DRS_univariate_TI <- coxph(Surv(time_DRS_months, distant_recurrence) ~ TI_CD38, data = PPBC_metadata)
summary(cox_DRS_univariate_TI)
```


### stratified CD38


```{r}
sg_TI_DRS <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + TI_CD38, data = PPBC_metadata), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "CD38 count by study group in tumor",
    pval = T, facet.by = "TI_CD38")

sg_TI_DRS
```


```{r}
sg_TI_DRS_without_lac <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + TI_CD38, data = CD38_without_lac), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "CD38 count by study group in tumor",
    pval = T, facet.by = "TI_CD38")

sg_TI_DRS_without_lac
```



```{r}
sg_TI_DRS_short <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + TI_CD38, data = CD38_inv_nonprbc), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "CD38 count by study group in tumor",
    pval = T, facet.by = "TI_CD38")

sg_TI_DRS_short
```



### stratified study group

```{r}
sg_TI_DRS_group <-  ggsurvplot(
    fit = survfit(Surv(time=time_DRS_months, event=distant_recurrence) ~ group + TI_CD38, data = PPBC_metadata), 
    xlab = "Months", 
    ylab = "Overall survival probability",
    title = "CD38 count by study group in tumor",
    pval = T, facet.by = "group")

sg_TI_DRS_group
```



### within study group 

subset data low CD38+ signature versus high CD38+ signature 

```{r}
CD38_without_lac_low <- subset(CD38_without_lac, TI_CD38 %in% c("low"), )
CD38_without_lac_high <- subset(CD38_without_lac, TI_CD38 %in% c("high"), )
```

low CD38

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    group + clin_subtype,
  data = CD38_without_lac_low)
summary(clin.cov.cox)
```

```{r}
#with study group as covariate 
study_strata <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage + clin_subtype + group, data = CD38_without_lac_low)
study_strata
plot_DRS_CD38_low <- ggadjustedcurves(study_strata, data=CD38_without_lac_low, method="conditional", variable="group", palette = c("#46CDCF", "#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_DRS_CD38_low
```


high CD38

```{r}
clin.cov.cox <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage +
    group + clin_subtype,
  data = CD38_without_lac_high)
summary(clin.cov.cox)
```

```{r}
#with study group as covariate 
study_strata <- coxph(
  Surv(time=time_DRS_months,
       event=distant_recurrence) ~ stage + clin_subtype + group, data = CD38_without_lac_high)
study_strata
plot_DRS_CD38_high <- ggadjustedcurves(study_strata, data=CD38_without_lac_high, method="conditional", variable="group", palette = c("#46CDCF", "#AA96DA", "#521262"), ggtheme = theme_bw()) +
  ggtitle("Adjusted survival curve for clinical covariates: Stratified")
plot_DRS_CD38_high
```



