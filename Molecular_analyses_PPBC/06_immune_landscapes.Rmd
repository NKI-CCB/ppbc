---
title: "Immune Landscapes"
author: "Hanne Lefrere"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    df_print: paged
---

```{r, include=F}
rm(list = ls())
```

```{r, include=F}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(rstatix)
library(pheatmap)
library(ComplexHeatmap)
library(circlize)
library(RColorBrewer)
library(dendsort)
library(tibble)
library(EnhancedVolcano)
library(survminer)
library(survival)
library(tidyverse)
library(Biobase)
library(scrime)
library(TCGAbiolinks)
library(ImmuneSubtypeClassifier)
library(writexl)
library(tximport)
library(readxl)
library(here)
library(Hmisc)
library(ggalluvial)
library(ggsankey)
library(treemap)
library(ggplot2)
library(tidyverse)
library(readxl)
library(tximport)
library(here)
library(tidyr)
library(gplots)
library(grid)
library(vcd)
library(corrplot)
library(ca)
library(scales)
library(ggthemes)
library(ztable)
library(devtools)
library(ggpubr)
library(multcomp)
library(car)
library(ggpubr)
library(multcomp)
library(rstatix)
```


```{r}
?callEnsemble
```



# Load the data

read in meta-file 
```{r}
meta <- read_excel("PPBC_metadata_20220807.xlsx", sheet = "patient_data")
```

```{r}
npbc <- meta[meta$study_group == c('npbc'),]
ppbcdl <- meta[meta$study_group == c('ppbcdl'),]
ppbcpw <- meta[meta$study_group == c('ppbcpw'),]
prbc <- meta[meta$study_group == c('prbc'),]
```


load count matrix file 

```{r}
hugo_mat <- read_tsv(here("hugo_fpkm.txt"))
```

```{r}
hugo_mat[1:4, 1:4] 
```

```{r}
X <- column_to_rownames(hugo_mat, var = 'GeneSymbol')
```

```{r}
X[1:4, 1:4] 
```

```{r}
X <- as.matrix(X)
```




```{r}
calls <- callEnsemble(X, geneid = 'symbol')
```



```{r}
immune_signature <- calls
```

```{r}
calls <- calls[, c(1, 2)]
```


```{r}
#calls <- calls %>% select(SampleIDs, BestCall)
```

```{r}
calls$cluster <- NA
calls$SampleIDs <- as.character(calls$SampleIDs)

calls <- calls %>%
  mutate(cluster = case_when(
    startsWith(SampleIDs, "non_prbc") ~ "npbc",
    startsWith(SampleIDs, "prbc") ~ "prbc",
    startsWith(SampleIDs, "ppbc_inv") ~ "ppbcpw",
    startsWith(SampleIDs, "ppbc_lac") ~ "ppbcdl"
    ))
```

```{r}
immune_signature$cluster <- NA
immune_signature$SampleIDs <- as.character(immune_signature$SampleIDs)

immune_signature <- immune_signature %>%
  mutate(cluster = case_when(
    startsWith(SampleIDs, "non_prbc") ~ "npbc",
    startsWith(SampleIDs, "prbc") ~ "prbc",
    startsWith(SampleIDs, "ppbc_inv") ~ "ppbcpw",
    startsWith(SampleIDs, "ppbc_lac") ~ "ppbcdl"
    ))
```


```{r}
calls_df <- calls %>%
  mutate(cluster = case_when(
    startsWith(SampleIDs, "non_prbc") ~ "npbc",
    startsWith(SampleIDs, "prbc") ~ "prbc",
    startsWith(SampleIDs, "ppbc_inv") ~ "ppbcpw",
    startsWith(SampleIDs, "ppbc_lac") ~ "ppbcdl"
    ))
```



```{r}
calls_df <- na.omit(calls_df)
```

```{r}
calls_df <- as.vector(calls_df)
```


```{r}
calls_df <- count(calls_df, cluster, BestCall)
```


```{r}
calls_df$Subtype <- NA
calls_df$Subtype[calls_df$BestCall == '1'] <- 'Wound healing'
calls_df$Subtype[calls_df$BestCall == '2'] <- 'IFNg dominant'
calls_df$Subtype[calls_df$BestCall == '3'] <- 'Inflammatory'
calls_df$Subtype[calls_df$BestCall == '4'] <- 'Lymphocyte depleted'
calls_df$Subtype[calls_df$BestCall == '5'] <- 'Immunologically quiet'
calls_df$Subtype[calls_df$BestCall == '6'] <- 'TGFb dominant'
```


```{r}
treemap(calls_df,
        index=c("cluster","Subtype"),
        vSize="n",
        type="index")
```


# ggplot

## PP-BCPW


```{r}
#Create test data
data_ppbcpw <- data.frame(
  category=c("Wound healing", "IFNg dominant", "Inflammatory", "Lymphocyte depleted", "Immunologically quiet", "TGFb dominant"),
  count=c(2, 24, 26, 9, 0, 5)
)

#Compute percentages
data_ppbcpw$fraction = data_ppbcpw$count / sum(data_ppbcpw$count)

#Compute the cumulative percentages (top of each rectangle)
data_ppbcpw$ymax = cumsum(data_ppbcpw$fraction)

# Compute the bottom of each rectangle
data_ppbcpw$ymin = c(0, head(data_ppbcpw$ymax, n=-1))

# Compute label position
data_ppbcpw$labelPosition <- (data_ppbcpw$ymax + data_ppbcpw$ymin) / 2

# Make the plot
immune_ppbcpw <- ggplot(data_ppbcpw, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=category)) +
     geom_rect() +
     coord_polar(theta="y") + # Try to remove that to understand how the chart is built initially
     xlim(c(1, 4)) #+ # Try to remove that to see how to make a pie chart
  #scale_fill_brewer(palette=5) +
  #scale_color_brewer(palette=5) 
immune_ppbcpw
```



## NPBC


```{r}
#Create test data
data_npbc <- data.frame(
  category=c("Wound healing", "IFNg dominant", "Inflammatory", "Lymphocyte depleted", "Immunologically quiet", "TGFb dominant"),
  count=c(5, 21, 27, 20, 0, 3)
)

#Compute percentages
data_npbc$fraction = data_npbc$count / sum(data_npbc$count)

#Compute the cumulative percentages (top of each rectangle)
data_npbc$ymax = cumsum(data_npbc$fraction)

# Compute the bottom of each rectangle
data_npbc$ymin = c(0, head(data_npbc$ymax, n=-1))

# Make the plot
immune_npbc <- ggplot(data_npbc, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=category)) +
     geom_rect() +
     coord_polar(theta="y") + # Try to remove that to understand how the chart is built initially
     xlim(c(1, 4)) #+ # Try to remove that to see how to make a pie chart
  #scale_fill_brewer(palette=3) +
  #scale_color_brewer(palette=3) 
immune_npbc
```




## PP-BCDL


```{r}
#Create test data
data_ppbcdl <- data.frame(
  category=c("Wound healing", "IFNg dominant", "Inflammatory", "Lymphocyte depleted", "Immunologically quiet", "TGFb dominant"),
  count=c(1, 4, 5, 6, 0, 2)
)

#Compute percentages
data_ppbcdl$fraction = data_ppbcdl$count / sum(data_ppbcdl$count)

#Compute the cumulative percentages (top of each rectangle)
data_ppbcdl$ymax = cumsum(data_ppbcdl$fraction)

# Compute the bottom of each rectangle
data_ppbcdl$ymin = c(0, head(data_ppbcdl$ymax, n=-1))

# Make the plot
immune_ppbcdl <- ggplot(data_ppbcdl, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=category)) +
     geom_rect() +
     coord_polar(theta="y") + # Try to remove that to understand how the chart is built initially
     xlim(c(1, 4))# + # Try to remove that to see how to make a pie chart
  #scale_fill_brewer(palette=3) +
  #scale_color_brewer(palette=3) 
immune_ppbcdl
```


## PrBC


```{r}
#Create test data
data_prbc <- data.frame(
  category=c("Wound healing", "IFNg dominant", "Inflammatory", "Lymphocyte depleted", "Immunologically quiet", "TGFb dominant"),
  count=c(0, 15, 10, 24, 0, 2)
)

#Compute percentages
data_prbc$fraction = data_prbc$count / sum(data_prbc$count)

#Compute the cumulative percentages (top of each rectangle)
data_prbc$ymax = cumsum(data_prbc$fraction)

# Compute the bottom of each rectangle
data_prbc$ymin = c(0, head(data_prbc$ymax, n=-1))

# Make the plot
immune_prbc <- ggplot(data_prbc, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=category)) +
     geom_rect() +
     coord_polar(theta="y") + # Try to remove that to understand how the chart is built initially
     xlim(c(1, 4)) #+ # Try to remove that to see how to make a pie chart
  #scale_fill_brewer(palette=3) +
  #scale_color_brewer(palette=3) 
immune_prbc
```




# ANOVA 

rename cluster 1-6

```{r}
immune_signature <- immune_signature %>% 
  rename(
    wound_healing = 3,
    IFNy_dominant = 4,
    inflammatory = 5,
    lymphocyte_depleted = 6,
    immunologically_quiet = 7,
    TGFb_dominant = 8
    )
immune_signature
```


```{r}
#immune_signature <- subset(immune_signature, cluster %in% c("ppbcpw", "ppbcdl", "prbc", "npbc"), )
```


```{r}
immune_signature$cluster <- ordered(immune_signature$cluster,
                                levels = c("ppbcpw", "ppbcdl", "prbc", "npbc"))
table(immune_signature$cluster)
```



## Wound healing 

```{r}
group_by(immune_signature, cluster) %>%
  summarise(
    count = n(),
    mean = mean(wound_healing, na.rm = TRUE),
    sd = sd(wound_healing, na.rm = TRUE)
  )
```


Remove NA values
```{r}
immune_signature <- immune_signature[!is.na(immune_signature$wound_healing),]

group_by(immune_signature, cluster) %>%
  summarise(
    count = n(),
    mean = mean(wound_healing, na.rm = TRUE),
    sd = sd(wound_healing, na.rm = TRUE)
  )
```


Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(immune_signature$wound_healing)
```


```{r}
outliers_wound_healing <- boxplot(immune_signature$wound_healing, plot=FALSE)$out
```

Remove outliers
```{r}
immune_signature_wound_healing <- immune_signature
immune_signature_wound_healing <- immune_signature_wound_healing[-which(immune_signature_wound_healing$wound_healing %in% outliers_wound_healing),]
```


Compute one-way ANOVA
As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.
```{r}
# compute the analysis of variance
res.aov.wound_healing <- aov(wound_healing ~ cluster, data = immune_signature_wound_healing)
# summary of the analysis
summary(res.aov.wound_healing)
```


Tukey multiple pairwise-comparisons
As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.
with outliers:
```{r}
TukeyHSD(res.aov.wound_healing)
```

```{r}
pwc_wound_healing <- immune_signature_wound_healing %>% tukey_hsd(wound_healing ~ cluster)
pwc_wound_healing
```



Multiple comparisons using multicomp packwound_healing
t’s possible to use the function glht() [in multcomp packwound_healing] to perform multiple comparison procedures for an ANOVA. glht stands for general linear hypothesis tests. The simplified format is as follow:
```{r}
#summary(glht(res.aov.wound_healing, linfct = mcp(cluster = "Tukey")))
```


Pairwise t-test
The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.
```{r}
pairwise.t.test(immune_signature_wound_healing$wound_healing, immune_signature_wound_healing$cluster,
                 p.adjust.method = "BH")
```


Check ANOVA assumptions: test validity? 
The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.
homogeneity of variance assumption
```{r}
plot(res.aov.wound_healing, 1)
```

```{r}
leveneTest(wound_healing ~ cluster, data = immune_signature_wound_healing)
```

From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption
How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?
An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().
```{r}
# ANOVA test with no assumption of equal variances
oneway.test(wound_healing ~ cluster, data = immune_signature_wound_healing)
```

```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(immune_signature_wound_healing$wound_healing, immune_signature_wound_healing$cluster,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption
Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.
The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.
```{r}
plot(res.aov.wound_healing, 2)

model_wound_healing <- lm(wound_healing ~ cluster, data=immune_signature_wound_healing)
ggqqplot(residuals(model_wound_healing))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.
```{r}
# Extract the reisudals 
aov_residuals_wound_healing <- residuals(object = res.aov.wound_healing)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_wound_healing)
shapiro_test(residuals(model_wound_healing))
```

Check normality assumption by groups. Computing Shapiro-Wilk test for each group level. If the data is normally distributed, the p-value should be greater than 0.05.
```{r}
immune_signature_wound_healing %>%
  group_by(cluster) %>%
  shapiro_test(wound_healing)

ggqqplot(immune_signature_wound_healing, "wound_healing", facet.by = "cluster")
```


Non-parametric alternative to one-way ANOVA test
Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.
```{r}
kruskal.test(wound_healing ~ cluster, data = immune_signature_wound_healing)
```

```{r}
table(immune_signature_wound_healing$cluster)
```


```{r}
my_comparisons <- list( c("ppbcpw", "ppbcdl"), c("ppbcpw", "prbc"), c("ppbcpw", "npbc") )
```


Visualization
```{r, fig.width=7, fig.height=4.5}
pwc_wound_healing <- pwc_wound_healing %>% add_xy_position(x = "cluster")

ggboxplot(immune_signature_wound_healing, x="cluster", y="wound_healing",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "wound_healing at Diagnosis", xlab = "Study Group", lwd = 1) + stat_compare_means(method = "anova") + stat_pvalue_manual(pwc_wound_healing, hide.ns = TRUE) 

ggline(immune_signature_wound_healing, x= "cluster", y= "wound_healing",
       add = c("mean_se", "jitter"),
       order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
       ylab = "wound_healing at Diagnosis", xlab = "Study Group") + stat_compare_means(method = "anova")

ANOVA_wound_healing <- ggboxplot(immune_signature_wound_healing, x="cluster", y="wound_healing",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "wound_healing at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.00015, aes(colour = cluster)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.01) #) + ylim(0,0.01) + stat_pvalue_manual(pwc_wound_healing, hide.ns = TRUE, y.position = c(0.015))
ANOVA_wound_healing
```

```{r}
ANOVA_wound_healing <- ggboxplot(immune_signature_wound_healing, x="cluster", y="wound_healing",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "wound_healing at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.00015, aes(colour = cluster)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.01) + ylim(0, 0.01) #) + ylim(0,0.01) + stat_pvalue_manual(pwc_wound_healing, hide.ns = TRUE, y.position = c(0.015))
ANOVA_wound_healing
```


## IFNy dominant

```{r}
group_by(immune_signature, cluster) %>%
  summarise(
    count = n(),
    mean = mean(IFNy_dominant, na.rm = TRUE),
    sd = sd(IFNy_dominant, na.rm = TRUE)
  )
```


Remove NA values
```{r}
immune_signature <- immune_signature[!is.na(immune_signature$IFNy_dominant),]

group_by(immune_signature, cluster) %>%
  summarise(
    count = n(),
    mean = mean(IFNy_dominant, na.rm = TRUE),
    sd = sd(IFNy_dominant, na.rm = TRUE)
  )
```


Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(immune_signature$IFNy_dominant)
```


```{r}
outliers_IFNy_dominant <- boxplot(immune_signature$IFNy_dominant, plot=FALSE)$out
```

Remove outliers
```{r}
immune_signature_IFNy_dominant <- immune_signature
immune_signature_IFNy_dominant <- immune_signature_IFNy_dominant[-which(immune_signature_IFNy_dominant$IFNy_dominant %in% outliers_IFNy_dominant),]
```


Compute one-way ANOVA
As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.
```{r}
# compute the analysis of variance
res.aov.IFNy_dominant <- aov(IFNy_dominant ~ cluster, data = immune_signature_IFNy_dominant)
# summary of the analysis
summary(res.aov.IFNy_dominant)
```


Tukey multiple pairwise-comparisons
As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.
with outliers:
```{r}
TukeyHSD(res.aov.IFNy_dominant)
```

```{r}
pwc_IFNy_dominant <- immune_signature_IFNy_dominant %>% tukey_hsd(IFNy_dominant ~ cluster)
pwc_IFNy_dominant
```



Multiple comparisons using multicomp packIFNy_dominant
t’s possible to use the function glht() [in multcomp packIFNy_dominant] to perform multiple comparison procedures for an ANOVA. glht stands for general linear hypothesis tests. The simplified format is as follow:
```{r}
#summary(glht(res.aov.IFNy_dominant, linfct = mcp(cluster = "Tukey")))
```


Pairwise t-test
The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.
```{r}
pairwise.t.test(immune_signature_IFNy_dominant$IFNy_dominant, immune_signature_IFNy_dominant$cluster,
                 p.adjust.method = "BH")
```


Check ANOVA assumptions: test validity? 
The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.
homogeneity of variance assumption
```{r}
plot(res.aov.IFNy_dominant, 1)
```

```{r}
leveneTest(IFNy_dominant ~ cluster, data = immune_signature_IFNy_dominant)
```

From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption
How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?
An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().
```{r}
# ANOVA test with no assumption of equal variances
oneway.test(IFNy_dominant ~ cluster, data = immune_signature_IFNy_dominant)
```

```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(immune_signature_IFNy_dominant$IFNy_dominant, immune_signature_IFNy_dominant$cluster,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption
Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.
The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.
```{r}
plot(res.aov.IFNy_dominant, 2)

model_IFNy_dominant <- lm(IFNy_dominant ~ cluster, data=immune_signature_IFNy_dominant)
ggqqplot(residuals(model_IFNy_dominant))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.
```{r}
# Extract the reisudals 
aov_residuals_IFNy_dominant <- residuals(object = res.aov.IFNy_dominant)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_IFNy_dominant)
shapiro_test(residuals(model_IFNy_dominant))
```

Check normality assumption by groups. Computing Shapiro-Wilk test for each group level. If the data is normally distributed, the p-value should be greater than 0.05.
```{r}
immune_signature_IFNy_dominant %>%
  group_by(cluster) %>%
  shapiro_test(IFNy_dominant)

ggqqplot(immune_signature_IFNy_dominant, "IFNy_dominant", facet.by = "cluster")
```


Non-parametric alternative to one-way ANOVA test
Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.
```{r}
kruskal.test(IFNy_dominant ~ cluster, data = immune_signature_IFNy_dominant)
```

```{r}
table(immune_signature_IFNy_dominant$cluster)
```


Visualization
```{r, fig.width=7, fig.height=4.5}
pwc_IFNy_dominant <- pwc_IFNy_dominant %>% add_xy_position(x = "cluster")
my_comparisons <- list( c("ppbcpw", "ppbcdl"), c("ppbcpw", "prbc"), c("ppbcpw", "npbc") )


ggboxplot(immune_signature_IFNy_dominant, x="cluster", y="IFNy_dominant",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "IFNy_dominant at Diagnosis", xlab = "Study Group", lwd = 1) + stat_compare_means(method = "anova") + stat_pvalue_manual(pwc_IFNy_dominant, hide.ns = TRUE) 

ggline(immune_signature_IFNy_dominant, x= "cluster", y= "IFNy_dominant",
       add = c("mean_se", "jitter"),
       order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
       ylab = "IFNy_dominant at Diagnosis", xlab = "Study Group") + stat_compare_means(method = "anova")

ANOVA_IFNy_dominant <- ggboxplot(immune_signature_IFNy_dominant, x="cluster", y="IFNy_dominant",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "IFNy_dominant at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.001, aes(colour = cluster)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.8) # + ylim(0, 0.01)# ) + ylim(0, 0.06) + stat_pvalue_manual(pwc_IFNy_dominant, hide.ns = TRUE, y.position = c(0.06))
ANOVA_IFNy_dominant
```

```{r}
ANOVA_IFNy_dominant <- ggboxplot(immune_signature_IFNy_dominant, x="cluster", y="IFNy_dominant",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "IFNy_dominant at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.008, aes(colour = cluster)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.8)  + ylim(0, 0.4)# ) + ylim(0, 0.06) + stat_pvalue_manual(pwc_IFNy_dominant, hide.ns = TRUE, y.position = c(0.06))
ANOVA_IFNy_dominant
```


## Inflammatory

```{r}
group_by(immune_signature, cluster) %>%
  summarise(
    count = n(),
    mean = mean(inflammatory, na.rm = TRUE),
    sd = sd(inflammatory, na.rm = TRUE)
  )
```


Remove NA values
```{r}
immune_signature <- immune_signature[!is.na(immune_signature$inflammatory),]

group_by(immune_signature, cluster) %>%
  summarise(
    count = n(),
    mean = mean(inflammatory, na.rm = TRUE),
    sd = sd(inflammatory, na.rm = TRUE)
  )
```


Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(immune_signature$inflammatory)
```

```{r}
boxplot(immune_signature$inflammatory, plot=FALSE)$out
```

No outliers
```{r}
immune_signature_inflammatory <- immune_signature
```



Compute one-way ANOVA
As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.
```{r}
# compute the analysis of variance
res.aov.inflammatory <- aov(inflammatory ~ cluster, data = immune_signature_inflammatory)
# summary of the analysis
summary(res.aov.inflammatory)
```


Tukey multiple pairwise-comparisons
As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.
with outliers:
```{r}
#TukeyHSD(res.aov.inflammatory)
```

```{r}
pwc_inflammatory <- immune_signature_inflammatory %>% tukey_hsd(inflammatory ~ cluster)
pwc_inflammatory
```



Multiple comparisons using multicomp packinflammatory
t’s possible to use the function glht() [in multcomp packinflammatory] to perform multiple comparison procedures for an ANOVA. glht stands for general linear hypothesis tests. The simplified format is as follow:
```{r}
#summary(glht(res.aov.inflammatory, linfct = mcp(cluster = "Tukey")))
```


Pairwise t-test
The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.
```{r}
pairwise.t.test(immune_signature_inflammatory$inflammatory, immune_signature_inflammatory$cluster,
                 p.adjust.method = "BH")
```


Check ANOVA assumptions: test validity? 
The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.
homogeneity of variance assumption
```{r}
plot(res.aov.inflammatory, 1)
```

```{r}
leveneTest(inflammatory ~ cluster, data = immune_signature_inflammatory)
```

From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption
How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?
An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().
```{r}
# ANOVA test with no assumption of equal variances
oneway.test(inflammatory ~ cluster, data = immune_signature_inflammatory)
```

```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(immune_signature_inflammatory$inflammatory, immune_signature_inflammatory$cluster,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption
Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.
The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.
```{r}
plot(res.aov.inflammatory, 2)

model_inflammatory <- lm(inflammatory ~ cluster, data=immune_signature_inflammatory)
ggqqplot(residuals(model_inflammatory))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.
```{r}
# Extract the reisudals 
aov_residuals_inflammatory <- residuals(object = res.aov.inflammatory)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_inflammatory)
shapiro_test(residuals(model_inflammatory))
```

Check normality assumption by groups. Computing Shapiro-Wilk test for each group level. If the data is normally distributed, the p-value should be greater than 0.05.
```{r}
immune_signature_inflammatory %>%
  group_by(cluster) %>%
  shapiro_test(inflammatory)

ggqqplot(immune_signature_inflammatory, "inflammatory", facet.by = "cluster")
```


Non-parametric alternative to one-way ANOVA test
Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.
```{r}
kruskal.test(inflammatory ~ cluster, data = immune_signature_inflammatory)
```

```{r}
table(immune_signature_inflammatory$cluster)
```


Visualization
```{r, fig.width=7, fig.height=4.5}
pwc_inflammatory <- pwc_inflammatory %>% add_xy_position(x = "cluster")
my_comparisons <- list( c("ppbcpw", "ppbcdl"), c("ppbcpw", "prbc"), c("ppbcpw", "npbc") )

ggboxplot(immune_signature_inflammatory, x="cluster", y="inflammatory",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "inflammatory at Diagnosis", xlab = "Study Group", lwd = 1) + stat_compare_means(method = "anova") + stat_pvalue_manual(pwc_inflammatory, hide.ns = TRUE) 

ggline(immune_signature_inflammatory, x= "cluster", y= "inflammatory",
       add = c("mean_se", "jitter"),
       order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
       ylab = "inflammatory at Diagnosis", xlab = "Study Group") + stat_compare_means(method = "anova")

ANOVA_inflammatory <- ggboxplot(immune_signature_inflammatory, x="cluster", y="inflammatory",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "inflammatory at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.012, aes(colour = cluster)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 1.0) #  + ylim(0, 1)# ) + ylim(0, 0.06)
ANOVA_inflammatory
```

```{r}
ANOVA_inflammatory <- ggboxplot(immune_signature_inflammatory, x="cluster", y="inflammatory",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "inflammatory at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.012, aes(colour = cluster)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.8)  + ylim(0, 0.7)# ) + ylim(0, 0.06)
ANOVA_inflammatory
```


## lymphocyte_depleted

```{r}
group_by(immune_signature, cluster) %>%
  summarise(
    count = n(),
    mean = mean(lymphocyte_depleted, na.rm = TRUE),
    sd = sd(lymphocyte_depleted, na.rm = TRUE)
  )
```


Remove NA values
```{r}
immune_signature <- immune_signature[!is.na(immune_signature$lymphocyte_depleted),]

group_by(immune_signature, cluster) %>%
  summarise(
    count = n(),
    mean = mean(lymphocyte_depleted, na.rm = TRUE),
    sd = sd(lymphocyte_depleted, na.rm = TRUE)
  )
```


Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(immune_signature$lymphocyte_depleted)
boxplot(immune_signature$lymphocyte_depleted, plot=FALSE)$out
```


```{r}
outliers_lymphocyte_depleted <- boxplot(immune_signature$lymphocyte_depleted, plot=FALSE)$out
```

Remove outliers
```{r}
immune_signature_lymphocyte_depleted <- immune_signature
immune_signature_lymphocyte_depleted <- immune_signature_lymphocyte_depleted[-which(immune_signature_lymphocyte_depleted$lymphocyte_depleted %in% outliers_lymphocyte_depleted),]
```


Compute one-way ANOVA
As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.
```{r}
# compute the analysis of variance
res.aov.lymphocyte_depleted <- aov(lymphocyte_depleted ~ cluster, data = immune_signature_lymphocyte_depleted)
# summary of the analysis
summary(res.aov.lymphocyte_depleted)
```


Tukey multiple pairwise-comparisons
As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.
with outliers:
```{r}
TukeyHSD(res.aov.lymphocyte_depleted)
```

```{r}
pwc_lymphocyte_depleted <- immune_signature_lymphocyte_depleted %>% tukey_hsd(lymphocyte_depleted ~ cluster)
pwc_lymphocyte_depleted
```



Multiple comparisons using multicomp packlymphocyte_depleted
t’s possible to use the function glht() [in multcomp packlymphocyte_depleted] to perform multiple comparison procedures for an ANOVA. glht stands for general linear hypothesis tests. The simplified format is as follow:
```{r}
#summary(glht(res.aov.lymphocyte_depleted, linfct = mcp(cluster = "Tukey")))
```


Pairwise t-test
The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.
```{r}
pairwise.t.test(immune_signature_lymphocyte_depleted$lymphocyte_depleted, immune_signature_lymphocyte_depleted$cluster,
                 p.adjust.method = "BH")
```


Check ANOVA assumptions: test validity? 
The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.
homogeneity of variance assumption
```{r}
plot(res.aov.lymphocyte_depleted, 1)
```

```{r}
leveneTest(lymphocyte_depleted ~ cluster, data = immune_signature_lymphocyte_depleted)
```

From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption
How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?
An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().
```{r}
# ANOVA test with no assumption of equal variances
oneway.test(lymphocyte_depleted ~ cluster, data = immune_signature_lymphocyte_depleted)
```

```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(immune_signature_lymphocyte_depleted$lymphocyte_depleted, immune_signature_lymphocyte_depleted$cluster,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption
Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.
The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.
```{r}
plot(res.aov.lymphocyte_depleted, 2)

model_lymphocyte_depleted <- lm(lymphocyte_depleted ~ cluster, data=immune_signature_lymphocyte_depleted)
ggqqplot(residuals(model_lymphocyte_depleted))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.
```{r}
# Extract the reisudals 
aov_residuals_lymphocyte_depleted <- residuals(object = res.aov.lymphocyte_depleted)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_lymphocyte_depleted)
shapiro_test(residuals(model_lymphocyte_depleted))
```

Check normality assumption by groups. Computing Shapiro-Wilk test for each group level. If the data is normally distributed, the p-value should be greater than 0.05.
```{r}
immune_signature_lymphocyte_depleted %>%
  group_by(cluster) %>%
  shapiro_test(lymphocyte_depleted)

ggqqplot(immune_signature_lymphocyte_depleted, "lymphocyte_depleted", facet.by = "cluster")
```


Non-parametric alternative to one-way ANOVA test
Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.
```{r}
kruskal.test(lymphocyte_depleted ~ cluster, data = immune_signature_lymphocyte_depleted)
```

```{r}
table(immune_signature_lymphocyte_depleted$cluster)
```


Visualization
```{r, fig.width=7, fig.height=4.5}
pwc_lymphocyte_depleted <- pwc_lymphocyte_depleted %>% add_xy_position(x = "cluster")
my_comparisons <- list( c("ppbcpw", "ppbcdl"), c("ppbcpw", "prbc"), c("ppbcpw", "npbc") )

ggboxplot(immune_signature_lymphocyte_depleted, x="cluster", y="lymphocyte_depleted",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "lymphocyte_depleted at Diagnosis", xlab = "Study Group", lwd = 1) + stat_compare_means(method = "anova") + stat_pvalue_manual(pwc_lymphocyte_depleted, hide.ns = TRUE) 

ggline(immune_signature_lymphocyte_depleted, x= "cluster", y= "lymphocyte_depleted",
       add = c("mean_se", "jitter"),
       order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
       ylab = "lymphocyte_depleted at Diagnosis", xlab = "Study Group") + stat_compare_means(method = "anova")

ANOVA_lymphocyte_depleted <- ggboxplot(immune_signature_lymphocyte_depleted, x="cluster", y="lymphocyte_depleted",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "lymphocyte_depleted at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.01, aes(colour = cluster)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.8) # + ylim(0, 0.7)# ) + ylim(0, 0.06)
ANOVA_lymphocyte_depleted
```

```{r}
ANOVA_lymphocyte_depleted <- ggboxplot(immune_signature_lymphocyte_depleted, x="cluster", y="lymphocyte_depleted",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "lymphocyte_depleted at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.01, aes(colour = cluster)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.8) + ylim(0, 0.7)# ) + ylim(0, 0.06)
ANOVA_lymphocyte_depleted
```


## immunologically_quiet

```{r}
group_by(immune_signature, cluster) %>%
  summarise(
    count = n(),
    mean = mean(immunologically_quiet, na.rm = TRUE),
    sd = sd(immunologically_quiet, na.rm = TRUE)
  )
```


Remove NA values
```{r}
immune_signature <- immune_signature[!is.na(immune_signature$immunologically_quiet),]

group_by(immune_signature, cluster) %>%
  summarise(
    count = n(),
    mean = mean(immunologically_quiet, na.rm = TRUE),
    sd = sd(immunologically_quiet, na.rm = TRUE)
  )
```


Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(immune_signature$immunologically_quiet)
```


```{r}
outliers_immunologically_quiet <- boxplot(immune_signature$immunologically_quiet, plot=FALSE)$out
```

Remove outliers
```{r}
immune_signature_immunologically_quiet <- immune_signature
immune_signature_immunologically_quiet <- immune_signature_immunologically_quiet[-which(immune_signature_immunologically_quiet$immunologically_quiet %in% outliers_immunologically_quiet),]
```


Compute one-way ANOVA
As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.
```{r}
# compute the analysis of variance
res.aov.immunologically_quiet <- aov(immunologically_quiet ~ cluster, data = immune_signature_immunologically_quiet)
# summary of the analysis
summary(res.aov.immunologically_quiet)
```


Tukey multiple pairwise-comparisons
As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.
with outliers:
```{r}
TukeyHSD(res.aov.immunologically_quiet)
```

```{r}
pwc_immunologically_quiet <- immune_signature_immunologically_quiet %>% tukey_hsd(immunologically_quiet ~ cluster)
pwc_immunologically_quiet
```



Multiple comparisons using multicomp packimmunologically_quiet
t’s possible to use the function glht() [in multcomp packimmunologically_quiet] to perform multiple comparison procedures for an ANOVA. glht stands for general linear hypothesis tests. The simplified format is as follow:
```{r}
#summary(glht(res.aov.immunologically_quiet, linfct = mcp(cluster = "Tukey")))
```


Pairwise t-test
The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.
```{r}
pairwise.t.test(immune_signature_immunologically_quiet$immunologically_quiet, immune_signature_immunologically_quiet$cluster,
                 p.adjust.method = "BH")
```


Check ANOVA assumptions: test validity? 
The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.
homogeneity of variance assumption
```{r}
plot(res.aov.immunologically_quiet, 1)
```

```{r}
leveneTest(immunologically_quiet ~ cluster, data = immune_signature_immunologically_quiet)
```

From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption
How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?
An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().
```{r}
# ANOVA test with no assumption of equal variances
oneway.test(immunologically_quiet ~ cluster, data = immune_signature_immunologically_quiet)
```

```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(immune_signature_immunologically_quiet$immunologically_quiet, immune_signature_immunologically_quiet$cluster,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption
Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.
The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.
```{r}
plot(res.aov.immunologically_quiet, 2)

model_immunologically_quiet <- lm(immunologically_quiet ~ cluster, data=immune_signature_immunologically_quiet)
ggqqplot(residuals(model_immunologically_quiet))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.
```{r}
# Extract the reisudals 
aov_residuals_immunologically_quiet <- residuals(object = res.aov.immunologically_quiet)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_immunologically_quiet)
shapiro_test(residuals(model_immunologically_quiet))
```

Check normality assumption by groups. Computing Shapiro-Wilk test for each group level. If the data is normally distributed, the p-value should be greater than 0.05.
```{r}
immune_signature_immunologically_quiet %>%
  group_by(cluster) %>%
  shapiro_test(immunologically_quiet)

ggqqplot(immune_signature_immunologically_quiet, "immunologically_quiet", facet.by = "cluster")
```


Non-parametric alternative to one-way ANOVA test
Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.
```{r}
kruskal.test(immunologically_quiet ~ cluster, data = immune_signature_immunologically_quiet)
```

```{r}
table(immune_signature_immunologically_quiet$cluster)
```


Visualization
```{r, fig.width=7, fig.height=4.5}
pwc_immunologically_quiet <- pwc_immunologically_quiet %>% add_xy_position(x = "cluster")
my_comparisons <- list( c("ppbcpw", "ppbcdl"), c("ppbcpw", "prbc"), c("ppbcpw", "npbc") )

ggboxplot(immune_signature_immunologically_quiet, x="cluster", y="immunologically_quiet",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "immunologically_quiet at Diagnosis", xlab = "Study Group", lwd = 1) + stat_compare_means(method = "anova") + stat_pvalue_manual(pwc_immunologically_quiet, hide.ns = TRUE) 

ggline(immune_signature_immunologically_quiet, x= "cluster", y= "immunologically_quiet",
       add = c("mean_se", "jitter"),
       order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
       ylab = "immunologically_quiet at Diagnosis", xlab = "Study Group") + stat_compare_means(method = "anova")

ANOVA_immunologically_quiet <- ggboxplot(immune_signature_immunologically_quiet, x="cluster", y="immunologically_quiet",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "immunologically_quiet at Diagnosis", xlab = "Study Group") +  
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.0000005, aes(colour = cluster)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.00015) # + ylim(0, 0.7)# ) + ylim(0, 0.06)
ANOVA_immunologically_quiet
```


```{r}
ANOVA_immunologically_quiet <- ggboxplot(immune_signature_immunologically_quiet, x="cluster", y="immunologically_quiet",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "immunologically_quiet at Diagnosis", xlab = "Study Group") +  
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.000002, aes(colour = cluster)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.8) + ylim(0, 0.00012)# ) + ylim(0, 0.06)
ANOVA_immunologically_quiet
```

## TGFb dominant

```{r}
group_by(immune_signature, cluster) %>%
  summarise(
    count = n(),
    mean = mean(TGFb_dominant, na.rm = TRUE),
    sd = sd(TGFb_dominant, na.rm = TRUE)
  )
```


Remove NA values
```{r}
immune_signature <- immune_signature[!is.na(immune_signature$TGFb_dominant),]

group_by(immune_signature, cluster) %>%
  summarise(
    count = n(),
    mean = mean(TGFb_dominant, na.rm = TRUE),
    sd = sd(TGFb_dominant, na.rm = TRUE)
  )
```


Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(immune_signature$TGFb_dominant)
```


```{r}
outliers_TGFb_dominant <- boxplot(immune_signature$TGFb_dominant, plot=FALSE)$out
```

Remove outliers
```{r}
immune_signature_TGFb_dominant <- immune_signature
immune_signature_TGFb_dominant <- immune_signature_TGFb_dominant[-which(immune_signature_TGFb_dominant$TGFb_dominant %in% outliers_TGFb_dominant),]
```


Compute one-way ANOVA
As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.
```{r}
# compute the analysis of variance
res.aov.TGFb_dominant <- aov(TGFb_dominant ~ cluster, data = immune_signature_TGFb_dominant)
# summary of the analysis
summary(res.aov.TGFb_dominant)
```


Tukey multiple pairwise-comparisons
As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.
with outliers:
```{r}
TukeyHSD(res.aov.TGFb_dominant)
```

```{r}
pwc_TGFb_dominant <- immune_signature_TGFb_dominant %>% tukey_hsd(TGFb_dominant ~ cluster)
pwc_TGFb_dominant
```



Multiple comparisons using multicomp packTGFb_dominant
t’s possible to use the function glht() [in multcomp packTGFb_dominant] to perform multiple comparison procedures for an ANOVA. glht stands for general linear hypothesis tests. The simplified format is as follow:
```{r}
#summary(glht(res.aov.TGFb_dominant, linfct = mcp(cluster = "Tukey")))
```


Pairwise t-test
The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.
```{r}
pairwise.t.test(immune_signature_TGFb_dominant$TGFb_dominant, immune_signature_TGFb_dominant$cluster,
                 p.adjust.method = "BH")
```


Check ANOVA assumptions: test validity? 
The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.
homogeneity of variance assumption
```{r}
plot(res.aov.TGFb_dominant, 1)
```

```{r}
leveneTest(TGFb_dominant ~ cluster, data = immune_signature_TGFb_dominant)
```

From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption
How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?
An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().
```{r}
# ANOVA test with no assumption of equal variances
oneway.test(TGFb_dominant ~ cluster, data = immune_signature_TGFb_dominant)
```

```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(immune_signature_TGFb_dominant$TGFb_dominant, immune_signature_TGFb_dominant$cluster,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption
Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.
The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.
```{r}
plot(res.aov.TGFb_dominant, 2)

model_TGFb_dominant <- lm(TGFb_dominant ~ cluster, data=immune_signature_TGFb_dominant)
ggqqplot(residuals(model_TGFb_dominant))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.
```{r}
# Extract the reisudals 
aov_residuals_TGFb_dominant <- residuals(object = res.aov.TGFb_dominant)
# run Shapiro-Wilk test
shapiro.test(x = aov_residuals_TGFb_dominant)
shapiro_test(residuals(model_TGFb_dominant))
```

Check normality assumption by groups. Computing Shapiro-Wilk test for each group level. If the data is normally distributed, the p-value should be greater than 0.05.
```{r}
immune_signature_TGFb_dominant %>%
  group_by(cluster) %>%
  shapiro_test(TGFb_dominant)

ggqqplot(immune_signature_TGFb_dominant, "TGFb_dominant", facet.by = "cluster")
```


Non-parametric alternative to one-way ANOVA test
Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.
```{r}
kruskal.test(TGFb_dominant ~ cluster, data = immune_signature_TGFb_dominant)
```

```{r}
table(immune_signature_TGFb_dominant$cluster)
```


Visualization
```{r, fig.width=7, fig.height=4.5}
pwc_TGFb_dominant <- pwc_TGFb_dominant %>% add_xy_position(x = "cluster")
my_comparisons <- list( c("ppbcpw", "ppbcdl"), c("ppbcpw", "prbc"), c("ppbcpw", "npbc") )

ggboxplot(immune_signature_TGFb_dominant, x="cluster", y="TGFb_dominant",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "TGFb_dominant at Diagnosis", xlab = "Study Group", lwd = 1) + stat_compare_means(method = "anova") + stat_pvalue_manual(pwc_TGFb_dominant, hide.ns = TRUE) 

ggline(immune_signature_TGFb_dominant, x= "cluster", y= "TGFb_dominant",
       add = c("mean_se", "jitter"),
       order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
       ylab = "TGFb_dominant at Diagnosis", xlab = "Study Group") + stat_compare_means(method = "anova")

ANOVA_TGFb_dominant <- ggboxplot(immune_signature_TGFb_dominant, x="cluster", y="TGFb_dominant",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "TGFb_dominant at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.0005, aes(colour = cluster)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.03) # + ylim(0, 0.7)# ) + ylim(0, 0.06)
ANOVA_TGFb_dominant
```

```{r}
ANOVA_TGFb_dominant <- ggboxplot(immune_signature_TGFb_dominant, x="cluster", y="TGFb_dominant",
          color = "cluster", palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c("ppbcpw", "ppbcdl", "prbc", "npbc"),
          ylab = "TGFb_dominant at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.0005, aes(colour = cluster)) + stat_compare_means(method = "wilcox.test", comparisons = my_comparisons) + stat_compare_means(label.y = 0.03)  + ylim(0, 0.02)# ) + ylim(0, 0.06)
ANOVA_TGFb_dominant
```

# ANOVA per subgroup 

read in meta-file made to fit bestcall fractions 
```{r}
immune_signature <- read_excel("immune_signature.xlsx", sheet = "Sheet1")
```


## PPBC-PW

subset ppbcpw

```{r}
immune_signature_ppbcpw <- subset(immune_signature, cluster %in% c("ppbcpw"), )
```


```{r}
group_by(immune_signature_ppbcpw, BestCall) %>%
  summarise(
    count = n(),
    mean = mean(fraction_bestcall, na.rm = TRUE),
    sd = sd(fraction_bestcall, na.rm = TRUE)
  )
```


Remove NA values
```{r}
immune_signature_ppbcpw <- immune_signature_ppbcpw[!is.na(immune_signature_ppbcpw$fraction_bestcall),]

group_by(immune_signature_ppbcpw, BestCall) %>%
  summarise(
    count = n(),
    mean = mean(fraction_bestcall, na.rm = TRUE),
    sd = sd(fraction_bestcall, na.rm = TRUE)
  )
```


Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(immune_signature_ppbcpw$fraction_bestcall)
```

```{r}
boxplot(immune_signature_ppbcpw$fraction_bestcall, plot=FALSE)$out
```

NO outliers

```{r}
#outliers_fraction_bestcall <- boxplot(immune_signature_ppbcpw$fraction_bestcall, plot=FALSE)$out
```

Remove outliers
```{r}
#immune_signature_ppbcpw <- immune_signature_ppbcpw
#immune_signature_ppbcpw <- immune_signature_ppbcpw[-which(immune_signature_ppbcpw$fraction_bestcall %in% outliers_fraction_bestcall),]
```


Compute one-way ANOVA
As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.
```{r}
# compute the analysis of variance
res.aov.ppbcpw <- aov(fraction_bestcall ~ BestCall, data = immune_signature_ppbcpw)
# summary of the analysis
summary(res.aov.ppbcpw)
```


Tukey multiple pairwise-comparisons
As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.
with outliers:
```{r}
#TukeyHSD(res.aov.ppbcpw)
```

```{r}
immune_signature_ppbcpw$BestCall <- as.factor(immune_signature_ppbcpw$BestCall)
```


```{r}
pwc_ppbcpw <- immune_signature_ppbcpw %>% tukey_hsd(fraction_bestcall ~ BestCall)
pwc_ppbcpw
```



Multiple comparisons using multicomp packfraction_bestcall
t’s possible to use the function glht() [in multcomp packfraction_bestcall] to perform multiple comparison procedures for an ANOVA. glht stands for general linear hypothesis tests. The simplified format is as follow:
```{r}
#summary(glht(res.aov.fraction_bestcall, linfct = mcp(BestCall = "Tukey")))
```


Pairwise t-test
The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.
```{r}
pairwise.t.test(immune_signature_ppbcpw$fraction_bestcall, immune_signature_ppbcpw$BestCall,
                 p.adjust.method = "BH")
```


Check ANOVA assumptions: test validity? 
The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.
homogeneity of variance assumption
```{r}
#plot(res.aov.fraction_bestcall, 1)
```

```{r}
#leveneTest(fraction_bestcall ~ BestCall, data = immune_signature_ppbcpw)
```

From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption
How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?
An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().
```{r}
# ANOVA test with no assumption of equal variances
oneway.test(fraction_bestcall ~ BestCall, data = immune_signature_ppbcpw)
```

```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(immune_signature_ppbcpw$fraction_bestcall, immune_signature_ppbcpw$BestCall,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption
Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.
The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.
```{r}
#plot(res.aov.fraction_bestcall, 2)

#model_fraction_bestcall <- lm(fraction_bestcall ~ BestCall, data=immune_signature_ppbcpw)
#ggqqplot(residuals(model_fraction_bestcall))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.
```{r}
# Extract the reisudals 
#aov_residuals_fraction_bestcall <- residuals(object = res.aov.fraction_bestcall)
# run Shapiro-Wilk test
#shapiro.test(x = aov_residuals_fraction_bestcall)
#shapiro_test(residuals(model_fraction_bestcall))
```

Check normality assumption by groups. Computing Shapiro-Wilk test for each group level. If the data is normally distributed, the p-value should be greater than 0.05.
```{r}
#immune_signature_ppbcpw %>%
  #group_by(BestCall) %>%
  #shapiro_test(fraction_bestcall)

#ggqqplot(immune_signature_ppbcpw, "fraction_bestcall", facet.by = "BestCall")
```


Non-parametric alternative to one-way ANOVA test
Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.
```{r}
kruskal.test(fraction_bestcall ~ BestCall, data = immune_signature_ppbcpw)
```

```{r}
table(immune_signature_ppbcpw$BestCall)
```


Visualization
```{r, fig.width=7, fig.height=4.5}
pwc_ppbcpw <- pwc_ppbcpw %>% add_xy_position(x = "BestCall")

ggboxplot(immune_signature_ppbcpw, x="BestCall", y="fraction_bestcall",
          color = "BestCall", #palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c(1,2,3,4,5,6),
          ylab = "ppbcpw at Diagnosis", xlab = "Study Group", lwd = 1) + stat_compare_means(method = "anova") + stat_pvalue_manual(pwc_ppbcpw, hide.ns = TRUE) 

ggline(immune_signature_ppbcpw, x= "BestCall", y= "fraction_bestcall",
       add = c("mean_se", "jitter"),
       order = c(1,2,3,4,5,6),
       ylab = "ppbcpw at Diagnosis", xlab = "Study Group") + stat_compare_means(method = "anova")

ANOVA_ppbcpw <- ggboxplot(immune_signature_ppbcpw, x="BestCall", y="fraction_bestcall",
          color = "BestCall", #palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c(1,2,3,4,5,6),
          ylab = "ppbcpw at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.02, aes(colour = BestCall)) + stat_compare_means(method = "anova") + ylim(0,1.6) + stat_pvalue_manual(pwc_ppbcpw, hide.ns = TRUE, y.position = c(1.4,1.6))
ANOVA_ppbcpw
```




## PrBC

subset ppbcdl

```{r}
immune_signature_prbc <- subset(immune_signature, cluster %in% c("prbc"), )
```


```{r}
group_by(immune_signature_prbc, BestCall) %>%
  summarise(
    count = n(),
    mean = mean(fraction_bestcall, na.rm = TRUE),
    sd = sd(fraction_bestcall, na.rm = TRUE)
  )
```


Remove NA values
```{r}
immune_signature_prbc <- immune_signature_prbc[!is.na(immune_signature_prbc$fraction_bestcall),]

group_by(immune_signature_prbc, BestCall) %>%
  summarise(
    count = n(),
    mean = mean(fraction_bestcall, na.rm = TRUE),
    sd = sd(fraction_bestcall, na.rm = TRUE)
  )
```


Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(immune_signature_prbc$fraction_bestcall)
```

```{r}
boxplot(immune_signature_prbc$fraction_bestcall, plot=FALSE)$out
```

NO outliers

```{r}
#outliers_fraction_bestcall <- boxplot(immune_signature_prbc$fraction_bestcall, plot=FALSE)$out
```

Remove outliers
```{r}
#immune_signature_prbc <- immune_signature_prbc
#immune_signature_prbc <- immune_signature_prbc[-which(immune_signature_prbc$fraction_bestcall %in% outliers_fraction_bestcall),]
```


Compute one-way ANOVA
As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.
```{r}
# compute the analysis of variance
res.aov.prbc <- aov(fraction_bestcall ~ BestCall, data = immune_signature_prbc)
# summary of the analysis
summary(res.aov.prbc)
```


Tukey multiple pairwise-comparisons
As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.
with outliers:
```{r}
#TukeyHSD(res.aov.prbc)
```

```{r}
immune_signature_prbc$BestCall <- as.factor(immune_signature_prbc$BestCall)
```


```{r}
pwc_prbc <- immune_signature_prbc %>% tukey_hsd(fraction_bestcall ~ BestCall)
pwc_prbc
```



Multiple comparisons using multicomp packfraction_bestcall
t’s possible to use the function glht() [in multcomp packfraction_bestcall] to perform multiple comparison procedures for an ANOVA. glht stands for general linear hypothesis tests. The simplified format is as follow:
```{r}
#summary(glht(res.aov.fraction_bestcall, linfct = mcp(BestCall = "Tukey")))
```


Pairwise t-test
The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.
```{r}
pairwise.t.test(immune_signature_prbc$fraction_bestcall, immune_signature_prbc$BestCall,
                 p.adjust.method = "BH")
```


Check ANOVA assumptions: test validity? 
The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.
homogeneity of variance assumption
```{r}
#plot(res.aov.fraction_bestcall, 1)
```

```{r}
#leveneTest(fraction_bestcall ~ BestCall, data = immune_signature_prbc)
```

From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption
How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?
An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().
```{r}
# ANOVA test with no assumption of equal variances
oneway.test(fraction_bestcall ~ BestCall, data = immune_signature_prbc)
```

```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(immune_signature_prbc$fraction_bestcall, immune_signature_prbc$BestCall,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption
Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.
The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.
```{r}
#plot(res.aov.fraction_bestcall, 2)

#model_fraction_bestcall <- lm(fraction_bestcall ~ BestCall, data=immune_signature_prbc)
#ggqqplot(residuals(model_fraction_bestcall))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.
```{r}
# Extract the reisudals 
#aov_residuals_fraction_bestcall <- residuals(object = res.aov.fraction_bestcall)
# run Shapiro-Wilk test
#shapiro.test(x = aov_residuals_fraction_bestcall)
#shapiro_test(residuals(model_fraction_bestcall))
```

Check normality assumption by groups. Computing Shapiro-Wilk test for each group level. If the data is normally distributed, the p-value should be greater than 0.05.
```{r}
#immune_signature_prbc %>%
  #group_by(BestCall) %>%
  #shapiro_test(fraction_bestcall)

#ggqqplot(immune_signature_prbc, "fraction_bestcall", facet.by = "BestCall")
```


Non-parametric alternative to one-way ANOVA test
Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.
```{r}
kruskal.test(fraction_bestcall ~ BestCall, data = immune_signature_prbc)
```

```{r}
table(immune_signature_prbc$BestCall)
```


Visualization
```{r, fig.width=7, fig.height=4.5}
pwc_prbc <- pwc_prbc %>% add_xy_position(x = "BestCall")

ggboxplot(immune_signature_prbc, x="BestCall", y="fraction_bestcall",
          color = "BestCall", #palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c(1,2,3,4,5,6),
          ylab = "prbc at Diagnosis", xlab = "Study Group", lwd = 1) + stat_compare_means(method = "anova") + stat_pvalue_manual(pwc_prbc, hide.ns = TRUE) 

ggline(immune_signature_prbc, x= "BestCall", y= "fraction_bestcall",
       add = c("mean_se", "jitter"),
       order = c(1,2,3,4,5,6),
       ylab = "prbc at Diagnosis", xlab = "Study Group") + stat_compare_means(method = "anova")

ANOVA_prbc <- ggboxplot(immune_signature_prbc, x="BestCall", y="fraction_bestcall",
          color = "BestCall", #palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c(1,2,3,4,5,6),
          ylab = "prbc at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.02, aes(colour = BestCall)) + stat_compare_means(method = "anova") + ylim(0,1.6) + stat_pvalue_manual(pwc_prbc, hide.ns = TRUE, y.position = c(1.4))
ANOVA_prbc
```



## NPBC

subset ppbcdl

```{r}
immune_signature_npbc <- subset(immune_signature, cluster %in% c("npbc"), )
```


```{r}
group_by(immune_signature_npbc, BestCall) %>%
  summarise(
    count = n(),
    mean = mean(fraction_bestcall, na.rm = TRUE),
    sd = sd(fraction_bestcall, na.rm = TRUE)
  )
```


Remove NA values
```{r}
immune_signature_npbc <- immune_signature_npbc[!is.na(immune_signature_npbc$fraction_bestcall),]

group_by(immune_signature_npbc, BestCall) %>%
  summarise(
    count = n(),
    mean = mean(fraction_bestcall, na.rm = TRUE),
    sd = sd(fraction_bestcall, na.rm = TRUE)
  )
```


Outliers

We have a bunch of outliers in our data -> remove extreme outliers? 

```{r}
boxplot(immune_signature_npbc$fraction_bestcall)
```

```{r}
boxplot(immune_signature_npbc$fraction_bestcall, plot=FALSE)$out
```

NO outliers

```{r}
#outliers_fraction_bestcall <- boxplot(immune_signature_npbc$fraction_bestcall, plot=FALSE)$out
```

Remove outliers
```{r}
#immune_signature_npbc <- immune_signature_npbc
#immune_signature_npbc <- immune_signature_npbc[-which(immune_signature_npbc$fraction_bestcall %in% outliers_fraction_bestcall),]
```


Compute one-way ANOVA
As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the groups highlighted with “*" in the model summary.
```{r}
# compute the analysis of variance
res.aov.npbc <- aov(fraction_bestcall ~ BestCall, data = immune_signature_npbc)
# summary of the analysis
summary(res.aov.npbc)
```


Tukey multiple pairwise-comparisons
As the ANOVA test is significant, we can compute Tukey HSD (Tukey Honest Significant Differences, R function: TukeyHSD()) for performing multiple pairwise-comparison between the means of groups.
with outliers:
```{r}
#TukeyHSD(res.aov.npbc)
```

```{r}
immune_signature_npbc$BestCall <- as.factor(immune_signature_npbc$BestCall)
```


```{r}
pwc_npbc <- immune_signature_npbc %>% tukey_hsd(fraction_bestcall ~ BestCall)
pwc_npbc
```



Multiple comparisons using multicomp packfraction_bestcall
t’s possible to use the function glht() [in multcomp packfraction_bestcall] to perform multiple comparison procedures for an ANOVA. glht stands for general linear hypothesis tests. The simplified format is as follow:
```{r}
#summary(glht(res.aov.fraction_bestcall, linfct = mcp(BestCall = "Tukey")))
```


Pairwise t-test
The result is a table of p-values for the pairwise comparisons. Here, the p-values have been adjusted by the Benjamini-Hochberg method.
```{r}
pairwise.t.test(immune_signature_npbc$fraction_bestcall, immune_signature_npbc$BestCall,
                 p.adjust.method = "BH")
```


Check ANOVA assumptions: test validity? 
The ANOVA test assumes that, the data are normally distributed and the variance across groups are homogeneous. We can check that with some diagnostic plots.
homogeneity of variance assumption
```{r}
#plot(res.aov.fraction_bestcall, 1)
```

```{r}
#leveneTest(fraction_bestcall ~ BestCall, data = immune_signature_npbc)
```

From the output above we can see that the p-value is less than the significance level of 0.05. This means that there is evidence to suggest that the variance across groups is statistically significantly different. Therefore, we cannot assume the homogeneity of variances in the different treatment groups.


Relaxing the homogeneity of variance assumption
How do we save our ANOVA test, in a situation where the homogeneity of variance assumption is violated?
An alternative procedure (i.e.: Welch one-way test), that does not require that assumption have been implemented in the function oneway.test().
```{r}
# ANOVA test with no assumption of equal variances
oneway.test(fraction_bestcall ~ BestCall, data = immune_signature_npbc)
```

```{r}
# Paiwise t-test with no assumption of equel variances
pairwise.t.test(immune_signature_npbc$fraction_bestcall, immune_signature_npbc$BestCall,
                 p.adjust.method = "BH", pool.sd = FALSE)
```

Check the normality assumption
Normality plot of residuals. In the plot below, the quantiles of the residuals are plotted against the quantiles of the normal distribution. A 45-degree reference line is also plotted.
The normal probability plot of residuals is used to check the assumption that the residuals are normally distributed. It should approximately follow a straight line.
```{r}
#plot(res.aov.fraction_bestcall, 2)

#model_fraction_bestcall <- lm(fraction_bestcall ~ BestCall, data=immune_signature_npbc)
#ggqqplot(residuals(model_fraction_bestcall))
```

The conclusion above, is supported by the Shapiro-Wilk test on the ANOVA residuals which finds an indication that normality is violated.
```{r}
# Extract the reisudals 
#aov_residuals_fraction_bestcall <- residuals(object = res.aov.fraction_bestcall)
# run Shapiro-Wilk test
#shapiro.test(x = aov_residuals_fraction_bestcall)
#shapiro_test(residuals(model_fraction_bestcall))
```

Check normality assumption by groups. Computing Shapiro-Wilk test for each group level. If the data is normally distributed, the p-value should be greater than 0.05.
```{r}
#immune_signature_npbc %>%
  #group_by(BestCall) %>%
  #shapiro_test(fraction_bestcall)

#ggqqplot(immune_signature_npbc, "fraction_bestcall", facet.by = "BestCall")
```


Non-parametric alternative to one-way ANOVA test
Note that, a non-parametric alternative to one-way ANOVA is Kruskal-Wallis rank sum test, which can be used when ANNOVA assumptions are not met.
```{r}
kruskal.test(fraction_bestcall ~ BestCall, data = immune_signature_npbc)
```

```{r}
table(immune_signature_npbc$BestCall)
```


Visualization
```{r, fig.width=7, fig.height=4.5}
pwc_npbc <- pwc_npbc %>% add_xy_position(x = "BestCall")

ggboxplot(immune_signature_npbc, x="BestCall", y="fraction_bestcall",
          color = "BestCall", #palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c(1,2,3,4,5,6),
          ylab = "npbc at Diagnosis", xlab = "Study Group", lwd = 1) + stat_compare_means(method = "anova") + stat_pvalue_manual(pwc_npbc, hide.ns = TRUE) 

ggline(immune_signature_npbc, x= "BestCall", y= "fraction_bestcall",
       add = c("mean_se", "jitter"),
       order = c(1,2,3,4,5,6),
       ylab = "npbc at Diagnosis", xlab = "Study Group") + stat_compare_means(method = "anova")

ANOVA_npbc <- ggboxplot(immune_signature_npbc, x="BestCall", y="fraction_bestcall",
          color = "BestCall", #palette = c("#46CDCF", "#112D4E","#AA96DA", "#521262"),
          order = c(1,2,3,4,5,6),
          ylab = "npbc at Diagnosis", xlab = "Study Group") +
  geom_dotplot(binaxis = "y", stackdir = "center", position = "dodge", binwidth = 0.02, aes(colour = BestCall)) + stat_compare_means(method = "anova") + ylim(0,1.6) + stat_pvalue_manual(pwc_npbc, hide.ns = TRUE, y.position = c(1.1,1.2,1.3,1.4,1.5))
ANOVA_npbc
```




